{% extends 'mssp_dashboard/base.html' %}

{% block title %}{{ vulnerability.cve_id }} - MSSP{% endblock %}
{% block page_title %}Vulnerability Detail{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'mssp_dashboard:vulnerabilities' %}">Vulnerabilities</a></li>
<li class="breadcrumb-item active">{{ vulnerability.cve_id|default:"Detail" }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Vulnerability Info -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bug mr-2"></i>
                    {{ vulnerability.title }}
                </h3>
                <div class="card-tools">
                    <span class="badge severity-{{ vulnerability.severity }}">{{ vulnerability.severity|upper }}</span>
                    {% if vulnerability.cvss_score %}
                        <span class="badge badge-dark">CVSS: {{ vulnerability.cvss_score }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <!-- CVE Information -->
                {% if vulnerability.cve_id %}
                <div class="mb-3">
                    <strong>CVE ID:</strong> <code>{{ vulnerability.cve_id }}</code>
                    <a href="https://nvd.nist.gov/vuln/detail/{{ vulnerability.cve_id }}" target="_blank" class="ml-2">
                        <i class="fas fa-external-link-alt"></i> View on NVD
                    </a>
                </div>
                {% endif %}

                <!-- Description -->
                <div class="mb-3">
                    <h5><i class="fas fa-info-circle mr-2"></i>Description</h5>
                    <p>{{ vulnerability.description }}</p>
                </div>

                <!-- AI Mitigation Recommendation -->
                {% if vulnerability.ai_mitigation_recommendation %}
                <div class="alert alert-info">
                    <h5>
                        <i class="fas fa-robot mr-2"></i>
                        AI-Powered Mitigation Recommendation
                        {% if vulnerability.ai_confidence_score %}
                            <span class="badge badge-success">{{ vulnerability.ai_confidence_score|floatformat:0 }}% Confidence</span>
                        {% endif %}
                    </h5>
                    <div style="white-space: pre-wrap;">{{ vulnerability.ai_mitigation_recommendation }}</div>
                </div>
                {% endif %}

                <!-- Affected Devices -->
                <div class="mb-3">
                    <h5><i class="fas fa-server mr-2"></i>Affected Devices ({{ vulnerability.affected_devices.count }})</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Type</th>
                                    <th>IP Address</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in vulnerability.affected_devices.all %}
                                <tr>
                                    <td>{{ device.name }}</td>
                                    <td><span class="badge badge-secondary">{{ device.device_type }}</span></td>
                                    <td><code>{{ device.ip_address }}</code></td>
                                    <td>{{ device.location_name }}</td>
                                    <td>
                                        <span class="badge status-{{ device.status }}">{{ device.status }}</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-muted">No affected devices</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- References -->
                {% if vulnerability.references %}
                <div class="mb-3">
                    <h5><i class="fas fa-link mr-2"></i>References</h5>
                    <ul>
                        {% for ref in vulnerability.references %}
                        <li><a href="{{ ref }}" target="_blank">{{ ref }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Remediation Playbooks -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cogs mr-2"></i>
                    Available Remediation Playbooks
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Playbook</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for playbook in available_playbooks %}
                            <tr>
                                <td>
                                    <strong>{{ playbook.name }}</strong><br>
                                    <small class="text-muted">{{ playbook.description|truncatewords:15 }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-success">{{ playbook.success_rate|floatformat:1 }}%</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="runPlaybook({{ playbook.id }})">
                                        <i class="fas fa-play"></i> Execute
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-muted">No playbooks available for this vulnerability.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Status Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks mr-2"></i>
                    Status Information
                </h3>
            </div>
            <div class="card-body">
                <p><strong>Status:</strong>
                    {% if vulnerability.status == 'open' %}
                        <span class="badge badge-danger">Open</span>
                    {% elif vulnerability.status == 'in_progress' %}
                        <span class="badge badge-warning">In Progress</span>
                    {% elif vulnerability.status == 'mitigated' %}
                        <span class="badge badge-info">Mitigated</span>
                    {% elif vulnerability.status == 'resolved' %}
                        <span class="badge badge-success">Resolved</span>
                    {% endif %}
                </p>
                <p><strong>Discovered:</strong> {{ vulnerability.discovered_at|date:"M d, Y" }}</p>
                {% if vulnerability.resolved_at %}
                <p><strong>Resolved:</strong> {{ vulnerability.resolved_at|date:"M d, Y" }}</p>
                {% endif %}
                {% if vulnerability.assigned_to %}
                <p><strong>Assigned To:</strong> {{ vulnerability.assigned_to.username }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history mr-2"></i>
                    Recent Activity
                </h3>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for execution in recent_executions %}
                    <div>
                        <i class="fas fa-robot bg-{{ execution.status == 'success' and 'success' or 'danger' }}"></i>
                        <div class="timeline-item">
                            <span class="time">{{ execution.started_at|timesince }} ago</span>
                            <h3 class="timeline-header">{{ execution.playbook.name }}</h3>
                            <div class="timeline-body">
                                Status: <span class="badge badge-{{ execution.status == 'success' and 'success' or 'danger' }}">{{ execution.status }}</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent activity</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function runPlaybook(playbookId) {
    if (confirm('Execute this remediation playbook?')) {
        alert('Playbook execution started! (Mock implementation)');
        // In production, this would trigger an API call to execute the playbook
    }
}
</script>
{% endblock %}
