# SPF, DMARC, and DKIM DNS Configuration
# HookProbe POD-009 Email System

## Overview

These DNS records prevent email spoofing and improve deliverability by:
- **SPF**: Authorizing which IPs can send email for your domain
- **DKIM**: Cryptographically signing outbound emails
- **DMARC**: Telling recipients how to handle authentication failures

## DNS Records to Add

### 1. SPF Record

**Record Type:** TXT
**Name:** `hookprobe.com` (or `@`)
**Value:**
```
v=spf1 ip4:YOUR_DMZ_GATEWAY_PUBLIC_IP include:_spf.google.com ~all
```

**Explanation:**
- `v=spf1` - SPF version 1
- `ip4:YOUR_DMZ_GATEWAY_PUBLIC_IP` - Your DMZ gateway's public IP (10.200.9.10 is internal)
- `include:_spf.google.com` - If using Google Workspace as backup
- `~all` - Soft fail for other senders (use `-all` for hard fail after testing)

**Example:**
```
v=spf1 ip4:203.0.113.10 include:_spf.google.com ~all
```

### 2. DKIM Record

**Record Type:** TXT
**Name:** `default._domainkey.hookprobe.com`
**Value:** (Generated by `dkim-setup.sh`)

```
v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
```

**Notes:**
- The public key is generated by OpenDKIM
- Located at: `/etc/postfix/dkim/keys/hookprobe.com/default.txt`
- Must match the private key used for signing

**Verification:**
```bash
opendkim-testkey -d hookprobe.com -s default -vvv
```

### 3. DMARC Record

**Record Type:** TXT
**Name:** `_dmarc.hookprobe.com`
**Value:**
```
v=DMARC1; p=quarantine; rua=mailto:dmarc-reports@hookprobe.com; ruf=mailto:dmarc-failures@hookprobe.com; fo=1; adkim=r; aspf=r; pct=100; ri=86400
```

**Explanation:**
- `v=DMARC1` - DMARC version 1
- `p=quarantine` - Policy for failed messages (none/quarantine/reject)
- `rua=` - Aggregate reports sent here daily
- `ruf=` - Forensic reports for individual failures
- `fo=1` - Report if either SPF or DKIM fails
- `adkim=r` - Relaxed DKIM alignment
- `aspf=r` - Relaxed SPF alignment
- `pct=100` - Apply policy to 100% of messages
- `ri=86400` - Report interval (24 hours)

**Recommended Progression:**
1. Start with `p=none` to monitor without blocking
2. After 2 weeks of clean reports, change to `p=quarantine`
3. After 1 month with `p=quarantine`, change to `p=reject`

### 4. MX Records (Mail Exchange)

**Record Type:** MX
**Name:** `hookprobe.com` (or `@`)
**Priority:** `10`
**Value:** `mail.hookprobe.com`

**Secondary MX (Optional Backup):**
**Priority:** `20`
**Value:** `mail-backup.hookprobe.com`

### 5. A Record for Mail Server

**Record Type:** A
**Name:** `mail.hookprobe.com`
**Value:** YOUR_DMZ_GATEWAY_PUBLIC_IP (e.g., `203.0.113.10`)

### 6. PTR Record (Reverse DNS)

**Important:** Configure with your hosting provider/ISP

**Name:** `10.113.0.203.in-addr.arpa`
**Value:** `mail.hookprobe.com`

**Why it matters:**
- Many mail servers reject email if PTR doesn't match
- Must be configured by whoever controls the IP block
- Essential for deliverability

## Complete DNS Configuration Example

```dns
; Domain: hookprobe.com
; Update YOUR_PUBLIC_IP with actual public IP

; MX Records
@               IN  MX  10  mail.hookprobe.com.
@               IN  MX  20  mail-backup.hookprobe.com.

; A Records
mail            IN  A   YOUR_PUBLIC_IP
mail-backup     IN  A   YOUR_BACKUP_IP

; SPF Record
@               IN  TXT "v=spf1 ip4:YOUR_PUBLIC_IP ~all"

; DKIM Record (generated by OpenDKIM)
default._domainkey  IN  TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w..."

; DMARC Record
_dmarc          IN  TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc-reports@hookprobe.com; ruf=mailto:dmarc-failures@hookprobe.com; fo=1"

; Additional Records
@               IN  TXT "v=spf1 ip4:YOUR_PUBLIC_IP ~all"
```

## Verification Steps

### 1. SPF Verification

```bash
# Using dig
dig +short TXT hookprobe.com | grep spf

# Using nslookup
nslookup -q=TXT hookprobe.com

# Online tool
https://mxtoolbox.com/spf.aspx
```

### 2. DKIM Verification

```bash
# Using opendkim-testkey
opendkim-testkey -d hookprobe.com -s default -vvv

# Using dig
dig +short TXT default._domainkey.hookprobe.com

# Send test email and check headers
```

### 3. DMARC Verification

```bash
# Using dig
dig +short TXT _dmarc.hookprobe.com

# Online validation
https://mxtoolbox.com/dmarc.aspx
```

### 4. Complete Email Authentication Check

Send a test email to:
- `check-auth@verifier.port25.com` - Detailed authentication report
- `check@tools.mxtoolbox.com` - MXToolbox analysis
- Your own Gmail account - Check "Show original" headers

## Monitoring DMARC Reports

### Setting up DMARC Report Processing

1. **Create Email Aliases** (on internal mail server):
```
dmarc-reports@hookprobe.com  →  qsecbit@hookprobe.com
dmarc-failures@hookprobe.com  →  qsecbit@hookprobe.com
```

2. **Use DMARC Analyzer** (Optional):
- https://dmarc.postmarkapp.com/ (Free)
- https://dmarcian.com/ (Paid)
- https://dmarc.org/dmarc-tools/ (Self-hosted)

3. **Manual Analysis**:
DMARC reports arrive as XML attachments. Key metrics:
- SPF pass/fail rate
- DKIM pass/fail rate
- Source IPs sending as your domain
- Disposition (none/quarantine/reject)

## Troubleshooting

### SPF Issues

**Problem:** SPF lookup limit exceeded
**Solution:** Reduce `include:` statements, flatten SPF record

**Problem:** `-all` causing delivery failures
**Solution:** Use `~all` during testing

### DKIM Issues

**Problem:** DKIM signature verification failed
**Solution:**
- Check DNS propagation: `dig default._domainkey.hookprobe.com TXT`
- Verify key permissions: `chmod 600 /etc/postfix/dkim/keys/*/private`
- Check OpenDKIM logs: `journalctl -u opendkim -f`

**Problem:** DKIM key not found
**Solution:** Wait 24-48 hours for DNS propagation

### DMARC Issues

**Problem:** Not receiving reports
**Solution:**
- Verify email address in `rua=` is correct
- Check spam folder
- Ensure mailbox has enough space

**Problem:** High failure rate
**Solution:**
- Review DMARC reports to identify sources
- Check if SPF/DKIM are properly configured
- Look for forwarding issues

## Best Practices

1. **Start Conservative**:
   - Begin with `p=none` in DMARC
   - Use `~all` in SPF
   - Monitor for 2-4 weeks

2. **Gradual Enforcement**:
   - `p=none` → Monitor (2-4 weeks)
   - `p=quarantine` → Soft enforcement (4-8 weeks)
   - `p=reject` → Full enforcement (ongoing)

3. **Monitor Regularly**:
   - Review DMARC reports weekly
   - Check for unauthorized senders
   - Verify alignment rates >95%

4. **Keep Records Updated**:
   - Update SPF when IPs change
   - Rotate DKIM keys annually
   - Update DMARC policy as needed

5. **Test Before Deploying**:
   - Use test emails to check-auth services
   - Verify headers show SPF and DKIM pass
   - Confirm DMARC alignment

## Security Considerations

- **DKIM Key Size**: Use at least 2048-bit keys
- **DKIM Key Rotation**: Rotate annually or when compromised
- **SPF Record**: Keep under 10 DNS lookups
- **DMARC Reports**: Protect aggregate report mailbox
- **PTR Record**: Essential for deliverability
- **DNSSEC**: Consider signing your domain

## References

- [SPF RFC 7208](https://tools.ietf.org/html/rfc7208)
- [DKIM RFC 6376](https://tools.ietf.org/html/rfc6376)
- [DMARC RFC 7489](https://tools.ietf.org/html/rfc7489)
- [DMARC.org](https://dmarc.org/)
- [MXToolbox](https://mxtoolbox.com/)
