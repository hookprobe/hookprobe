#!/bin/bash
#
# mitigation-config.conf
# Configuration for HookProbe Attack Mitigation System
#

# ============================================================
# DIRECTORY CONFIGURATION
# ============================================================
LOG_DIR="/var/log/hookprobe/mitigation"
STATE_DIR="/var/lib/hookprobe/mitigation"
REPORT_DIR="/var/lib/hookprobe/reports"

# ============================================================
# API ENDPOINTS
# ============================================================
QSECBIT_API="http://10.107.0.10:8888"
VICTORIAMETRICS_URL="http://10.105.0.11:9090"
CLICKHOUSE_URL="http://10.200.5.11:8123"

# ============================================================
# LOG FILE PATHS
# ============================================================
SNORT3_ALERT_FILE="/var/log/snort/alert_fast.txt"
ZEEK_NOTICE_LOG="/opt/zeek/logs/current/notice.log"
MODSECURITY_AUDIT_LOG="/var/log/modsec_audit/audit.log"

# ============================================================
# HONEYPOT CONFIGURATION
# ============================================================
ENABLE_HONEYPOT=true
HONEYPOT_IP="10.108.0.10"
HONEYPOT_SSH_PORT=2222
HONEYPOT_TELNET_PORT=2223
HONEYPOT_HTTP_PORT=8080

# ============================================================
# MITIGATION BEHAVIOR
# ============================================================
# Action levels: "block", "honeypot", "monitor"
CRITICAL_ACTION="block"
HIGH_ACTION="block"
MEDIUM_ACTION="honeypot"
LOW_ACTION="honeypot"

# Auto-block thresholds
AUTO_BLOCK_THRESHOLD=5          # Block after N attacks from same IP
HONEYPOT_REDIRECT_THRESHOLD=2   # Redirect to honeypot after N attacks

# ============================================================
# NOTIFICATION SETTINGS
# ============================================================
NOTIFICATION_EMAIL="qsecbit@hookprobe.com"
ENABLE_EMAIL_NOTIFICATIONS=true
EMAIL_ON_AMBER=true
EMAIL_ON_RED=true
EMAIL_ON_CRITICAL_ATTACK=true

# ============================================================
# QSECBIT INTEGRATION
# ============================================================
QSECBIT_CHECK_INTERVAL=30       # Seconds between Qsecbit checks
ACTIVATE_ON_AMBER=true          # Activate mitigation on AMBER status
ACTIVATE_ON_RED=true            # Activate mitigation on RED status

# ============================================================
# ATTACK DETECTION WINDOWS
# ============================================================
SNORT_LOOKBACK_WINDOW="5m"      # How far back to check Snort alerts
ZEEK_LOOKBACK_WINDOW="5m"       # How far back to check Zeek notices
MODSEC_LOOKBACK_WINDOW="5m"     # How far back to check ModSecurity
CLICKHOUSE_LOOKBACK_WINDOW="5m" # How far back to check ClickHouse security events

# ============================================================
# IP WHITELIST (Never block these IPs)
# ============================================================
IP_WHITELIST=(
    "127.0.0.1"
    "::1"
    "10.100.0.0/16"             # Internal HookProbe network
    # Add your trusted IPs here
    # "192.168.1.100"
)

# ============================================================
# ATTACK PATTERN SIGNATURES
# ============================================================
# NOTE: ClickHouse uses SQL queries directly (see attack-mitigation-orchestrator.sh)
# Legacy patterns below are kept for reference
XSS_PATTERN='xss'
SQLI_PATTERN='sqli'
CMD_INJECTION_PATTERN='cmd_injection'
PATH_TRAVERSAL_PATTERN='path_traversal'
BRUTE_FORCE_PATTERN='brute_force'

# ============================================================
# ADVANCED SETTINGS
# ============================================================
# Clean up old data
CLEANUP_OLD_REPORTS_DAYS=30     # Delete reports older than N days
CLEANUP_OLD_BLOCKS_DAYS=7       # Remove IP blocks older than N days

# Rate limiting
MAX_MITIGATIONS_PER_MINUTE=100  # Prevent runaway mitigation

# Honeypot logging
HONEYPOT_LOG_RETENTION_DAYS=90  # Keep honeypot logs for N days

# Performance
MAX_CONCURRENT_PROCESSES=4      # Max parallel mitigation processes

# ============================================================
# EXPERIMENTAL FEATURES
# ============================================================
ENABLE_ML_CORRELATION=false     # Use ML to correlate attacks (requires trained model)
ENABLE_GEO_BLOCKING=false       # Block entire countries (requires GeoIP database)
ENABLE_AUTO_WAF_UPDATE=true     # Automatically update WAF rules from attack patterns

# ============================================================
# DEBUG SETTINGS
# ============================================================
DEBUG_MODE=false
VERBOSE_LOGGING=true
DRY_RUN=false                   # If true, log actions but don't execute

# ============================================================
# VALIDATION
# ============================================================
validate_config() {
    local errors=0
    
    # Check required directories
    for dir in "$LOG_DIR" "$STATE_DIR" "$REPORT_DIR"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir" || {
                echo "ERROR: Cannot create directory: $dir"
                errors=$((errors + 1))
            }
        fi
    done
    
    # Check API endpoints
    if ! curl -s --connect-timeout 5 "${QSECBIT_API}/health" > /dev/null; then
        echo "WARNING: Qsecbit API not reachable at ${QSECBIT_API}"
    fi
    
    # Validate email
    if [ "$ENABLE_EMAIL_NOTIFICATIONS" = "true" ]; then
        if ! command -v mail &> /dev/null; then
            echo "ERROR: 'mail' command not found. Install mailutils or postfix."
            errors=$((errors + 1))
        fi
    fi
    
    # Check honeypot
    if [ "$ENABLE_HONEYPOT" = "true" ]; then
        if ! command -v podman &> /dev/null; then
            echo "ERROR: 'podman' not found. Required for honeypot."
            errors=$((errors + 1))
        fi
    fi
    
    return $errors
}

# Auto-validate on source
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    echo "Validating HookProbe Mitigation Configuration..."
    if validate_config; then
        echo "✓ Configuration validated successfully"
    else
        echo "✗ Configuration validation failed"
        exit 1
    fi
fi
