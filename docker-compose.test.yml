# docker-compose.test.yml
# Multi-arch testing environment for HookProbe using Podman
# Supports: linux/amd64, linux/arm64 (Raspberry Pi 4)
#
# Prerequisites:
#   sudo apt install podman
#   pip3 install podman-compose
#
# Usage:
#   podman-compose -f docker-compose.test.yml up
#   podman-compose -f docker-compose.test.yml down -v
#
# Run tests:
#   ./scripts/run-unit-tests.sh
#   ./scripts/run-integration-tests.sh
#   ./scripts/run-performance-tests.sh

version: '3.8'

services:
  # Web application test service
  web-test:
    platform: linux/arm64
    build:
      context: ./src/web
      dockerfile: Dockerfile.test
    container_name: hookprobe-web-test
    environment:
      # Django settings
      DJANGO_ENV: test
      DJANGO_SETTINGS_MODULE: hookprobe.settings.test
      DJANGO_SECRET_KEY: test-secret-key-change-in-production
      DEBUG: 'True'
      ALLOWED_HOSTS: '*'

      # Database settings
      POSTGRES_DB: hookprobe_test
      POSTGRES_USER: hookprobe
      POSTGRES_PASSWORD: test_password
      POSTGRES_HOST: db-test
      POSTGRES_PORT: 5432

      # Redis settings
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      REDIS_DB: 0

      # Disable Logto in tests
      LOGTO_ENDPOINT: ''
      LOGTO_APP_ID: ''
      LOGTO_APP_SECRET: ''

      # Test-specific settings
      PYTEST_XDIST_WORKER_COUNT: 2
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    mem_limit: 1g
    cpus: "2.0"
    volumes:
      - ./src/web:/app:ro
      - test-static:/app/staticfiles
      - test-media:/app/media
    command: ["sleep", "infinity"]  # Keep container running for manual tests

  # PostgreSQL test database
  db-test:
    platform: linux/arm64
    image: postgres:16-alpine
    container_name: hookprobe-db-test
    environment:
      POSTGRES_DB: hookprobe_test
      POSTGRES_USER: hookprobe
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    networks:
      - test-network
    mem_limit: 512m
    cpus: "1.0"
    volumes:
      - test-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hookprobe"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    tmpfs:
      - /tmp
      - /var/run/postgresql

  # Redis test cache
  redis-test:
    platform: linux/arm64
    image: redis:7-alpine
    container_name: hookprobe-redis-test
    networks:
      - test-network
    mem_limit: 256m
    cpus: "0.5"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    command: >
      redis-server
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no

  # Optional: Logto IAM for integration tests (can be disabled)
  iam-test:
    platform: linux/arm64
    image: svhd/logto:latest
    container_name: hookprobe-iam-test
    environment:
      DB_URL: postgresql://hookprobe:test_password@db-test:5432/hookprobe_test
      ADMIN_ENDPOINT: http://localhost:3002
      ENDPOINT: http://localhost:3001
    networks:
      - test-network
    mem_limit: 512m
    cpus: "1.0"
    depends_on:
      db-test:
        condition: service_healthy
    profiles:
      - full-integration  # Only start with: docker-compose --profile full-integration up

networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  test-pgdata:
    driver: local
  test-static:
    driver: local
  test-media:
    driver: local
