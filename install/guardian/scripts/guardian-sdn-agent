#!/usr/bin/env python3
"""
HookProbe Guardian SDN Agent

Runs on Guardian (Raspberry Pi) to:
- Sync configuration from Nexus/Fortress
- Report network scans
- Update hostapd/dnsmasq dynamically
- Monitor connected devices

Version: 5.0.0
"""

import os
import sys
import json
import time
import logging
import subprocess
import hashlib
from pathlib import Path

import requests

# Configuration
NEXUS_API = os.getenv('HOOKPROBE_NEXUS_API', 'https://nexus.hookprobe.com/api/sdn')
GUARDIAN_ID = os.getenv('HOOKPROBE_GUARDIAN_ID', '')
API_KEY = os.getenv('HOOKPROBE_API_KEY', '')
SYNC_INTERVAL = int(os.getenv('HOOKPROBE_SYNC_INTERVAL', '60'))

CONFIG_DIR = Path('/etc/hostapd')
VLAN_FILE = CONFIG_DIR / 'hostapd.vlan'
ACCEPT_FILE = CONFIG_DIR / 'hostapd.accept'

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('/var/log/guardian-sdn.log')
    ]
)
logger = logging.getLogger(__name__)


def get_guardian_id():
    """Get or generate Guardian ID from hardware."""
    if GUARDIAN_ID:
        return GUARDIAN_ID

    # Use MAC address of eth0 as ID
    try:
        with open('/sys/class/net/eth0/address') as f:
            mac = f.read().strip().replace(':', '')
            return f"guardian-{mac}"
    except Exception:
        return f"guardian-{hashlib.md5(os.urandom(16)).hexdigest()[:12]}"


def scan_wifi_networks():
    """Scan for available WiFi networks."""
    networks = []
    try:
        # Use iw to scan
        result = subprocess.run(
            ['iw', 'wlan1', 'scan'],
            capture_output=True,
            text=True,
            timeout=30
        )

        current_network = {}
        for line in result.stdout.split('\n'):
            line = line.strip()
            if line.startswith('BSS '):
                if current_network:
                    networks.append(current_network)
                bssid = line.split()[1].split('(')[0]
                current_network = {'bssid': bssid}
            elif line.startswith('SSID:'):
                current_network['ssid'] = line.split(':', 1)[1].strip()
            elif line.startswith('signal:'):
                signal = line.split(':')[1].strip().split()[0]
                current_network['signal'] = int(float(signal))
            elif line.startswith('freq:'):
                current_network['frequency'] = int(line.split(':')[1].strip())
            elif 'WPA' in line or 'RSN' in line:
                current_network['security'] = 'WPA2'
            elif line.startswith('DS Parameter set: channel'):
                current_network['channel'] = int(line.split()[-1])

        if current_network:
            networks.append(current_network)

    except Exception as e:
        logger.error(f"WiFi scan failed: {e}")

    return networks


def report_scan_results(guardian_id, networks):
    """Send scan results to Nexus API."""
    try:
        response = requests.post(
            f"{NEXUS_API}/guardian/scan-results/",
            json={
                'guardian_id': guardian_id,
                'networks': networks
            },
            headers={'Authorization': f'Bearer {API_KEY}'},
            timeout=10
        )
        response.raise_for_status()
        logger.info(f"Reported {len(networks)} networks to Nexus")
    except Exception as e:
        logger.error(f"Failed to report scan results: {e}")


def fetch_config(guardian_id):
    """Fetch configuration from Nexus."""
    try:
        response = requests.get(
            f"{NEXUS_API}/guardian/{guardian_id}/config/",
            headers={'Authorization': f'Bearer {API_KEY}'},
            timeout=10
        )
        response.raise_for_status()
        return response.json()
    except Exception as e:
        logger.error(f"Failed to fetch config: {e}")
        return None


def update_hostapd_config(config):
    """Update hostapd configuration from Nexus config."""
    if not config:
        return False

    try:
        hotspot = config.get('hotspot', {})

        # Update hostapd.conf
        hostapd_conf = CONFIG_DIR / 'hostapd.conf'
        with open(hostapd_conf, 'r') as f:
            content = f.read()

        # Update SSID and password
        import re
        content = re.sub(r'^ssid=.*$', f"ssid={hotspot.get('ssid', 'HookProbe-Guardian')}", content, flags=re.M)
        content = re.sub(r'^wpa_passphrase=.*$', f"wpa_passphrase={hotspot.get('password', 'hookprobe')}", content, flags=re.M)
        content = re.sub(r'^channel=.*$', f"channel={hotspot.get('channel', 6)}", content, flags=re.M)

        with open(hostapd_conf, 'w') as f:
            f.write(content)

        # Update VLAN file
        vlans = config.get('vlans', {}).get('configured', [])
        with open(VLAN_FILE, 'w') as f:
            f.write("# Auto-generated VLAN configuration\n")
            f.write("1\tbr1\n")
            for vlan in vlans:
                f.write(f"{vlan['vlan_id']}\tbr{vlan['vlan_id']}\n")
            f.write(f"{config.get('vlans', {}).get('quarantine', 999)}\tbr999\n")

        # Update MAC accept list
        devices = config.get('devices', [])
        with open(ACCEPT_FILE, 'w') as f:
            f.write("# Auto-generated MAC accept list\n")
            for device in devices:
                f.write(f"{device['mac_address']}\n")

        logger.info(f"Updated hostapd config: {len(vlans)} VLANs, {len(devices)} devices")
        return True

    except Exception as e:
        logger.error(f"Failed to update hostapd config: {e}")
        return False


def reload_hostapd():
    """Reload hostapd to apply configuration changes."""
    try:
        subprocess.run(['systemctl', 'reload', 'hostapd'], check=True)
        logger.info("Reloaded hostapd")
    except Exception as e:
        logger.error(f"Failed to reload hostapd: {e}")


def get_connected_clients():
    """Get list of connected WiFi clients."""
    clients = []
    try:
        result = subprocess.run(
            ['iw', 'dev', 'wlan0', 'station', 'dump'],
            capture_output=True,
            text=True
        )
        current_client = {}
        for line in result.stdout.split('\n'):
            line = line.strip()
            if line.startswith('Station '):
                if current_client:
                    clients.append(current_client)
                mac = line.split()[1]
                current_client = {'mac': mac}
            elif 'signal:' in line:
                current_client['signal'] = line.split(':')[1].strip()

        if current_client:
            clients.append(current_client)

    except Exception as e:
        logger.error(f"Failed to get clients: {e}")

    return clients


def main():
    """Main agent loop."""
    guardian_id = get_guardian_id()
    logger.info(f"Starting Guardian SDN Agent: {guardian_id}")

    config_version = 0
    scan_counter = 0

    while True:
        try:
            # Fetch configuration from Nexus
            config = fetch_config(guardian_id)
            if config:
                new_version = config.get('config_version', 0)
                if new_version > config_version:
                    logger.info(f"Config updated: v{config_version} -> v{new_version}")
                    if update_hostapd_config(config):
                        reload_hostapd()
                    config_version = new_version

            # Periodic WiFi scan (every 5 sync intervals)
            scan_counter += 1
            if scan_counter >= 5:
                networks = scan_wifi_networks()
                if networks:
                    report_scan_results(guardian_id, networks)
                scan_counter = 0

            # Log connected clients
            clients = get_connected_clients()
            if clients:
                logger.debug(f"Connected clients: {len(clients)}")

        except Exception as e:
            logger.exception(f"Agent error: {e}")

        time.sleep(SYNC_INTERVAL)


if __name__ == '__main__':
    main()
