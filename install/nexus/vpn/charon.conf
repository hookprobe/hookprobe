# HookProbe Nexus VPN Gateway - Charon Configuration
# /etc/strongswan.d/charon.conf

charon {
    # Load balance across CPU cores
    threads = 16

    # Keep-alive for NAT
    keep_alive = 20s

    # Retransmit settings for mobile networks
    retransmit_tries = 5
    retransmit_timeout = 4.0
    retransmit_base = 1.8

    # Half-open IKE SA limit (DoS protection)
    half_open_timeout = 30
    cookie_threshold = 10
    block_threshold = 5

    # DNS resolver configuration
    dns1 = 10.200.1.1
    dns2 = 10.200.2.1

    # Logging
    syslog {
        daemon {
            ike = 1
            cfg = 1
            knl = 1
        }
    }

    # File logging for debugging
    filelog {
        hookprobe-vpn {
            path = /var/log/hookprobe/vpn.log
            time_format = %Y-%m-%d %H:%M:%S
            ike_name = yes
            append = yes
            default = 1
            flush_line = yes
        }
    }

    # Plugin configuration
    plugins {
        # Kernel interface
        kernel-netlink {
            fwmark = 100
        }

        # Virtual IP pool
        attr {
            dns = 10.200.1.1,10.200.2.1
            split-include = 10.200.0.0/16,10.100.0.0/16
        }

        # Certificate handling
        x509 {
            # Enforce strict certificate validation
            # crl = yes
            # ocsp = yes
        }

        # EAP plugins
        eap-tls {
            # Fragment size for EAP-TLS
            fragment_size = 1400
        }

        # Unity (Cisco client compatibility) - optional
        # unity {
        #     load = no
        # }

        # Updown script
        updown {
            load = yes
        }
    }

    # Install virtual IPs
    install_virtual_ip = yes
    install_virtual_ip_on = %any

    # Routing table
    routing_table = 220
    routing_table_prio = 220

    # Replay window (anti-replay protection)
    replay_window = 32
}

# Include additional configuration
include /etc/strongswan.d/charon/*.conf
