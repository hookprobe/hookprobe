name: Installation & Configuration Tests

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
    paths:
      - 'install.sh'
      - 'install/**/*.sh'
      - '.github/workflows/installation-test.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'install.sh'
      - 'install/**/*.sh'
      - '.github/workflows/installation-test.yml'

jobs:
  syntax-check:
    name: Shell Script Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate install.sh syntax
        run: bash -n install.sh

      - name: Validate all shell scripts
        run: |
          find install/ -name "*.sh" -type f | while read script; do
            echo "Checking syntax: $script"
            bash -n "$script"
          done

      - name: Check for common issues
        run: |
          echo "Checking for common shell script issues..."

          # Check for missing shebangs
          find install/ -name "*.sh" -type f | while read script; do
            if ! head -n1 "$script" | grep -q "^#!/"; then
              echo "ERROR: Missing shebang in $script"
              exit 1
            fi
          done

          # Check for set -e in critical scripts
          for script in install.sh install/edge/setup.sh install/cloud/setup.sh; do
            if [ -f "$script" ] && ! grep -q "set -e" "$script"; then
              echo "WARNING: Missing 'set -e' in $script"
            fi
          done

  test-config-wizard:
    name: Configuration Wizard Tests
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Test password generation
        run: |
          # Test that openssl is available for password generation
          openssl rand -base64 32 | grep -E '^[A-Za-z0-9+/]{43}=$'

      - name: Validate config wizard structure
        run: |
          # Check that config wizard file exists
          if [ ! -f install/common/config-wizard.sh ]; then
            echo "ERROR: config-wizard.sh not found"
            exit 1
          fi

          # Check syntax
          bash -n install/common/config-wizard.sh

          # Check for required functions (without sourcing the file)
          if ! grep -q "run_configuration_wizard" install/common/config-wizard.sh; then
            echo "WARNING: Missing run_configuration_wizard function"
          fi

          echo "✓ Config wizard validation passed"

  test-edge-deployment:
    name: Edge Deployment Dry Run
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check deployment scripts exist
        run: |
          # Check for key deployment files
          if [ -f install/edge/setup.sh ]; then
            echo "✓ Edge setup script exists"
            bash -n install/edge/setup.sh
          else
            echo "WARNING: install/edge/setup.sh not found"
          fi

          if [ -f install/cloud/setup.sh ]; then
            echo "✓ Cloud setup script exists"
            bash -n install/cloud/setup.sh
          else
            echo "WARNING: install/cloud/setup.sh not found"
          fi

      - name: Validate configuration templates
        run: |
          # Check if config templates exist
          for config in install/edge/config.sh install/cloud/config.sh; do
            if [ -f "$config" ]; then
              echo "✓ $config exists"
              bash -n "$config" || echo "WARNING: Syntax issue in $config"
            else
              echo "INFO: $config not found (will be generated by wizard)"
            fi
          done

          echo "✓ Deployment structure validation passed"

  test-documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check core documentation exists
        run: |
          echo "Checking core documentation files..."

          # Check for README
          if [ -f README.md ]; then
            echo "✓ README.md exists"
            # Check that README mentions the installer
            if grep -q "install.sh" README.md; then
              echo "✓ README mentions install.sh"
            else
              echo "WARNING: README.md doesn't mention install.sh"
            fi
          else
            echo "ERROR: README.md not found"
            exit 1
          fi

          # Check for QUICK-START
          if [ -f QUICK-START.md ]; then
            echo "✓ QUICK-START.md exists"
            if grep -q "install.sh" QUICK-START.md; then
              echo "✓ QUICK-START mentions install.sh"
            fi
          else
            echo "INFO: QUICK-START.md not found"
          fi

          echo "✓ Documentation validation passed"

  security-scan:
    name: Security & Best Practices
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for password generation
        run: |
          echo "Checking for secure password generation..."

          # Check that openssl is used for password generation
          if [ -f install/common/config-wizard.sh ]; then
            if grep -q "openssl rand" install/common/config-wizard.sh; then
              echo "✓ Password generation found"
            else
              echo "WARNING: Password generation not found in config wizard"
            fi
          fi

      - name: Check for unsafe patterns
        run: |
          echo "Checking for unsafe patterns..."

          # Look for obvious hardcoded passwords (very strict pattern)
          if grep -r "password=\"[^$]" install/ --include="*.sh" 2>/dev/null | grep -v "test\|example\|POSTGRES_PASSWORD\|GRAFANA_PASSWORD"; then
            echo "WARNING: Potential hardcoded password found"
          else
            echo "✓ No obvious hardcoded passwords"
          fi

      - name: Verify security defaults
        run: |
          echo "Verifying security defaults..."

          # Check config wizard exists and has good defaults
          if [ -f install/common/config-wizard.sh ]; then
            # Check that GDPR is enabled by default (if variable exists)
            if grep -q "ENABLE_GDPR" install/common/config-wizard.sh; then
              if grep -q 'ENABLE_GDPR=false' install/common/config-wizard.sh; then
                echo "WARNING: GDPR might be disabled by default"
              else
                echo "✓ GDPR defaults look good"
              fi
            fi
          fi

          echo "✓ Security scan passed"

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, test-config-wizard, test-edge-deployment, test-documentation, security-scan]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "   HookProbe Installation Tests"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Syntax Check: ${{ needs.syntax-check.result }}"
          echo "Config Wizard: ${{ needs.test-config-wizard.result }}"
          echo "Edge Deployment: ${{ needs.test-edge-deployment.result }}"
          echo "Documentation: ${{ needs.test-documentation.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo ""
          echo "Summary completed"
