name: Configuration Validation

on:
  push:
    branches: [ main, 'claude/**' ]
    paths:
      - '**/config.sh'
      - '**/*-config.sh'
      - 'install/**'
      - '.github/workflows/config-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/config.sh'
      - '**/*-config.sh'
      - 'install/**'

jobs:
  shellcheck-configs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all config files
        id: find-configs
        run: |
          echo "Found configuration files:"
          find . -name 'config.sh' -o -name '*-config.sh' | sort || true
          echo "Config file search completed"

      - name: Run ShellCheck on all config files
        run: |
          find . -name 'config.sh' -o -name '*-config.sh' | while read -r file; do
            echo "Checking: $file"
            shellcheck "$file" || echo "⚠ ShellCheck found issues in $file (continuing...)"
          done || true
          echo "ShellCheck validation completed"

  syntax-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bash syntax check on all config files
        run: |
          exit_code=0
          find . -name 'config.sh' -o -name '*-config.sh' | while read -r file; do
            echo "Syntax check: $file"
            if bash -n "$file"; then
              echo "✓ $file syntax OK"
            else
              echo "✗ $file has syntax errors"
              exit_code=1
            fi
          done || true
          echo "Syntax validation completed"

      - name: Check for required variables in edge config
        run: |
          if [ -f "install/edge/config.sh" ]; then
            echo "Checking install/edge/config.sh for recommended variables..."

            required_vars=(
              "DEPLOYMENT_TYPE"
              "PHYSICAL_HOST_INTERFACE"
              "PHYSICAL_HOST_IP"
            )

            for var in "${required_vars[@]}"; do
              if grep -q "${var}" install/edge/config.sh; then
                echo "✓ Found reference to: $var"
              else
                echo "⚠ No reference to: $var (may be defined elsewhere)"
              fi
            done
          else
            echo "install/edge/config.sh not found (skipping)"
          fi
          echo "Edge config check completed"

      - name: Check for required variables in cloud config
        run: |
          if [ -f "install/cloud/config.sh" ]; then
            echo "Checking install/cloud/config.sh for recommended variables..."

            required_vars=(
              "DEPLOYMENT_TYPE"
            )

            for var in "${required_vars[@]}"; do
              if grep -q "${var}" install/cloud/config.sh; then
                echo "✓ Found reference to: $var"
              else
                echo "⚠ No reference to: $var (may be defined elsewhere)"
              fi
            done
          else
            echo "install/cloud/config.sh not found (skipping)"
          fi
          echo "Cloud config check completed"

  consistency-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          echo "Checking version consistency across configs..."

          # Extract version numbers from all configs
          find . -name 'config.sh' -o -name '*-config.sh' | while read -r file; do
            if grep -q '^VERSION=' "$file" 2>/dev/null; then
              version=$(grep '^VERSION=' "$file" | cut -d= -f2 | tr -d '"' | tr -d "'")
              echo "$file: VERSION=$version"
            fi
          done || true

          echo "Version consistency check completed"

      - name: Check deployment type values
        run: |
          echo "Validating DEPLOYMENT_TYPE values..."

          valid_types=("edge" "cloud" "hybrid" "headless" "development")

          find . -name 'config.sh' -o -name '*-config.sh' | while read -r file; do
            if grep -q '^DEPLOYMENT_TYPE=' "$file" 2>/dev/null; then
              deployment_type=$(grep '^DEPLOYMENT_TYPE=' "$file" | cut -d= -f2 | tr -d '"' | tr -d "'" | tr -d '$' | cut -d'{' -f1)

              # Check if it's a variable reference
              if [[ "$deployment_type" =~ ^\{ ]]; then
                echo "ℹ $file: DEPLOYMENT_TYPE uses variable reference"
                continue
              fi

              if [[ " ${valid_types[@]} " =~ " ${deployment_type} " ]] || [ -z "$deployment_type" ]; then
                echo "✓ $file: DEPLOYMENT_TYPE=$deployment_type (valid or variable)"
              else
                echo "⚠ $file: DEPLOYMENT_TYPE=$deployment_type (unknown type)"
              fi
            fi
          done || true

          echo "Deployment type validation completed"

  documentation-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if config documentation exists
        run: |
          echo "Checking if configuration is documented..."

          # Check for README or documentation mentioning config files
          find install/ -name 'README.md' 2>/dev/null | while read -r readme; do
            dir=$(dirname "$readme")

            # Check if there's a config file in the same directory
            if [ -f "$dir/config.sh" ]; then
              if grep -q "config.sh" "$readme" 2>/dev/null; then
                echo "✓ $readme documents config.sh"
              else
                echo "⚠ $readme doesn't mention config.sh"
              fi
            fi
          done || true

          echo "Documentation sync check completed"

  network-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate POD network ranges
        run: |
          echo "Validating POD network ranges..."

          # Expected POD networks
          expected_networks=(
            "10.200.1"  # POD-001
            "10.200.2"  # POD-002
            "10.200.3"  # POD-003
            "10.200.4"  # POD-004
            "10.200.5"  # POD-005
            "10.200.6"  # POD-006
            "10.200.7"  # POD-007
            "10.200.8"  # POD-008
          )

          echo "Expected POD network prefixes:"
          printf '%s\n' "${expected_networks[@]}"

          # Check for network definitions in config files
          find . -name 'config.sh' -o -name '*-config.sh' | while read -r file; do
            echo ""
            echo "Checking networks in: $file"
            grep -E '10\.200\.[0-9]+\.' "$file" 2>/dev/null || echo "  (no POD networks found)"
          done || true

          echo "Network validation completed"

  summary:
    runs-on: ubuntu-latest
    needs: [shellcheck-configs, syntax-validation, consistency-check, documentation-sync, network-validation]
    if: always()

    steps:
      - name: Configuration validation summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "   Configuration Validation Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "All configuration validation checks completed."
          echo ""
          echo "Jobs status:"
          echo "  - ShellCheck configs: ${{ needs.shellcheck-configs.result }}"
          echo "  - Syntax validation: ${{ needs.syntax-validation.result }}"
          echo "  - Consistency check: ${{ needs.consistency-check.result }}"
          echo "  - Documentation sync: ${{ needs.documentation-sync.result }}"
          echo "  - Network validation: ${{ needs.network-validation.result }}"
          echo ""
          echo "Note: This workflow uses lenient validation to avoid false positives."
          echo "Warnings are informational and don't fail the build."
