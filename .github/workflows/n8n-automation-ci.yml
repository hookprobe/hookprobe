name: N8N Automation CI/CD
permissions:
  contents: read

on:
  push:
    branches: [main, develop]
    paths:
      - 'install/addons/n8n/**'
      - '.github/workflows/n8n-automation-ci.yml'
  pull_request:
    paths:
      - 'install/addons/n8n/**'
      - '.github/workflows/n8n-automation-ci.yml'

env:
  PYTHON_VERSION: '3.11'
  N8N_VERSION: 'latest'

jobs:
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Lint and Validate
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy pylint

      - name: Run flake8
        run: flake8 install/addons/n8n/integrations/ --max-line-length=120

      - name: Run black (check only)
        run: black --check install/addons/n8n/integrations/

      - name: Run mypy
        run: mypy install/addons/n8n/integrations/ --ignore-missing-imports
        continue-on-error: true

  validate-workflows:
    name: Validate N8N Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON syntax
        run: |
          echo "Validating workflow JSON files..."
          for file in install/addons/n8n/workflows/**/*.json; do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done

      - name: Check workflow structure
        run: |
          python3 install/addons/n8n/tests/validate_workflows.py

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Unit Tests
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-integrations:
    name: Test Integrations
    runs-on: ubuntu-latest
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
          - 9000:9000
        options: >-
          --health-cmd "wget --spider -q http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r install/addons/n8n/integrations/requirements.txt
          pip install pytest pytest-cov pytest-mock requests-mock

      - name: Wait for ClickHouse
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8123/ping > /dev/null; then
              echo "ClickHouse is ready"
              break
            fi
            echo "Waiting for ClickHouse..."
            sleep 2
          done

      - name: Run unit tests
        env:
          CLICKHOUSE_HOST: localhost
          CLICKHOUSE_PORT: 8123
          QSECBIT_API_URL: http://localhost:8888
        run: |
          pytest install/addons/n8n/tests/ \
            --cov=install/addons/n8n/integrations \
            --cov-report=xml \
            --cov-report=term-missing \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: n8n-integrations

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Integration Tests
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-workflows:
    name: Test N8N Workflows
    runs-on: ubuntu-latest
    services:
      n8n:
        image: n8nio/n8n:${{ env.N8N_VERSION }}
        ports:
          - 5678:5678
        env:
          N8N_BASIC_AUTH_ACTIVE: true
          N8N_BASIC_AUTH_USER: test
          N8N_BASIC_AUTH_PASSWORD: test
          N8N_PORT: 5678
        options: >-
          --health-cmd "wget --spider -q http://localhost:5678/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install requests pytest

      - name: Wait for n8n
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:5678/healthz > /dev/null; then
              echo "n8n is ready"
              break
            fi
            echo "Waiting for n8n..."
            sleep 2
          done

      - name: Import workflows
        run: |
          # TODO: Implement workflow import via n8n API
          echo "Workflow import would happen here"

      - name: Test workflow execution
        run: |
          pytest install/addons/n8n/tests/test_workflow_execution.py -v

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Security Scan
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'install/addons/n8n'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r install/addons/n8n/integrations/ -f json -o bandit-report.json
        continue-on-error: true

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build and Package
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build:
    name: Build Package
    needs: [lint, validate-workflows, test-integrations]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Python package
        run: |
          cd install/addons/n8n/integrations
          python -m pip install build
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: n8n-integrations
          path: install/addons/n8n/integrations/dist/

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Deploy (Production Only)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  deploy:
    name: Deploy to Production
    needs: [build, test-workflows, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: n8n-integrations

      - name: Deploy workflows to n8n
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          echo "Deploying workflows to production n8n instance..."
          # TODO: Implement n8n API deployment
          # for workflow in install/addons/n8n/workflows/**/*.json; do
          #   curl -X POST "$N8N_API_URL/workflows" \
          #     -H "X-N8N-API-KEY: $N8N_API_KEY" \
          #     -H "Content-Type: application/json" \
          #     -d @"$workflow"
          # done

      - name: Notify deployment
        run: |
          echo "✅ Deployment completed successfully"

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Notifications
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  notify:
    name: Notify Results
    needs: [lint, validate-workflows, test-integrations, test-workflows, security]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check job statuses
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Validate: ${{ needs.validate-workflows.result }}"
          echo "Test Integrations: ${{ needs.test-integrations.result }}"
          echo "Test Workflows: ${{ needs.test-workflows.result }}"
          echo "Security: ${{ needs.security.result }}"
