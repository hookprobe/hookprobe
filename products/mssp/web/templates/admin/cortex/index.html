{% extends "admin/base.html" %}
{% load static %}

{% block title %}HookProbe Cortex - Neural Command Center{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap');

    .cortex-wrapper {
        background: linear-gradient(135deg, #0a0a0f 0%, #05050a 100%);
        min-height: calc(100vh - 57px);
        padding: 0;
        margin: -15px;
    }

    .cortex-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        background: rgba(0, 20, 40, 0.9);
        border-bottom: 1px solid rgba(0, 229, 255, 0.2);
    }

    .cortex-logo {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .cortex-logo-icon {
        font-size: 2rem;
        color: #00e5ff;
        animation: pulse 2s ease-in-out infinite;
    }

    .cortex-logo-text h1 {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffffff;
        letter-spacing: 3px;
        margin: 0;
    }

    .cortex-logo-text .subtitle {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        color: #00e5ff;
        letter-spacing: 4px;
        margin: 0;
    }

    .cortex-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .cortex-mode-toggle {
        display: flex;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        overflow: hidden;
    }

    .cortex-mode-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .cortex-mode-btn.active {
        background: rgba(0, 229, 255, 0.2);
        color: #00e5ff;
    }

    .cortex-mode-btn:hover {
        background: rgba(0, 229, 255, 0.1);
        color: #ffffff;
    }

    .cortex-stats-bar {
        display: flex;
        align-items: center;
        gap: 2rem;
        padding: 0.75rem 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(0, 229, 255, 0.1);
    }

    .cortex-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .cortex-stat-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: #00e5ff;
    }

    .cortex-stat-label {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .cortex-stat.tier-sentinel .cortex-stat-value { color: #888888; }
    .cortex-stat.tier-guardian .cortex-stat-value { color: #00aaff; }
    .cortex-stat.tier-fortress .cortex-stat-value { color: #00ff88; }
    .cortex-stat.tier-nexus .cortex-stat-value { color: #ffaa00; }

    .cortex-stat-divider {
        width: 1px;
        height: 40px;
        background: rgba(0, 229, 255, 0.2);
    }

    .cortex-content {
        display: flex;
        height: calc(100vh - 200px);
    }

    .cortex-globe-container {
        flex: 1;
        position: relative;
        background: radial-gradient(ellipse at center, #0a1628 0%, #050508 100%);
    }

    #globe-container {
        width: 100%;
        height: 100%;
    }

    .cortex-sidebar {
        width: 300px;
        background: rgba(0, 10, 20, 0.95);
        border-left: 1px solid rgba(0, 229, 255, 0.2);
        display: flex;
        flex-direction: column;
    }

    .cortex-event-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(0, 229, 255, 0.1);
    }

    .cortex-event-header h3 {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.9rem;
        color: #00e5ff;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin: 0;
    }

    .cortex-event-list {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .cortex-event-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .cortex-event-item.attack { border-left: 3px solid #ff4444; }
    .cortex-event-item.repelled { border-left: 3px solid #00aaff; }
    .cortex-event-item.status { border-left: 3px solid #00ff88; }

    .cortex-event-time {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.4);
    }

    .cortex-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .cortex-loading-spinner {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(0, 229, 255, 0.2);
        border-top-color: #00e5ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .cortex-loading-text {
        font-family: 'Rajdhani', sans-serif;
        font-size: 1rem;
        color: #00e5ff;
        letter-spacing: 2px;
    }

    .connection-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 4px;
    }

    .connection-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: breathe 2s ease-in-out infinite;
    }

    .connection-dot.offline {
        background: #ff4444;
        animation: none;
    }

    .connection-text {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.8);
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.8; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.1); }
    }

    @keyframes breathe {
        0%, 100% { opacity: 0.6; box-shadow: 0 0 5px currentColor; }
        50% { opacity: 1; box-shadow: 0 0 15px currentColor; }
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="cortex-wrapper">
    <!-- Header -->
    <div class="cortex-header">
        <div class="cortex-logo">
            <span class="cortex-logo-icon">&#x2B21;</span>
            <div class="cortex-logo-text">
                <h1>HOOKPROBE CORTEX</h1>
                <p class="subtitle">NEURAL COMMAND CENTER</p>
            </div>
        </div>

        <div class="cortex-controls">
            <div class="cortex-mode-toggle">
                <button id="demo-mode-btn" class="cortex-mode-btn {% if demo_mode %}active{% endif %}" onclick="setMode('demo')">
                    DEMO
                </button>
                <button id="live-mode-btn" class="cortex-mode-btn {% if not demo_mode %}active{% endif %}" onclick="setMode('live')">
                    LIVE
                </button>
            </div>

            <div class="connection-indicator">
                <span class="connection-dot" id="connection-dot"></span>
                <span class="connection-text" id="connection-text">Connecting...</span>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="cortex-stats-bar">
        <div class="cortex-stat">
            <span class="cortex-stat-value" id="stat-nodes">{{ mesh_stats.total_nodes }}</span>
            <span class="cortex-stat-label">Nodes</span>
        </div>
        <div class="cortex-stat">
            <span class="cortex-stat-value" id="stat-online">{{ mesh_stats.nodes_online }}</span>
            <span class="cortex-stat-label">Online</span>
        </div>
        <div class="cortex-stat">
            <span class="cortex-stat-value" id="stat-threats">{{ mesh_stats.threats_24h }}</span>
            <span class="cortex-stat-label">Threats (24h)</span>
        </div>
        <div class="cortex-stat">
            <span class="cortex-stat-value" id="stat-blocked">{{ mesh_stats.threats_blocked_24h }}</span>
            <span class="cortex-stat-label">Blocked</span>
        </div>

        <div class="cortex-stat-divider"></div>

        <div class="cortex-stat tier-sentinel">
            <span class="cortex-stat-value" id="stat-sentinels">{{ mesh_stats.by_tier.sentinel }}</span>
            <span class="cortex-stat-label">Sentinels</span>
        </div>
        <div class="cortex-stat tier-guardian">
            <span class="cortex-stat-value" id="stat-guardians">{{ mesh_stats.by_tier.guardian }}</span>
            <span class="cortex-stat-label">Guardians</span>
        </div>
        <div class="cortex-stat tier-fortress">
            <span class="cortex-stat-value" id="stat-fortresses">{{ mesh_stats.by_tier.fortress }}</span>
            <span class="cortex-stat-label">Fortresses</span>
        </div>
        <div class="cortex-stat tier-nexus">
            <span class="cortex-stat-value" id="stat-nexuses">{{ mesh_stats.by_tier.nexus }}</span>
            <span class="cortex-stat-label">Nexuses</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="cortex-content">
        <!-- Globe Container -->
        <div class="cortex-globe-container">
            <div id="globe-container"></div>
            <div class="cortex-loading" id="loading">
                <div class="cortex-loading-spinner"></div>
                <div class="cortex-loading-text">INITIALIZING CORTEX</div>
            </div>
        </div>

        <!-- Event Sidebar -->
        <div class="cortex-sidebar">
            <div class="cortex-event-header">
                <h3>Live Events</h3>
                <button class="cortex-mode-btn" onclick="clearEvents()">Clear</button>
            </div>
            <ul class="cortex-event-list" id="event-list">
                <li class="cortex-event-item">Waiting for events...</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Globe.gl Library -->
<script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>

<script>
    // Cortex Configuration
    const CORTEX_WS_URL = '{{ cortex_ws_url }}';
    const CORTEX_API_URL = '{{ cortex_api_url }}';

    let ws = null;
    let globe = null;
    let nodes = [];
    let arcs = [];
    let events = [];

    // Initialize Globe
    function initGlobe() {
        const container = document.getElementById('globe-container');

        globe = Globe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#00e5ff')
            .atmosphereAltitude(0.15)
            .pointsData([])
            .pointColor(d => d.status === 'green' ? '#00ff88' :
                         d.status === 'amber' ? '#ffaa00' : '#ff4444')
            .pointAltitude(0.01)
            .pointRadius(d => {
                switch(d.tier) {
                    case 'nexus': return 0.8;
                    case 'fortress': return 0.6;
                    case 'guardian': return 0.4;
                    default: return 0.2;
                }
            })
            .pointLabel(d => `<b>${d.label}</b><br/>Tier: ${d.tier}<br/>Qsecbit: ${d.qsecbit.toFixed(3)}`)
            .arcsData([])
            .arcColor(d => d.type === 'attack' ? '#ff4444' : '#00aaff')
            .arcDashLength(0.4)
            .arcDashGap(0.2)
            .arcDashAnimateTime(1500)
            .arcStroke(0.5)
            (container);

        // Auto-rotate
        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.5;

        // Hide loading
        document.getElementById('loading').style.display = 'none';
    }

    // Connect to WebSocket
    function connectWebSocket() {
        ws = new WebSocket(CORTEX_WS_URL);

        ws.onopen = function() {
            console.log('Connected to Cortex');
            updateConnectionStatus(true);
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleEvent(data);
        };

        ws.onclose = function() {
            console.log('Disconnected from Cortex');
            updateConnectionStatus(false);
            // Reconnect after 3 seconds
            setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateConnectionStatus(false);
        };
    }

    // Handle incoming events
    function handleEvent(data) {
        switch(data.type) {
            case 'connected':
                console.log('Cortex connected:', data.message);
                break;

            case 'node_status':
                updateNodes(data.nodes);
                break;

            case 'attack_detected':
            case 'attack_repelled':
                addAttackArc(data);
                addEventToLog(data);
                break;

            case 'qsecbit_update':
                updateNodeQsecbit(data.node_id, data.score);
                break;

            case 'snapshot':
                if (data.nodes) {
                    updateNodes(data.nodes);
                }
                break;
        }
    }

    // Update nodes on globe
    function updateNodes(newNodes) {
        nodes = newNodes;
        globe.pointsData(nodes);
        updateStats();
    }

    // Add attack arc
    function addAttackArc(event) {
        const arc = {
            startLat: event.source.lat,
            startLng: event.source.lng,
            endLat: event.target.lat,
            endLng: event.target.lng,
            type: event.type === 'attack_repelled' ? 'repelled' : 'attack',
        };

        arcs.push(arc);
        globe.arcsData(arcs);

        // Remove arc after 5 seconds
        setTimeout(() => {
            arcs = arcs.filter(a => a !== arc);
            globe.arcsData(arcs);
        }, 5000);
    }

    // Add event to log
    function addEventToLog(event) {
        const list = document.getElementById('event-list');
        const item = document.createElement('li');
        item.className = `cortex-event-item ${event.type === 'attack_repelled' ? 'repelled' : 'attack'}`;

        const time = new Date().toLocaleTimeString();
        item.innerHTML = `
            <div>${event.type === 'attack_repelled' ? 'Repelled' : 'Attack'}: ${event.attack_type || 'unknown'}</div>
            <div>Target: ${event.target.label}</div>
            <div class="cortex-event-time">${time}</div>
        `;

        // Remove placeholder
        const placeholder = list.querySelector('.cortex-event-item:first-child');
        if (placeholder && placeholder.textContent.includes('Waiting')) {
            placeholder.remove();
        }

        list.insertBefore(item, list.firstChild);

        // Keep only last 50 events
        while (list.children.length > 50) {
            list.removeChild(list.lastChild);
        }

        events.push(event);
    }

    // Update node Qsecbit
    function updateNodeQsecbit(nodeId, score) {
        const node = nodes.find(n => n.id === nodeId);
        if (node) {
            node.qsecbit = score;
            if (score < 0.45) node.status = 'green';
            else if (score < 0.70) node.status = 'amber';
            else node.status = 'red';

            globe.pointsData(nodes);
        }
    }

    // Update stats display
    function updateStats() {
        document.getElementById('stat-nodes').textContent = nodes.length;

        const online = nodes.filter(n => n.online !== false).length;
        document.getElementById('stat-online').textContent = online;

        const byTier = { sentinel: 0, guardian: 0, fortress: 0, nexus: 0 };
        nodes.forEach(n => {
            if (byTier[n.tier] !== undefined) byTier[n.tier]++;
        });

        document.getElementById('stat-sentinels').textContent = byTier.sentinel;
        document.getElementById('stat-guardians').textContent = byTier.guardian;
        document.getElementById('stat-fortresses').textContent = byTier.fortress;
        document.getElementById('stat-nexuses').textContent = byTier.nexus;
    }

    // Update connection status
    function updateConnectionStatus(connected) {
        const dot = document.getElementById('connection-dot');
        const text = document.getElementById('connection-text');

        if (connected) {
            dot.classList.remove('offline');
            text.textContent = 'Connected';
        } else {
            dot.classList.add('offline');
            text.textContent = 'Disconnected';
        }
    }

    // Set demo/live mode
    function setMode(mode) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'set_mode', mode: mode }));
        }

        document.getElementById('demo-mode-btn').classList.toggle('active', mode === 'demo');
        document.getElementById('live-mode-btn').classList.toggle('active', mode === 'live');
    }

    // Clear events
    function clearEvents() {
        const list = document.getElementById('event-list');
        list.innerHTML = '<li class="cortex-event-item">Waiting for events...</li>';
        events = [];
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initGlobe();
        connectWebSocket();
    });
</script>
{% endblock %}
