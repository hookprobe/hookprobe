{% extends "admin_dashboard/base.html" %}
{% load static %}

{% block title %}Adversarial Security Dashboard - HookProbe MSSP{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-shield-alt text-danger"></i>
                    Adversarial Security Dashboard
                </h1>
                <small class="text-muted">
                    "One node's detection → Everyone's protection"
                </small>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_dashboard:home' %}">Admin</a></li>
                    <li class="breadcrumb-item active">Adversarial Security</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Risk Score Card -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box {% if risk_score >= 70 %}bg-danger{% elif risk_score >= 40 %}bg-warning{% else %}bg-success{% endif %}">
                    <div class="inner">
                        <h3>{{ risk_score }}</h3>
                        <p>Risk Score</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <a href="{% url 'adversarial:risk_report' %}" class="small-box-footer">
                        View Report <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ critical_vulns }}</h3>
                        <p>Critical Vulnerabilities</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-bug"></i>
                    </div>
                    <a href="{% url 'adversarial:vulnerabilities_list' %}?severity=critical" class="small-box-footer">
                        View All <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ pending_mitigations }}</h3>
                        <p>Pending Mitigations</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <a href="{% url 'adversarial:mitigations_list' %}?status=pending" class="small-box-footer">
                        View All <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box {% if unack_alerts > 0 %}bg-info{% else %}bg-secondary{% endif %}">
                    <div class="inner">
                        <h3>{{ unack_alerts }}</h3>
                        <p>Unacknowledged Alerts</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <a href="{% url 'adversarial:alerts_list' %}?acknowledged=unack" class="small-box-footer">
                        View All <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- HTP-DSM-NEURO-QSECBIT-NSE Stack Status -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-layer-group"></i>
                            HTP-DSM-NEURO-QSECBIT-NSE Security Stack
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 text-center">
                                <div class="info-box bg-gradient-primary">
                                    <span class="info-box-icon"><i class="fas fa-exchange-alt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">HTP</span>
                                        <span class="info-box-number">Transport</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="info-box bg-gradient-success">
                                    <span class="info-box-icon"><i class="fas fa-network-wired"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">DSM</span>
                                        <span class="info-box-number">Consensus</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="info-box bg-gradient-info">
                                    <span class="info-box-icon"><i class="fas fa-brain"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">NEURO</span>
                                        <span class="info-box-number">Resonance</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="info-box bg-gradient-warning">
                                    <span class="info-box-icon"><i class="fas fa-chart-line"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">QSECBIT</span>
                                        <span class="info-box-number">Scoring</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="info-box bg-gradient-danger">
                                    <span class="info-box-icon"><i class="fas fa-lock"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">NSE</span>
                                        <span class="info-box-number">Encryption</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <a href="{% url 'adversarial:schedule_test' %}" class="btn btn-lg btn-outline-primary">
                                    <i class="fas fa-play-circle"></i><br>
                                    Run Test
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Top Vulnerabilities -->
            <div class="col-md-6">
                <div class="card card-danger card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bug"></i>
                            Top Vulnerabilities (Active)
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'adversarial:vulnerabilities_list' %}?status=active" class="btn btn-tool">
                                View All
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Vulnerability</th>
                                    <th>CVSS</th>
                                    <th>Attack Vector</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vuln in top_vulns %}
                                <tr>
                                    <td>
                                        <a href="{% url 'adversarial:vulnerability_detail' vuln.id %}">
                                            {{ vuln.title|truncatechars:40 }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge {% if vuln.cvss_score >= 9 %}badge-danger{% elif vuln.cvss_score >= 7 %}badge-warning{% else %}badge-secondary{% endif %}">
                                            {{ vuln.cvss_score|floatformat:1 }}
                                        </span>
                                    </td>
                                    <td>{{ vuln.get_attack_vector_display }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-success">
                                        <i class="fas fa-check-circle"></i> No active vulnerabilities
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Tests -->
            <div class="col-md-6">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-vial"></i>
                            Recent Tests
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'adversarial:tests_list' %}" class="btn btn-tool">
                                View All
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Status</th>
                                    <th>Vulns Found</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in recent_test_list %}
                                <tr>
                                    <td>
                                        <a href="{% url 'adversarial:test_detail' test.id %}">
                                            {{ test.name|truncatechars:30 }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge {% if test.status == 'completed' %}badge-success{% elif test.status == 'running' %}badge-primary{% elif test.status == 'failed' %}badge-danger{% else %}badge-secondary{% endif %}">
                                            {{ test.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ test.vulnerabilities_found }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">
                                        No tests run yet
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Designer Alerts -->
        {% if alerts %}
        <div class="row">
            <div class="col-12">
                <div class="card card-warning card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bell"></i>
                            Designer Alerts (Require Acknowledgement)
                        </h3>
                    </div>
                    <div class="card-body">
                        {% for alert in alerts %}
                        <div class="alert {% if alert.level == 'critical' %}alert-danger{% elif alert.level == 'high' %}alert-warning{% else %}alert-info{% endif %} alert-dismissible">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                            <h5>
                                <i class="icon fas fa-exclamation-triangle"></i>
                                {{ alert.title }}
                            </h5>
                            {{ alert.message|truncatechars:200 }}
                            <br>
                            <small class="text-muted">{{ alert.created_at|timesince }} ago</small>
                            <a href="{% url 'adversarial:alert_acknowledge' alert.id %}" class="btn btn-sm btn-outline-dark float-right">
                                Acknowledge
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</section>
{% endblock %}
