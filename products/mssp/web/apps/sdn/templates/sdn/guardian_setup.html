{% extends 'sdn/base.html' %}

{% block sdn_title %}Guardian Setup{% endblock %}
{% block sdn_breadcrumb %}
<li class="breadcrumb-item active">Guardian Setup</li>
{% endblock %}

{% block sdn_content %}
{% if not config %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-exclamation-triangle text-warning mr-2"></i>
            No Guardian Selected
        </h3>
    </div>
    <div class="card-body">
        <p class="text-muted">Select a Guardian device to configure its network settings.</p>
        <a href="{% url 'sdn:dashboard' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
    </div>
</div>
{% else %}

<div class="row">
    <!-- Upstream Connection -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-wifi mr-2"></i>
                    Upstream WiFi Connection
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Connect Guardian to your existing WiFi network for internet access.
                </p>

                {% if config.upstream_connected %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle mr-2"></i>
                    Connected to: <strong>{{ config.upstream_ssid }}</strong>
                </div>
                {% endif %}

                <!-- Scan Button -->
                <form method="post" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="scan">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-1"></i> Scan for Networks
                    </button>
                </form>

                {% if scans %}
                <!-- Connection Form -->
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="connect">

                    <div class="form-group">
                        <label for="upstream_ssid">Select Network</label>
                        <select class="form-control" id="upstream_ssid" name="upstream_ssid" required>
                            <option value="">-- Select WiFi Network --</option>
                            {% for scan in scans %}
                            <option value="{{ scan.ssid }}"
                                {% if scan.ssid == config.upstream_ssid %}selected{% endif %}>
                                {{ scan.ssid }} ({{ scan.signal_strength }} dBm) - {{ scan.security }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="upstream_password">Password</label>
                        <input type="password" class="form-control" id="upstream_password" name="upstream_password"
                            value="{{ config.upstream_password }}" placeholder="WiFi Password">
                    </div>

                    <div class="form-group">
                        <label for="upstream_security">Security Type</label>
                        <select class="form-control" id="upstream_security" name="upstream_security">
                            <option value="wpa2" {% if config.upstream_security == 'wpa2' %}selected{% endif %}>WPA2-PSK</option>
                            <option value="wpa3" {% if config.upstream_security == 'wpa3' %}selected{% endif %}>WPA3-SAE</option>
                            <option value="open" {% if config.upstream_security == 'open' %}selected{% endif %}>Open</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plug mr-1"></i> Connect
                    </button>
                </form>
                {% else %}
                <p class="text-muted">Click "Scan for Networks" to find available WiFi networks.</p>
                {% endif %}
            </div>
        </div>

        <!-- Available Networks Table -->
        {% if scans %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-broadcast-tower mr-2"></i>
                    Available Networks
                </h3>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>SSID</th>
                                <th>Signal</th>
                                <th>Channel</th>
                                <th>Security</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for scan in scans %}
                            <tr>
                                <td><strong>{{ scan.ssid }}</strong></td>
                                <td>
                                    <div class="progress progress-sm" style="min-width: 60px;">
                                        <div class="progress-bar bg-success" style="width: {{ scan.signal_strength|add:100 }}%;"></div>
                                    </div>
                                    <small class="text-muted">{{ scan.signal_strength }} dBm</small>
                                </td>
                                <td><span class="badge badge-secondary">{{ scan.channel }}</span></td>
                                <td><span class="badge badge-info">{{ scan.security }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Hotspot Configuration -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-broadcast-tower mr-2"></i>
                    Hotspot Configuration
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Configure the Guardian's WiFi hotspot for your IoT devices.
                </p>

                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="hotspot">

                    <div class="form-group">
                        <label for="hotspot_ssid">Hotspot SSID</label>
                        <input type="text" class="form-control" id="hotspot_ssid" name="hotspot_ssid"
                            value="{{ config.hotspot_ssid }}" placeholder="HookProbe-Guardian" required>
                    </div>

                    <div class="form-group">
                        <label for="hotspot_password">Password</label>
                        <input type="password" class="form-control" id="hotspot_password" name="hotspot_password"
                            value="{{ config.hotspot_password }}" placeholder="Minimum 8 characters" required minlength="8">
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hotspot_channel">Channel</label>
                                <select class="form-control" id="hotspot_channel" name="hotspot_channel">
                                    <option value="1" {% if config.hotspot_channel == 1 %}selected{% endif %}>1</option>
                                    <option value="6" {% if config.hotspot_channel == 6 %}selected{% endif %}>6</option>
                                    <option value="11" {% if config.hotspot_channel == 11 %}selected{% endif %}>11</option>
                                    <option value="36" {% if config.hotspot_channel == 36 %}selected{% endif %}>36 (5GHz)</option>
                                    <option value="44" {% if config.hotspot_channel == 44 %}selected{% endif %}>44 (5GHz)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hotspot_band">Band</label>
                                <select class="form-control" id="hotspot_band" name="hotspot_band">
                                    <option value="2.4GHz" {% if config.hotspot_band == '2.4GHz' %}selected{% endif %}>2.4 GHz</option>
                                    <option value="5GHz" {% if config.hotspot_band == '5GHz' %}selected{% endif %}>5 GHz</option>
                                    <option value="dual" {% if config.hotspot_band == 'dual' %}selected{% endif %}>Dual Band</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-3 mb-3">
                        <i class="fas fa-cog mr-1"></i>
                        Bridge Settings
                    </h5>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="bridge_lan" name="bridge_lan" {% if config.bridge_lan %}checked{% endif %}>
                            <label class="custom-control-label" for="bridge_lan">Bridge LAN port (provides wired WAN access)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="bridge_upstream" name="bridge_upstream" {% if config.bridge_upstream %}checked{% endif %}>
                            <label class="custom-control-label" for="bridge_upstream">Bridge to upstream WiFi (share internet)</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save mr-1"></i> Save Hotspot Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- VLAN Configuration -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-layer-group mr-2"></i>
            VLAN Settings
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 text-center">
                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-cogs"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Management VLAN</span>
                        <span class="info-box-number">{{ config.management_vlan }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="info-box bg-warning">
                    <span class="info-box-icon"><i class="fas fa-shield-alt"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Quarantine VLAN</span>
                        <span class="info-box-number">{{ config.quarantine_vlan }}</span>
                        <small>Unknown Devices</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="info-box bg-secondary">
                    <span class="info-box-icon"><i class="fas fa-server"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">RADIUS Server</span>
                        <span class="info-box-number" style="font-size: 0.85rem;">{{ config.radius_server }}:{{ config.radius_port }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
