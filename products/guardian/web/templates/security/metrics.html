<!-- Security Tab - Simplified Unified -->
<style>
    .security-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .security-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
    }

    .security-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .security-datetime {
        text-align: right;
        padding: 8px 15px;
        background: var(--bg-secondary, rgba(255,255,255,0.05));
        border-radius: 8px;
    }

    .security-datetime .date {
        font-size: 0.85rem;
        color: var(--text-primary, #fff);
    }

    .security-datetime .time {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--accent-color, #F05B2D);
    }

    /* Main Score Display */
    .score-hero {
        background: var(--bg-secondary, rgba(255,255,255,0.03));
        border-radius: 16px;
        padding: 30px 20px;
        text-align: center;
        margin-bottom: 25px;
    }

    .score-circle {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 20px;
    }

    .score-circle svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .score-circle .bg {
        fill: none;
        stroke: var(--bg-tertiary, #2d3748);
        stroke-width: 12;
    }

    .score-circle .progress {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
        stroke-dasharray: 440;
        stroke-dashoffset: 440;
        transition: stroke-dashoffset 0.8s ease, stroke 0.5s ease;
    }

    .score-circle .progress.green { stroke: #10b981; }
    .score-circle .progress.amber { stroke: #f59e0b; }
    .score-circle .progress.red { stroke: #ef4444; }

    .score-circle .value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.5rem;
        font-weight: 700;
    }

    .score-circle .value.green { color: #10b981; }
    .score-circle .value.amber { color: #f59e0b; }
    .score-circle .value.red { color: #ef4444; }

    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .status-pill.green {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-pill.amber {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .status-pill.red {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
        0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
        50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
    }

    /* Quick Stats Row */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 25px;
    }

    .quick-stat {
        background: var(--bg-secondary, rgba(255,255,255,0.03));
        border-radius: 10px;
        padding: 15px 10px;
        text-align: center;
    }

    .quick-stat .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary, #fff);
    }

    .quick-stat .label {
        font-size: 0.7rem;
        color: var(--text-muted, #64748b);
        text-transform: uppercase;
        margin-top: 4px;
    }

    .quick-stat.danger .value { color: #ef4444; }
    .quick-stat.success .value { color: #10b981; }
    .quick-stat.info .value { color: #3b82f6; }

    /* Layer Bars */
    .layers-section {
        background: var(--bg-secondary, rgba(255,255,255,0.03));
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .layers-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-secondary, #94a3b8);
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .layer-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .layer-row:last-child {
        margin-bottom: 0;
    }

    .layer-label {
        width: 60px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary, #94a3b8);
    }

    .layer-bar-bg {
        flex: 1;
        height: 10px;
        background: var(--bg-tertiary, #1e293b);
        border-radius: 5px;
        overflow: hidden;
        margin: 0 12px;
    }

    .layer-bar {
        height: 100%;
        border-radius: 5px;
        transition: width 0.5s ease;
    }

    .layer-bar.green { background: #10b981; }
    .layer-bar.amber { background: #f59e0b; }
    .layer-bar.red { background: #ef4444; }

    .layer-value {
        width: 50px;
        font-size: 0.8rem;
        text-align: right;
        font-weight: 600;
        color: var(--text-primary, #fff);
    }

    .layer-threats {
        width: 70px;
        font-size: 0.7rem;
        text-align: right;
        color: var(--text-muted, #64748b);
    }

    /* XDP Stats */
    .xdp-section {
        background: var(--bg-secondary, rgba(255,255,255,0.03));
        border-radius: 12px;
        padding: 20px;
    }

    .xdp-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .xdp-item {
        text-align: center;
        padding: 12px;
        background: var(--bg-tertiary, rgba(255,255,255,0.02));
        border-radius: 8px;
    }

    .xdp-item .value {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .xdp-item .label {
        font-size: 0.7rem;
        color: var(--text-muted, #64748b);
        text-transform: uppercase;
        margin-top: 4px;
    }

    /* Responsive */
    @media (max-width: 600px) {
        .quick-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .score-circle {
            width: 150px;
            height: 150px;
        }

        .score-circle .value {
            font-size: 2rem;
        }

        .layer-threats {
            display: none;
        }
    }
</style>

<div class="security-container">
    <!-- Header with DateTime -->
    <div class="security-header">
        <div>
            <h2>Security</h2>
            <p class="text-muted" style="margin: 0; font-size: 0.85rem;">Qsecbit Protection</p>
        </div>
        <div class="security-datetime">
            <div class="date" id="sec-date"></div>
            <div class="time" id="sec-time"></div>
        </div>
    </div>

    <!-- Main Score Display -->
    <div class="score-hero">
        <div class="score-circle">
            <svg viewBox="0 0 160 160">
                <circle class="bg" cx="80" cy="80" r="70"/>
                <circle class="progress green" id="sec-progress" cx="80" cy="80" r="70"/>
            </svg>
            <div class="value green" id="sec-score">0.00</div>
        </div>
        <div class="status-pill green" id="sec-status">
            <span class="status-dot"></span>
            <span id="sec-status-text">PROTECTED</span>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat danger">
            <div class="value" id="sec-threats">0</div>
            <div class="label">Threats</div>
        </div>
        <div class="quick-stat success">
            <div class="value" id="sec-blocked">0</div>
            <div class="label">Blocked</div>
        </div>
        <div class="quick-stat info">
            <div class="value" id="sec-xdp">0</div>
            <div class="label">XDP Drops</div>
        </div>
        <div class="quick-stat">
            <div class="value" id="sec-chains">0</div>
            <div class="label">Chains</div>
        </div>
    </div>

    <!-- Layer Breakdown -->
    <div class="layers-section">
        <div class="layers-title">OSI Layer Detection</div>

        <div class="layer-row" data-layer="L2">
            <span class="layer-label">L2</span>
            <div class="layer-bar-bg">
                <div class="layer-bar green" style="width: 0%"></div>
            </div>
            <span class="layer-value">0.00</span>
            <span class="layer-threats">0 threats</span>
        </div>

        <div class="layer-row" data-layer="L3">
            <span class="layer-label">L3</span>
            <div class="layer-bar-bg">
                <div class="layer-bar green" style="width: 0%"></div>
            </div>
            <span class="layer-value">0.00</span>
            <span class="layer-threats">0 threats</span>
        </div>

        <div class="layer-row" data-layer="L4">
            <span class="layer-label">L4</span>
            <div class="layer-bar-bg">
                <div class="layer-bar green" style="width: 0%"></div>
            </div>
            <span class="layer-value">0.00</span>
            <span class="layer-threats">0 threats</span>
        </div>

        <div class="layer-row" data-layer="L5">
            <span class="layer-label">L5</span>
            <div class="layer-bar-bg">
                <div class="layer-bar green" style="width: 0%"></div>
            </div>
            <span class="layer-value">0.00</span>
            <span class="layer-threats">0 threats</span>
        </div>

        <div class="layer-row" data-layer="L7">
            <span class="layer-label">L7</span>
            <div class="layer-bar-bg">
                <div class="layer-bar green" style="width: 0%"></div>
            </div>
            <span class="layer-value">0.00</span>
            <span class="layer-threats">0 threats</span>
        </div>
    </div>

    <!-- XDP Protection -->
    <div class="xdp-section">
        <div class="layers-title">XDP/eBPF Protection</div>
        <div class="xdp-grid">
            <div class="xdp-item">
                <div class="value" id="sec-xdp-mode" style="color: #10b981;">--</div>
                <div class="label">Mode</div>
            </div>
            <div class="xdp-item">
                <div class="value" id="sec-xdp-iface">eth0</div>
                <div class="label">Interface</div>
            </div>
            <div class="xdp-item">
                <div class="value" id="sec-xdp-pkts">0</div>
                <div class="label">Packets</div>
            </div>
            <div class="xdp-item">
                <div class="value" id="sec-xdp-rate" style="color: #ef4444;">0%</div>
                <div class="label">Drop Rate</div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const POLL_INTERVAL = 5000;
    const CIRCUMFERENCE = 440; // 2 * PI * 70

    // Elements
    const els = {
        score: document.getElementById('sec-score'),
        progress: document.getElementById('sec-progress'),
        status: document.getElementById('sec-status'),
        statusText: document.getElementById('sec-status-text'),
        threats: document.getElementById('sec-threats'),
        blocked: document.getElementById('sec-blocked'),
        xdp: document.getElementById('sec-xdp'),
        chains: document.getElementById('sec-chains'),
        date: document.getElementById('sec-date'),
        time: document.getElementById('sec-time'),
        xdpMode: document.getElementById('sec-xdp-mode'),
        xdpIface: document.getElementById('sec-xdp-iface'),
        xdpPkts: document.getElementById('sec-xdp-pkts'),
        xdpRate: document.getElementById('sec-xdp-rate'),
    };

    function getStatusClass(score) {
        if (score >= 0.70) return 'red';
        if (score >= 0.45) return 'amber';
        return 'green';
    }

    function getStatusText(score) {
        if (score >= 0.70) return 'THREAT DETECTED';
        if (score >= 0.45) return 'ELEVATED RISK';
        return 'PROTECTED';
    }

    function updateSecurityUI(data) {
        const score = data.score || 0;
        const statusClass = getStatusClass(score);

        // Update score
        els.score.textContent = score.toFixed(2);
        els.score.className = 'value ' + statusClass;

        // Update progress ring
        const progress = 1 - score;
        const offset = CIRCUMFERENCE - (progress * CIRCUMFERENCE);
        els.progress.style.strokeDashoffset = offset;
        els.progress.className = 'progress ' + statusClass;

        // Update status pill
        els.status.className = 'status-pill ' + statusClass;
        els.statusText.textContent = getStatusText(score);

        // Update stats
        els.threats.textContent = data.threats_active || 0;
        els.blocked.textContent = data.blocked || 0;
        els.xdp.textContent = data.xdp_drops || 0;
        els.chains.textContent = data.attack_chains || 0;

        // Update layers
        if (data.layers) {
            Object.entries(data.layers).forEach(([layer, info]) => {
                const row = document.querySelector(`[data-layer="${layer}"]`);
                if (row) {
                    const bar = row.querySelector('.layer-bar');
                    const val = row.querySelector('.layer-value');
                    const threats = row.querySelector('.layer-threats');
                    const layerScore = typeof info === 'object' ? info.score : info;
                    const layerThreats = typeof info === 'object' ? info.threats : 0;
                    const layerClass = getStatusClass(layerScore);

                    bar.style.width = (layerScore * 100) + '%';
                    bar.className = 'layer-bar ' + layerClass;
                    val.textContent = layerScore.toFixed(2);
                    if (threats) threats.textContent = layerThreats + ' threats';
                }
            });
        }
    }

    async function fetchSecurityData() {
        try {
            // Fetch Qsecbit score
            const scoreRes = await fetch('/qsecbit/api/score');
            if (scoreRes.ok) {
                const data = await scoreRes.json();
                updateSecurityUI(data);
            }

            // Fetch XDP stats
            const xdpRes = await fetch('/api/xdp_stats');
            if (xdpRes.ok) {
                const xdp = await xdpRes.json();
                els.xdpMode.textContent = xdp.mode || '--';
                els.xdpIface.textContent = xdp.interface || 'eth0';
                els.xdpPkts.textContent = formatNumber(xdp.packets || 0);
                els.xdpRate.textContent = (xdp.drop_rate || 0) + '%';
            }
        } catch (e) {
            console.error('Security fetch error:', e);
        }
    }

    function formatNumber(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
        return n.toString();
    }

    function updateClock() {
        const now = new Date();
        els.date.textContent = now.toLocaleDateString('en-GB', {
            weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
        });
        els.time.textContent = now.toLocaleTimeString('en-GB', {
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    // Initialize
    fetchSecurityData();
    updateClock();
    setInterval(fetchSecurityData, POLL_INTERVAL);
    setInterval(updateClock, 1000);
})();
</script>
