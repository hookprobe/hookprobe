# dnsmasq configuration for Fortress OVS VLAN network
# Provides DHCP and DNS services for all VLANs with device identification
#
# Install: cp dnsmasq-fortress.conf /etc/dnsmasq.d/fortress.conf
# Restart: systemctl restart dnsmasq
#
# Performance optimizations enabled for router deployment

# ============================================
# General settings - Performance optimized
# ============================================
domain-needed
bogus-priv
no-resolv
no-poll

# Upstream DNS with failover
server=1.1.1.1
server=8.8.8.8
server=9.9.9.9

# Local domain
local=/fortress.local/
domain=fortress.local
expand-hosts

# Don't read /etc/hosts for faster startup
no-hosts

# DHCP authoritative mode - faster response
dhcp-authoritative

# Rapid commit for faster DHCP (RFC 4039)
dhcp-rapid-commit

# ============================================
# Performance tuning
# ============================================
# DNS cache size (increase for many clients)
cache-size=2000

# Negative cache - avoid repeated lookups for NXDOMAIN
neg-ttl=60

# Minimum TTL to cache
min-cache-ttl=300

# Don't forward queries without dots
domain-needed

# ============================================
# Interface bindings
# ============================================
# Listen on OVS VLAN interfaces (NOT the main bridge directly)
interface=vlan10
interface=vlan20
interface=vlan30
interface=vlan40
interface=vlan99

# Main bridge as fallback
interface=fortress

# Bind only to specified interfaces
bind-interfaces

# ============================================
# DHCP Options - Common
# ============================================
# Lease database location
dhcp-leasefile=/var/lib/dnsmasq/fortress.leases

# Script to run on DHCP events (device tracking)
dhcp-script=/opt/hookprobe/fortress/bin/dhcp-event.sh

# Send vendor class in DHCP offers for client identification
dhcp-vendorclass=set:apple,Apple
dhcp-vendorclass=set:android,android
dhcp-vendorclass=set:windows,MSFT
dhcp-vendorclass=set:linux,Linux

# ============================================
# VLAN 10 - Management (10.250.10.0/24)
# Admin devices, full access
# ============================================
dhcp-range=vlan10,10.250.10.100,10.250.10.199,255.255.255.0,12h
dhcp-option=vlan10,3,10.250.10.1
dhcp-option=vlan10,6,10.250.10.1
dhcp-option=vlan10,15,fortress.local
dhcp-option=vlan10,119,fortress.local

# ============================================
# VLAN 20 - POS/Payment (10.250.20.0/24)
# Payment terminals - internet only
# ============================================
dhcp-range=vlan20,10.250.20.100,10.250.20.199,255.255.255.0,12h
dhcp-option=vlan20,3,10.250.20.1
dhcp-option=vlan20,6,10.250.20.1
# No search domain - POS devices don't need it

# ============================================
# VLAN 30 - Staff (10.250.30.0/24)
# Staff devices - full access
# ============================================
dhcp-range=vlan30,10.250.30.100,10.250.30.199,255.255.255.0,12h
dhcp-option=vlan30,3,10.250.30.1
dhcp-option=vlan30,6,10.250.30.1
dhcp-option=vlan30,15,fortress.local

# ============================================
# VLAN 40 - Guest WiFi (10.250.40.0/24)
# Guest devices - internet only, short lease
# ============================================
dhcp-range=vlan40,10.250.40.100,10.250.40.199,255.255.255.0,2h
dhcp-option=vlan40,3,10.250.40.1
dhcp-option=vlan40,6,10.250.40.1
# No domain search for guests

# ============================================
# VLAN 99 - IoT Devices (10.250.99.0/24)
# IoT devices - LAN only or isolated
# ============================================
dhcp-range=vlan99,10.250.99.100,10.250.99.199,255.255.255.0,24h
dhcp-option=vlan99,3,10.250.99.1
dhcp-option=vlan99,6,10.250.99.1

# ============================================
# Main Bridge (10.250.0.0/24) - LAN clients
# Wired clients connected via RJ45 get DHCP from this range
# ============================================
dhcp-range=fortress,10.250.0.100,10.250.0.199,255.255.255.0,12h
dhcp-option=fortress,3,10.250.0.1
dhcp-option=fortress,6,10.250.0.1

# ============================================
# Device type identification via DHCP options
# ============================================
# Apple devices (iPhone, iPad, Mac)
dhcp-mac=set:apple,00:1C:B3:*:*:*
dhcp-mac=set:apple,00:03:93:*:*:*
dhcp-mac=set:apple,A4:5E:60:*:*:*
dhcp-mac=set:apple,AC:BC:32:*:*:*

# Samsung devices
dhcp-mac=set:samsung,00:07:AB:*:*:*
dhcp-mac=set:samsung,00:12:47:*:*:*

# Google/Nest devices
dhcp-mac=set:google,3C:5A:B4:*:*:*
dhcp-mac=set:google,94:EB:2C:*:*:*
dhcp-mac=set:google,F4:F5:D8:*:*:*

# IoT device OUIs
dhcp-mac=set:iot,B8:27:EB:*:*:*
dhcp-mac=set:iot,DC:A6:32:*:*:*
dhcp-mac=set:iot,E4:5F:01:*:*:*

# Philips Hue
dhcp-mac=set:iot,00:17:88:*:*:*

# Amazon Echo
dhcp-mac=set:iot,0C:47:C9:*:*:*
dhcp-mac=set:iot,44:65:0D:*:*:*

# Ring devices
dhcp-mac=set:iot,34:D2:70:*:*:*

# Hikvision cameras
dhcp-mac=set:camera,00:0C:B5:*:*:*
dhcp-mac=set:camera,54:C4:15:*:*:*

# POS terminals (Square)
dhcp-mac=set:pos,58:E6:BA:*:*:*

# Printers (HP)
dhcp-mac=set:printer,00:1E:0B:*:*:*
dhcp-mac=set:printer,3C:D9:2B:*:*:*

# ============================================
# Static leases (management devices)
# ============================================
# Add your known devices here:
# dhcp-host=AA:BB:CC:DD:EE:FF,10.250.10.10,admin-laptop
# dhcp-host=11:22:33:44:55:66,10.250.20.10,pos-terminal-1

# ============================================
# Logging - optimized for production
# ============================================
log-facility=/var/log/dnsmasq.log
log-dhcp

# Log async to prevent blocking
log-async=25

# Quiet DHCP lease renewals in log
quiet-dhcp

# ============================================
# DNS Security
# ============================================
# Block rebinding attacks
stop-dns-rebind
rebind-localhost-ok

# Don't read /etc/resolv.conf changes
no-resolv
