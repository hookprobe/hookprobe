# dnsmasq configuration for HookProbe Fortress
# OVS flat bridge architecture
#
# IMPORTANT: This is a TEMPLATE file. The actual configuration
# is generated by setup-dhcp.sh which calculates correct DHCP ranges
# based on the user's selected subnet size (/29, /28, /27, /26, /25, /24, /23).
#
# Network Architecture (FLAT BRIDGE):
#   FTS Bridge: OVS switch with gateway IP 10.200.0.1/XX
#   OpenFlow rules handle NAC (Network Access Control)
#   No VLANs - all ports untagged for low-latency operation
#
# Install: setup-dhcp.sh configure
# Restart: systemctl restart dnsmasq
#
# ============================================
# THIS FILE IS A TEMPLATE - DO NOT EDIT DIRECTLY
# Use setup-dhcp.sh to generate the actual config
# ============================================

# General settings
domain-needed
bogus-priv
no-resolv
no-poll

# Upstream DNS with failover
server=1.1.1.1
server=8.8.8.8
server=9.9.9.9

# Local domain
local=/hookprobe.local/
domain=hookprobe.local
expand-hosts
no-hosts

# DHCP authoritative mode
dhcp-authoritative
dhcp-rapid-commit

# Performance tuning
cache-size=2000
neg-ttl=60
min-cache-ttl=300

# ============================================
# Interface binding
# ============================================
# DHCP/DNS listens ONLY on FTS bridge (LAN gateway)
# Using bind-interfaces + listen-address to avoid conflict with
# Podman's aardvark-dns which listens on 172.20.200.1:53
interface=FTS
bind-interfaces
listen-address=10.200.0.1
# Don't listen on localhost (avoids conflict with systemd-resolved)
except-interface=lo

# ============================================
# DHCP Configuration
# ============================================
# These values are PLACEHOLDERS - setup-dhcp.sh generates
# the actual values based on user's subnet selection.
#
# The range is calculated as follows:
#   /29: 10.200.0.2 - 10.200.0.6 (6 devices)
#   /28: 10.200.0.2 - 10.200.0.14 (14 devices)
#   /27: 10.200.0.10 - 10.200.0.30 (30 devices)
#   /26: 10.200.0.10 - 10.200.0.62 (62 devices)
#   /25: 10.200.0.10 - 10.200.0.126 (126 devices)
#   /24: 10.200.0.100 - 10.200.0.200 (254 devices)
#   /23: 10.200.0.100 - 10.200.1.200 (510 devices)
#
dhcp-range=lan,10.200.0.100,10.200.0.200,255.255.255.0,12h

# Gateway (Fortress on FTS bridge)
dhcp-option=lan,3,10.200.0.1

# DNS server (Fortress - dnsXai filtering)
dhcp-option=lan,6,10.200.0.1

# Domain search
dhcp-option=lan,15,hookprobe.local
dhcp-option=lan,119,hookprobe.local

# ============================================
# Lease database and event handling
# ============================================
dhcp-leasefile=/var/lib/dnsmasq/fortress.leases
dhcp-script=/opt/hookprobe/fortress/bin/dhcp-event.sh

# ============================================
# Device type identification via DHCP options
# ============================================
dhcp-vendorclass=set:apple,Apple
dhcp-vendorclass=set:android,android
dhcp-vendorclass=set:windows,MSFT
dhcp-vendorclass=set:linux,Linux

# ============================================
# OUI-based device identification
# ============================================
# Apple devices
dhcp-mac=set:apple,00:1C:B3:*:*:*
dhcp-mac=set:apple,00:03:93:*:*:*
dhcp-mac=set:apple,A4:5E:60:*:*:*
dhcp-mac=set:apple,AC:BC:32:*:*:*

# Samsung devices
dhcp-mac=set:samsung,00:07:AB:*:*:*
dhcp-mac=set:samsung,00:12:47:*:*:*

# Google/Nest devices
dhcp-mac=set:google,3C:5A:B4:*:*:*
dhcp-mac=set:google,94:EB:2C:*:*:*
dhcp-mac=set:google,F4:F5:D8:*:*:*

# IoT device OUIs (Raspberry Pi)
dhcp-mac=set:iot,B8:27:EB:*:*:*
dhcp-mac=set:iot,DC:A6:32:*:*:*
dhcp-mac=set:iot,E4:5F:01:*:*:*

# Philips Hue
dhcp-mac=set:iot,00:17:88:*:*:*

# Amazon Echo
dhcp-mac=set:voice,0C:47:C9:*:*:*
dhcp-mac=set:voice,44:65:0D:*:*:*

# Ring devices
dhcp-mac=set:camera,34:D2:70:*:*:*

# Hikvision cameras
dhcp-mac=set:camera,00:0C:B5:*:*:*
dhcp-mac=set:camera,54:C4:15:*:*:*

# POS terminals - Square
dhcp-mac=set:pos,58:E6:BA:*:*:*

# Printers - HP
dhcp-mac=set:printer,00:1E:0B:*:*:*
dhcp-mac=set:printer,3C:D9:2B:*:*:*

# ============================================
# Logging
# ============================================
log-facility=/var/log/dnsmasq.log
log-dhcp
log-async=25
quiet-dhcp

# ============================================
# DNS Security
# ============================================
stop-dns-rebind
rebind-localhost-ok
no-resolv
