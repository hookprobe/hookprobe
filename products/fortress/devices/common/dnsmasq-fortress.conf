# dnsmasq configuration for HookProbe Fortress
# Single subnet with nftables-based device filtering
#
# Network: 10.250.0.0/24 (gateway: 10.250.0.1)
# DHCP: 10.250.0.100-199
# Device filtering: via nftables (not VLANs)
#
# Install: cp dnsmasq-fortress.conf /etc/dnsmasq.d/fortress.conf
# Restart: systemctl restart dnsmasq

# ============================================
# General settings - Performance optimized
# ============================================
domain-needed
bogus-priv
no-resolv
no-poll

# Upstream DNS with failover
server=1.1.1.1
server=8.8.8.8
server=9.9.9.9

# Local domain
local=/fortress.local/
domain=fortress.local
expand-hosts

# Don't read /etc/hosts for faster startup
no-hosts

# DHCP authoritative mode - faster response
dhcp-authoritative

# Rapid commit for faster DHCP (RFC 4039)
dhcp-rapid-commit

# ============================================
# Performance tuning
# ============================================
# DNS cache size (increase for many clients)
cache-size=2000

# Negative cache - avoid repeated lookups for NXDOMAIN
neg-ttl=60

# Minimum TTL to cache
min-cache-ttl=300

# Don't forward queries without dots
domain-needed

# ============================================
# Interface binding - Single Bridge
# ============================================
# Listen on the fortress bridge interface
interface=fortress

# Also listen on common WiFi interface names (for AP mode)
# These are added to bridge, so traffic flows through fortress
# interface=wlan0
# interface=wlan1

# Bind only to specified interfaces
bind-interfaces

# ============================================
# DHCP Configuration - Single Subnet
# ============================================
# Main network: 10.250.0.0/24
# Gateway: 10.250.0.1 (Fortress)
# DHCP: 10.250.0.100-199 (100 addresses)
# Lease: 12 hours
dhcp-range=fortress,10.250.0.100,10.250.0.199,255.255.255.0,12h

# Gateway (Fortress itself)
dhcp-option=fortress,3,10.250.0.1

# DNS server (Fortress itself, for dnsXai filtering)
dhcp-option=fortress,6,10.250.0.1

# Domain search
dhcp-option=fortress,15,fortress.local
dhcp-option=fortress,119,fortress.local

# ============================================
# Lease database and event handling
# ============================================
# Lease database location
dhcp-leasefile=/var/lib/dnsmasq/fortress.leases

# Script to run on DHCP events (device tracking + auto-classification)
dhcp-script=/opt/hookprobe/fortress/bin/dhcp-event.sh

# ============================================
# Device type identification via DHCP options
# Used for OUI-based auto-classification
# ============================================
# Vendor class identification
dhcp-vendorclass=set:apple,Apple
dhcp-vendorclass=set:android,android
dhcp-vendorclass=set:windows,MSFT
dhcp-vendorclass=set:linux,Linux

# ============================================
# OUI-based device identification
# These are used for initial classification before
# the dhcp-event.sh applies nftables policies
# ============================================

# Apple devices (iPhone, iPad, Mac)
dhcp-mac=set:apple,00:1C:B3:*:*:*
dhcp-mac=set:apple,00:03:93:*:*:*
dhcp-mac=set:apple,A4:5E:60:*:*:*
dhcp-mac=set:apple,AC:BC:32:*:*:*

# Samsung devices
dhcp-mac=set:samsung,00:07:AB:*:*:*
dhcp-mac=set:samsung,00:12:47:*:*:*

# Google/Nest devices (voice assistants - internet_only policy)
dhcp-mac=set:google,3C:5A:B4:*:*:*
dhcp-mac=set:google,94:EB:2C:*:*:*
dhcp-mac=set:google,F4:F5:D8:*:*:*

# IoT device OUIs (Raspberry Pi - lan_only policy)
dhcp-mac=set:iot,B8:27:EB:*:*:*
dhcp-mac=set:iot,DC:A6:32:*:*:*
dhcp-mac=set:iot,E4:5F:01:*:*:*

# Philips Hue (lan_only policy)
dhcp-mac=set:iot,00:17:88:*:*:*

# Amazon Echo (internet_only policy)
dhcp-mac=set:voice,0C:47:C9:*:*:*
dhcp-mac=set:voice,44:65:0D:*:*:*

# Ring devices (lan_only - camera)
dhcp-mac=set:camera,34:D2:70:*:*:*

# Hikvision cameras (lan_only policy)
dhcp-mac=set:camera,00:0C:B5:*:*:*
dhcp-mac=set:camera,54:C4:15:*:*:*

# POS terminals - Square (internet_only policy)
dhcp-mac=set:pos,58:E6:BA:*:*:*

# Printers - HP (lan_only policy)
dhcp-mac=set:printer,00:1E:0B:*:*:*
dhcp-mac=set:printer,3C:D9:2B:*:*:*

# ============================================
# Static leases (optional - add your devices)
# ============================================
# Example: dhcp-host=AA:BB:CC:DD:EE:FF,10.250.0.10,admin-laptop

# ============================================
# Logging - optimized for production
# ============================================
log-facility=/var/log/dnsmasq.log
log-dhcp

# Log async to prevent blocking
log-async=25

# Quiet DHCP lease renewals in log
quiet-dhcp

# ============================================
# DNS Security
# ============================================
# Block rebinding attacks
stop-dns-rebind
rebind-localhost-ok

# Don't read /etc/resolv.conf changes
no-resolv
