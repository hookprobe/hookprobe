{% extends "base.html" %}
{% block title %}dnsXai - HookProbe Fortress{% endblock %}
{% block page_title %}DNS Protection{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">dnsXai</li>{% endblock %}
{% block content %}
<div class="row">
    <!-- Protection Status Card -->
    <div class="col-lg-4 col-md-6">
        <div class="card card-success card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-shield-alt"></i> Protection Status</h3>
            </div>
            <div class="card-body text-center">
                <div id="protection-status-icon" class="mb-3">
                    <i class="fas fa-shield-alt fa-4x text-success"></i>
                </div>
                <h4 id="protection-status-text" class="text-success">Active</h4>
                <p class="text-muted" id="pause-timer" style="display: none;">
                    Resuming in: <span id="pause-countdown">--:--</span>
                </p>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-sm btn-warning" onclick="pauseProtection(5)" title="Pause 5 min">5m</button>
                    <button class="btn btn-sm btn-warning" onclick="pauseProtection(15)" title="Pause 15 min">15m</button>
                    <button class="btn btn-sm btn-warning" onclick="pauseProtection(30)" title="Pause 30 min">30m</button>
                    <button class="btn btn-sm btn-danger" id="killswitch-btn" onclick="toggleProtection()">DISABLE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Card -->
    <div class="col-lg-4 col-md-6">
        <div class="card card-info card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-bar"></i> Statistics</h3>
                <div class="card-tools">
                    <button class="btn btn-tool" onclick="loadStats()"><i class="fas fa-sync"></i></button>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm">
                    <tr><td>Total Queries</td><td class="text-right" id="stat-queries">0</td></tr>
                    <tr><td>Blocked</td><td class="text-right text-danger" id="stat-blocked">0</td></tr>
                    <tr><td>Allowed</td><td class="text-right text-success" id="stat-allowed">0</td></tr>
                    <tr><td>Block Rate</td><td class="text-right" id="stat-rate">0%</td></tr>
                    <tr><td>Blocklist Size</td><td class="text-right" id="stat-blocklist">0</td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- ML/LSTM Status Card -->
    <div class="col-lg-4 col-md-6">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-brain"></i> ML/LSTM Threat Detection</h3>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Status:</span>
                    <span id="ml-status" class="badge badge-secondary">Checking...</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Model Trained:</span>
                    <span id="ml-trained" class="badge badge-secondary">--</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Threat Sequences:</span>
                    <span id="ml-threats">0</span>
                </div>
                <small class="text-muted">Daily training at 3:00 AM</small>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-primary" onclick="trainML()">
                    <i class="fas fa-graduation-cap"></i> Train Now
                </button>
                <button class="btn btn-sm btn-secondary" onclick="loadMLStatus()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Protection Level -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-sliders-h"></i> Protection Level</h3>
            </div>
            <div class="card-body">
                <input type="range" class="custom-range" min="0" max="5" value="3" id="protection-level"
                       oninput="updateLevelDisplay(this.value)" onchange="setProtectionLevel(this.value)">
                <div class="d-flex justify-content-between text-muted small mt-2">
                    <span>OFF</span>
                    <span>BASE</span>
                    <span>ENHANCED</span>
                    <span>STRONG</span>
                    <span>MAX</span>
                    <span>FULL</span>
                </div>
                <div class="text-center mt-3">
                    <h4>Current: <span id="level-name" class="text-success">Strong</span></h4>
                    <small id="level-description" class="text-muted">Ads + Malware + Fakenews + Gambling</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Settings -->
<div class="row">
    <div class="col-12">
        <div class="card card-warning card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-user-shield"></i> Privacy Settings</h3>
                <div class="card-tools">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-success" onclick="applyPrivacyPreset('maximum')">Maximum Privacy</button>
                        <button class="btn btn-warning" onclick="applyPrivacyPreset('balanced')">Balanced</button>
                        <button class="btn btn-danger" onclick="applyPrivacyPreset('full')">Full Analytics</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-query-logging"
                                       onchange="setPrivacy('enable_query_logging', this.checked)">
                                <label class="custom-control-label" for="privacy-query-logging">
                                    DNS Query Logging
                                </label>
                            </div>
                            <small class="form-text text-muted">Log individual DNS queries (HIGH privacy impact)</small>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-domain-tracking"
                                       onchange="setPrivacy('enable_domain_tracking', this.checked)">
                                <label class="custom-control-label" for="privacy-domain-tracking">
                                    Domain Tracking
                                </label>
                            </div>
                            <small class="form-text text-muted">Track domain visit frequency (HIGH privacy impact)</small>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-ad-stats" checked
                                       onchange="setPrivacy('enable_ad_blocking_stats', this.checked)">
                                <label class="custom-control-label" for="privacy-ad-stats">
                                    Ad Blocking Statistics
                                </label>
                            </div>
                            <small class="form-text text-muted">Count blocked ads/trackers (LOW privacy impact)</small>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-threat-detection" checked
                                       onchange="setPrivacy('enable_threat_detection', this.checked)">
                                <label class="custom-control-label" for="privacy-threat-detection">
                                    Threat Detection
                                </label>
                            </div>
                            <small class="form-text text-muted">Essential security feature (RECOMMENDED)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-ml-training"
                                       onchange="setPrivacy('enable_ml_training_data', this.checked)">
                                <label class="custom-control-label" for="privacy-ml-training">
                                    ML Training Data
                                </label>
                            </div>
                            <small class="form-text text-muted">Use anonymized patterns for ML (MEDIUM privacy impact)</small>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="privacy-anonymize-ips" checked
                                       onchange="setPrivacy('anonymize_client_ips', this.checked)">
                                <label class="custom-control-label" for="privacy-anonymize-ips">
                                    Anonymize Client IPs
                                </label>
                            </div>
                            <small class="form-text text-muted">Replace IPs with hashes (ALWAYS recommended)</small>
                        </div>
                        <div class="form-group">
                            <label for="privacy-retention">Data Retention (days)</label>
                            <input type="number" class="form-control form-control-sm" id="privacy-retention"
                                   value="7" min="1" max="90" style="width: 100px;"
                                   onchange="setPrivacy('retention_days', parseInt(this.value))">
                            <small class="form-text text-muted">Shorter = more privacy</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Whitelist Management -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-check-circle"></i> Whitelist</h3>
                <div class="card-tools">
                    <span class="badge badge-info" id="whitelist-count">0 domains</span>
                </div>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="whitelist-input" placeholder="domain.com"
                           onkeypress="if(event.key==='Enter') addWhitelist()">
                    <div class="input-group-append">
                        <button class="btn btn-success" onclick="addWhitelist()">Add</button>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <tbody id="whitelist-body">
                            <tr><td colspan="2" class="text-muted text-center">No whitelisted domains</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Blocked -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-ban"></i> Recently Blocked</h3>
                <div class="card-tools">
                    <button class="btn btn-tool" onclick="loadBlocked()"><i class="fas fa-sync"></i></button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr><th>Domain</th><th>Count</th><th></th></tr>
                        </thead>
                        <tbody id="blocked-body">
                            <tr><td colspan="3" class="text-muted text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Blocklist Sources -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-list"></i> Blocklist Sources</h3>
                <div class="card-tools">
                    <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#add-source-modal">
                        <i class="fas fa-plus"></i> Add Source
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="sources-list">
                    <p class="text-muted">Loading sources...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Source Modal -->
<div class="modal fade" id="add-source-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Blocklist Source</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Source Name</label>
                    <input type="text" class="form-control" id="source-name" placeholder="e.g., StevenBlack Hosts">
                </div>
                <div class="form-group">
                    <label>Source URL</label>
                    <input type="text" class="form-control" id="source-url" placeholder="https://raw.githubusercontent.com/...">
                    <small class="form-text text-muted">URL to a hosts file or domain list</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSource()">Add Source</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const LEVEL_NAMES = ['OFF', 'Base', 'Enhanced', 'Strong', 'Maximum', 'Full'];
const LEVEL_DESCS = [
    'Protection disabled',
    'Ads + Malware only',
    'Ads + Malware + Fakenews',
    'Ads + Malware + Fakenews + Gambling',
    'All above + Adult content',
    'Maximum protection + Social trackers'
];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadPrivacy();
    loadWhitelist();
    loadBlocked();
    loadSources();
    loadMLStatus();
    setInterval(checkPauseStatus, 10000);
});

// === STATS ===
async function loadStats() {
    try {
        const resp = await fetch('/dnsxai/api/stats');
        const data = await resp.json();

        document.getElementById('stat-queries').textContent = data.total_queries.toLocaleString();
        document.getElementById('stat-blocked').textContent = data.blocked.toLocaleString();
        document.getElementById('stat-allowed').textContent = data.allowed.toLocaleString();
        document.getElementById('stat-rate').textContent = data.block_rate.toFixed(1) + '%';
        document.getElementById('stat-blocklist').textContent = data.blocklist_domains.toLocaleString();

        document.getElementById('protection-level').value = data.level;
        updateLevelDisplay(data.level);
        updateProtectionStatus(data.status);
    } catch(e) {
        console.error('Failed to load stats:', e);
    }
}

// === PROTECTION STATUS ===
function updateProtectionStatus(status) {
    const icon = document.getElementById('protection-status-icon');
    const text = document.getElementById('protection-status-text');
    const btn = document.getElementById('killswitch-btn');
    const timer = document.getElementById('pause-timer');

    if (status === 'active') {
        icon.innerHTML = '<i class="fas fa-shield-alt fa-4x text-success"></i>';
        text.textContent = 'Active';
        text.className = 'text-success';
        btn.textContent = 'DISABLE';
        btn.className = 'btn btn-sm btn-danger';
        timer.style.display = 'none';
    } else if (status === 'paused') {
        icon.innerHTML = '<i class="fas fa-pause-circle fa-4x text-warning"></i>';
        text.textContent = 'Paused';
        text.className = 'text-warning';
        btn.textContent = 'RESUME';
        btn.className = 'btn btn-sm btn-success';
        timer.style.display = 'block';
    } else {
        icon.innerHTML = '<i class="fas fa-times-circle fa-4x text-danger"></i>';
        text.textContent = 'Disabled';
        text.className = 'text-danger';
        btn.textContent = 'ENABLE';
        btn.className = 'btn btn-sm btn-success';
        timer.style.display = 'none';
    }
}

async function toggleProtection() {
    const btn = document.getElementById('killswitch-btn');
    const action = btn.textContent === 'DISABLE' ? 'disable' : 'enable';

    try {
        const resp = await fetch('/dnsxai/api/pause', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action})
        });
        const data = await resp.json();
        if (data.success) {
            updateProtectionStatus(data.status);
            toastr.success('Protection ' + data.status);
        }
    } catch(e) {
        toastr.error('Failed to toggle protection');
    }
}

async function pauseProtection(minutes) {
    try {
        const resp = await fetch('/dnsxai/api/pause', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'pause', minutes})
        });
        const data = await resp.json();
        if (data.success) {
            updateProtectionStatus('paused');
            toastr.success('Protection paused for ' + minutes + ' minutes');
        }
    } catch(e) {
        toastr.error('Failed to pause protection');
    }
}

async function checkPauseStatus() {
    try {
        const resp = await fetch('/dnsxai/api/pause');
        const data = await resp.json();

        updateProtectionStatus(data.status);

        if (data.status === 'paused' && data.remaining_seconds > 0) {
            const mins = Math.floor(data.remaining_seconds / 60);
            const secs = data.remaining_seconds % 60;
            document.getElementById('pause-countdown').textContent =
                mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }
    } catch(e) {}
}

// === PROTECTION LEVEL ===
function updateLevelDisplay(level) {
    document.getElementById('level-name').textContent = LEVEL_NAMES[level];
    document.getElementById('level-description').textContent = LEVEL_DESCS[level];

    const colors = ['text-secondary', 'text-info', 'text-primary', 'text-success', 'text-warning', 'text-danger'];
    document.getElementById('level-name').className = colors[level];
}

async function setProtectionLevel(level) {
    try {
        const resp = await fetch('/dnsxai/api/level', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({level: parseInt(level)})
        });
        const data = await resp.json();
        if (data.success) {
            toastr.success('Protection level set to ' + LEVEL_NAMES[level]);
        }
    } catch(e) {
        toastr.error('Failed to set level');
    }
}

// === PRIVACY ===
async function loadPrivacy() {
    try {
        const resp = await fetch('/dnsxai/api/privacy');
        const data = await resp.json();
        const settings = data.settings || {};

        document.getElementById('privacy-query-logging').checked = settings.enable_query_logging;
        document.getElementById('privacy-domain-tracking').checked = settings.enable_domain_tracking;
        document.getElementById('privacy-ad-stats').checked = settings.enable_ad_blocking_stats;
        document.getElementById('privacy-threat-detection').checked = settings.enable_threat_detection;
        document.getElementById('privacy-ml-training').checked = settings.enable_ml_training_data;
        document.getElementById('privacy-anonymize-ips').checked = settings.anonymize_client_ips;
        document.getElementById('privacy-retention').value = settings.retention_days || 7;
    } catch(e) {
        console.error('Failed to load privacy settings:', e);
    }
}

async function setPrivacy(setting, value) {
    try {
        const resp = await fetch('/dnsxai/api/privacy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({setting, value})
        });
        const data = await resp.json();
        if (data.success) {
            toastr.success('Privacy setting updated');
        }
    } catch(e) {
        toastr.error('Failed to update setting');
    }
}

async function applyPrivacyPreset(preset) {
    if (preset === 'full' && !confirm('This enables full analytics including query logging. Continue?')) {
        return;
    }

    try {
        const resp = await fetch('/dnsxai/api/privacy/preset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({preset})
        });
        const data = await resp.json();
        if (data.success) {
            loadPrivacy();
            toastr.success('Privacy preset applied: ' + preset);
        }
    } catch(e) {
        toastr.error('Failed to apply preset');
    }
}

// === WHITELIST ===
async function loadWhitelist() {
    try {
        const resp = await fetch('/dnsxai/api/whitelist');
        const data = await resp.json();
        const whitelist = data.whitelist || [];

        document.getElementById('whitelist-count').textContent = whitelist.length + ' domains';

        const tbody = document.getElementById('whitelist-body');
        if (whitelist.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No whitelisted domains</td></tr>';
        } else {
            tbody.innerHTML = whitelist.map(d => `
                <tr>
                    <td class="text-monospace">${d}</td>
                    <td class="text-right">
                        <button class="btn btn-xs btn-danger" onclick="removeWhitelist('${d}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    } catch(e) {
        console.error('Failed to load whitelist:', e);
    }
}

async function addWhitelist() {
    const input = document.getElementById('whitelist-input');
    const domain = input.value.trim().toLowerCase();
    if (!domain) return;

    try {
        const resp = await fetch('/dnsxai/api/whitelist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain})
        });
        const data = await resp.json();
        if (data.success) {
            input.value = '';
            loadWhitelist();
            toastr.success(domain + ' whitelisted');
        } else {
            toastr.error(data.error || 'Failed to whitelist');
        }
    } catch(e) {
        toastr.error('Failed to add to whitelist');
    }
}

async function removeWhitelist(domain) {
    try {
        const resp = await fetch('/dnsxai/api/whitelist', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain})
        });
        const data = await resp.json();
        if (data.success) {
            loadWhitelist();
            toastr.success(domain + ' removed from whitelist');
        }
    } catch(e) {
        toastr.error('Failed to remove from whitelist');
    }
}

// === BLOCKED ===
async function loadBlocked() {
    try {
        const resp = await fetch('/dnsxai/api/blocked?limit=20');
        const data = await resp.json();
        const domains = data.domains || [];

        const tbody = document.getElementById('blocked-body');
        if (domains.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">No blocked domains</td></tr>';
        } else {
            tbody.innerHTML = domains.map(d => `
                <tr>
                    <td class="text-monospace" style="font-size: 0.85em; word-break: break-all;">${d.domain}</td>
                    <td><span class="badge badge-danger">${d.block_count}</span></td>
                    <td>
                        <button class="btn btn-xs btn-success" onclick="addWhitelistDomain('${d.domain}')" title="Whitelist">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    } catch(e) {
        console.error('Failed to load blocked:', e);
    }
}

async function addWhitelistDomain(domain) {
    document.getElementById('whitelist-input').value = domain;
    await addWhitelist();
    loadBlocked();
}

// === SOURCES ===
async function loadSources() {
    try {
        const resp = await fetch('/dnsxai/api/sources');
        const data = await resp.json();
        const sources = data.sources || [];

        const container = document.getElementById('sources-list');
        if (sources.length === 0) {
            container.innerHTML = '<p class="text-muted">No blocklist sources configured</p>';
        } else {
            container.innerHTML = sources.map(s => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <div>
                        <strong>${s.name}</strong>
                        ${s.builtin ? '<span class="badge badge-secondary ml-2">Built-in</span>' : ''}
                        <br>
                        <small class="text-muted">${s.url}</small>
                    </div>
                    ${!s.builtin ? `
                        <button class="btn btn-sm btn-danger" onclick="removeSource('${s.url}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }
    } catch(e) {
        console.error('Failed to load sources:', e);
    }
}

async function addSource() {
    const name = document.getElementById('source-name').value.trim();
    const url = document.getElementById('source-url').value.trim();

    if (!url) {
        toastr.error('URL is required');
        return;
    }

    try {
        const resp = await fetch('/dnsxai/api/sources', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name || 'Custom Source', url})
        });
        const data = await resp.json();
        if (data.success) {
            $('#add-source-modal').modal('hide');
            document.getElementById('source-name').value = '';
            document.getElementById('source-url').value = '';
            loadSources();
            toastr.success('Source added');
        } else {
            toastr.error(data.error || 'Failed to add source');
        }
    } catch(e) {
        toastr.error('Failed to add source');
    }
}

async function removeSource(url) {
    if (!confirm('Remove this source?')) return;

    try {
        const resp = await fetch('/dnsxai/api/sources', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        const data = await resp.json();
        if (data.success) {
            loadSources();
            toastr.success('Source removed');
        }
    } catch(e) {
        toastr.error('Failed to remove source');
    }
}

// === ML/LSTM ===
async function loadMLStatus() {
    try {
        const resp = await fetch('/dnsxai/api/ml/status');
        const data = await resp.json();

        document.getElementById('ml-status').textContent = data.available ? 'Active' : 'Initializing';
        document.getElementById('ml-status').className = 'badge badge-' + (data.available ? 'success' : 'warning');

        document.getElementById('ml-trained').textContent = data.lstm_model_exists ? 'Yes' : 'No';
        document.getElementById('ml-trained').className = 'badge badge-' + (data.lstm_model_exists ? 'success' : 'secondary');

        document.getElementById('ml-threats').textContent = (data.stats?.attack_sequences || 0).toLocaleString();
    } catch(e) {
        console.error('Failed to load ML status:', e);
    }
}

async function trainML() {
    if (!confirm('Start ML/LSTM training? This may take a few minutes.')) return;

    toastr.info('Training started...');

    try {
        const resp = await fetch('/dnsxai/api/ml/train', {method: 'POST'});
        const data = await resp.json();
        if (data.success) {
            toastr.success('Training completed!');
            loadMLStatus();
        } else {
            toastr.error(data.error || 'Training failed');
        }
    } catch(e) {
        toastr.error('Training failed');
    }
}
</script>
{% endblock %}
