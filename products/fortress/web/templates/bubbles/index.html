{% extends "base.html" %}

{% block page_title %}Device Groups{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
<li class="breadcrumb-item active">Device Groups</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Header with actions -->
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-layer-group mr-2"></i>Device Groups
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-success btn-sm" onclick="showCreateGroupModal()">
                        <i class="fas fa-plus mr-1"></i> Create Group
                    </button>
                    <button type="button" class="btn btn-info btn-sm ml-2" onclick="loadSuggestions()">
                        <i class="fas fa-lightbulb mr-1"></i> AI Suggestions
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm ml-2" onclick="loadGroups()">
                        <i class="fas fa-sync mr-1"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle mr-1"></i>
                    Drag and drop devices between groups to organize them. Each group has its own network policy (OpenFlow rules).
                    <strong>Pin</strong> groups to prevent AI from changing them.
                    <br><small class="text-info">Note: Device groups are separate from D2D bubble coloring (which shows device relationships in the background).</small>
                </p>
            </div>
        </div>
    </div>

    <!-- AI Suggestions (collapsible) -->
    <div class="col-12 mb-3" id="suggestions-container" style="display: none;">
        <div class="card card-outline card-info collapsed-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-lightbulb mr-2"></i>AI Suggestions
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" id="suggestions-body">
                <!-- Suggestions loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Groups Grid -->
    <div class="col-12">
        <div class="row" id="groups-container">
            <!-- Groups loaded dynamically -->
            <div class="col-12 text-center py-5" id="loading-indicator">
                <i class="fas fa-spinner fa-spin fa-3x text-muted"></i>
                <p class="mt-3 text-muted">Loading device groups...</p>
            </div>
        </div>
    </div>

    <!-- Unassigned Devices -->
    <div class="col-12 mt-4">
        <div class="card card-outline card-secondary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-question-circle mr-2"></i>Unassigned Devices
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="unassigned-devices">
                    <div class="col-12 text-muted text-center py-3">
                        <i class="fas fa-check-circle mr-1"></i>
                        All devices are assigned to groups
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle mr-2"></i>Create New Device Group</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <!-- Preset buttons -->
                    <div class="form-group">
                        <label>Quick Presets</label>
                        <div class="btn-group d-flex flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-primary preset-btn" data-preset="dad">
                                <i class="fas fa-user-tie"></i> Dad
                            </button>
                            <button type="button" class="btn btn-outline-danger preset-btn" data-preset="mom">
                                <i class="fas fa-user"></i> Mom
                            </button>
                            <button type="button" class="btn btn-outline-warning preset-btn" data-preset="kids">
                                <i class="fas fa-child"></i> Kids
                            </button>
                            <button type="button" class="btn btn-outline-secondary preset-btn" data-preset="guest">
                                <i class="fas fa-user-friends"></i> Guest
                            </button>
                            <button type="button" class="btn btn-outline-dark preset-btn" data-preset="work">
                                <i class="fas fa-laptop"></i> Work
                            </button>
                        </div>
                    </div>

                    <hr>

                    <div class="form-group">
                        <label for="groupName">Group Name</label>
                        <input type="text" class="form-control" id="groupName" placeholder="e.g., Dad's Devices" required>
                    </div>

                    <div class="form-group">
                        <label for="groupType">Group Type</label>
                        <select class="form-control" id="groupType">
                            <option value="family">Family (Full Access + Smart Home)</option>
                            <option value="guest">Guest (Internet Only)</option>
                            <option value="corporate">Corporate (Isolated)</option>
                            <option value="smart_home">Smart Home (IoT Devices)</option>
                            <!-- Quarantine removed: system-managed group, cannot be created manually -->
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="groupIcon">Icon</label>
                            <select class="form-control" id="groupIcon">
                                <option value="fa-users">Users</option>
                                <option value="fa-user-tie">Dad</option>
                                <option value="fa-user">Mom</option>
                                <option value="fa-child">Kids</option>
                                <option value="fa-user-friends">Guests</option>
                                <option value="fa-laptop">Work</option>
                                <option value="fa-home">Home</option>
                                <option value="fa-wifi">IoT</option>
                                <option value="fa-ban">Quarantine</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="groupColor">Color</label>
                            <input type="color" class="form-control" id="groupColor" value="#4CAF50" style="height: 38px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createGroup()">
                    <i class="fas fa-plus mr-1"></i>Create Group
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Group Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit mr-2"></i>Edit Device Group</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editGroupForm">
                    <input type="hidden" id="editGroupId">

                    <div class="form-group">
                        <label for="editGroupName">Group Name</label>
                        <input type="text" class="form-control" id="editGroupName" required>
                    </div>

                    <div class="form-group">
                        <label for="editGroupType">Group Type</label>
                        <select class="form-control" id="editGroupType">
                            <option value="family">Family</option>
                            <option value="guest">Guest</option>
                            <option value="corporate">Corporate</option>
                            <option value="smart_home">Smart Home</option>
                            <option value="lan_only">LAN Only</option>
                            <option value="quarantine">Quarantine</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGroupIcon">Icon</label>
                            <select class="form-control" id="editGroupIcon">
                                <option value="fa-users">Users</option>
                                <option value="fa-user-tie">Dad</option>
                                <option value="fa-user">Mom</option>
                                <option value="fa-child">Kids</option>
                                <option value="fa-user-friends">Guests</option>
                                <option value="fa-laptop">Work</option>
                                <option value="fa-home">Home</option>
                                <option value="fa-wifi">IoT</option>
                                <option value="fa-ban">Quarantine</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGroupColor">Color</label>
                            <input type="color" class="form-control" id="editGroupColor" style="height: 38px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editGroupPinned">
                            <label class="custom-control-label" for="editGroupPinned">
                                <i class="fas fa-thumbtack mr-1"></i>Pin (prevent AI changes)
                            </label>
                        </div>
                    </div>

                    <!-- System group warning -->
                    <div class="alert alert-warning d-none" id="systemGroupWarning">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        This is a system group and cannot be deleted.
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" id="deleteGroupBtn" onclick="deleteGroup()">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveGroup()">
                        <i class="fas fa-save mr-1"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Device Groups data (separate from D2D bubble coloring which runs in background)
let groups = [];
let allDevices = [];
const presets = {
    dad: { name: "Dad's Group", icon: 'fa-user-tie', color: '#1976D2', type: 'family' },
    mom: { name: "Mom's Group", icon: 'fa-user', color: '#E91E63', type: 'family' },
    kids: { name: "Kids' Group", icon: 'fa-child', color: '#FF5722', type: 'family' },
    guest: { name: 'Guests', icon: 'fa-user-friends', color: '#607D8B', type: 'guest' },
    work: { name: 'Work Devices', icon: 'fa-laptop', color: '#455A64', type: 'corporate' }
};

// Load groups on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGroups();
    loadAllDevices();

    // Setup preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const preset = presets[this.dataset.preset];
            if (preset) {
                document.getElementById('groupName').value = preset.name;
                document.getElementById('groupType').value = preset.type;
                document.getElementById('groupIcon').value = preset.icon;
                document.getElementById('groupColor').value = preset.color;
            }
        });
    });
});

function loadGroups() {
    fetch('/bubbles/api/list')
        .then(r => r.json())
        .then(data => {
            groups = data.bubbles || [];
            renderGroups();
        })
        .catch(err => {
            console.error('Failed to load groups:', err);
            document.getElementById('loading-indicator').innerHTML =
                '<p class="text-danger"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load device groups</p>';
        });
}

function loadAllDevices() {
    fetch('/api/dashboard/devices')
        .then(r => r.json())
        .then(data => {
            allDevices = data.devices || [];
            updateUnassignedDevices();
        })
        .catch(err => console.error('Failed to load devices:', err));
}

function renderGroups() {
    const container = document.getElementById('groups-container');
    container.innerHTML = '';

    if (groups.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No device groups yet</h5>
                <p class="text-muted">Create your first device group to organize devices by user or purpose</p>
                <button class="btn btn-success" onclick="showCreateGroupModal()">
                    <i class="fas fa-plus mr-1"></i>Create Group
                </button>
            </div>
        `;
        return;
    }

    groups.forEach(group => {
        const card = createGroupCard(group);
        container.appendChild(card);
    });

    // Initialize drag and drop
    initDragDrop();
    updateUnassignedDevices();
}

function createGroupCard(group) {
    const col = document.createElement('div');
    col.className = 'col-lg-4 col-md-6 mb-4';

    // Check if this is the quarantine group (system-managed)
    const isQuarantine = group.bubble_type === 'quarantine' ||
                         group.bubble_id === 'SYSTEM-QUARANTINE';

    const pinnedBadge = group.is_pinned ?
        '<span class="badge badge-warning ml-2"><i class="fas fa-thumbtack"></i> Pinned</span>' : '';

    const manualBadge = group.is_manual ?
        '<span class="badge badge-info ml-2">Manual</span>' :
        '<span class="badge badge-secondary ml-2">AI</span>';

    // System group badge (e.g., Quarantine)
    const systemBadge = (group.is_system || isQuarantine) ?
        '<span class="badge badge-danger ml-2"><i class="fas fa-lock"></i> System</span>' : '';

    const policyInfo = group.policy || {};
    const accessBadges = [];
    if (policyInfo.internet_access) accessBadges.push('<span class="badge badge-success badge-sm">Internet</span>');
    if (policyInfo.lan_access) accessBadges.push('<span class="badge badge-primary badge-sm">LAN</span>');
    if (policyInfo.smart_home_access) accessBadges.push('<span class="badge badge-warning badge-sm">Smart Home</span>');
    if (policyInfo.d2d_allowed) accessBadges.push('<span class="badge badge-info badge-sm">D2D</span>');
    // Show isolation for quarantine groups
    if (!policyInfo.internet_access && !policyInfo.lan_access) {
        accessBadges.push('<span class="badge badge-danger badge-sm">Isolated</span>');
    }

    let devicesHtml = '';
    if (group.devices && group.devices.length > 0) {
        group.devices.forEach(mac => {
            const device = allDevices.find(d => d.mac_address === mac) || { mac_address: mac };
            devicesHtml += `
                <div class="device-item d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded"
                     draggable="true" data-mac="${mac}" data-group="${group.bubble_id}">
                    <div>
                        <i class="fas fa-microchip mr-2 text-muted"></i>
                        <span class="device-name">${device.hostname || device.friendly_name || mac.substr(0,11)}</span>
                        <small class="text-muted d-block ml-4">${mac}</small>
                    </div>
                    <button class="btn btn-xs btn-outline-danger" onclick="removeDevice('${group.bubble_id}', '${mac}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        });
    } else {
        devicesHtml = '<p class="text-muted text-center py-3"><i class="fas fa-inbox mr-1"></i>No devices</p>';
    }

    col.innerHTML = `
        <div class="card group-card" data-group-id="${group.bubble_id}"
             style="border-left: 4px solid ${group.color || '#9C27B0'};">
            <div class="card-header" style="background-color: ${group.color || '#9C27B0'}20;">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas ${group.icon || 'fa-layer-group'} mr-2" style="color: ${group.color || '#9C27B0'};"></i>
                        ${group.display_name || 'Unnamed Group'}
                    </h3>
                    <div>
                        ${pinnedBadge}
                        ${systemBadge}
                        ${manualBadge}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    ${accessBadges.join(' ')}
                </div>
                <div class="group-devices dropzone" data-group-id="${group.bubble_id}">
                    ${devicesHtml}
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">
                        <i class="fas fa-laptop mr-1"></i>${group.device_count || 0} devices
                    </span>
                    <div>
                        ${isQuarantine ? `
                            <span class="text-muted small"><i class="fas fa-info-circle mr-1"></i>System-managed</span>
                        ` : `
                            <button class="btn btn-xs btn-outline-primary" onclick="editGroup('${group.bubble_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-xs btn-outline-warning ml-1" onclick="togglePin('${group.bubble_id}', ${!group.is_pinned})">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;

    return col;
}

function updateUnassignedDevices() {
    const container = document.getElementById('unassigned-devices');
    const assignedMacs = new Set();

    groups.forEach(g => {
        (g.devices || []).forEach(mac => assignedMacs.add(mac.toUpperCase()));
    });

    const unassigned = allDevices.filter(d => !assignedMacs.has(d.mac_address.toUpperCase()));

    if (unassigned.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-muted text-center py-3">
                <i class="fas fa-check-circle mr-1"></i>
                All devices are assigned to groups
            </div>
        `;
        return;
    }

    container.innerHTML = '';
    unassigned.forEach(device => {
        const div = document.createElement('div');
        div.className = 'col-md-3 col-sm-4 mb-2';
        div.innerHTML = `
            <div class="device-item d-flex justify-content-between align-items-center p-2 bg-light rounded"
                 draggable="true" data-mac="${device.mac_address}" data-group="">
                <div>
                    <i class="fas fa-question-circle mr-2 text-warning"></i>
                    <span class="device-name">${device.hostname || device.friendly_name || device.mac_address.substr(0,11)}</span>
                    <small class="text-muted d-block ml-4">${device.manufacturer || 'Unknown'}</small>
                </div>
            </div>
        `;
        container.appendChild(div);
    });

    initDragDrop();
}

function initDragDrop() {
    // Make devices draggable
    document.querySelectorAll('.device-item[draggable="true"]').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });

    // Make dropzones accept drops
    document.querySelectorAll('.dropzone, .group-devices').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragleave', handleDragLeave);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify({
        mac: this.dataset.mac,
        fromGroup: this.dataset.group
    }));
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.dropzone').forEach(z => z.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault();
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const toGroup = this.dataset.groupId;

        if (toGroup && data.mac) {
            moveDevice(data.mac, data.fromGroup, toGroup);
        }
    } catch (err) {
        console.error('Drop error:', err);
    }
}

function moveDevice(mac, fromGroup, toGroup) {
    fetch('/bubbles/api/move-device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            mac: mac,
            from_bubble: fromGroup || null,
            to_bubble: toGroup
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadGroups();
            toastr.success(`Device moved to group`);
        } else {
            toastr.error(data.error || 'Failed to move device');
        }
    })
    .catch(err => {
        console.error('Move error:', err);
        toastr.error('Failed to move device');
    });
}

function removeDevice(groupId, mac) {
    if (!confirm('Remove device from group?')) return;

    fetch(`/bubbles/api/${groupId}/devices/${mac}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadGroups();
                toastr.success('Device removed');
            } else {
                toastr.error(data.error || 'Failed to remove device');
            }
        });
}

function showCreateGroupModal() {
    document.getElementById('createGroupForm').reset();
    $('#createGroupModal').modal('show');
}

function createGroup() {
    const name = document.getElementById('groupName').value;
    const type = document.getElementById('groupType').value;
    const icon = document.getElementById('groupIcon').value;
    const color = document.getElementById('groupColor').value;

    if (!name) {
        toastr.error('Please enter a group name');
        return;
    }

    fetch('/bubbles/api/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            bubble_type: type,
            icon: icon,
            color: color,
            devices: []
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            $('#createGroupModal').modal('hide');
            loadGroups();
            toastr.success(`Group "${name}" created`);
        } else {
            toastr.error(data.error || 'Failed to create group');
        }
    });
}

function editGroup(groupId) {
    const group = groups.find(g => g.bubble_id === groupId);
    if (!group) return;

    document.getElementById('editGroupId').value = groupId;
    document.getElementById('editGroupName').value = group.display_name || '';
    document.getElementById('editGroupType').value = group.bubble_type || 'custom';
    document.getElementById('editGroupIcon').value = group.icon || 'fa-layer-group';
    document.getElementById('editGroupColor').value = group.color || '#9C27B0';
    document.getElementById('editGroupPinned').checked = group.is_pinned;

    // Show warning and hide delete button for system groups (e.g., Quarantine)
    const isSystem = group.is_system || group.bubble_type === 'quarantine';
    document.getElementById('systemGroupWarning').classList.toggle('d-none', !isSystem);
    document.getElementById('deleteGroupBtn').classList.toggle('d-none', isSystem);

    $('#editGroupModal').modal('show');
}

function saveGroup() {
    const groupId = document.getElementById('editGroupId').value;

    fetch(`/bubbles/api/${groupId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            display_name: document.getElementById('editGroupName').value,
            bubble_type: document.getElementById('editGroupType').value,
            icon: document.getElementById('editGroupIcon').value,
            color: document.getElementById('editGroupColor').value,
            is_pinned: document.getElementById('editGroupPinned').checked
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            $('#editGroupModal').modal('hide');
            loadGroups();
            toastr.success('Group updated');
        } else {
            toastr.error(data.error || 'Failed to update group');
        }
    });
}

function deleteGroup() {
    const groupId = document.getElementById('editGroupId').value;
    if (!confirm('Delete this group? Devices will become unassigned.')) return;

    fetch(`/bubbles/api/${groupId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                $('#editGroupModal').modal('hide');
                loadGroups();
                toastr.success('Group deleted');
            } else {
                toastr.error(data.error || 'Failed to delete group');
            }
        });
}

function togglePin(groupId, pin) {
    const endpoint = pin ? 'pin' : 'unpin';
    fetch(`/bubbles/api/${groupId}/${endpoint}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadGroups();
                toastr.success(pin ? 'Group pinned' : 'Group unpinned');
            }
        });
}

function loadSuggestions() {
    const container = document.getElementById('suggestions-container');
    const body = document.getElementById('suggestions-body');

    fetch('/bubbles/api/suggestions')
        .then(r => r.json())
        .then(data => {
            const suggestions = data.suggestions || [];

            if (suggestions.length === 0) {
                body.innerHTML = '<p class="text-muted"><i class="fas fa-check-circle mr-1"></i>No suggestions at this time</p>';
            } else {
                body.innerHTML = suggestions.map(s => `
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-lightbulb mr-2"></i>
                            ${s.message}
                            <span class="badge badge-primary ml-2">Affinity: ${(s.affinity * 100).toFixed(0)}%</span>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="applySuggestion(${JSON.stringify(s.action).replace(/"/g, '&quot;')})">
                            <i class="fas fa-check mr-1"></i>Apply
                        </button>
                    </div>
                `).join('');
            }

            container.style.display = 'block';
            $(container).find('.card').removeClass('collapsed-card');
        });
}

function applySuggestion(action) {
    if (action.type === 'move_device') {
        moveDevice(action.mac, action.from_bubble, action.to_bubble);
    } else if (action.type === 'add_device') {
        fetch(`/bubbles/api/${action.bubble_id}/devices`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mac: action.mac })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadGroups();
                toastr.success('Device added to group');
            }
        });
    }
}
</script>

<style>
.group-card {
    transition: transform 0.2s;
}
.group-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.device-item {
    cursor: grab;
    transition: background-color 0.2s;
}
.device-item:hover {
    background-color: #e9ecef !important;
}
.device-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}
.dropzone.drag-over {
    background-color: #d4edda;
    border: 2px dashed #28a745;
}
.badge-sm {
    font-size: 0.7rem;
    padding: 0.2em 0.5em;
}
.group-devices {
    min-height: 100px;
    border: 1px dashed #dee2e6;
    border-radius: 4px;
    padding: 8px;
}
/* Quarantine group highlight */
.group-card[data-group-id*="QUARANTINE"] {
    border-left-color: #F44336 !important;
}
</style>
{% endblock %}
