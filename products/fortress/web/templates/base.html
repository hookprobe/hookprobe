<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="HookProbe Fortress - Small Business Security Gateway">
    <!-- Mobile touch behavior -->
    <meta name="format-detection" content="telephone=no">
    <title>{% block title %}HookProbe Fortress{% endblock %}</title>

    <!-- Google Fonts - Inter (Premium UI font) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Font Awesome 6.5.1 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- AdminLTE 3.2.0 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2.0/dist/css/adminlte.min.css" crossorigin="anonymous">
    <!-- Toastr 2.1.4 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- DataTables 1.13.7 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css" crossorigin="anonymous">
    <!-- Fortress Unified Design System (AdminLTE + Component Library) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,{% filter urlencode %}<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23002742'/><path d='M50 15L20 30v40l30 15 30-15V30L50 15z' fill='%23e69500'/><path d='M50 25L30 35v30l20 10 20-10V35L50 25z' fill='%23002742'/></svg>{% endfilter %}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#002742">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Eyes">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/aiochi-icon-192.png') }}">

    {% block extra_css %}{% endblock %}
</head>
<body class="hold-transition sidebar-mini sidebar-collapse layout-fixed dark-mode">
<div class="wrapper">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-dark">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="{{ url_for('dashboard.index') }}" class="nav-link">
                    <i class="fas fa-fort-awesome mr-1"></i> Fortress
                </a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <!-- Live Status Indicator -->
            <li class="nav-item">
                <span class="nav-link" id="live-indicator">
                    <span class="live-dot"></span>
                    <span class="d-none d-md-inline">Live</span>
                </span>
            </li>

            <!-- QSecBit RAG Status -->
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('security.index') }}" title="Security Status">
                    <span class="status-badge rag-green" id="qsecbit-badge">GREEN</span>
                </a>
            </li>

            <!-- Notifications -->
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge" id="notification-count">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">Notifications</span>
                    <div class="dropdown-divider"></div>
                    <div id="notification-list">
                        <a href="{{ url_for('security.index') }}" class="dropdown-item">
                            <i class="fas fa-shield-halved mr-2 text-success"></i> No active threats
                        </a>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('security.index') }}" class="dropdown-item dropdown-footer">View All</a>
                </div>
            </li>

            <!-- User Menu -->
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-user-circle"></i>
                    <span class="d-none d-md-inline ml-1">{{ current_user.display_name or current_user.id }}</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a href="{{ url_for('auth.profile') }}" class="dropdown-item">
                        <i class="fas fa-user mr-2"></i> Profile
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('auth.logout') }}" class="dropdown-item text-danger">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </a>
                </div>
            </li>
        </ul>
    </nav>

    <!-- Main Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="{{ url_for('dashboard.index') }}" class="brand-link d-flex align-items-center">
            <span class="brand-logo ml-2" style="width: 32px; height: 32px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 860 1080" style="width: 100%; height: 100%;">
                    <g transform="matrix(1 0 0 1 540 540)">
                        <g transform="matrix(1 0 0 1 -104.29 0)">
                            <path style="fill: #e69500;" transform="translate(-1393.9, -335.11)" d="M 1579.57 92.7761 C 1595.97 121.984 1612.04 150.374 1627.68 178.997 C 1631.63 186.349 1637.17 192.727 1643.89 197.665 C 1668.28 215.777 1680.83 240.452 1679.97 270.579 C 1678.5 321.857 1679.22 373.196 1675.79 424.413 C 1673.98 451.309 1660.89 471.825 1639.35 487.11 C 1633.49 491.161 1628.58 496.43 1624.94 502.557 C 1610.5 526.828 1595.42 550.726 1581.17 575.108 C 1568 597.663 1548.98 607.941 1522.86 606.699 C 1494.26 605.336 1465.61 605.013 1436.98 604.145 C 1430.48 603.943 1424.64 605.427 1418.63 608.143 C 1390.32 620.955 1362.01 620.47 1335.07 604.811 C 1291.71 579.654 1248.67 553.954 1205.96 527.717 C 1181.13 512.441 1166.77 489.856 1165.14 460.083 C 1164.81 454.025 1162.88 448.513 1159.91 443.162 C 1145.79 417.78 1132.35 392.015 1117.8 366.896 C 1104.75 344.412 1104.01 322.826 1118.22 300.665 C 1129.6 282.916 1139.65 264.299 1151.42 246.823 C 1160.99 232.597 1166.44 217.817 1167.87 200.562 C 1170.18 172.626 1184.3 150.839 1208.59 136.765 C 1254.02 110.424 1299.98 84.9516 1347.14 61.8315 C 1373.03 49.1507 1399.65 50.5339 1425.3 63.4771 C 1431.65 66.7045 1438.7 68.3333 1445.82 68.2223 C 1474.47 68.2122 1503.12 68.4747 1531.78 68.7069 C 1551.28 68.8684 1567.36 76.0973 1579.57 92.7761 M 1430.03 420.648 C 1414.63 445.252 1399.36 469.917 1383.81 494.42 C 1375.05 508.211 1374.51 521.801 1382.98 535.895 C 1388.1 544.406 1393.2 552.998 1397.48 561.943 C 1404.47 576.532 1416.42 583.175 1431.77 583.75 C 1464.33 584.982 1496.92 585.598 1529.5 586.446 C 1544.02 586.82 1554.66 580.035 1562.06 568.011 C 1574.14 548.384 1586.02 528.615 1597.93 508.867 C 1623.38 466.615 1624.94 472.42 1597.03 421.879 C 1588.12 405.756 1574.86 399.082 1557 399.062 C 1527.58 399.032 1498.16 398.517 1468.74 398.285 C 1466.13 398.264 1463.05 397.265 1460.99 400.97 C 1465.08 414.237 1472.54 426.715 1475.03 440.87 C 1475.61 444.242 1477.31 448.321 1473.11 450.512 C 1469.1 452.612 1466.34 449.371 1463.82 447.009 C 1455.08 438.821 1447.53 429.583 1440.62 419.84 C 1437.32 415.186 1434.44 413.681 1430.03 420.648 M 1605.02 239.14 C 1619.83 220.664 1619.79 202.39 1607.25 182.107 C 1592.64 158.472 1580.13 133.544 1566.74 109.162 C 1559.16 95.3405 1547.69 88.7174 1531.79 88.6467 C 1500.79 88.5155 1469.8 87.6775 1438.79 87.4453 C 1422.63 87.3242 1409.43 93.0083 1401.21 108.031 C 1396.08 117.431 1390.28 126.487 1384.64 135.614 C 1376.79 148.305 1376.73 160.965 1384.12 173.858 C 1399.14 200.057 1414.06 226.317 1429.11 252.497 C 1430.8 255.435 1431.95 259.221 1436.8 259.695 C 1444.48 250.336 1451.97 240.583 1460.16 231.456 C 1464.14 226.994 1468.71 218.947 1475.18 222.642 C 1481.71 226.368 1476.62 234.142 1475.22 240.028 C 1472.59 251.063 1465.51 260.695 1464.22 272.76 C 1467.13 273.315 1469.4 274.082 1471.7 274.143 C 1500.3 274.94 1528.9 275.435 1557.49 276.455 C 1574.26 277.05 1586.71 270.781 1594.78 255.869 C 1597.6 250.639 1601.05 245.732 1605.02 239.14 M 1324.69 349.52 C 1307.23 346.633 1288.68 347.481 1271.18 335.345 C 1290.34 322.12 1311.72 326.713 1331.14 318.626 C 1313.81 288.621 1297.2 259.281 1279.95 230.326 C 1275.55 222.945 1267.67 218.735 1259.01 217.917 C 1245.56 216.632 1232.06 215.831 1218.55 215.515 C 1202.25 215.161 1189.54 221.522 1180.9 236.101 C 1165.68 261.765 1149.98 287.147 1134.28 312.508 C 1125.68 326.4 1125.75 340.161 1133.51 354.255 C 1148.28 381.101 1162.93 407.997 1177.72 434.823 C 1185.11 448.23 1196.8 454.712 1211.92 455.005 C 1224.25 455.237 1236.6 455.035 1248.92 455.247 C 1260.62 455.449 1270.5 450.825 1276.66 441.486 C 1294.61 414.257 1311.71 386.472 1329.09 358.869 C 1331.5 355.033 1332.44 351.338 1324.69 349.52 M 1448.27 301.574 C 1446.49 306.158 1441.91 309.863 1443.72 316.042 C 1445.69 316.375 1447.6 316.9 1449.53 317.001 C 1478.9 318.465 1508.29 319.616 1537.65 321.403 C 1553.89 322.392 1570.02 324.825 1585.86 328.642 C 1590.25 329.692 1596.65 330.095 1596.54 336.103 C 1596.44 341.958 1589.94 342.17 1585.65 343.604 C 1581.1 345.055 1576.43 346.056 1571.69 346.593 C 1532.63 351.429 1493.44 354.286 1454.06 353.953 C 1449.53 353.922 1444.48 352.297 1439.51 357.244 C 1445.51 364.291 1442.79 378.163 1457.66 378.294 C 1491.83 378.597 1526.01 378.607 1560.18 379.253 C 1584.97 379.718 1603.27 391.187 1614.74 413.469 C 1622.67 428.906 1632.73 443.263 1637.45 461.375 C 1647.14 453.965 1651.24 444.505 1654.23 434.802 C 1656.47 427.582 1657.55 420.056 1657.44 412.5 C 1656.64 362.787 1661.35 313.144 1659.72 263.421 C 1659.12 245.429 1651.76 230.548 1636.98 217.746 C 1631.14 237.565 1619.89 251.739 1611.04 267.207 C 1599.53 287.359 1582.09 297.091 1558.88 296.516 C 1527.08 295.728 1495.28 294.961 1463.49 294.194 C 1457.86 294.052 1452.12 293.669 1448.27 301.574 M 1250.88 135.836 C 1237.35 144.145 1222.14 149.718 1210 160.259 C 1198.14 170.557 1189.7 182.874 1188.26 200.885 C 1209.33 194.454 1229.23 197.867 1248.96 197.16 C 1272.75 196.292 1290.23 206.872 1301.92 227.297 C 1317.33 254.213 1332.63 281.19 1347.95 308.157 C 1355.09 320.716 1358.6 321.847 1372.91 315.396 C 1370.35 310.469 1367.89 305.532 1365.25 300.685 C 1346.6 266.46 1327.75 232.315 1314.01 195.726 C 1311.23 188.316 1303.89 177.503 1311.38 172.828 C 1320.4 167.205 1326.01 179.411 1331.2 185.59 C 1354.5 213.415 1373.45 244.289 1392.65 274.981 C 1397.61 282.926 1400.77 292.185 1410.41 300.564 C 1414.68 290.398 1426.39 286.521 1419.58 274.506 C 1402.32 244.077 1384.13 214.192 1366.82 183.803 C 1355.42 163.802 1356.01 143.671 1368.41 123.983 C 1378.61 107.759 1386.48 89.9794 1403.39 76.1478 C 1383.87 72.5031 1367.72 72.8665 1352.19 81.2867 C 1318.99 99.2881 1285.67 117.088 1250.88 135.836 M 1306.5 432.369 C 1304.38 435.731 1302.07 438.982 1300.16 442.465 C 1287.18 466.181 1267.28 476.822 1240.27 475.631 C 1222.55 474.854 1204.7 476.257 1186.37 470.038 C 1190.71 486.828 1198.71 499.761 1211.98 507.858 C 1257.81 535.822 1303.93 563.296 1350.35 590.272 C 1364.76 598.642 1380.88 598.178 1398.88 594.392 C 1381.91 579.732 1375.08 561.105 1365.29 544.386 C 1353 523.345 1354.56 502.911 1367.6 482.607 C 1383.74 457.509 1399.41 432.127 1415.23 406.836 C 1423.66 393.358 1422.12 387.058 1407.31 376.639 L 1400.49 387.583 C 1378.38 423 1356.96 458.932 1329.23 490.402 C 1325.11 495.076 1320.36 504.324 1313.6 500.306 C 1306.27 495.955 1311.92 487.1 1314.18 480.8 C 1324.87 450.734 1339.67 422.546 1354.73 394.509 C 1361.82 381.323 1369.08 368.218 1376.83 354.054 C 1367.2 352.489 1358.97 347.037 1352.46 357.779 C 1337.63 382.262 1322.46 406.543 1306.5 432.369 M 1415.1 321.645 C 1410.51 327.107 1405.6 328.51 1399.36 321.595 C 1402.68 331.994 1397.15 334.891 1388.78 336.345 C 1396.83 339.152 1400.67 342.877 1398.27 352.59 C 1405.89 346.693 1404.59 347.006 1408.51 347.239 C 1413.04 348.087 1415.09 351.196 1419.7 355.406 C 1417.61 345.946 1417.29 339.162 1428.61 336.194 C 1415.61 336.83 1416.97 328.046 1415.1 321.645 Z"/>
                        </g>
                    </g>
                </svg>
            </span>
            <span class="brand-text ml-2" style="font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px;">HOOKPROBE</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Menu - 5 Tab Structure -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column nav-child-indent" data-widget="treeview" role="menu" data-accordion="true">

                    <!-- 1. DASHBOARD -->
                    <li class="nav-item">
                        <a href="{{ url_for('dashboard.index') }}" class="nav-link {% if request.endpoint == 'dashboard.index' %}active{% endif %}">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>

                    <!-- 2. SDN AI (Unified Devices + VLANs + Network Control) -->
                    <li class="nav-item">
                        <a href="{{ url_for('sdn.index') }}" class="nav-link {% if 'clients' in request.endpoint or 'networks' in request.endpoint or 'sdn' in request.endpoint %}active{% endif %}">
                            <i class="nav-icon fas fa-network-wired"></i>
                            <p>
                                SDN AI
                                <span class="badge badge-info right" id="sidebar-devices-badge">0</span>
                            </p>
                        </a>
                    </li>

                    <!-- 3. AI SECURITY (Unified QSecBit + dnsXai) -->
                    <li class="nav-item">
                        <a href="{{ url_for('security.index') }}" class="nav-link {% if 'security' in request.endpoint or 'dnsxai' in request.endpoint %}active{% endif %}">
                            <i class="nav-icon fas fa-shield-halved"></i>
                            <p>
                                AI Security
                                <span class="badge right sidebar-rag-badge rag-green" id="sidebar-rag-badge">GREEN</span>
                            </p>
                        </a>
                    </li>

                    <!-- 4. REMOTE ACCESS (Cloudflare Tunnel) -->
                    <li class="nav-item">
                        <a href="{{ url_for('tunnel.index') }}" class="nav-link {% if 'tunnel' in request.endpoint %}active{% endif %}">
                            <i class="nav-icon fas fa-cloud"></i>
                            <p>Remote Access</p>
                        </a>
                    </li>

                    <!-- 5. AIOCHI (Cognitive Network Layer) -->
                    <li class="nav-item">
                        <a href="{{ url_for('aiochi.index') }}" class="nav-link {% if request.endpoint == 'aiochi.index' %}active{% endif %}">
                            <i class="nav-icon fas fa-eye"></i>
                            <p>AIOCHI</p>
                        </a>
                    </li>

                    <!-- 6. CORTEX (Neural Command Center - 3D Globe) -->
                    <li class="nav-item">
                        <a href="{{ url_for('aiochi.cortex') }}" class="nav-link {% if request.endpoint == 'aiochi.cortex' %}active{% endif %}">
                            <i class="nav-icon fas fa-globe"></i>
                            <p>Cortex</p>
                        </a>
                    </li>

                    <!-- 7. AEGIS (AI Security Assistant) -->
                    <li class="nav-item">
                        <a href="{{ url_for('aegis.index') }}" class="nav-link {% if request.endpoint and 'aegis' in request.endpoint %}active{% endif %}">
                            <i class="nav-icon fas fa-robot"></i>
                            <p>AEGIS</p>
                        </a>
                    </li>

                    <!-- 8. SETTINGS (Admin only) -->
                    {% if current_user.is_admin %}
                    <li class="nav-header">ADMIN</li>
                    <li class="nav-item {% if 'settings' in request.endpoint %}menu-open{% endif %}">
                        <a href="#" class="nav-link {% if 'settings' in request.endpoint %}active{% endif %}">
                            <i class="nav-icon fas fa-cog"></i>
                            <p>
                                Settings
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="{{ url_for('settings.index') }}" class="nav-link {% if request.endpoint == 'settings.index' %}active{% endif %}">
                                    <i class="fas fa-sliders-h nav-icon"></i>
                                    <p>System</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('settings.users') }}" class="nav-link {% if request.endpoint == 'settings.users' %}active{% endif %}">
                                    <i class="fas fa-users-cog nav-icon"></i>
                                    <p>Users</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}

                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        {% block content_header %}
        <!-- Content Header -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        {% block page_header %}
                        <h1 class="m-0">{% block page_title %}Home{% endblock %}</h1>
                        {% endblock %}
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            {% block breadcrumb %}
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
                            {% endblock %}
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        {% endblock %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="container-fluid">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                {% block content %}{% endblock %}
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <strong>&copy; {{ now.year if now else 2024 }} <a href="https://hookprobe.com">HookProbe</a></strong>
        <span class="float-right d-none d-sm-inline-block">
            <i class="fas fa-shield-halved text-warning"></i> One node's detection &rarr; Everyone's protection
        </span>
    </footer>
</div>

<!-- jQuery 3.6.0 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
<!-- Bootstrap 4.6.0 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<!-- AdminLTE 3.2.0 -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2.0/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
<!-- Toastr 2.1.4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- DataTables 1.13.7 -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>
<!-- Toastr configuration -->
<script>
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "3000",
        "extendedTimeOut": "1000",
        "showMethod": "slideDown",
        "hideMethod": "slideUp",
        "newestOnTop": true
    };
    // Offset toastr below navbar
    document.addEventListener('DOMContentLoaded', function() {
        const style = document.createElement('style');
        style.textContent = '#toast-container.toast-top-right { top: 70px !important; right: 20px !important; }';
        document.head.appendChild(style);
    });
</script>
<!-- Fortress Component Library -->
<script src="{{ url_for('static', filename='js/components.js') }}"></script>
<!-- Fortress JS -->
<script src="{{ url_for('static', filename='js/fortress.js') }}"></script>

<!-- Mobile Touch Support -->
<script>
(function() {
    'use strict';

    // Detect if device has touch capability
    var isTouchDevice = ('ontouchstart' in window) ||
        (navigator.maxTouchPoints > 0) ||
        (navigator.msMaxTouchPoints > 0);

    if (isTouchDevice) {
        document.documentElement.classList.add('touch-device');

        // Fix AdminLTE sidebar toggle for touch devices
        document.addEventListener('DOMContentLoaded', function() {
            var pushMenuBtn = document.querySelector('[data-widget="pushmenu"]');
            if (pushMenuBtn) {
                // Add explicit touch handler
                pushMenuBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Trigger AdminLTE's pushmenu
                    if (typeof $ !== 'undefined' && $.fn.PushMenu) {
                        $('[data-widget="pushmenu"]').PushMenu('toggle');
                    } else {
                        // Fallback: toggle sidebar-open class manually
                        document.body.classList.toggle('sidebar-open');
                        document.body.classList.toggle('sidebar-collapse');
                    }
                }, { passive: false });
            }

            // Fix dropdown toggles for touch
            document.querySelectorAll('[data-toggle="dropdown"]').forEach(function(el) {
                el.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (typeof $ !== 'undefined') {
                        $(this).dropdown('toggle');
                    }
                }, { passive: false });
            });

            // Ensure all nav-links have touch support
            document.querySelectorAll('.nav-link:not([data-toggle])').forEach(function(el) {
                el.addEventListener('touchend', function(e) {
                    // Allow link navigation
                    if (this.href && !this.href.endsWith('#')) {
                        window.location.href = this.href;
                    }
                });
            });

            // Fix sidebar treeview menus for touch
            document.querySelectorAll('.nav-treeview').forEach(function(menu) {
                var parent = menu.previousElementSibling;
                if (parent && parent.classList.contains('nav-link')) {
                    parent.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        var menuItem = this.closest('.nav-item');
                        if (menuItem) {
                            menuItem.classList.toggle('menu-open');
                        }
                    }, { passive: false });
                }
            });
        });

        // Close sidebar when tapping outside on mobile
        document.addEventListener('touchstart', function(e) {
            var sidebar = document.querySelector('.main-sidebar');
            var pushMenuBtn = document.querySelector('[data-widget="pushmenu"]');
            if (sidebar && document.body.classList.contains('sidebar-open')) {
                if (!sidebar.contains(e.target) && (!pushMenuBtn || !pushMenuBtn.contains(e.target))) {
                    document.body.classList.remove('sidebar-open');
                    document.body.classList.add('sidebar-collapse');
                }
            }
        }, { passive: true });
    }

    // Add fast-click behavior for all clickable elements
    document.addEventListener('DOMContentLoaded', function() {
        // Remove any existing fastclick (we use touch-action: manipulation instead)
        // But ensure click events fire immediately on touch
        document.querySelectorAll('a, button, .btn, [role="button"]').forEach(function(el) {
            if (!el.dataset.touchHandled) {
                el.dataset.touchHandled = 'true';
                // The CSS touch-action: manipulation removes the 300ms delay
                // This JS is just for edge cases
            }
        });
    });
})();
</script>

<!-- Live Status Polling -->
<script>
(function() {
    // Update QSecBit badge
    function updateQSecBitBadge(status) {
        const badge = document.getElementById('qsecbit-badge');
        const sidebarBadge = document.getElementById('sidebar-rag-badge');
        if (!badge) return;

        const statusLower = status.toLowerCase();
        badge.className = 'status-badge rag-' + statusLower;
        badge.textContent = status.toUpperCase();

        if (sidebarBadge) {
            // Use RAG-specific classes for dynamic coloring
            sidebarBadge.className = 'badge right sidebar-rag-badge rag-' + statusLower;
            sidebarBadge.textContent = status.toUpperCase();
        }
    }

    // Update SDN devices badge
    function updateDevicesBadge(count) {
        const badge = document.getElementById('sidebar-devices-badge');
        if (badge && count !== undefined) {
            badge.textContent = count;
        }
    }

    // Poll status
    function pollStatus() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                if (data.qsecbit && data.qsecbit.status) {
                    updateQSecBitBadge(data.qsecbit.status);
                }
                if (data.notification_count !== undefined) {
                    document.getElementById('notification-count').textContent = data.notification_count;
                }
                if (data.device_count !== undefined) {
                    updateDevicesBadge(data.device_count);
                }
            })
            .catch(() => {});
    }

    // Start polling every 10 seconds
    setInterval(pollStatus, 10000);
    pollStatus();
})();
</script>

<!-- AIOCHI Push Notifications -->
<script src="{{ url_for('static', filename='js/push-notifications.js') }}"></script>

{% block extra_js %}{% endblock %}
</body>
</html>
