{% extends "base.html" %}

{% block title %}AIOCHI - HookProbe Fortress{% endblock %}

{% block page_title %}AIOCHI{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
<li class="breadcrumb-item active">AIOCHI</li>
{% endblock %}

{% block extra_css %}
<style>
    /* AIOCHI Dashboard - Cognitive Network Layer */
    :root {
        --aiochi-calm: #81c784;
        --aiochi-curious: #ffb74d;
        --aiochi-alert: #e57373;
        --aiochi-primary: #4fc3f7;
        --aiochi-bg-dark: #1a1a2e;
        --aiochi-bg-card: #16213e;
        --aiochi-text: #e8e8e8;
        --aiochi-text-muted: #8b8b9a;
    }

    .aiochi-container {
        padding: 0;
    }

    /* Ambient State Banner */
    .ambient-banner {
        background: linear-gradient(135deg, var(--aiochi-bg-card) 0%, #0f3460 100%);
        border-radius: 12px;
        padding: 24px 32px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .ambient-state {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .ambient-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        transition: all 0.5s ease;
    }

    .ambient-icon.calm {
        background: linear-gradient(135deg, rgba(129, 199, 132, 0.2) 0%, rgba(129, 199, 132, 0.1) 100%);
        color: var(--aiochi-calm);
        box-shadow: 0 0 30px rgba(129, 199, 132, 0.3);
    }

    .ambient-icon.curious {
        background: linear-gradient(135deg, rgba(255, 183, 77, 0.2) 0%, rgba(255, 183, 77, 0.1) 100%);
        color: var(--aiochi-curious);
        box-shadow: 0 0 30px rgba(255, 183, 77, 0.3);
        animation: pulse-curious 2s ease-in-out infinite;
    }

    .ambient-icon.alert {
        background: linear-gradient(135deg, rgba(229, 115, 115, 0.2) 0%, rgba(229, 115, 115, 0.1) 100%);
        color: var(--aiochi-alert);
        box-shadow: 0 0 30px rgba(229, 115, 115, 0.4);
        animation: pulse-alert 1s ease-in-out infinite;
    }

    @keyframes pulse-curious {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.9; }
    }

    @keyframes pulse-alert {
        0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(229, 115, 115, 0.4); }
        50% { transform: scale(1.08); box-shadow: 0 0 50px rgba(229, 115, 115, 0.6); }
    }

    .ambient-text h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--aiochi-text);
    }

    .ambient-text p {
        margin: 0;
        color: var(--aiochi-text-muted);
        font-size: 0.95rem;
    }

    .whisper-badge {
        background: rgba(79, 195, 247, 0.1);
        border: 1px solid rgba(79, 195, 247, 0.3);
        border-radius: 20px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--aiochi-primary);
    }

    .whisper-phase {
        font-size: 1.2rem;
    }

    /* L1 Trust Indicator (in Ambient Banner) */
    .l1-trust-container {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 8px 16px;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .l1-trust-gauge {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .l1-trust-icon {
        font-size: 1.1rem;
        color: var(--aiochi-primary);
    }

    .l1-trust-bar {
        width: 80px;
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .l1-trust-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease, background 0.3s ease;
    }

    .l1-trust-fill.trusted { background: var(--aiochi-calm); }
    .l1-trust-fill.suspicious { background: var(--aiochi-curious); }
    .l1-trust-fill.hostile { background: var(--aiochi-alert); }

    .l1-trust-value {
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 32px;
        color: var(--aiochi-text);
    }

    .l1-trust-label {
        font-size: 0.65rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Survival Mode Toggle */
    .survival-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.03);
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .survival-toggle:hover {
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.2);
    }

    .survival-toggle.active {
        background: rgba(229, 115, 115, 0.15);
        border-color: rgba(229, 115, 115, 0.4);
        color: var(--aiochi-alert);
        animation: survival-pulse 1.5s ease-in-out infinite;
    }

    .survival-toggle i {
        font-size: 0.9rem;
    }

    .survival-toggle .survival-status {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    @keyframes survival-pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(229, 115, 115, 0.4); }
        50% { box-shadow: 0 0 12px 2px rgba(229, 115, 115, 0.3); }
    }

    /* L1 Status Hidden by Default (no LTE modem) */
    .l1-trust-container.hidden {
        display: none;
    }

    /* Ambient Banner Right Side Layout */
    .ambient-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    /* Three Pillars Grid */
    .pillars-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
        .pillars-grid {
            grid-template-columns: 1fr;
        }
    }

    .pillar-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .pillar-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pillar-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .pillar-title i {
        font-size: 1.2rem;
    }

    .pillar-title h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: var(--aiochi-text);
    }

    .pillar-title span {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        font-weight: 400;
    }

    .pillar-body {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* PRESENCE - Device Bubbles */
    .presence-icon { color: var(--aiochi-primary); }

    .bubble-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .bubble-item {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: all 0.3s ease;
    }

    .bubble-item:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
    }

    .bubble-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .bubble-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .bubble-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .bubble-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--aiochi-text);
    }

    .bubble-meta {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .trust-badge {
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .trust-CORE { background: rgba(129, 199, 132, 0.2); color: #81c784; }
    .trust-TRUSTED { background: rgba(79, 195, 247, 0.2); color: #4fc3f7; }
    .trust-KNOWN { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .trust-VISITOR { background: rgba(186, 104, 200, 0.2); color: #ba68c8; }

    .bubble-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .device-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 4px 10px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .device-chip.online {
        color: var(--aiochi-calm);
    }

    .device-chip i {
        font-size: 0.7rem;
    }

    /* AI ACTIVITY - What I'm Doing */
    .ai-activity-icon { color: var(--aiochi-primary); }

    .ai-feed-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ai-feed-empty {
        text-align: center;
        padding: 32px 16px;
        color: var(--aiochi-text-muted);
    }

    .ai-feed-empty i {
        font-size: 2rem;
        color: var(--aiochi-calm);
        margin-bottom: 12px;
        display: block;
    }

    .ai-feed-empty p {
        font-size: 0.85rem;
        line-height: 1.5;
        margin: 0;
    }

    .ai-feed-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
    }

    .ai-feed-item:hover {
        background: rgba(255,255,255,0.04);
    }

    .ai-feed-item.success { border-left-color: var(--aiochi-calm); }
    .ai-feed-item.warning { border-left-color: var(--aiochi-curious); }
    .ai-feed-item.info { border-left-color: var(--aiochi-primary); }
    .ai-feed-item.danger { border-left-color: var(--aiochi-alert); }

    /* Auto-execute countdown indicator */
    .ai-feed-item.pending {
        border-left-color: var(--aiochi-curious);
        background: rgba(255, 183, 77, 0.05);
    }

    .ai-feed-item.pending::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--aiochi-curious);
        animation: countdown-bar 120s linear forwards;
    }

    @keyframes countdown-bar {
        from { width: 100%; }
        to { width: 0%; }
    }

    .ai-feed-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.85rem;
    }

    .ai-feed-icon.success { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .ai-feed-icon.warning { background: rgba(255, 183, 77, 0.15); color: var(--aiochi-curious); }
    .ai-feed-icon.info { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .ai-feed-icon.danger { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }

    .ai-feed-content {
        flex: 1;
        min-width: 0;
    }

    .ai-feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .ai-feed-headline {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--aiochi-text);
    }

    .ai-feed-time {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .ai-feed-narrative {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
        line-height: 1.4;
    }

    /* Feedback buttons for AI decisions */
    .ai-feed-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .ai-feed-btn {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.03);
        color: var(--aiochi-text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }

    .ai-feed-btn:hover {
        background: rgba(255,255,255,0.08);
        color: var(--aiochi-text);
    }

    .ai-feed-btn.correct {
        border-color: rgba(129, 199, 132, 0.3);
    }

    .ai-feed-btn.correct:hover {
        background: rgba(129, 199, 132, 0.15);
        color: var(--aiochi-calm);
    }

    .ai-feed-btn.wrong {
        border-color: rgba(229, 115, 115, 0.3);
    }

    .ai-feed-btn.wrong:hover {
        background: rgba(229, 115, 115, 0.15);
        color: var(--aiochi-alert);
    }

    /* Countdown timer for pending actions */
    .ai-feed-countdown {
        font-size: 0.7rem;
        color: var(--aiochi-curious);
        font-weight: 600;
    }

    /* AI Notification Toast Container */
    #ai-notification-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
    }

    .ai-notification {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        background: var(--aiochi-bg-card);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        animation: notification-slide-in 0.3s ease;
    }

    .ai-notification.fade-out {
        animation: notification-fade-out 0.3s ease forwards;
    }

    @keyframes notification-slide-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes notification-fade-out {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .ai-notification.success { border-left: 3px solid var(--aiochi-calm); }
    .ai-notification.warning { border-left: 3px solid var(--aiochi-curious); }
    .ai-notification.info { border-left: 3px solid var(--aiochi-primary); }
    .ai-notification.danger { border-left: 3px solid var(--aiochi-alert); }

    .ai-notification-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1rem;
    }

    .ai-notification.success .ai-notification-icon { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .ai-notification.warning .ai-notification-icon { background: rgba(255, 183, 77, 0.15); color: var(--aiochi-curious); }
    .ai-notification.info .ai-notification-icon { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .ai-notification.danger .ai-notification-icon { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }

    .ai-notification-content {
        flex: 1;
        min-width: 0;
    }

    .ai-notification-headline {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--aiochi-text);
        margin-bottom: 4px;
    }

    .ai-notification-message {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
        line-height: 1.4;
    }

    .ai-notification-close {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        padding: 4px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .ai-notification-close:hover {
        opacity: 1;
    }

    /* Legacy feed-list support (backward compatibility) */
    .feed-list { display: flex; flex-direction: column; gap: 12px; }
    .feed-item { display: flex; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; border-left: 3px solid transparent; transition: all 0.3s ease; }
    .feed-item:hover { background: rgba(255,255,255,0.04); }
    .feed-item.success { border-left-color: var(--aiochi-calm); }
    .feed-item.warning { border-left-color: var(--aiochi-curious); }
    .feed-item.info { border-left-color: var(--aiochi-primary); }
    .feed-item.danger { border-left-color: var(--aiochi-alert); }
    .feed-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.85rem; }
    .feed-icon.success { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .feed-icon.warning { background: rgba(255, 183, 77, 0.15); color: var(--aiochi-curious); }
    .feed-icon.info { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .feed-icon.danger { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .feed-content { flex: 1; min-width: 0; }
    .feed-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .feed-title { font-weight: 600; font-size: 0.85rem; color: var(--aiochi-text); }
    .feed-time { font-size: 0.7rem; color: var(--aiochi-text-muted); }
    .feed-narrative { font-size: 0.8rem; color: var(--aiochi-text-muted); line-height: 1.4; }

    /* ==========================================================================
       USER PROMPT MODAL - Only shows when AI confidence < 30%
       ========================================================================== */

    #user-prompt-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: prompt-overlay-fade-in 0.3s ease;
    }

    #user-prompt-overlay.visible {
        display: flex;
    }

    @keyframes prompt-overlay-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .user-prompt-modal {
        background: var(--aiochi-bg-card);
        border-radius: 16px;
        border: 1px solid rgba(255, 183, 77, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 183, 77, 0.1);
        max-width: 520px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        animation: prompt-modal-slide-up 0.4s ease;
    }

    @keyframes prompt-modal-slide-up {
        from { transform: translateY(40px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .prompt-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(255, 183, 77, 0.15) 0%, rgba(255, 183, 77, 0.05) 100%);
        border-bottom: 1px solid rgba(255, 183, 77, 0.2);
    }

    .prompt-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(255, 183, 77, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--aiochi-curious);
        font-size: 1.5rem;
        flex-shrink: 0;
        animation: prompt-icon-pulse 2s ease-in-out infinite;
    }

    @keyframes prompt-icon-pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255, 183, 77, 0.4); }
        50% { box-shadow: 0 0 0 10px rgba(255, 183, 77, 0); }
    }

    .prompt-header-text h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--aiochi-text);
        margin: 0 0 4px 0;
    }

    .prompt-header-text p {
        font-size: 0.85rem;
        color: var(--aiochi-text-muted);
        margin: 0;
    }

    .prompt-body {
        padding: 24px;
    }

    .prompt-situation {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .prompt-situation-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--aiochi-text-muted);
        margin-bottom: 8px;
    }

    .prompt-situation-text {
        font-size: 0.95rem;
        color: var(--aiochi-text);
        line-height: 1.5;
    }

    .prompt-ai-analysis {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        background: rgba(79, 195, 247, 0.08);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(79, 195, 247, 0.2);
    }

    .prompt-ai-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(79, 195, 247, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--aiochi-primary);
        font-size: 0.85rem;
        flex-shrink: 0;
    }

    .prompt-ai-content {
        flex: 1;
    }

    .prompt-ai-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--aiochi-primary);
        margin-bottom: 4px;
    }

    .prompt-ai-text {
        font-size: 0.85rem;
        color: var(--aiochi-text);
        line-height: 1.5;
    }

    .prompt-confidence {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
    }

    .prompt-confidence-label {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
    }

    .prompt-confidence-bar {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .prompt-confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--aiochi-alert), var(--aiochi-curious));
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .prompt-confidence-value {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-curious);
        min-width: 40px;
        text-align: right;
    }

    .prompt-actions {
        display: flex;
        gap: 12px;
    }

    .prompt-btn {
        flex: 1;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
    }

    .prompt-btn-primary {
        background: linear-gradient(135deg, var(--aiochi-primary) 0%, #039be5 100%);
        color: white;
        box-shadow: 0 4px 16px rgba(79, 195, 247, 0.3);
    }

    .prompt-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 195, 247, 0.4);
    }

    .prompt-btn-secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--aiochi-text);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .prompt-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.12);
    }

    .prompt-btn-danger {
        background: rgba(229, 115, 115, 0.15);
        color: var(--aiochi-alert);
        border: 1px solid rgba(229, 115, 115, 0.3);
    }

    .prompt-btn-danger:hover {
        background: rgba(229, 115, 115, 0.25);
    }

    .prompt-footer {
        padding: 16px 24px;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .prompt-footer-text {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .prompt-dismiss {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        font-size: 0.8rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .prompt-dismiss:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--aiochi-text);
    }

    /* PERFORMANCE - Health Score */
    .performance-icon { color: var(--aiochi-curious); }

    .health-score-container {
        text-align: center;
        margin-bottom: 24px;
    }

    .health-gauge {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto 16px;
    }

    .health-gauge svg {
        transform: rotate(-90deg);
    }

    .health-gauge-bg {
        fill: none;
        stroke: rgba(255,255,255,0.1);
        stroke-width: 12;
    }

    .health-gauge-fill {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
    }

    .health-gauge-fill.good { stroke: var(--aiochi-calm); }
    .health-gauge-fill.warning { stroke: var(--aiochi-curious); }
    .health-gauge-fill.critical { stroke: var(--aiochi-alert); }

    .health-score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .health-score-number {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .health-score-number.good { color: var(--aiochi-calm); }
    .health-score-number.warning { color: var(--aiochi-curious); }
    .health-score-number.critical { color: var(--aiochi-alert); }

    .health-score-label {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .health-insight {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.85rem;
        color: var(--aiochi-text-muted);
        line-height: 1.5;
        margin-bottom: 20px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .health-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .metric-item {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .metric-label {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Quick Actions */
    .quick-actions-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .quick-actions-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--aiochi-text);
    }

    .quick-actions-title i {
        color: var(--aiochi-primary);
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    @media (max-width: 992px) {
        .quick-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px 12px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.06);
        transform: translateY(-2px);
    }

    .action-btn.active {
        border-color: var(--aiochi-primary);
        background: rgba(79, 195, 247, 0.1);
    }

    .action-btn i {
        font-size: 1.5rem;
    }

    .action-btn.warning i { color: var(--aiochi-curious); }
    .action-btn.info i { color: var(--aiochi-primary); }
    .action-btn.primary i { color: #ba68c8; }
    .action-btn.danger i { color: var(--aiochi-alert); }

    .action-btn span {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        line-height: 1.3;
    }

    .action-btn.active span {
        color: var(--aiochi-text);
    }

    /* Demo Mode Badge */
    .demo-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 183, 77, 0.15);
        color: var(--aiochi-curious);
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* =========================================================================
       L1/CELLULAR SECTION - Physical Layer Security (Collapsible)
       ========================================================================= */
    .l1-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    .l1-header {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .l1-header:hover {
        background: rgba(255,255,255,0.02);
    }

    .l1-card.collapsed .l1-body {
        display: none;
    }

    .l1-card.collapsed .l1-header {
        border-bottom: none;
    }

    .l1-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .l1-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .l1-title i {
        color: var(--aiochi-primary);
        font-size: 1rem;
    }

    /* L1 Summary badges (shown in header) */
    .l1-summary {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .l1-network-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
    }

    .l1-network-badge.lte { background: rgba(156, 39, 176, 0.15); color: #CE93D8; }
    .l1-network-badge.g5 { background: rgba(0, 150, 136, 0.15); color: #4DB6AC; }
    .l1-network-badge.g5sa { background: rgba(76, 175, 80, 0.15); color: #81C784; }
    .l1-network-badge.g4 { background: rgba(255, 152, 0, 0.15); color: #FFB74D; }
    .l1-network-badge.g3 { background: rgba(255, 87, 34, 0.15); color: #FF8A65; }
    .l1-network-badge.offline { background: rgba(158, 158, 158, 0.15); color: #9E9E9E; }

    .l1-signal-indicator {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 16px;
    }

    .l1-signal-bar {
        width: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        transition: background 0.3s;
    }

    .l1-signal-bar:nth-child(1) { height: 4px; }
    .l1-signal-bar:nth-child(2) { height: 7px; }
    .l1-signal-bar:nth-child(3) { height: 10px; }
    .l1-signal-bar:nth-child(4) { height: 13px; }
    .l1-signal-bar:nth-child(5) { height: 16px; }

    .l1-signal-indicator.excellent .l1-signal-bar { background: var(--aiochi-calm); }
    .l1-signal-indicator.good .l1-signal-bar:nth-child(-n+4) { background: var(--aiochi-calm); }
    .l1-signal-indicator.fair .l1-signal-bar:nth-child(-n+3) { background: var(--aiochi-curious); }
    .l1-signal-indicator.poor .l1-signal-bar:nth-child(-n+2) { background: var(--aiochi-alert); }
    .l1-signal-indicator.none .l1-signal-bar:nth-child(-n+1) { background: var(--aiochi-alert); }

    .l1-trust-mini {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .l1-trust-mini.trusted { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .l1-trust-mini.suspicious { background: rgba(255, 183, 77, 0.15); color: var(--aiochi-curious); }
    .l1-trust-mini.hostile { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }

    .l1-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        color: var(--aiochi-text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .l1-toggle:hover {
        background: rgba(255,255,255,0.06);
        color: var(--aiochi-text);
    }

    .l1-toggle i {
        transition: transform 0.3s ease;
    }

    .l1-card.collapsed .l1-toggle i {
        transform: rotate(-90deg);
    }

    /* L1 Body - Expanded Content */
    .l1-body {
        padding: 20px;
        border-top: 1px solid rgba(255,255,255,0.05);
    }

    .l1-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    /* Cell Info Panel */
    .l1-panel {
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .l1-panel-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .l1-panel-header i {
        color: var(--aiochi-primary);
    }

    .l1-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .l1-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .l1-info-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--aiochi-text-muted);
    }

    .l1-info-value {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--aiochi-text);
    }

    /* L1 Trust Score Gauge */
    .l1-trust-gauge {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    .l1-trust-circle {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .l1-trust-circle svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 6px rgba(0,0,0,0.3));
    }

    .l1-trust-circle .bg {
        fill: none;
        stroke: rgba(255,255,255,0.15);
        stroke-width: 3.5;
    }

    .l1-trust-circle .progress {
        fill: none;
        stroke-width: 3.5;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .l1-trust-circle .progress.trusted {
        stroke: var(--aiochi-calm);
    }
    .l1-trust-circle .progress.suspicious {
        stroke: var(--aiochi-curious);
        filter: drop-shadow(0 0 8px var(--aiochi-curious));
    }
    .l1-trust-circle .progress.hostile {
        stroke: var(--aiochi-alert);
        filter: drop-shadow(0 0 10px var(--aiochi-alert));
        animation: pulse-alert 1.5s ease-in-out infinite;
    }

    @keyframes pulse-alert {
        0%, 100% { filter: drop-shadow(0 0 8px var(--aiochi-alert)); }
        50% { filter: drop-shadow(0 0 16px var(--aiochi-alert)); }
    }

    .l1-trust-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--aiochi-text);
    }

    .l1-trust-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .l1-trust-label.trusted { color: var(--aiochi-calm); }
    .l1-trust-label.suspicious { color: var(--aiochi-curious); }
    .l1-trust-label.hostile { color: var(--aiochi-alert); }

    /* L1 Trust Components */
    .l1-trust-components {
        width: 100%;
        margin-top: 12px;
    }

    .l1-component {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .l1-component-label {
        flex: 0 0 80px;
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .l1-component-bar {
        flex: 1;
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .l1-component-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }

    .l1-component-fill.high { background: var(--aiochi-calm); }
    .l1-component-fill.medium { background: var(--aiochi-curious); }
    .l1-component-fill.low { background: var(--aiochi-alert); }

    .l1-component-value {
        flex: 0 0 35px;
        font-size: 0.7rem;
        text-align: right;
        color: var(--aiochi-text-muted);
    }

    /* Security Gauges Panel */
    .l1-security-gauges {
        grid-column: 1 / -1;
    }

    .l1-security-gauge-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    @media (max-width: 900px) {
        .l1-security-gauge-grid {
            grid-template-columns: 1fr;
        }
    }

    .l1-security-gauge {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: all 0.3s ease;
    }

    .l1-security-gauge.alert {
        border-color: var(--aiochi-alert);
        background: rgba(255,82,82,0.1);
        animation: gauge-alert-pulse 2s ease-in-out infinite;
    }

    .l1-security-gauge.warning {
        border-color: var(--aiochi-curious);
        background: rgba(255,193,7,0.1);
    }

    @keyframes gauge-alert-pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255,82,82,0.4); }
        50% { box-shadow: 0 0 15px 3px rgba(255,82,82,0.3); }
    }

    .l1-gauge-icon {
        flex: 0 0 36px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: var(--aiochi-accent);
    }

    .l1-security-gauge.alert .l1-gauge-icon {
        background: rgba(255,82,82,0.2);
        color: var(--aiochi-alert);
    }

    .l1-security-gauge.warning .l1-gauge-icon {
        background: rgba(255,193,7,0.2);
        color: var(--aiochi-curious);
    }

    .l1-gauge-content {
        flex: 1;
        min-width: 0;
    }

    .l1-gauge-label {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        margin-bottom: 4px;
    }

    .l1-gauge-value {
        display: flex;
        align-items: baseline;
        gap: 4px;
        margin-bottom: 8px;
    }

    .l1-gauge-number {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .l1-gauge-unit,
    .l1-gauge-band {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
    }

    .l1-gauge-band {
        font-weight: 600;
        color: var(--aiochi-accent);
    }

    .l1-gauge-state {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--aiochi-calm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .l1-security-gauge.alert .l1-gauge-state {
        color: var(--aiochi-alert);
    }

    .l1-security-gauge.warning .l1-gauge-state {
        color: var(--aiochi-curious);
    }

    .l1-gauge-bar {
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 6px;
    }

    .l1-gauge-bar-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease, background-color 0.3s ease;
    }

    .l1-gauge-bar-fill.normal {
        background: var(--aiochi-calm);
    }

    .l1-gauge-bar-fill.warning {
        background: var(--aiochi-curious);
    }

    .l1-gauge-bar-fill.alert {
        background: var(--aiochi-alert);
        animation: bar-pulse 1.5s ease-in-out infinite;
    }

    @keyframes bar-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .l1-gauge-status {
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .l1-gauge-status.normal {
        color: var(--aiochi-calm);
    }

    .l1-gauge-status.warning {
        color: var(--aiochi-curious);
    }

    .l1-gauge-status.alert {
        color: var(--aiochi-alert);
        font-weight: 600;
    }

    .l1-gauge-status i {
        font-size: 0.65rem;
    }

    /* Security Alert Banner */
    .l1-security-alert {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 16px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(255,82,82,0.15), rgba(255,82,82,0.05));
        border: 1px solid var(--aiochi-alert);
        border-radius: 8px;
        animation: alert-slide-in 0.3s ease-out;
    }

    .l1-security-alert.hidden {
        display: none;
    }

    @keyframes alert-slide-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .l1-alert-icon {
        flex: 0 0 40px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,82,82,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--aiochi-alert);
        font-size: 1.1rem;
        animation: alert-icon-pulse 2s ease-in-out infinite;
    }

    @keyframes alert-icon-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .l1-alert-content {
        flex: 1;
    }

    .l1-alert-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-alert);
        margin-bottom: 2px;
    }

    .l1-alert-message {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .l1-alert-dismiss {
        flex: 0 0 auto;
        padding: 8px;
        background: transparent;
        border: none;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .l1-alert-dismiss:hover {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text);
    }

    /* Survival Mode Panel */
    .l1-survival-panel {
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .l1-survival-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .l1-survival-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .l1-survival-title i {
        color: var(--aiochi-curious);
    }

    .l1-survival-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .l1-survival-status.normal {
        background: rgba(129, 199, 132, 0.15);
        color: var(--aiochi-calm);
    }

    .l1-survival-status.active {
        background: rgba(229, 115, 115, 0.15);
        color: var(--aiochi-alert);
        animation: survival-pulse 2s infinite;
    }

    @keyframes survival-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .l1-survival-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .l1-survival-triggers {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .l1-trigger-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
    }

    .l1-trigger-item input[type="checkbox"] {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .l1-trigger-item input[type="checkbox"]:checked {
        background: var(--aiochi-primary);
        border-color: var(--aiochi-primary);
    }

    .l1-trigger-item input[type="checkbox"]:checked::after {
        content: 'âœ“';
        display: block;
        color: white;
        font-size: 10px;
        text-align: center;
        line-height: 12px;
    }

    .l1-survival-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .l1-survival-btn.enter {
        background: rgba(255, 183, 77, 0.15);
        color: var(--aiochi-curious);
        border: 1px solid rgba(255, 183, 77, 0.3);
    }

    .l1-survival-btn.enter:hover {
        background: rgba(255, 183, 77, 0.25);
    }

    .l1-survival-btn.exit {
        background: rgba(129, 199, 132, 0.15);
        color: var(--aiochi-calm);
        border: 1px solid rgba(129, 199, 132, 0.3);
    }

    .l1-survival-btn.exit:hover {
        background: rgba(129, 199, 132, 0.25);
    }

    .l1-vpn-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        margin-top: 8px;
    }

    .l1-vpn-status i.ready { color: var(--aiochi-calm); }
    .l1-vpn-status i.not-ready { color: var(--aiochi-alert); }

    /* Bubble Manager Section */
    .bubble-manager-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .bubble-manager-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-manager-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .bubble-manager-title i {
        color: var(--aiochi-primary);
    }

    .bubble-manager-body {
        padding: 20px;
    }

    .bubble-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .bubble-card {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .bubble-card:hover {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.15);
        transform: translateY(-2px);
    }

    .bubble-card.drop-target {
        border-color: var(--aiochi-primary);
        background: rgba(79, 195, 247, 0.1);
        box-shadow: 0 0 20px rgba(79, 195, 247, 0.2);
    }

    .bubble-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .bubble-card-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .bubble-card-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .bubble-card-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--aiochi-text);
    }

    .bubble-card-type {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
    }

    .bubble-card-actions {
        display: flex;
        gap: 4px;
    }

    .bubble-card-actions button {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .bubble-card-actions button:hover {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text);
    }

    .bubble-card-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 36px;
    }

    .device-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 5px 10px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        cursor: grab;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    /* D2D cluster styling - devices that communicate show same color */
    /* This makes it visually obvious across bubbles which devices talk to each other */
    .device-tag[data-d2d-cluster] {
        border-left-width: 4px;
        border-left-style: solid;
        padding-left: 10px;
    }

    .device-tag:hover {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text);
    }

    /* D2D cluster color - prominent styling for cross-bubble communication */
    .device-tag.d2d-clustered {
        font-weight: 600;
        /* The background color will be set via inline style with cluster color */
        border-radius: 20px;
        box-shadow: 0 0 0 0.2px currentColor;
    }

    .device-tag.d2d-clustered:hover {
        /* Enhance glow on hover to make D2D relationship more visible */
        box-shadow: 0 0 12px currentColor;
        transform: scale(1.02);
    }

    .device-tag.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .device-tag.online::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--aiochi-calm);
        border-radius: 50%;
    }

    .device-tag.offline::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--aiochi-text-muted);
        border-radius: 50%;
    }

    .bubble-card-footer {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-policy-badges {
        display: flex;
        gap: 6px;
    }

    .policy-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.05);
        color: var(--aiochi-text-muted);
    }

    .policy-badge.active {
        background: rgba(129, 199, 132, 0.2);
        color: var(--aiochi-calm);
    }

    .policy-badge.inactive {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
        text-decoration: line-through;
    }

    .bubble-device-count {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    /* Unassigned Devices Section */
    .unassigned-section {
        margin-top: 20px;
        padding: 16px;
        background: rgba(255, 183, 77, 0.05);
        border-radius: 10px;
        border: 1px dashed rgba(255, 183, 77, 0.3);
    }

    .unassigned-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-curious);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .unassigned-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 32px;
    }

    /* Create Bubble Button */
    .create-bubble-card {
        background: rgba(79, 195, 247, 0.05);
        border: 2px dashed rgba(79, 195, 247, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        color: var(--aiochi-primary);
        transition: all 0.3s ease;
    }

    .create-bubble-card:hover {
        background: rgba(79, 195, 247, 0.1);
        border-color: var(--aiochi-primary);
    }

    .create-bubble-card i {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .create-bubble-card span {
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Bubble Modal */
    .bubble-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .bubble-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .bubble-modal {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .bubble-modal-overlay.active .bubble-modal {
        transform: scale(1);
    }

    .bubble-modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--aiochi-text);
    }

    .bubble-modal-close {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .bubble-modal-body {
        padding: 20px;
    }

    .bubble-form-group {
        margin-bottom: 16px;
    }

    .bubble-form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--aiochi-text);
        margin-bottom: 6px;
    }

    .bubble-form-group input,
    .bubble-form-group select {
        width: 100%;
        padding: 10px 12px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        color: var(--aiochi-text);
        font-size: 0.9rem;
    }

    .bubble-form-group input:focus,
    .bubble-form-group select:focus {
        outline: none;
        border-color: var(--aiochi-primary);
    }

    .bubble-color-picker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: white;
        box-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .bubble-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-bubble {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-bubble-cancel {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text-muted);
    }

    .btn-bubble-cancel:hover {
        background: rgba(255,255,255,0.15);
    }

    .btn-bubble-save {
        background: var(--aiochi-primary);
        color: #000;
    }

    .btn-bubble-save:hover {
        background: #6fd0fc;
    }

    .btn-bubble-delete {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
    }

    .btn-bubble-delete:hover {
        background: rgba(229, 115, 115, 0.3);
    }

    /* Loading State */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 26, 46, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 12px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255,255,255,0.1);
        border-top-color: var(--aiochi-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Scrollbar styling */
    .pillar-body::-webkit-scrollbar {
        width: 6px;
    }

    .pillar-body::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.02);
        border-radius: 3px;
    }

    .pillar-body::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
    }

    .pillar-body::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.15);
    }

    /* =========================================================================
       ACTIVE DEFENSES SECTION - 5 Innovations (Collapsible)
       ========================================================================= */
    .defenses-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    .defenses-header {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .defenses-header:hover {
        background: rgba(255,255,255,0.02);
    }

    /* Collapsed state - hide body */
    .defenses-card.collapsed .defenses-body {
        display: none;
    }

    .defenses-card.collapsed .defenses-tabs {
        display: none;
    }

    .defenses-card.collapsed .defenses-header {
        border-bottom: none;
    }

    .defenses-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .defenses-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .defenses-title i {
        color: var(--aiochi-alert);
        font-size: 1rem;
    }

    /* Summary badges (shown when collapsed) */
    .defenses-summary {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .defense-summary-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        background: rgba(255,255,255,0.05);
        color: var(--aiochi-text-muted);
    }

    .defense-summary-badge.active {
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
    }

    .defense-summary-badge.warning {
        background: rgba(255, 183, 77, 0.15);
        color: var(--aiochi-curious);
    }

    .defense-summary-badge.danger {
        background: rgba(229, 115, 115, 0.15);
        color: var(--aiochi-alert);
    }

    /* Expand/collapse toggle */
    .defenses-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        color: var(--aiochi-text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .defenses-toggle:hover {
        background: rgba(255,255,255,0.06);
        color: var(--aiochi-text);
    }

    .defenses-toggle i {
        transition: transform 0.3s ease;
    }

    .defenses-card.collapsed .defenses-toggle i {
        transform: rotate(-90deg);
    }

    /* Toggle button positions on the right */

    /* Only show tabs when expanded */
    .defenses-tabs-wrapper {
        padding: 0 20px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .defenses-card.collapsed .defenses-tabs-wrapper {
        display: none;
    }

    .defenses-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding-bottom: 2rem;
    }

    .defense-tab {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 8px 14px;
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .defense-tab:hover {
        background: rgba(255,255,255,0.08);
        color: var(--aiochi-text);
    }

    .defense-tab.active {
        background: rgba(79, 195, 247, 0.15);
        border-color: var(--aiochi-primary);
        color: var(--aiochi-primary);
    }

    .defense-tab i {
        font-size: 0.85rem;
    }

    .defenses-body {
        padding: 20px;
    }

    .defense-panel {
        display: none;
    }

    .defense-panel.active {
        display: block;
    }

    .defense-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    @media (max-width: 992px) {
        .defense-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-card {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        margin: 0 auto 10px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
    }

    .stat-icon.subtle { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.degraded { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
    .stat-icon.severe { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.clean { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .stat-icon.suspicious { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.masquerade { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.hardened { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .stat-icon.prevented { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .stat-icon.active-chains { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.dark-ports { background: rgba(156, 39, 176, 0.15); color: #ba68c8; }
    .stat-icon.attackers { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.critical-threats { background: rgba(183, 28, 28, 0.2); color: #ef5350; }
    .stat-icon.blocked-exfil { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.sensitive { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.high-risk { background: rgba(183, 28, 28, 0.2); color: #ef5350; }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--aiochi-text);
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* List headers */
    .friction-list-header,
    .ghost-list-header,
    .chain-list-header,
    .honeypot-list-header,
    .gravity-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .friction-list-header h5,
    .ghost-list-header h5,
    .chain-list-header h5,
    .honeypot-list-header h5,
    .gravity-list-header h5 {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0;
        color: var(--aiochi-text);
    }

    /* List containers */
    .friction-list,
    .ghost-list,
    .chain-list,
    .honeypot-list,
    .gravity-list {
        max-height: 350px;
        overflow-y: auto;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--aiochi-text-muted);
    }

    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin: 0;
    }

    /* Friction item */
    .friction-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid transparent;
    }

    .friction-item.subtle { border-left-color: #ffb74d; }
    .friction-item.noticeable { border-left-color: #ff9800; }
    .friction-item.degraded { border-left-color: #f57c00; }
    .friction-item.severe { border-left-color: var(--aiochi-alert); }

    .friction-device {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .friction-device-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--aiochi-text-muted);
    }

    .friction-device-info {
        display: flex;
        flex-direction: column;
    }

    .friction-device-name {
        font-weight: 500;
        font-size: 0.85rem;
        color: var(--aiochi-text);
    }

    .friction-device-ip {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .friction-level {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .friction-level-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .friction-level-badge.subtle { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .friction-level-badge.noticeable { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .friction-level-badge.degraded { background: rgba(245, 124, 0, 0.2); color: #f57c00; }
    .friction-level-badge.severe { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }

    .friction-latency {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
    }

    .friction-qsecbit {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 8px;
        background: rgba(79, 195, 247, 0.1);
        color: var(--aiochi-primary);
    }

    /* Ghost Probe item */
    .ghost-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid transparent;
    }

    .ghost-item.clean { border-left-color: var(--aiochi-calm); }
    .ghost-item.suspicious { border-left-color: #ffb74d; }
    .ghost-item.masquerading { border-left-color: var(--aiochi-alert); }
    .ghost-item.compromised { border-left-color: #b71c1c; }

    .ghost-verdict {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .ghost-verdict.clean { background: rgba(129, 199, 132, 0.2); color: var(--aiochi-calm); }
    .ghost-verdict.suspicious { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .ghost-verdict.masquerading { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }
    .ghost-verdict.compromised { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .btn-probe-all {
        background: rgba(79, 195, 247, 0.15);
        border: 1px solid rgba(79, 195, 247, 0.3);
        color: var(--aiochi-primary);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .btn-probe-all:hover {
        background: rgba(79, 195, 247, 0.25);
    }

    /* Chain Predictor item */
    .chain-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .chain-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .chain-source {
        font-weight: 500;
        color: var(--aiochi-text);
    }

    .chain-confidence {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        background: rgba(255, 183, 77, 0.2);
        color: #ffb74d;
    }

    .chain-sequence {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
    }

    .chain-technique {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 4px;
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
        font-family: monospace;
    }

    .chain-technique.observed {
        background: rgba(255, 183, 77, 0.2);
        color: #ffb74d;
    }

    .chain-technique.predicted {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
        border: 1px dashed rgba(229, 115, 115, 0.4);
    }

    .chain-arrow {
        color: var(--aiochi-text-muted);
        font-size: 0.8rem;
    }

    .chain-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .chain-action {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 4px;
        background: rgba(129, 199, 132, 0.15);
        color: var(--aiochi-calm);
    }

    /* Honeypot item */
    .honeypot-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid var(--aiochi-alert);
    }

    .honeypot-item.low { border-left-color: var(--aiochi-calm); }
    .honeypot-item.medium { border-left-color: #ffb74d; }
    .honeypot-item.high { border-left-color: #ff9800; }
    .honeypot-item.critical { border-left-color: #b71c1c; }

    .honeypot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .honeypot-ip {
        font-weight: 600;
        font-family: monospace;
        color: var(--aiochi-text);
    }

    .honeypot-threat {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .honeypot-threat.low { background: rgba(129, 199, 132, 0.2); color: var(--aiochi-calm); }
    .honeypot-threat.medium { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .honeypot-threat.high { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .honeypot-threat.critical { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .honeypot-details {
        display: flex;
        gap: 16px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .honeypot-ports {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .honeypot-port {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: rgba(229, 115, 115, 0.1);
        border-radius: 4px;
        color: var(--aiochi-alert);
        font-family: monospace;
    }

    /* Data Gravity item */
    .gravity-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid #ffb74d;
    }

    .gravity-item.blocked { border-left-color: var(--aiochi-alert); }
    .gravity-item.allowed { border-left-color: var(--aiochi-calm); }

    .gravity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .gravity-file {
        font-weight: 500;
        color: var(--aiochi-text);
        font-size: 0.85rem;
    }

    .gravity-file-type {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .gravity-action {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .gravity-action.blocked { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }
    .gravity-action.throttled { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .gravity-action.logged { background: rgba(79, 195, 247, 0.1); color: var(--aiochi-primary); }
    .gravity-action.allowed { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }

    .gravity-details {
        display: flex;
        gap: 16px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        margin-bottom: 8px;
    }

    .gravity-sensitivity {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .gravity-sensitivity.public { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .gravity-sensitivity.internal { background: rgba(79, 195, 247, 0.1); color: var(--aiochi-primary); }
    .gravity-sensitivity.confidential { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .gravity-sensitivity.restricted { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .gravity-sensitivity.secret { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .gravity-risk {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .gravity-risk-bar {
        width: 60px;
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .gravity-risk-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .gravity-risk-fill.low { background: var(--aiochi-calm); }
    .gravity-risk-fill.medium { background: #ffb74d; }
    .gravity-risk-fill.high { background: #ff9800; }
    .gravity-risk-fill.critical { background: var(--aiochi-alert); }

    .gravity-mitre {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .gravity-mitre-tag {
        font-size: 0.65rem;
        padding: 2px 5px;
        background: rgba(79, 195, 247, 0.1);
        border-radius: 3px;
        color: var(--aiochi-primary);
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="aiochi-container">
    <!-- Ambient State Banner -->
    <div class="ambient-banner" id="ambient-banner">
        <div class="ambient-state">
            <div class="ambient-icon calm" id="ambient-icon">
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="ambient-text">
                <h2 id="ambient-title">Everything is Peaceful</h2>
                <p id="ambient-message">Your network is protected and running smoothly.</p>
            </div>
        </div>
        <div class="ambient-right">
            <div class="whisper-badge" id="whisper-badge">
                <span class="whisper-phase">ðŸŒ™</span>
                <span id="whisper-message">Dreaming...</span>
            </div>
            <span class="demo-badge" id="demo-badge" style="display: none;">
                <i class="fas fa-flask"></i> Demo Mode
            </span>
        </div>
    </div>

    <!-- Three Pillars -->
    <div class="pillars-grid">
        <!-- PRESENCE - Who's Home -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-users presence-icon"></i>
                    <div>
                        <h3>PRESENCE</h3>
                        <span>Who's Home</span>
                    </div>
                </div>
                <span class="badge bg-info" id="presence-count">0 devices</span>
            </div>
            <div class="pillar-body" id="presence-body">
                <div class="bubble-list" id="bubble-list">
                    <!-- Bubbles populated by JS -->
                </div>
            </div>
        </div>

        <!-- AI ACTIVITY - What I'm Doing -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-robot ai-activity-icon"></i>
                    <div>
                        <h3>AI ACTIVITY</h3>
                        <span>What I'm Doing</span>
                    </div>
                </div>
                <span class="badge bg-success" id="ai-activity-count">All clear</span>
            </div>
            <div class="pillar-body" id="ai-activity-body">
                <div class="ai-feed-list" id="ai-feed-list">
                    <!-- AI activity feed populated by JS -->
                    <div class="ai-feed-empty" id="ai-feed-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>Everything is running smoothly. I'm watching over your network.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PERFORMANCE - How Fast -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-tachometer-alt performance-icon"></i>
                    <div>
                        <h3>PERFORMANCE</h3>
                        <span>How Fast</span>
                    </div>
                </div>
            </div>
            <div class="pillar-body" id="performance-body">
                <div class="health-score-container">
                    <div class="health-gauge">
                        <svg viewBox="0 0 160 160">
                            <circle class="health-gauge-bg" cx="80" cy="80" r="70"></circle>
                            <circle class="health-gauge-fill good" cx="80" cy="80" r="70"
                                    stroke-dasharray="439.8" stroke-dashoffset="439.8" id="health-gauge-fill"></circle>
                        </svg>
                        <div class="health-score-value">
                            <div class="health-score-number good" id="health-score">--</div>
                            <div class="health-score-label">Health</div>
                        </div>
                    </div>
                </div>
                <div class="health-insight" id="health-insight">
                    Loading network insights...
                </div>
                <div class="health-metrics" id="health-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="metric-latency">--</div>
                        <div class="metric-label">Latency (ms)</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-bandwidth">--</div>
                        <div class="metric-label">Bandwidth %</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-uptime">--</div>
                        <div class="metric-label">Uptime %</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-blocked">--</div>
                        <div class="metric-label">Blocked (24h)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Defenses Section - Compact View (Collapsed by default) -->
    <div class="defenses-card collapsed">
        <div class="defenses-header" onclick="toggleDefenses()">
            <div class="defenses-header-left">
                <div class="defenses-title">
                    <i class="fas fa-shield-virus"></i>
                    <span>Active Defenses</span>
                </div>
                <!-- Summary badges inline -->
                <div class="defenses-summary">
                    <span class="defense-summary-badge" id="summary-friction" title="Friction Control">
                        <i class="fas fa-hourglass-half"></i><span>0</span>
                    </span>
                    <span class="defense-summary-badge" id="summary-ghost" title="Ghost Probes">
                        <i class="fas fa-ghost"></i><span>0</span>
                    </span>
                    <span class="defense-summary-badge" id="summary-chain" title="Chain Predictions">
                        <i class="fas fa-link"></i><span>0</span>
                    </span>
                    <span class="defense-summary-badge" id="summary-honeypot" title="Honeypots">
                        <i class="fas fa-spider"></i><span>0</span>
                    </span>
                    <span class="defense-summary-badge" id="summary-gravity" title="Data Gravity">
                        <i class="fas fa-magnet"></i><span>0</span>
                    </span>
                </div>
            </div>
            <button class="defenses-toggle" id="defenses-toggle" title="Expand details">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="defenses-body">
            <!-- Tabs (hidden when collapsed) -->
            <div class="defenses-tabs" id="defense-tabs">
                <button class="defense-tab active" data-tab="friction" onclick="event.stopPropagation(); switchDefenseTab('friction')">
                    <i class="fas fa-hourglass-half"></i> Friction
                </button>
                <button class="defense-tab" data-tab="ghost" onclick="event.stopPropagation(); switchDefenseTab('ghost')">
                    <i class="fas fa-ghost"></i> Ghost Probe
                </button>
                <button class="defense-tab" data-tab="chain" onclick="event.stopPropagation(); switchDefenseTab('chain')">
                    <i class="fas fa-link"></i> Chain Predict
                </button>
                <button class="defense-tab" data-tab="honeypot" onclick="event.stopPropagation(); switchDefenseTab('honeypot')">
                    <i class="fas fa-spider"></i> Honeypots
                </button>
                <button class="defense-tab" data-tab="gravity" onclick="event.stopPropagation(); switchDefenseTab('gravity')">
                    <i class="fas fa-magnet"></i> Data Gravity
                </button>
            </div>
            <!-- Friction Control Tab -->
            <div class="defense-panel active" id="panel-friction">
                <div class="defense-stats">
                    <div class="stat-card friction-stat">
                        <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                        <div class="stat-value" id="friction-active">0</div>
                        <div class="stat-label">Active Frictions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon subtle"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="friction-subtle">0</div>
                        <div class="stat-label">Subtle (50ms)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon degraded"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="friction-degraded">0</div>
                        <div class="stat-label">Degraded (500ms)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon severe"><i class="fas fa-ban"></i></div>
                        <div class="stat-value" id="friction-severe">0</div>
                        <div class="stat-label">Severe (1000ms)</div>
                    </div>
                </div>
                <div class="friction-list-header">
                    <h5>Devices with Applied Friction</h5>
                    <span class="badge bg-info" id="friction-count">0 devices</span>
                </div>
                <div class="friction-list" id="friction-list">
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No friction applied. All devices are operating normally.</p>
                    </div>
                </div>
            </div>

            <!-- Ghost Probe Tab -->
            <div class="defense-panel" id="panel-ghost">
                <div class="defense-stats">
                    <div class="stat-card ghost-stat">
                        <div class="stat-icon"><i class="fas fa-ghost"></i></div>
                        <div class="stat-value" id="ghost-probes">0</div>
                        <div class="stat-label">Probes Run (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon clean"><i class="fas fa-check"></i></div>
                        <div class="stat-value" id="ghost-clean">0</div>
                        <div class="stat-label">Clean</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon suspicious"><i class="fas fa-question"></i></div>
                        <div class="stat-value" id="ghost-suspicious">0</div>
                        <div class="stat-label">Suspicious</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon masquerade"><i class="fas fa-mask"></i></div>
                        <div class="stat-value" id="ghost-masquerade">0</div>
                        <div class="stat-label">Masquerading</div>
                    </div>
                </div>
                <div class="ghost-list-header">
                    <h5>Recent Probe Results</h5>
                    <button class="btn-probe-all" onclick="runProbeAll()">
                        <i class="fas fa-radar"></i> Probe All Devices
                    </button>
                </div>
                <div class="ghost-list" id="ghost-list">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No recent probes. Click "Probe All Devices" to start active interrogation.</p>
                    </div>
                </div>
            </div>

            <!-- Chain Predictor Tab -->
            <div class="defense-panel" id="panel-chain">
                <div class="defense-stats">
                    <div class="stat-card chain-stat">
                        <div class="stat-icon"><i class="fas fa-link"></i></div>
                        <div class="stat-value" id="chain-predictions">0</div>
                        <div class="stat-label">Predictions (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon hardened"><i class="fas fa-shield-alt"></i></div>
                        <div class="stat-value" id="chain-hardened">0</div>
                        <div class="stat-label">Pre-Hardened</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon prevented"><i class="fas fa-hand-paper"></i></div>
                        <div class="stat-value" id="chain-prevented">0</div>
                        <div class="stat-label">Attacks Prevented</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active-chains"><i class="fas fa-project-diagram"></i></div>
                        <div class="stat-value" id="chain-active">0</div>
                        <div class="stat-label">Active Chains</div>
                    </div>
                </div>
                <div class="chain-list-header">
                    <h5>Attack Chain Predictions</h5>
                    <span class="badge bg-warning" id="chain-count">0 active</span>
                </div>
                <div class="chain-list" id="chain-list">
                    <div class="empty-state">
                        <i class="fas fa-brain"></i>
                        <p>No attack chains detected. The AI is monitoring for MITRE ATT&CK sequences.</p>
                    </div>
                </div>
            </div>

            <!-- Honeypot Mesh Tab -->
            <div class="defense-panel" id="panel-honeypot">
                <div class="defense-stats">
                    <div class="stat-card honeypot-stat">
                        <div class="stat-icon"><i class="fas fa-spider"></i></div>
                        <div class="stat-value" id="honeypot-touches">0</div>
                        <div class="stat-label">Touches (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon dark-ports"><i class="fas fa-door-closed"></i></div>
                        <div class="stat-value" id="honeypot-ports">0</div>
                        <div class="stat-label">Dark Ports</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon attackers"><i class="fas fa-user-secret"></i></div>
                        <div class="stat-value" id="honeypot-attackers">0</div>
                        <div class="stat-label">Unique Attackers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon critical-threats"><i class="fas fa-skull-crossbones"></i></div>
                        <div class="stat-value" id="honeypot-critical">0</div>
                        <div class="stat-label">Critical Threats</div>
                    </div>
                </div>
                <div class="honeypot-list-header">
                    <h5>Attacker Profiles</h5>
                    <span class="badge bg-danger" id="honeypot-count">0 tracked</span>
                </div>
                <div class="honeypot-list" id="honeypot-list">
                    <div class="empty-state">
                        <i class="fas fa-shield-check"></i>
                        <p>No honeypot touches detected. Dark ports are active and monitoring.</p>
                    </div>
                </div>
            </div>

            <!-- Data Gravity Tab -->
            <div class="defense-panel" id="panel-gravity">
                <div class="defense-stats">
                    <div class="stat-card gravity-stat">
                        <div class="stat-icon"><i class="fas fa-magnet"></i></div>
                        <div class="stat-value" id="gravity-events">0</div>
                        <div class="stat-label">Events (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blocked-exfil"><i class="fas fa-hand-paper"></i></div>
                        <div class="stat-value" id="gravity-blocked">0</div>
                        <div class="stat-label">Blocked Exfil</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon sensitive"><i class="fas fa-file-shield"></i></div>
                        <div class="stat-value" id="gravity-sensitive">0</div>
                        <div class="stat-label">Sensitive Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon high-risk"><i class="fas fa-exclamation-circle"></i></div>
                        <div class="stat-value" id="gravity-highrisk">0</div>
                        <div class="stat-label">High Risk Sources</div>
                    </div>
                </div>
                <div class="gravity-list-header">
                    <h5>Recent Exfiltration Events</h5>
                    <span class="badge bg-warning" id="gravity-count">0 detected</span>
                </div>
                <div class="gravity-list" id="gravity-list">
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <p>No sensitive data movement detected. Zeek file monitoring is active.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- L1/Cellular Security Section - Physical Layer Protection (Collapsible) -->
    <div class="l1-card collapsed" id="l1-card">
        <div class="l1-header" onclick="toggleL1()">
            <div class="l1-header-left">
                <div class="l1-title">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>L1 Cellular Security</span>
                </div>
                <!-- Summary info (always visible) -->
                <div class="l1-summary">
                    <span class="l1-network-badge g5sa" id="l1-network-type">
                        <i class="fas fa-signal"></i> 5G SA
                    </span>
                    <div class="l1-signal-indicator good" id="l1-signal-bars">
                        <div class="l1-signal-bar"></div>
                        <div class="l1-signal-bar"></div>
                        <div class="l1-signal-bar"></div>
                        <div class="l1-signal-bar"></div>
                        <div class="l1-signal-bar"></div>
                    </div>
                    <span class="l1-trust-mini" id="l1-trust-mini">
                        <i class="fas fa-shield-alt"></i> --%
                    </span>
                </div>
            </div>
            <button class="l1-toggle" id="l1-toggle" title="Expand details">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="l1-body">
            <div class="l1-grid">
                <!-- Cell Information Panel -->
                <div class="l1-panel">
                    <div class="l1-panel-header">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Current Cell</span>
                    </div>
                    <div class="l1-info-grid">
                        <div class="l1-info-item">
                            <div class="l1-info-label">Cell ID</div>
                            <div class="l1-info-value" id="l1-cell-id">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">PCI</div>
                            <div class="l1-info-value" id="l1-pci">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">TAC</div>
                            <div class="l1-info-value" id="l1-tac">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">Band</div>
                            <div class="l1-info-value" id="l1-band">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">Carrier</div>
                            <div class="l1-info-value" id="l1-carrier">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">MCC-MNC</div>
                            <div class="l1-info-value" id="l1-mccmnc">--</div>
                        </div>
                    </div>
                </div>

                <!-- Signal Metrics Panel -->
                <div class="l1-panel">
                    <div class="l1-panel-header">
                        <i class="fas fa-chart-line"></i>
                        <span>Signal Quality</span>
                    </div>
                    <div class="l1-info-grid">
                        <div class="l1-info-item">
                            <div class="l1-info-label">RSRP</div>
                            <div class="l1-info-value" id="l1-rsrp">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">SINR</div>
                            <div class="l1-info-value" id="l1-sinr">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">SNR</div>
                            <div class="l1-info-value" id="l1-snr">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">Distance</div>
                            <div class="l1-info-value" id="l1-distance">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">Handovers (1h)</div>
                            <div class="l1-info-value" id="l1-handovers">--</div>
                        </div>
                        <div class="l1-info-item">
                            <div class="l1-info-label">Tower Status</div>
                            <div class="l1-info-value" id="l1-tower-status">
                                <i class="fas fa-question-circle"></i> --
                            </div>
                        </div>
                    </div>
                </div>

                <!-- L1 Trust Score Panel -->
                <div class="l1-panel">
                    <div class="l1-panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <i class="fas fa-shield-alt"></i>
                            <span>L1 Trust Score</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85em;">
                            <span style="color: var(--aiochi-text-muted);">Survival Mode</span>
                            <span class="l1-survival-status normal" id="l1-survival-status-mini">Normal</span>
                        </div>
                    </div>
                    <div class="l1-trust-gauge">
                        <div class="l1-trust-circle">
                            <svg viewBox="0 0 36 36">
                                <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                <path class="progress" id="l1-trust-progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                            </svg>
                            <div class="l1-trust-value" id="l1-trust-value">--%</div>
                        </div>
                        <div class="l1-trust-label" id="l1-trust-label">--</div>
                    </div>
                    <div class="l1-trust-components">
                        <div class="l1-component">
                            <span class="l1-component-label">Identity</span>
                            <div class="l1-component-bar">
                                <div class="l1-component-fill high" id="l1-comp-identity" style="width: 100%;"></div>
                            </div>
                            <span class="l1-component-value" id="l1-comp-identity-val">100%</span>
                        </div>
                        <div class="l1-component">
                            <span class="l1-component-label">SNR</span>
                            <div class="l1-component-bar">
                                <div class="l1-component-fill high" id="l1-comp-snr" style="width: 75%;"></div>
                            </div>
                            <span class="l1-component-value" id="l1-comp-snr-val">75%</span>
                        </div>
                        <div class="l1-component">
                            <span class="l1-component-label">Stability</span>
                            <div class="l1-component-bar">
                                <div class="l1-component-fill high" id="l1-comp-stability" style="width: 90%;"></div>
                            </div>
                            <span class="l1-component-value" id="l1-comp-stability-val">90%</span>
                        </div>
                        <div class="l1-component">
                            <span class="l1-component-label">Temporal</span>
                            <div class="l1-component-bar">
                                <div class="l1-component-fill high" id="l1-comp-temporal" style="width: 95%;"></div>
                            </div>
                            <span class="l1-component-value" id="l1-comp-temporal-val">95%</span>
                        </div>
                        <div class="l1-component">
                            <span class="l1-component-label">Handover</span>
                            <div class="l1-component-bar">
                                <div class="l1-component-fill high" id="l1-comp-handover" style="width: 100%;"></div>
                            </div>
                            <span class="l1-component-value" id="l1-comp-handover-val">100%</span>
                        </div>
                    </div>
                </div>

                <!-- Survival Mode Panel -->
                <div class="l1-survival-panel">
                    <div class="l1-survival-header">
                        <div class="l1-survival-title">
                            <i class="fas fa-life-ring"></i>
                            <span>Survival Mode</span>
                        </div>
                        <span class="l1-survival-status normal" id="l1-survival-status">Normal</span>
                    </div>
                    <div class="l1-survival-controls">
                        <div class="l1-survival-triggers">
                            <label class="l1-trigger-item">
                                <input type="checkbox" id="l1-trigger-trust" checked>
                                <span>Auto-trigger when Trust < 20%</span>
                            </label>
                            <label class="l1-trigger-item">
                                <input type="checkbox" id="l1-trigger-imsi" checked>
                                <span>Auto-trigger on IMSI Catcher</span>
                            </label>
                            <label class="l1-trigger-item">
                                <input type="checkbox" id="l1-trigger-jamming" checked>
                                <span>Auto-trigger on Jamming</span>
                            </label>
                        </div>
                        <button class="l1-survival-btn enter" id="l1-survival-btn" onclick="toggleSurvivalMode()">
                            <i class="fas fa-shield-alt"></i>
                            <span>Enter Survival Mode</span>
                        </button>
                        <div class="l1-vpn-status">
                            <i class="fas fa-exclamation-circle not-ready" id="l1-vpn-icon"></i>
                            <span id="l1-vpn-text">VPN Not Ready</span>
                        </div>
                    </div>
                </div>

                <!-- Security Gauges Panel -->
                <div class="l1-panel l1-security-gauges">
                    <div class="l1-panel-header">
                        <i class="fas fa-shield-virus"></i>
                        <span>Security Gauges</span>
                    </div>
                    <div class="l1-security-gauge-grid">
                        <!-- Neighbor Density Meter -->
                        <div class="l1-security-gauge" id="gauge-neighbor-density">
                            <div class="l1-gauge-icon">
                                <i class="fas fa-broadcast-tower"></i>
                            </div>
                            <div class="l1-gauge-content">
                                <div class="l1-gauge-label">Neighbor Density</div>
                                <div class="l1-gauge-value" id="gauge-neighbor-value">
                                    <span class="l1-gauge-number">--</span>
                                    <span class="l1-gauge-unit">PCIs</span>
                                </div>
                                <div class="l1-gauge-bar">
                                    <div class="l1-gauge-bar-fill normal" id="gauge-neighbor-bar" style="width: 75%;"></div>
                                </div>
                                <div class="l1-gauge-status normal" id="gauge-neighbor-status">
                                    <i class="fas fa-check-circle"></i> Normal
                                </div>
                            </div>
                        </div>

                        <!-- EARFCN Consistency Check -->
                        <div class="l1-security-gauge" id="gauge-earfcn-check">
                            <div class="l1-gauge-icon">
                                <i class="fas fa-wave-square"></i>
                            </div>
                            <div class="l1-gauge-content">
                                <div class="l1-gauge-label">EARFCN Consistency</div>
                                <div class="l1-gauge-value" id="gauge-earfcn-value">
                                    <span class="l1-gauge-number" id="gauge-earfcn-number">--</span>
                                    <span class="l1-gauge-unit">&rarr;</span>
                                    <span class="l1-gauge-band" id="gauge-earfcn-band">--</span>
                                </div>
                                <div class="l1-gauge-bar">
                                    <div class="l1-gauge-bar-fill normal" id="gauge-earfcn-bar" style="width: 100%;"></div>
                                </div>
                                <div class="l1-gauge-status normal" id="gauge-earfcn-status">
                                    <i class="fas fa-check-circle"></i> Verified
                                </div>
                            </div>
                        </div>

                        <!-- RRC State Watcher -->
                        <div class="l1-security-gauge" id="gauge-rrc-state">
                            <div class="l1-gauge-icon">
                                <i class="fas fa-random"></i>
                            </div>
                            <div class="l1-gauge-content">
                                <div class="l1-gauge-label">RRC State</div>
                                <div class="l1-gauge-value" id="gauge-rrc-value">
                                    <span class="l1-gauge-state" id="gauge-rrc-current">--</span>
                                </div>
                                <div class="l1-gauge-bar">
                                    <div class="l1-gauge-bar-fill normal" id="gauge-rrc-bar" style="width: 100%;"></div>
                                </div>
                                <div class="l1-gauge-status normal" id="gauge-rrc-status">
                                    <i class="fas fa-check-circle"></i> Healthy
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Banner (hidden by default) -->
                    <div class="l1-security-alert hidden" id="l1-security-alert">
                        <div class="l1-alert-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="l1-alert-content">
                            <div class="l1-alert-title" id="l1-alert-title">Security Alert</div>
                            <div class="l1-alert-message" id="l1-alert-message">No alerts</div>
                        </div>
                        <button class="l1-alert-dismiss" onclick="dismissL1Alert()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bubble Manager Section -->
    <div class="bubble-manager-card">
        <div class="bubble-manager-header">
            <div class="bubble-manager-title">
                <i class="fas fa-layer-group"></i>
                <div>
                    <span>Device Bubbles</span>
                    <small style="font-weight: 400; color: var(--aiochi-text-muted); font-size: 0.75rem; display: block;">
                        Drag devices between bubbles to organize your network
                    </small>
                </div>
            </div>
            <button class="btn-bubble btn-bubble-save" onclick="openCreateBubbleModal()">
                <i class="fas fa-plus"></i> New Bubble
            </button>
        </div>
        <div class="bubble-manager-body">
            <div class="bubble-grid" id="bubble-grid">
                <!-- Bubbles populated by JS -->
            </div>

            <!-- Unassigned Devices -->
            <div class="unassigned-section" id="unassigned-section">
                <div class="unassigned-title">
                    <i class="fas fa-question-circle"></i>
                    Unassigned Devices
                </div>
                <div class="unassigned-devices" id="unassigned-devices"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, null)">
                    <!-- Unassigned devices populated by JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- Bubble Create/Edit Modal -->
    <div class="bubble-modal-overlay" id="bubble-modal-overlay" onclick="closeBubbleModal(event)">
        <div class="bubble-modal" onclick="event.stopPropagation()">
            <div class="bubble-modal-header">
                <h3 id="bubble-modal-title">Create New Bubble</h3>
                <button class="bubble-modal-close" onclick="closeBubbleModal()">&times;</button>
            </div>
            <div class="bubble-modal-body">
                <input type="hidden" id="bubble-edit-id">

                <div class="bubble-form-group">
                    <label for="bubble-name">Bubble Name</label>
                    <input type="text" id="bubble-name" placeholder="e.g., Dad's Devices">
                </div>

                <div class="bubble-form-group">
                    <label for="bubble-type">Bubble Type</label>
                    <select id="bubble-type">
                        <option value="FAMILY">Family - Full network access</option>
                        <option value="GUEST">Guest - Internet only</option>
                        <option value="IOT">IoT - Smart home devices</option>
                        <option value="WORK">Work - Internet only (laptops, phones)</option>
                        <option value="CUSTOM">Custom</option>
                    </select>
                </div>

                <div class="bubble-form-group">
                    <label>Color</label>
                    <div class="bubble-color-picker" id="bubble-color-picker">
                        <div class="color-option" style="background: #1976D2" data-color="#1976D2" onclick="selectColor('#1976D2')"></div>
                        <div class="color-option" style="background: #E91E63" data-color="#E91E63" onclick="selectColor('#E91E63')"></div>
                        <div class="color-option" style="background: #FF5722" data-color="#FF5722" onclick="selectColor('#FF5722')"></div>
                        <div class="color-option" style="background: #4CAF50" data-color="#4CAF50" onclick="selectColor('#4CAF50')"></div>
                        <div class="color-option" style="background: #FF9800" data-color="#FF9800" onclick="selectColor('#FF9800')"></div>
                        <div class="color-option" style="background: #607D8B" data-color="#607D8B" onclick="selectColor('#607D8B')"></div>
                        <div class="color-option" style="background: #9C27B0" data-color="#9C27B0" onclick="selectColor('#9C27B0')"></div>
                        <div class="color-option selected" style="background: #2196F3" data-color="#2196F3" onclick="selectColor('#2196F3')"></div>
                    </div>
                </div>
            </div>
            <div class="bubble-modal-footer">
                <button class="btn-bubble btn-bubble-delete" id="bubble-delete-btn" style="display: none; margin-right: auto;" onclick="deleteBubble()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn-bubble btn-bubble-cancel" onclick="closeBubbleModal()">Cancel</button>
                <button class="btn-bubble btn-bubble-save" onclick="saveBubble()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- User Prompt Modal - Only shows when AI confidence < 30% -->
<div id="user-prompt-overlay">
    <div class="user-prompt-modal">
        <div class="prompt-header">
            <div class="prompt-icon">
                <i class="fas fa-question-circle"></i>
            </div>
            <div class="prompt-header-text">
                <h3 id="prompt-title">I need your input</h3>
                <p id="prompt-subtitle">Even after consulting other AI models, I'm uncertain about this decision</p>
            </div>
        </div>
        <div class="prompt-body">
            <div class="prompt-situation">
                <div class="prompt-situation-label">What's happening</div>
                <div class="prompt-situation-text" id="prompt-situation">
                    Loading situation details...
                </div>
            </div>
            <div class="prompt-ai-analysis">
                <div class="prompt-ai-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="prompt-ai-content">
                    <div class="prompt-ai-label">My Analysis</div>
                    <div class="prompt-ai-text" id="prompt-analysis">
                        I've analyzed this situation but I'm not confident enough to act without your guidance.
                    </div>
                </div>
            </div>
            <div class="prompt-confidence">
                <span class="prompt-confidence-label">Confidence:</span>
                <div class="prompt-confidence-bar">
                    <div class="prompt-confidence-fill" id="prompt-confidence-fill" style="width: 25%"></div>
                </div>
                <span class="prompt-confidence-value" id="prompt-confidence-value">25%</span>
            </div>
            <div class="prompt-actions" id="prompt-actions">
                <!-- Dynamic action buttons populated by JS -->
                <button class="prompt-btn prompt-btn-primary" onclick="handlePromptAction('approve')">
                    <i class="fas fa-check"></i> Approve Action
                </button>
                <button class="prompt-btn prompt-btn-secondary" onclick="handlePromptAction('ignore')">
                    <i class="fas fa-eye-slash"></i> Ignore
                </button>
                <button class="prompt-btn prompt-btn-danger" onclick="handlePromptAction('block')">
                    <i class="fas fa-ban"></i> Block
                </button>
            </div>
        </div>
        <div class="prompt-footer">
            <span class="prompt-footer-text">This prompt appears because my confidence is below 30%</span>
            <button class="prompt-dismiss" onclick="dismissUserPrompt()">
                <i class="fas fa-times"></i> Dismiss
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    // Configuration
    const API_BASE = '/aiochi/api';
    const REFRESH_INTERVAL = 5000;

    // State
    let isLoading = false;
    let demoMode = true;

    // Device type icons
    const deviceIcons = {
        'phone': 'fa-mobile-alt',
        'laptop': 'fa-laptop',
        'tablet': 'fa-tablet-alt',
        'watch': 'fa-clock',
        'speaker': 'fa-volume-up',
        'thermostat': 'fa-thermometer-half',
        'camera': 'fa-video',
        'hub': 'fa-sitemap',
        'gaming': 'fa-gamepad',
        'tv': 'fa-tv',
        'default': 'fa-microchip'
    };

    // Ecosystem colors
    const ecosystemColors = {
        'apple': '#a3a3a3',
        'samsung': '#1428a0',
        'google': '#4285f4',
        'iot': '#ffb74d',
        'mixed': '#ba68c8'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Show initial demo data immediately
        updatePerformance(null); // Will use fallback demo data

        fetchStatus();
        fetchL1Status();
        fetchAIActivity();
        fetchDefenseSummaries(); // Populate collapsed defense badges
        setInterval(fetchStatus, REFRESH_INTERVAL);
        setInterval(fetchL1Status, REFRESH_INTERVAL * 2); // L1 updates less frequently
        setInterval(fetchAIActivity, REFRESH_INTERVAL); // AI activity same as main
        setInterval(fetchDefenseSummaries, REFRESH_INTERVAL * 3); // Defense summaries less frequent
    });

    // Fetch all status data
    async function fetchStatus() {
        if (isLoading) return;
        isLoading = true;

        try {
            const response = await fetch(`${API_BASE}/status`);
            const data = await response.json();

            if (data.success) {
                demoMode = data.demo_mode;
                updateDemoMode(demoMode);
                updateAmbient(data.ambient);
                updatePresence(data.presence);
                updatePrivacy(data.privacy);
                updatePerformance(data.performance);
            }
        } catch (error) {
            console.error('Failed to fetch AIOCHI status:', error);
        } finally {
            isLoading = false;
        }
    }

    // Fetch AI Activity (decisions made by autonomous agent)
    async function fetchAIActivity() {
        try {
            const response = await fetch(`${API_BASE}/agent/activity`);
            const data = await response.json();
            if (data.success) {
                updateAIActivity(data);
            }
        } catch (error) {
            // AI activity endpoint may not exist yet - that's OK
            console.debug('AI activity not available:', error.message);
        }
    }

    // Update demo mode indicator
    function updateDemoMode(isDemo) {
        const badge = document.getElementById('demo-badge');
        badge.style.display = isDemo ? 'inline-flex' : 'none';
    }

    // Update ambient state banner
    function updateAmbient(ambient) {
        const icon = document.getElementById('ambient-icon');
        const title = document.getElementById('ambient-title');
        const message = document.getElementById('ambient-message');
        const whisperPhase = document.querySelector('.whisper-phase');
        const whisperMessage = document.getElementById('whisper-message');

        // Update state class
        icon.className = 'ambient-icon ' + ambient.state.toLowerCase();
        icon.innerHTML = `<i class="fas ${ambient.icon}"></i>`;

        // Update text
        title.textContent = getAmbientTitle(ambient.state);
        message.textContent = ambient.message;

        // Update whisper
        if (ambient.whisper) {
            whisperPhase.textContent = ambient.whisper.phase;
            whisperMessage.textContent = ambient.whisper.message;
        }
    }

    function getAmbientTitle(state) {
        const titles = {
            'CALM': 'Everything is Peaceful',
            'CURIOUS': 'Something Caught My Attention',
            'ALERT': 'Action Required'
        };
        return titles[state] || state;
    }

    // =========================================================================
    // L1 SOC - CELLULAR TRUST & SURVIVAL MODE
    // =========================================================================

    let l1Available = false;
    let survivalModeActive = false;

    // Fetch L1 SOC status
    async function fetchL1Status() {
        const l1Card = document.getElementById('l1-card');

        try {
            const response = await fetch(`${API_BASE}/l1/status`);
            const data = await response.json();

            if (data.success && data.available) {
                // Modem available - show L1 section with real data
                l1Available = true;
                l1Card.classList.remove('hidden');
                updateL1Display(data);  // Update the detailed L1 panel
            } else {
                // No modem or modem not responding - hide L1 section entirely
                l1Available = false;
                l1Card.classList.add('hidden');
                console.log('L1 Cellular: No modem detected, hiding section');
            }
        } catch (error) {
            // L1 not available (no LTE modem or API error) - hide section
            l1Available = false;
            l1Card.classList.add('hidden');
            console.log('L1 Cellular: API error, hiding section:', error.message);
        }
    }

    // Toggle survival mode
    window.toggleSurvivalMode = async function() {
        if (!l1Available) return;

        const newState = !survivalModeActive;
        const action = newState ? 'enter' : 'exit';

        try {
            const response = await fetch(`${API_BASE}/l1/survival/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            if (data.success) {
                survivalModeActive = newState;
                updateL1Trust({
                    trust_score: data.trust_score || 0,
                    survival_mode_active: newState
                });

                // Show notification
                showAINotification({
                    type: newState ? 'warning' : 'success',
                    headline: newState ? 'Survival Mode Activated' : 'Survival Mode Deactivated',
                    message: newState
                        ? 'Emergency protection enabled. VPN active, weak protocols disabled.'
                        : 'Returned to normal operation.',
                    icon: newState ? 'fa-shield-alt' : 'fa-check-circle'
                });
            }
        } catch (error) {
            console.error('Failed to toggle survival mode:', error);
        }
    };

    // Update presence bubbles
    function updatePresence(presence) {
        const countBadge = document.getElementById('presence-count');
        const bubbleList = document.getElementById('bubble-list');

        countBadge.textContent = `${presence.online_devices}/${presence.total_devices} online`;

        let html = '';
        for (const bubble of presence.bubbles) {
            const bgColor = bubble.color || ecosystemColors[bubble.ecosystem] || '#4fc3f7';
            const devices = bubble.devices.map(d => {
                const iconClass = deviceIcons[d.type] || deviceIcons.default;
                const onlineClass = d.online ? 'online' : '';
                return `<div class="device-chip ${onlineClass}">
                    <i class="fas ${iconClass}"></i>
                    ${d.name}
                </div>`;
            }).join('');

            html += `
            <div class="bubble-item">
                <div class="bubble-header">
                    <div class="bubble-info">
                        <div class="bubble-avatar" style="background: ${bgColor}20; color: ${bgColor}">
                            <i class="fas ${bubble.icon}"></i>
                        </div>
                        <div>
                            <div class="bubble-name">${bubble.label}</div>
                            <div class="bubble-meta">${bubble.devices.length} devices Â· ${bubble.ecosystem}</div>
                        </div>
                    </div>
                    <span class="trust-badge trust-${bubble.trust_level}">${bubble.trust_level}</span>
                </div>
                <div class="bubble-devices">
                    ${devices}
                </div>
            </div>`;
        }

        bubbleList.innerHTML = html;
    }

    // Update privacy feed
    function updatePrivacy(privacy) {
        const countBadge = document.getElementById('privacy-count');
        const feedList = document.getElementById('feed-list');

        if (privacy.unread_count > 0) {
            countBadge.textContent = `${privacy.unread_count} new`;
            countBadge.className = 'badge bg-warning';
        } else {
            countBadge.textContent = 'All clear';
            countBadge.className = 'badge bg-success';
        }

        let html = '';
        for (const event of privacy.events) {
            html += `
            <div class="feed-item ${event.color}">
                <div class="feed-icon ${event.color}">
                    <i class="fas ${event.icon}"></i>
                </div>
                <div class="feed-content">
                    <div class="feed-header">
                        <span class="feed-title">${event.title}</span>
                        <span class="feed-time">${event.time}</span>
                    </div>
                    <p class="feed-narrative">${event.narrative}</p>
                </div>
            </div>`;
        }

        feedList.innerHTML = html;
    }

    // =========================================================================
    // AI ACTIVITY FEED - "What I'm Doing"
    // =========================================================================

    let aiDecisions = [];

    // Update AI Activity feed
    function updateAIActivity(activity) {
        const countBadge = document.getElementById('ai-activity-count');
        const feedList = document.getElementById('ai-feed-list');
        const emptyState = document.getElementById('ai-feed-empty');

        if (!activity || !activity.decisions || activity.decisions.length === 0) {
            // Show empty state
            if (emptyState) emptyState.style.display = 'block';
            countBadge.textContent = 'All clear';
            countBadge.className = 'badge bg-success';
            return;
        }

        // Hide empty state
        if (emptyState) emptyState.style.display = 'none';

        // Update badge
        const pendingCount = activity.decisions.filter(d => d.pending).length;
        if (pendingCount > 0) {
            countBadge.textContent = `${pendingCount} pending`;
            countBadge.className = 'badge bg-warning';
        } else {
            countBadge.textContent = `${activity.decisions.length} actions`;
            countBadge.className = 'badge bg-info';
        }

        // Render decisions
        let html = '';
        for (const decision of activity.decisions.slice(0, 10)) {
            const colorClass = getDecisionColor(decision);
            const isPending = decision.pending || decision.confidence === 'low';

            html += `
            <div class="ai-feed-item ${colorClass} ${isPending ? 'pending' : ''}" data-decision-id="${decision.id}">
                <div class="ai-feed-icon ${colorClass}">
                    <i class="fas ${decision.icon || 'fa-robot'}"></i>
                </div>
                <div class="ai-feed-content">
                    <div class="ai-feed-header">
                        <span class="ai-feed-headline">${decision.headline}</span>
                        <span class="ai-feed-time">${decision.time}</span>
                    </div>
                    <p class="ai-feed-narrative">${decision.narrative}</p>
                    ${isPending ? `
                    <div class="ai-feed-actions">
                        <span class="ai-feed-countdown" data-countdown="${decision.auto_execute_in || 120}">
                            Auto-execute in <span class="countdown-value">2:00</span>
                        </span>
                        <button class="ai-feed-btn correct" onclick="approveAIDecision('${decision.id}')">
                            <i class="fas fa-check"></i> Do it
                        </button>
                        <button class="ai-feed-btn wrong" onclick="rejectAIDecision('${decision.id}')">
                            <i class="fas fa-times"></i> Don't
                        </button>
                    </div>
                    ` : decision.allow_feedback ? `
                    <div class="ai-feed-actions">
                        <button class="ai-feed-btn wrong" onclick="reportWrongDecision('${decision.id}')">
                            <i class="fas fa-exclamation-circle"></i> That was wrong
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>`;
        }

        feedList.innerHTML = html;

        // Start countdown timers for pending items
        startCountdownTimers();
    }

    function getDecisionColor(decision) {
        if (decision.severity === 'high' || decision.type === 'danger') return 'danger';
        if (decision.severity === 'medium' || decision.type === 'warning' || decision.pending) return 'warning';
        if (decision.type === 'info') return 'info';
        return 'success';
    }

    // Countdown timers for pending decisions
    function startCountdownTimers() {
        document.querySelectorAll('.ai-feed-countdown').forEach(el => {
            let seconds = parseInt(el.dataset.countdown) || 120;
            const valueEl = el.querySelector('.countdown-value');

            const timer = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(timer);
                    valueEl.textContent = 'executing...';
                    return;
                }
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                valueEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        });
    }

    // AI decision feedback functions
    window.approveAIDecision = async function(decisionId) {
        try {
            await fetch(`${API_BASE}/agent/decisions/${decisionId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            showAINotification({
                type: 'success',
                headline: 'Action approved',
                message: 'Executing the action now.',
                icon: 'fa-check-circle'
            });
            // Remove the pending item
            const item = document.querySelector(`[data-decision-id="${decisionId}"]`);
            if (item) item.remove();
        } catch (error) {
            console.error('Failed to approve decision:', error);
        }
    };

    window.rejectAIDecision = async function(decisionId) {
        try {
            await fetch(`${API_BASE}/agent/decisions/${decisionId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            showAINotification({
                type: 'info',
                headline: 'Action cancelled',
                message: 'I won\'t do that. Thanks for the feedback!',
                icon: 'fa-hand-paper'
            });
            // Remove the pending item
            const item = document.querySelector(`[data-decision-id="${decisionId}"]`);
            if (item) item.remove();
        } catch (error) {
            console.error('Failed to reject decision:', error);
        }
    };

    window.reportWrongDecision = async function(decisionId) {
        try {
            await fetch(`${API_BASE}/agent/decisions/${decisionId}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ correct: false })
            });
            showAINotification({
                type: 'info',
                headline: 'Thanks for the feedback',
                message: 'I\'ll learn from this and do better next time.',
                icon: 'fa-brain'
            });
        } catch (error) {
            console.error('Failed to report wrong decision:', error);
        }
    };

    // Show AI notification toast
    function showAINotification(notification) {
        // Create notification element
        const container = document.getElementById('ai-notification-container') ||
            createNotificationContainer();

        const notifEl = document.createElement('div');
        notifEl.className = `ai-notification ${notification.type}`;
        notifEl.innerHTML = `
            <div class="ai-notification-icon">
                <i class="fas ${notification.icon}"></i>
            </div>
            <div class="ai-notification-content">
                <div class="ai-notification-headline">${notification.headline}</div>
                <div class="ai-notification-message">${notification.message}</div>
            </div>
            <button class="ai-notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(notifEl);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notifEl.parentElement) {
                notifEl.classList.add('fade-out');
                setTimeout(() => notifEl.remove(), 300);
            }
        }, 5000);
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'ai-notification-container';
        document.body.appendChild(container);
        return container;
    }

    // =========================================================================
    // USER PROMPT MODAL - Only shows when AI confidence < 30%
    // =========================================================================

    let pendingPrompt = null; // Current pending prompt data

    // Show user prompt modal
    window.showUserPrompt = function(promptData) {
        pendingPrompt = promptData;
        const overlay = document.getElementById('user-prompt-overlay');

        // Update content
        document.getElementById('prompt-title').textContent = promptData.title || 'I need your input';
        document.getElementById('prompt-subtitle').textContent = promptData.subtitle ||
            'Even after consulting other AI models, I\'m uncertain about this decision';
        document.getElementById('prompt-situation').textContent = promptData.situation || 'Unknown situation';
        document.getElementById('prompt-analysis').textContent = promptData.analysis ||
            'I\'ve analyzed this situation but need your guidance.';

        // Update confidence bar
        const confidence = Math.round((promptData.confidence || 0.25) * 100);
        document.getElementById('prompt-confidence-fill').style.width = `${confidence}%`;
        document.getElementById('prompt-confidence-value').textContent = `${confidence}%`;

        // Update action buttons based on context
        const actionsEl = document.getElementById('prompt-actions');
        if (promptData.actions && promptData.actions.length > 0) {
            actionsEl.innerHTML = promptData.actions.map((action, index) => {
                const btnClass = index === 0 ? 'prompt-btn-primary' :
                                 action.type === 'danger' ? 'prompt-btn-danger' : 'prompt-btn-secondary';
                return `<button class="prompt-btn ${btnClass}" onclick="handlePromptAction('${action.id}')">
                    <i class="fas ${action.icon || 'fa-check'}"></i> ${action.label}
                </button>`;
            }).join('');
        }

        // Show the modal
        overlay.classList.add('visible');

        // Log that we showed a prompt
        console.log('User prompt shown:', promptData.decision_id);
    };

    // Handle user prompt action
    window.handlePromptAction = async function(actionId) {
        if (!pendingPrompt) {
            dismissUserPrompt();
            return;
        }

        const decisionId = pendingPrompt.decision_id;
        console.log(`User action: ${actionId} for decision ${decisionId}`);

        try {
            // Send user decision to backend
            const response = await fetch(`${API_BASE}/agent/decision/${decisionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: actionId,
                    user_decision: true,
                    timestamp: new Date().toISOString()
                })
            });

            const data = await response.json();

            if (data.success) {
                // Show success notification
                showAINotification({
                    type: 'success',
                    icon: 'fa-check-circle',
                    headline: 'Decision recorded',
                    message: `Your choice has been applied. I'll learn from this for future decisions.`
                });
            } else {
                showAINotification({
                    type: 'warning',
                    icon: 'fa-exclamation-triangle',
                    headline: 'Note',
                    message: data.message || 'Action recorded but backend processing pending.'
                });
            }
        } catch (error) {
            console.error('Failed to submit user decision:', error);
            showAINotification({
                type: 'info',
                icon: 'fa-info-circle',
                headline: 'Decision recorded locally',
                message: 'Your choice was recorded. Backend sync will retry.'
            });
        }

        // Clear and close
        pendingPrompt = null;
        dismissUserPrompt();
    };

    // Dismiss user prompt without action
    window.dismissUserPrompt = function() {
        const overlay = document.getElementById('user-prompt-overlay');
        overlay.classList.remove('visible');

        if (pendingPrompt) {
            console.log('User dismissed prompt:', pendingPrompt.decision_id);
            pendingPrompt = null;
        }
    };

    // Check for pending user prompts (called periodically)
    async function checkPendingPrompts() {
        try {
            const response = await fetch(`${API_BASE}/agent/prompts`);
            const data = await response.json();

            if (data.success && data.prompts && data.prompts.length > 0) {
                // Show the first pending prompt (oldest)
                const prompt = data.prompts[0];
                if (prompt.confidence < 0.30 && !pendingPrompt) {
                    showUserPrompt(prompt);
                }
            }
        } catch (error) {
            // Prompt endpoint may not exist yet - that's OK
            console.debug('Prompt check not available:', error.message);
        }
    }

    // Add prompt checking to initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Check for pending prompts after initial load
        setTimeout(checkPendingPrompts, 2000);
        // Then check periodically (every 10 seconds)
        setInterval(checkPendingPrompts, 10000);
    });

    // Update performance metrics
    function updatePerformance(performance) {
        // Fallback demo data if performance is missing
        if (!performance) {
            performance = {
                health_score: 92,
                insight: 'Network running smoothly',
                metrics: {
                    latency_ms: 12,
                    bandwidth_used_pct: 34,
                    uptime_pct: 99.8,
                    threats_blocked_24h: 47
                }
            };
        }

        const score = performance.health_score || 0;
        const gaugeFill = document.getElementById('health-gauge-fill');
        const scoreEl = document.getElementById('health-score');
        const insightEl = document.getElementById('health-insight');

        // Calculate gauge offset (circumference = 2 * PI * r = 2 * 3.14159 * 70 â‰ˆ 439.8)
        const circumference = 439.8;
        const offset = circumference - (circumference * score / 100);
        gaugeFill.style.strokeDashoffset = offset;

        // Determine color class
        let colorClass = 'good';
        if (score < 50) colorClass = 'critical';
        else if (score < 75) colorClass = 'warning';

        gaugeFill.className.baseVal = `health-gauge-fill ${colorClass}`;
        scoreEl.textContent = score;
        scoreEl.className = `health-score-number ${colorClass}`;

        // Update insight
        insightEl.textContent = performance.insight || 'Monitoring network health...';

        // Update metrics with fallbacks
        const metrics = performance.metrics || {};
        document.getElementById('metric-latency').textContent = metrics.latency_ms ?? '--';
        document.getElementById('metric-bandwidth').textContent = (metrics.bandwidth_used_pct ?? '--') + '%';
        document.getElementById('metric-uptime').textContent = (metrics.uptime_pct ?? '--') + '%';
        document.getElementById('metric-blocked').textContent = metrics.threats_blocked_24h ?? '--';
    }

    // Removed: Quick Actions (simplified UI)
    window.toggleAction = async function(actionId, activate) {
        try {
            const response = await fetch(`${API_BASE}/action/${actionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activate })
            });

            const data = await response.json();
            if (data.success) {
                // Update button state
                const btn = document.querySelector(`[data-action="${actionId}"]`);
                if (btn) {
                    if (activate) {
                        btn.classList.add('active');
                        btn.dataset.active = 'true';
                    } else {
                        btn.classList.remove('active');
                        btn.dataset.active = 'false';
                    }
                }
            }
        } catch (error) {
            console.error('Failed to toggle action:', error);
        }
    };

    // =========================================================================
    // L1 CELLULAR SECURITY
    // =========================================================================

    // L1 State
    let l1SurvivalMode = false;

    // Toggle L1 section expand/collapse
    window.toggleL1 = function() {
        const card = document.getElementById('l1-card');
        const toggle = document.getElementById('l1-toggle');
        const icon = toggle.querySelector('i');

        card.classList.toggle('collapsed');

        if (card.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            toggle.title = 'Expand details';
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            toggle.title = 'Collapse details';
            // Fetch L1 data when expanded
            fetchL1Status();
        }
    };

    // Toggle Survival Mode
    window.toggleSurvivalMode = async function() {
        const btn = document.getElementById('l1-survival-btn');
        const statusBadge = document.getElementById('l1-survival-status');

        try {
            if (l1SurvivalMode) {
                // Exit survival mode
                const response = await fetch('/aiochi/api/l1/survival/exit', { method: 'POST' });
                if (response.ok) {
                    l1SurvivalMode = false;
                    btn.className = 'l1-survival-btn enter';
                    btn.innerHTML = '<i class="fas fa-shield-alt"></i><span>Enter Survival Mode</span>';
                    statusBadge.className = 'l1-survival-status normal';
                    statusBadge.textContent = 'Normal';
                }
            } else {
                // Enter survival mode
                const response = await fetch('/aiochi/api/l1/survival/enter', { method: 'POST' });
                if (response.ok) {
                    l1SurvivalMode = true;
                    btn.className = 'l1-survival-btn exit';
                    btn.innerHTML = '<i class="fas fa-door-open"></i><span>Exit Survival Mode</span>';
                    statusBadge.className = 'l1-survival-status active';
                    statusBadge.textContent = 'Active';
                }
            }
        } catch (error) {
            console.error('Failed to toggle survival mode:', error);
        }
    };

    // Fetch L1 status - merged with main fetchL1Status function
    // NOTE: The primary fetchL1Status is defined earlier in the code (line ~3925)
    // This block handles the L1 panel display updates only

    // Get empty L1 data (when modem not available)
    function getEmptyL1Data() {
        return {
            available: false,
            network_type: 'N/A',
            carrier: 'No Modem',
            cell_id: '0x00000000',
            pci: '--',
            tac: '0x0000',
            band: '--',
            mcc_mnc: '--',
            rsrp: null,
            sinr: null,
            snr: null,
            distance_km: null,
            handovers_1h: 0,
            tower_status: 'unavailable',
            trust_score: 0,
            trust_components: {
                identity: 0,
                snr: 0,
                stability: 0,
                temporal: 0,
                handover: 0
            },
            survival_mode: false,
            vpn_ready: false,
            rrc_state: null,
            neighbor_count: 0,
            earfcn_valid: null,
            expected_band: null
        };
    }

    // Update L1 display with data
    function updateL1Display(data) {
        if (!data) return;

        // Update header badges
        updateL1NetworkBadge(data.network_type);
        updateL1SignalBars(data.rsrp);
        updateL1TrustMini(data.trust_score);

        // Update cell info
        document.getElementById('l1-cell-id').textContent = data.cell_id || '--';
        document.getElementById('l1-pci').textContent = data.pci || '--';
        document.getElementById('l1-tac').textContent = data.tac || '--';
        document.getElementById('l1-band').textContent = data.band || '--';
        document.getElementById('l1-carrier').textContent = data.carrier || '--';
        document.getElementById('l1-mccmnc').textContent = data.mcc_mnc || '--';

        // Update signal metrics
        document.getElementById('l1-rsrp').textContent = data.rsrp ? `${data.rsrp} dBm` : '--';
        document.getElementById('l1-sinr').textContent = data.sinr ? `${data.sinr} dB` : '--';
        document.getElementById('l1-snr').textContent = data.snr ? `${data.snr} dB` : '--';
        document.getElementById('l1-distance').textContent = data.distance_km ? `~${data.distance_km} km` : '--';
        document.getElementById('l1-handovers').textContent = data.handovers_1h ?? '--';

        // Update tower status
        const towerStatus = document.getElementById('l1-tower-status');
        if (data.tower_status === 'verified') {
            towerStatus.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
            towerStatus.style.color = 'var(--aiochi-calm)';
        } else if (data.tower_status === 'unknown') {
            towerStatus.innerHTML = '<i class="fas fa-question-circle"></i> Unknown';
            towerStatus.style.color = 'var(--aiochi-curious)';
        } else {
            towerStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Suspicious';
            towerStatus.style.color = 'var(--aiochi-alert)';
        }

        // Update trust score gauge
        updateL1TrustGauge(data.trust_score);

        // Update trust components
        if (data.trust_components) {
            updateL1Component('identity', data.trust_components.identity);
            updateL1Component('snr', data.trust_components.snr);
            updateL1Component('stability', data.trust_components.stability);
            updateL1Component('temporal', data.trust_components.temporal);
            updateL1Component('handover', data.trust_components.handover);
        }

        // Update survival mode
        l1SurvivalMode = data.survival_mode || false;
        const btn = document.getElementById('l1-survival-btn');
        const statusBadge = document.getElementById('l1-survival-status');
        const statusMini = document.getElementById('l1-survival-status-mini');
        if (l1SurvivalMode) {
            btn.className = 'l1-survival-btn exit';
            btn.innerHTML = '<i class="fas fa-door-open"></i><span>Exit Survival Mode</span>';
            statusBadge.className = 'l1-survival-status active';
            statusBadge.textContent = 'Active';
            if (statusMini) {
                statusMini.className = 'l1-survival-status active';
                statusMini.textContent = 'Active';
            }
        } else {
            btn.className = 'l1-survival-btn enter';
            btn.innerHTML = '<i class="fas fa-shield-alt"></i><span>Enter Survival Mode</span>';
            statusBadge.className = 'l1-survival-status normal';
            statusBadge.textContent = 'Normal';
            if (statusMini) {
                statusMini.className = 'l1-survival-status normal';
                statusMini.textContent = 'Normal';
            }
        }

        // Update VPN status
        const vpnIcon = document.getElementById('l1-vpn-icon');
        const vpnText = document.getElementById('l1-vpn-text');
        if (data.vpn_ready) {
            vpnIcon.className = 'fas fa-check-circle ready';
            vpnText.textContent = 'VPN Pre-Established';
        } else {
            vpnIcon.className = 'fas fa-exclamation-circle not-ready';
            vpnText.textContent = 'VPN Not Ready';
        }

        // Update Security Gauges
        updateSecurityGauges(data);
    }

    // Update L1 network type badge
    function updateL1NetworkBadge(networkType) {
        const badge = document.getElementById('l1-network-type');
        const type = (networkType || '').toLowerCase();
        badge.innerHTML = `<i class="fas fa-signal"></i> ${networkType || 'Unknown'}`;

        // Remove all type classes
        badge.classList.remove('lte', 'g5', 'g5sa', 'g4', 'g3', 'offline');

        // Add appropriate class
        if (type.includes('5g sa')) {
            badge.classList.add('g5sa');
        } else if (type.includes('5g')) {
            badge.classList.add('g5');
        } else if (type.includes('lte') || type.includes('4g')) {
            badge.classList.add('lte');
        } else if (type.includes('3g')) {
            badge.classList.add('g3');
        } else {
            badge.classList.add('offline');
        }
    }

    // Update L1 signal bars
    function updateL1SignalBars(rsrp) {
        const indicator = document.getElementById('l1-signal-bars');
        indicator.classList.remove('excellent', 'good', 'fair', 'poor', 'none');

        if (rsrp >= -80) {
            indicator.classList.add('excellent');
        } else if (rsrp >= -90) {
            indicator.classList.add('good');
        } else if (rsrp >= -100) {
            indicator.classList.add('fair');
        } else if (rsrp >= -110) {
            indicator.classList.add('poor');
        } else {
            indicator.classList.add('none');
        }
    }

    // Update L1 trust mini badge in header
    function updateL1TrustMini(score) {
        const badge = document.getElementById('l1-trust-mini');
        badge.innerHTML = `<i class="fas fa-shield-alt"></i> ${score}%`;
        badge.classList.remove('trusted', 'suspicious', 'hostile');

        if (score >= 70) {
            badge.classList.add('trusted');
        } else if (score >= 30) {
            badge.classList.add('suspicious');
        } else {
            badge.classList.add('hostile');
        }
    }

    // Update L1 trust gauge
    function updateL1TrustGauge(score) {
        const progress = document.getElementById('l1-trust-progress');
        const value = document.getElementById('l1-trust-value');
        const label = document.getElementById('l1-trust-label');

        progress.setAttribute('stroke-dasharray', `${score}, 100`);
        value.textContent = `${score}%`;

        // Update colors
        progress.classList.remove('trusted', 'suspicious', 'hostile');
        label.classList.remove('trusted', 'suspicious', 'hostile');

        if (score >= 70) {
            progress.classList.add('trusted');
            label.classList.add('trusted');
            label.textContent = 'TRUSTED';
        } else if (score >= 30) {
            progress.classList.add('suspicious');
            label.classList.add('suspicious');
            label.textContent = 'SUSPICIOUS';
        } else {
            progress.classList.add('hostile');
            label.classList.add('hostile');
            label.textContent = 'HOSTILE';
        }
    }

    // Update L1 trust component
    function updateL1Component(name, value) {
        const fill = document.getElementById(`l1-comp-${name}`);
        const valueEl = document.getElementById(`l1-comp-${name}-val`);

        if (fill && valueEl) {
            fill.style.width = `${value}%`;
            valueEl.textContent = `${value}%`;

            // Update color class
            fill.classList.remove('high', 'medium', 'low');
            if (value >= 70) {
                fill.classList.add('high');
            } else if (value >= 40) {
                fill.classList.add('medium');
            } else {
                fill.classList.add('low');
            }
        }
    }

    // =========================================================================
    // SECURITY GAUGES
    // =========================================================================

    let previousNeighborCount = null;  // Track neighbor count changes
    let rrcConnectingStartTime = null; // Track how long in rrc-connecting state

    // Update Security Gauges from L1 data
    function updateSecurityGauges(data) {
        if (!data) return;

        // Update Neighbor Density Meter
        updateNeighborDensityGauge(data.neighbor_count);

        // Update EARFCN Consistency Check
        updateEarfcnConsistencyGauge(data.earfcn, data.band, data.earfcn_valid, data.expected_band);

        // Update RRC State Watcher
        updateRrcStateGauge(data.rrc_state);
    }

    // Neighbor Density Meter
    function updateNeighborDensityGauge(count) {
        const gauge = document.getElementById('gauge-neighbor-density');
        const numberEl = gauge.querySelector('.l1-gauge-number');
        const barFill = document.getElementById('gauge-neighbor-bar');
        const statusEl = document.getElementById('gauge-neighbor-status');

        if (count === null || count === undefined) {
            numberEl.textContent = '--';
            return;
        }

        numberEl.textContent = count;

        // Calculate bar width (0 neighbors = 0%, 5+ neighbors = 100%)
        const barPercent = Math.min(count * 20, 100);
        barFill.style.width = `${barPercent}%`;

        // Determine status
        gauge.classList.remove('alert', 'warning');
        barFill.classList.remove('normal', 'warning', 'alert');
        statusEl.classList.remove('normal', 'warning', 'alert');

        // Check for Radio Isolation Alert (drop from 4+ to 1)
        if (previousNeighborCount !== null && previousNeighborCount >= 4 && count <= 1) {
            // Radio Isolation Alert!
            gauge.classList.add('alert');
            barFill.classList.add('alert');
            statusEl.classList.add('alert');
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Radio Isolation!';
            showL1SecurityAlert('Radio Isolation Alert',
                `Neighbor PCIs dropped from ${previousNeighborCount} to ${count}. Possible IMSI catcher or jammer nearby.`);
        } else if (count <= 1) {
            // Warning: Low neighbor count
            gauge.classList.add('warning');
            barFill.classList.add('warning');
            statusEl.classList.add('warning');
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Low Density';
        } else if (count <= 2) {
            // Caution
            barFill.classList.add('warning');
            statusEl.classList.add('warning');
            statusEl.innerHTML = '<i class="fas fa-minus-circle"></i> Sparse';
        } else {
            // Normal
            barFill.classList.add('normal');
            statusEl.classList.add('normal');
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Normal';
        }

        previousNeighborCount = count;
    }

    // EARFCN Consistency Check
    function updateEarfcnConsistencyGauge(earfcn, band, earfcnValid, expectedBand) {
        const gauge = document.getElementById('gauge-earfcn-check');
        const numberEl = document.getElementById('gauge-earfcn-number');
        const bandEl = document.getElementById('gauge-earfcn-band');
        const barFill = document.getElementById('gauge-earfcn-bar');
        const statusEl = document.getElementById('gauge-earfcn-status');

        if (!earfcn) {
            numberEl.textContent = '--';
            bandEl.textContent = '--';
            return;
        }

        numberEl.textContent = earfcn;
        bandEl.textContent = band || '--';

        gauge.classList.remove('alert', 'warning');
        barFill.classList.remove('normal', 'warning', 'alert');
        statusEl.classList.remove('normal', 'warning', 'alert');

        if (earfcnValid === false) {
            // Protocol Spoofing Alert!
            gauge.classList.add('alert');
            barFill.classList.add('alert');
            barFill.style.width = '100%';
            statusEl.classList.add('alert');
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Spoofing! Should be ${expectedBand}`;
            showL1SecurityAlert('Protocol Spoofing Alert',
                `EARFCN ${earfcn} should be ${expectedBand}, but tower claims ${band}. Possible fake base station.`);
        } else if (earfcnValid === true) {
            // Verified
            barFill.classList.add('normal');
            barFill.style.width = '100%';
            statusEl.classList.add('normal');
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
        } else {
            // Unknown/Can't verify
            barFill.classList.add('warning');
            barFill.style.width = '50%';
            statusEl.classList.add('warning');
            statusEl.innerHTML = '<i class="fas fa-question-circle"></i> Unverified';
        }
    }

    // RRC State Watcher
    function updateRrcStateGauge(rrcState) {
        const gauge = document.getElementById('gauge-rrc-state');
        const stateEl = document.getElementById('gauge-rrc-current');
        const barFill = document.getElementById('gauge-rrc-bar');
        const statusEl = document.getElementById('gauge-rrc-status');

        if (!rrcState) {
            stateEl.textContent = '--';
            return;
        }

        // Format state for display
        const stateDisplay = rrcState.replace('rrc-', '').toUpperCase();
        stateEl.textContent = stateDisplay;

        gauge.classList.remove('alert', 'warning');
        barFill.classList.remove('normal', 'warning', 'alert');
        statusEl.classList.remove('normal', 'warning', 'alert');

        if (rrcState === 'rrc-idle') {
            // Healthy idle state - phone is dormant, saving battery
            rrcConnectingStartTime = null;
            barFill.classList.add('normal');
            barFill.style.width = '100%';
            statusEl.classList.add('normal');
            statusEl.innerHTML = '<i class="fas fa-moon"></i> Idle';
        } else if (rrcState === 'rrc-connected') {
            // Best state - active data connection
            rrcConnectingStartTime = null;  // Reset timer - connection succeeded
            barFill.classList.add('normal');
            barFill.style.width = '100%';
            statusEl.classList.add('normal');
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
        } else if (rrcState === 'rrc-connecting') {
            // Transitional state - only alert if stuck here too long
            const now = Date.now();
            if (rrcConnectingStartTime === null) {
                rrcConnectingStartTime = now;
            }

            const timeInState = (now - rrcConnectingStartTime) / 1000; // seconds

            if (timeInState > 60) {
                // Signaling Storm Alert - stuck in connecting for over 1 minute
                gauge.classList.add('alert');
                barFill.classList.add('alert');
                barFill.style.width = '100%';
                statusEl.classList.add('alert');
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Stuck!';
                showL1SecurityAlert('Connection Blocked',
                    `RRC stuck in CONNECTING for ${Math.round(timeInState)}s. Possible jamming or L1 DoS attack.`);
            } else if (timeInState > 30) {
                // Warning - taking too long
                gauge.classList.add('warning');
                barFill.classList.add('warning');
                barFill.style.width = '75%';
                statusEl.classList.add('warning');
                statusEl.innerHTML = '<i class="fas fa-clock"></i> Slow';
            } else {
                // Normal transition - briefly connecting
                barFill.classList.add('normal');
                barFill.style.width = '50%';
                statusEl.classList.add('normal');
                statusEl.innerHTML = '<i class="fas fa-sync-alt"></i> Connecting';
            }
        } else {
            // Unknown state
            barFill.classList.add('warning');
            barFill.style.width = '50%';
            statusEl.classList.add('warning');
            statusEl.innerHTML = '<i class="fas fa-question-circle"></i> Unknown';
        }
    }

    // Show L1 Security Alert Banner
    function showL1SecurityAlert(title, message) {
        const alertEl = document.getElementById('l1-security-alert');
        const titleEl = document.getElementById('l1-alert-title');
        const messageEl = document.getElementById('l1-alert-message');

        titleEl.textContent = title;
        messageEl.textContent = message;
        alertEl.classList.remove('hidden');

        // Auto-dismiss after 30 seconds
        setTimeout(() => {
            if (!alertEl.classList.contains('hidden')) {
                alertEl.classList.add('hidden');
            }
        }, 30000);
    }

    // Dismiss L1 Security Alert
    window.dismissL1Alert = function() {
        document.getElementById('l1-security-alert').classList.add('hidden');
    };

    // Initialize L1 - will auto-hide if no modem detected
    // No demo data - only show real modem data
    setTimeout(() => {
        fetchL1Status();
    }, 1000);

    // =========================================================================
    // BUBBLE MANAGER
    // =========================================================================

    // State
    let bubblesData = { bubbles: [], unassigned_devices: [] };
    let selectedColor = '#2196F3';
    let draggedDevice = null;
    let draggedFromBubble = null;

    // Icon mapping for bubble types
    const typeIcons = {
        'FAMILY': 'fa-users',
        'GUEST': 'fa-user-friends',
        'IOT': 'fa-home',
        'WORK': 'fa-briefcase',
        'CUSTOM': 'fa-layer-group'
    };

    // Fetch bubbles from API
    async function fetchBubbles() {
        try {
            const response = await fetch(`${API_BASE}/bubbles`);
            const data = await response.json();
            if (data.success) {
                bubblesData = data;
                renderBubbles();
            }
        } catch (error) {
            console.error('Failed to fetch bubbles:', error);
        }
    }

    // Render bubbles grid
    function renderBubbles() {
        const grid = document.getElementById('bubble-grid');
        const unassignedEl = document.getElementById('unassigned-devices');

        let html = '';

        // Render each bubble
        for (const bubble of bubblesData.bubbles) {
            const devices = bubble.devices || [];
            const policy = bubble.policy || {};

            // Check if this is quarantine (system-managed - NO CRUD)
            const isQuarantine = bubble.bubble_id === 'SYSTEM-QUARANTINE' ||
                                 bubble.bubble_type === 'QUARANTINE' ||
                                 bubble.bubble_type === 'quarantine';

            // Special styling for quarantine: red dotted border, permanent look
            const quarantineStyle = isQuarantine
                ? 'border: 1px dotted #F44336 !important; border-left: 4px solid #F44336 !important;'
                : '';
            const quarantineClass = isQuarantine ? 'quarantine-bubble' : '';

            html += `
            <div class="bubble-card ${quarantineClass}"
                 data-bubble-id="${bubble.bubble_id}"
                 style="${quarantineStyle}"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event, '${bubble.bubble_id}')">
                <div class="bubble-card-header">
                    <div class="bubble-card-info">
                        <div class="bubble-card-avatar" style="background: ${bubble.color}20; color: ${bubble.color}">
                            <i class="fas ${bubble.icon || typeIcons[bubble.bubble_type] || 'fa-layer-group'}"></i>
                        </div>
                        <div>
                            <div class="bubble-card-name">${bubble.name}</div>
                            <div class="bubble-card-type">${isQuarantine ? '<i class="fas fa-lock mr-1"></i>System' : bubble.bubble_type}</div>
                        </div>
                    </div>
                    <div class="bubble-card-actions">
                        ${isQuarantine ? '' : `
                        <button onclick="openEditBubbleModal('${bubble.bubble_id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        `}
                    </div>
                </div>
                <div class="bubble-card-devices">
                    ${devices.map(d => {
                        // Apply D2D cluster color - devices that communicate show same color
                        // This makes it visually obvious across bubbles which devices talk to each other
                        const hasCluster = d.d2d_cluster && d.d2d_cluster.cluster_color;
                        const clusterColor = hasCluster ? d.d2d_cluster.cluster_color : '';
                        // Convert hex to rgba for background with opacity
                        const bgColor = hasCluster ? clusterColor + '25' : '';  // 25 = ~15% opacity in hex
                        const clusterStyle = hasCluster
                            ? `color: ${clusterColor} !important; border-left-color: ${clusterColor}; border-color: ${clusterColor}40; background: ${bgColor}; font-weight: 600;`
                            : '';
                        const clusterClass = hasCluster ? 'd2d-clustered' : '';
                        const clusterTitle = hasCluster
                            ? `D2D Cluster #${d.d2d_cluster.cluster_id + 1}: ${d.d2d_cluster.device_count} devices communicate together (affinity: ${(d.d2d_cluster.avg_affinity * 100).toFixed(0)}%)`
                            : '';
                        return `
                        <div class="device-tag ${d.online !== false ? 'online' : 'offline'} ${clusterClass}"
                             draggable="true"
                             data-mac="${d.mac}"
                             data-bubble="${bubble.bubble_id}"
                             data-d2d-cluster="${hasCluster ? d.d2d_cluster.cluster_id : ''}"
                             style="${clusterStyle}"
                             title="${clusterTitle || d.vendor || ''}"
                             ondragstart="handleDragStart(event, '${d.mac}', '${bubble.bubble_id}')"
                             ondragend="handleDragEnd(event)">
                            ${d.label || d.mac}
                        </div>`;
                    }).join('')}
                    ${devices.length === 0 ? '<span style="color: var(--aiochi-text-muted); font-size: 0.75rem;">Drop devices here</span>' : ''}
                </div>
                <div class="bubble-card-footer">
                    <div class="bubble-policy-badges">
                        <span class="policy-badge ${policy.internet !== false ? 'active' : 'inactive'}">Internet</span>
                        <span class="policy-badge ${policy.lan ? 'active' : 'inactive'}">LAN</span>
                        <span class="policy-badge ${policy.d2d ? 'active' : 'inactive'}">D2D</span>
                    </div>
                    <span class="bubble-device-count">${devices.length} devices</span>
                </div>
            </div>`;
        }

        // Add "Create New Bubble" card
        html += `
        <div class="bubble-card create-bubble-card" onclick="openCreateBubbleModal()">
            <i class="fas fa-plus-circle"></i>
            <span>Create New Bubble</span>
        </div>`;

        grid.innerHTML = html;

        // Render unassigned devices
        const unassigned = bubblesData.unassigned_devices || [];
        if (unassigned.length > 0) {
            unassignedEl.innerHTML = unassigned.map(d => {
                // Apply D2D cluster color - devices that communicate show same color
                // This makes it visually obvious which unassigned devices should be grouped together
                const hasCluster = d.d2d_cluster && d.d2d_cluster.cluster_color;
                const clusterColor = hasCluster ? d.d2d_cluster.cluster_color : '';
                // Convert hex to rgba for background with opacity
                const bgColor = hasCluster ? clusterColor + '25' : '';  // 25 = ~15% opacity in hex
                const clusterStyle = hasCluster
                    ? `color: ${clusterColor} !important; border-left-color: ${clusterColor}; border-color: ${clusterColor}40; background: ${bgColor}; font-weight: 600;`
                    : '';
                const clusterClass = hasCluster ? 'd2d-clustered' : '';
                const clusterTitle = hasCluster
                    ? `D2D Cluster #${d.d2d_cluster.cluster_id + 1}: ${d.d2d_cluster.device_count} devices communicate together (affinity: ${(d.d2d_cluster.avg_affinity * 100).toFixed(0)}%)`
                    : '';
                return `
                <div class="device-tag ${clusterClass}"
                     draggable="true"
                     data-mac="${d.mac}"
                     data-bubble=""
                     data-d2d-cluster="${hasCluster ? d.d2d_cluster.cluster_id : ''}"
                     style="${clusterStyle}"
                     title="${clusterTitle || d.vendor || ''}"
                     ondragstart="handleDragStart(event, '${d.mac}', '')"
                     ondragend="handleDragEnd(event)">
                    ${d.label || d.mac}
                </div>`;
            }).join('');
            document.getElementById('unassigned-section').style.display = 'block';
        } else {
            unassignedEl.innerHTML = '<span style="color: var(--aiochi-text-muted); font-size: 0.75rem;">No unassigned devices</span>';
        }
    }

    // Drag and drop handlers
    window.handleDragStart = function(event, mac, bubbleId) {
        draggedDevice = mac;
        draggedFromBubble = bubbleId;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', mac);
    };

    window.handleDragEnd = function(event) {
        event.target.classList.remove('dragging');
        // Remove drop-target class from all cards
        document.querySelectorAll('.bubble-card').forEach(card => {
            card.classList.remove('drop-target');
        });
    };

    window.handleDragOver = function(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        // Add visual feedback
        const card = event.target.closest('.bubble-card');
        if (card && !card.classList.contains('create-bubble-card')) {
            card.classList.add('drop-target');
        }
    };

    window.handleDrop = async function(event, targetBubbleId) {
        event.preventDefault();

        // Remove drop-target class
        document.querySelectorAll('.bubble-card').forEach(card => {
            card.classList.remove('drop-target');
        });

        if (!draggedDevice) return;

        // Don't do anything if dropped on same bubble
        if (draggedFromBubble === targetBubbleId) {
            draggedDevice = null;
            draggedFromBubble = null;
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/bubbles/move-device`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mac: draggedDevice,
                    from_bubble: draggedFromBubble || null,
                    to_bubble: targetBubbleId
                })
            });

            const data = await response.json();
            if (data.success) {
                // Refresh bubbles
                fetchBubbles();
            } else {
                console.error('Move device failed:', data.error);
            }
        } catch (error) {
            console.error('Failed to move device:', error);
        }

        draggedDevice = null;
        draggedFromBubble = null;
    };

    // Modal functions
    window.openCreateBubbleModal = function() {
        document.getElementById('bubble-modal-title').textContent = 'Create New Bubble';
        document.getElementById('bubble-edit-id').value = '';
        document.getElementById('bubble-name').value = '';
        document.getElementById('bubble-type').value = 'FAMILY';
        document.getElementById('bubble-delete-btn').style.display = 'none';
        selectColor('#2196F3');
        document.getElementById('bubble-modal-overlay').classList.add('active');
    };

    window.openEditBubbleModal = function(bubbleId) {
        const bubble = bubblesData.bubbles.find(b => b.bubble_id === bubbleId);
        if (!bubble) return;

        // Check if this is quarantine (system-managed - NO EDIT)
        const isQuarantine = bubbleId === 'SYSTEM-QUARANTINE' ||
                             bubble.bubble_type === 'QUARANTINE' ||
                             bubble.bubble_type === 'quarantine';

        if (isQuarantine) {
            alert('Quarantine is a system-managed group and cannot be modified. You can only add or remove devices from Quarantine.');
            return;
        }

        document.getElementById('bubble-modal-title').textContent = 'Edit Bubble';
        document.getElementById('bubble-edit-id').value = bubbleId;
        document.getElementById('bubble-name').value = bubble.name;
        document.getElementById('bubble-type').value = bubble.bubble_type;
        document.getElementById('bubble-delete-btn').style.display = 'block';
        selectColor(bubble.color || '#2196F3');
        document.getElementById('bubble-modal-overlay').classList.add('active');
    };

    window.closeBubbleModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('bubble-modal-overlay').classList.remove('active');
    };

    window.selectColor = function(color) {
        selectedColor = color;
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.color === color);
        });
    };

    window.saveBubble = async function() {
        const bubbleId = document.getElementById('bubble-edit-id').value;
        const name = document.getElementById('bubble-name').value.trim();
        const bubbleType = document.getElementById('bubble-type').value;

        if (!name) {
            alert('Please enter a bubble name');
            return;
        }

        try {
            let url = `${API_BASE}/bubbles`;
            let method = 'POST';

            if (bubbleId) {
                url = `${API_BASE}/bubbles/${bubbleId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    bubble_type: bubbleType,
                    color: selectedColor,
                    icon: typeIcons[bubbleType] || 'fa-layer-group'
                })
            });

            const data = await response.json();
            if (data.success) {
                closeBubbleModal();
                fetchBubbles();
            } else {
                alert(data.error || 'Failed to save bubble');
            }
        } catch (error) {
            console.error('Failed to save bubble:', error);
            alert('Failed to save bubble');
        }
    };

    window.deleteBubble = async function() {
        const bubbleId = document.getElementById('bubble-edit-id').value;
        if (!bubbleId) return;

        if (!confirm('Are you sure you want to delete this bubble? Devices will be moved to unassigned.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/bubbles/${bubbleId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                closeBubbleModal();
                fetchBubbles();
            } else {
                alert(data.error || 'Failed to delete bubble');
            }
        } catch (error) {
            console.error('Failed to delete bubble:', error);
            alert('Failed to delete bubble');
        }
    };

    // Initialize bubbles on load
    document.addEventListener('DOMContentLoaded', function() {
        fetchBubbles();
    });

    // =========================================================================
    // ACTIVE DEFENSES - 5 INNOVATIONS
    // =========================================================================

    // Toggle defenses section expand/collapse
    window.toggleDefenses = function() {
        const card = document.querySelector('.defenses-card');
        const toggle = document.getElementById('defenses-toggle');
        const icon = toggle.querySelector('i');

        card.classList.toggle('collapsed');

        if (card.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            toggle.title = 'Expand details';
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            toggle.title = 'Collapse details';
            // Fetch data for active tab when expanded
            const activeTab = document.querySelector('.defense-tab.active');
            if (activeTab) {
                fetchDefenseData(activeTab.dataset.tab);
            }
        }
    };

    // Update summary badges (called when data changes)
    function updateDefenseSummaryBadges(tabName, count) {
        const badge = document.getElementById(`summary-${tabName}`);
        if (badge) {
            const span = badge.querySelector('span');
            if (span) {
                span.textContent = count;
            }
            // Highlight badge if count > 0
            if (count > 0) {
                badge.classList.add('active');
            } else {
                badge.classList.remove('active');
            }
        }
    }

    // Fetch all defense summaries for collapsed view
    async function fetchDefenseSummaries() {
        try {
            const tabs = ['friction', 'ghost', 'chain', 'honeypot', 'gravity'];
            for (const tab of tabs) {
                const response = await fetch(`${API_BASE}/defenses/${tab}`);
                const data = await response.json();
                if (data.success) {
                    let count = 0;
                    switch(tab) {
                        case 'friction': count = data.stats?.active || 0; break;
                        case 'ghost': count = data.stats?.probes_24h || 0; break;
                        case 'chain': count = data.stats?.predictions || 0; break;
                        case 'honeypot': count = data.stats?.traps || 0; break;
                        case 'gravity': count = data.stats?.fields || 0; break;
                    }
                    updateDefenseSummaryBadges(tab, count);
                }
            }
        } catch (error) {
            console.error('Failed to fetch defense summaries:', error);
        }
    }

    // Switch defense tabs
    window.switchDefenseTab = function(tabName) {
        // Update tab buttons
        document.querySelectorAll('.defense-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Update panels
        document.querySelectorAll('.defense-panel').forEach(panel => {
            panel.classList.toggle('active', panel.id === `panel-${tabName}`);
        });

        // Fetch data for the active tab
        fetchDefenseData(tabName);
    };

    // Fetch defense data based on active tab
    async function fetchDefenseData(tabName) {
        try {
            const response = await fetch(`${API_BASE}/defenses/${tabName}`);
            const data = await response.json();

            if (data.success) {
                switch(tabName) {
                    case 'friction': updateFriction(data); break;
                    case 'ghost': updateGhostProbe(data); break;
                    case 'chain': updateChainPredictor(data); break;
                    case 'honeypot': updateHoneypot(data); break;
                    case 'gravity': updateGravity(data); break;
                }
            }
        } catch (error) {
            console.error(`Failed to fetch ${tabName} data:`, error);
        }
    }

    // Update Friction Control panel
    function updateFriction(data) {
        document.getElementById('friction-active').textContent = data.stats.active || 0;
        document.getElementById('friction-subtle').textContent = data.stats.subtle || 0;
        document.getElementById('friction-degraded').textContent = data.stats.degraded || 0;
        document.getElementById('friction-severe').textContent = data.stats.severe || 0;
        document.getElementById('friction-count').textContent = `${data.devices?.length || 0} devices`;

        const listEl = document.getElementById('friction-list');
        if (!data.devices || data.devices.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No friction applied. All devices are operating normally.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.devices.map(d => `
            <div class="friction-item">
                <div class="friction-device">
                    <span class="friction-mac">${d.mac}</span>
                    <span class="friction-label">${d.label || 'Unknown'}</span>
                </div>
                <div class="friction-details">
                    <span class="friction-level ${d.level}">${d.level}</span>
                    <span class="friction-delay">${d.delay_ms}ms</span>
                    <span class="friction-qsecbit">QSecBit: ${(d.qsecbit * 100).toFixed(0)}%</span>
                </div>
                <div class="friction-reason">${d.reason}</div>
            </div>
        `).join('');
    }

    // Update Ghost Probe panel
    function updateGhostProbe(data) {
        document.getElementById('ghost-probes').textContent = data.stats.probes_24h || 0;
        document.getElementById('ghost-clean').textContent = data.stats.clean || 0;
        document.getElementById('ghost-suspicious').textContent = data.stats.suspicious || 0;
        document.getElementById('ghost-masquerade').textContent = data.stats.masquerading || 0;

        const listEl = document.getElementById('ghost-list');
        if (!data.probes || data.probes.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>No recent probes. Click "Probe All Devices" to start active interrogation.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.probes.map(p => `
            <div class="ghost-item">
                <div class="ghost-device">
                    <span class="ghost-mac">${p.mac}</span>
                    <span class="ghost-label">${p.label || p.claimed_vendor || 'Unknown'}</span>
                </div>
                <div class="ghost-verdict-row">
                    <span class="ghost-verdict ${p.verdict}">${p.verdict}</span>
                    <span class="ghost-confidence">${(p.confidence * 100).toFixed(0)}% confidence</span>
                </div>
                <div class="ghost-details">
                    <span>Claimed: ${p.claimed_vendor || 'None'}</span>
                    <span>Actual: ${p.actual_vendor || 'Unknown'}</span>
                    <span class="ghost-action ${p.action}">${p.action}</span>
                </div>
            </div>
        `).join('');
    }

    // Run probe on all devices
    window.runProbeAll = async function() {
        const btn = document.querySelector('.btn-probe-all');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probing...';

        try {
            const response = await fetch(`${API_BASE}/defenses/ghost/probe-all`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                fetchDefenseData('ghost');
            }
        } catch (error) {
            console.error('Failed to run probe:', error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-radar"></i> Probe All Devices';
        }
    };

    // Update Chain Predictor panel
    function updateChainPredictor(data) {
        document.getElementById('chain-predictions').textContent = data.stats.predictions_24h || 0;
        document.getElementById('chain-hardened').textContent = data.stats.hardened || 0;
        document.getElementById('chain-prevented').textContent = data.stats.prevented || 0;
        document.getElementById('chain-active').textContent = data.stats.active_chains || 0;
        document.getElementById('chain-count').textContent = `${data.chains?.length || 0} active`;

        const listEl = document.getElementById('chain-list');
        if (!data.chains || data.chains.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-brain"></i>
                    <p>No attack chains detected. The AI is monitoring for MITRE ATT&CK sequences.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.chains.map(c => `
            <div class="chain-item">
                <div class="chain-header">
                    <span class="chain-id">${c.chain_id.slice(0, 8)}</span>
                    <span class="chain-stage">${c.current_stage}/${c.total_stages}</span>
                    <span class="chain-confidence ${c.confidence > 0.7 ? 'high' : 'medium'}">${(c.confidence * 100).toFixed(0)}%</span>
                </div>
                <div class="chain-techniques">
                    ${c.techniques.map(t => `<span class="mitre-tag">${t}</span>`).join('')}
                </div>
                <div class="chain-prediction">
                    <span class="chain-label">Next likely:</span>
                    ${c.predicted_next.map(p => `<span class="predicted-technique">${p.technique} (${(p.probability * 100).toFixed(0)}%)</span>`).join('')}
                </div>
                <div class="chain-device">
                    <span>Device: ${c.device_mac}</span>
                    <span class="chain-status ${c.status}">${c.status}</span>
                </div>
            </div>
        `).join('');
    }

    // Update Honeypot Mesh panel
    function updateHoneypot(data) {
        document.getElementById('honeypot-touches').textContent = data.stats.touches_24h || 0;
        document.getElementById('honeypot-ports').textContent = data.stats.dark_ports || 0;
        document.getElementById('honeypot-attackers').textContent = data.stats.unique_attackers || 0;
        document.getElementById('honeypot-critical').textContent = data.stats.critical_threats || 0;
        document.getElementById('honeypot-count').textContent = `${data.attackers?.length || 0} tracked`;

        const listEl = document.getElementById('honeypot-list');
        if (!data.attackers || data.attackers.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-check"></i>
                    <p>No honeypot touches detected. Dark ports are active and monitoring.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.attackers.map(a => `
            <div class="honeypot-item ${a.threat_level}">
                <div class="honeypot-header">
                    <span class="attacker-ip">${a.source_ip}</span>
                    <span class="threat-level-badge ${a.threat_level}">${a.threat_level}</span>
                </div>
                <div class="honeypot-ports">
                    ${a.ports_touched.map(p => `<span class="port-tag">${p}</span>`).join('')}
                </div>
                <div class="honeypot-intel">
                    <span>TTPs: ${a.ttp_count || 0}</span>
                    <span>Reputation: ${a.reputation || 'Unknown'}</span>
                    <span>Country: ${a.country || '??'}</span>
                </div>
                <div class="honeypot-action">
                    <span class="action-badge ${a.action}">${a.action}</span>
                    <span class="honeypot-time">${a.last_seen}</span>
                </div>
            </div>
        `).join('');
    }

    // Update Data Gravity panel
    function updateGravity(data) {
        document.getElementById('gravity-events').textContent = data.stats.events_24h || 0;
        document.getElementById('gravity-blocked').textContent = data.stats.blocked || 0;
        document.getElementById('gravity-sensitive').textContent = data.stats.sensitive_files || 0;
        document.getElementById('gravity-highrisk').textContent = data.stats.high_risk_sources || 0;
        document.getElementById('gravity-count').textContent = `${data.events?.length || 0} detected`;

        const listEl = document.getElementById('gravity-list');
        if (!data.events || data.events.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-database"></i>
                    <p>No sensitive data movement detected. Zeek file monitoring is active.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.events.map(e => `
            <div class="gravity-item ${e.risk_level}">
                <div class="gravity-header">
                    <span class="gravity-filename">${e.filename}</span>
                    <span class="gravity-size">${formatBytes(e.size_bytes)}</span>
                </div>
                <div class="gravity-flow">
                    <span class="gravity-source">${e.source_device}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span class="gravity-dest">${e.dest_ip}</span>
                </div>
                <div class="gravity-risk">
                    <div class="gravity-risk-bar">
                        <div class="gravity-risk-fill ${e.risk_level}" style="width: ${e.risk_score * 100}%"></div>
                    </div>
                    <span class="gravity-risk-score">${(e.risk_score * 100).toFixed(0)}%</span>
                </div>
                <div class="gravity-mitre">
                    ${e.mitre_techniques.map(t => `<span class="gravity-mitre-tag">${t}</span>`).join('')}
                </div>
                <div class="gravity-action">
                    <span class="action-badge ${e.action}">${e.action}</span>
                    <span class="gravity-time">${e.timestamp}</span>
                </div>
            </div>
        `).join('');
    }

    // Helper: format bytes
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Initialize defenses on load
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch initial defense data for the active tab (friction)
        fetchDefenseData('friction');

        // Refresh defense data every 10 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.defense-tab.active');
            if (activeTab) {
                fetchDefenseData(activeTab.dataset.tab);
            }
        }, 10000);
    });

})();
</script>
{% endblock %}
