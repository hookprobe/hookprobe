{% extends "base.html" %}

{% block title %}AIOCHI - HookProbe Fortress{% endblock %}

{% block page_title %}AIOCHI{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
<li class="breadcrumb-item active">AIOCHI</li>
{% endblock %}

{% block extra_css %}
<style>
    /* AIOCHI Dashboard - Cognitive Network Layer */
    :root {
        --aiochi-calm: #81c784;
        --aiochi-curious: #ffb74d;
        --aiochi-alert: #e57373;
        --aiochi-primary: #4fc3f7;
        --aiochi-bg-dark: #1a1a2e;
        --aiochi-bg-card: #16213e;
        --aiochi-text: #e8e8e8;
        --aiochi-text-muted: #8b8b9a;
    }

    .aiochi-container {
        padding: 0;
    }

    /* Ambient State Banner */
    .ambient-banner {
        background: linear-gradient(135deg, var(--aiochi-bg-card) 0%, #0f3460 100%);
        border-radius: 12px;
        padding: 24px 32px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .ambient-state {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .ambient-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        transition: all 0.5s ease;
    }

    .ambient-icon.calm {
        background: linear-gradient(135deg, rgba(129, 199, 132, 0.2) 0%, rgba(129, 199, 132, 0.1) 100%);
        color: var(--aiochi-calm);
        box-shadow: 0 0 30px rgba(129, 199, 132, 0.3);
    }

    .ambient-icon.curious {
        background: linear-gradient(135deg, rgba(255, 183, 77, 0.2) 0%, rgba(255, 183, 77, 0.1) 100%);
        color: var(--aiochi-curious);
        box-shadow: 0 0 30px rgba(255, 183, 77, 0.3);
        animation: pulse-curious 2s ease-in-out infinite;
    }

    .ambient-icon.alert {
        background: linear-gradient(135deg, rgba(229, 115, 115, 0.2) 0%, rgba(229, 115, 115, 0.1) 100%);
        color: var(--aiochi-alert);
        box-shadow: 0 0 30px rgba(229, 115, 115, 0.4);
        animation: pulse-alert 1s ease-in-out infinite;
    }

    @keyframes pulse-curious {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.9; }
    }

    @keyframes pulse-alert {
        0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(229, 115, 115, 0.4); }
        50% { transform: scale(1.08); box-shadow: 0 0 50px rgba(229, 115, 115, 0.6); }
    }

    .ambient-text h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--aiochi-text);
    }

    .ambient-text p {
        margin: 0;
        color: var(--aiochi-text-muted);
        font-size: 0.95rem;
    }

    .whisper-badge {
        background: rgba(79, 195, 247, 0.1);
        border: 1px solid rgba(79, 195, 247, 0.3);
        border-radius: 20px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--aiochi-primary);
    }

    .whisper-phase {
        font-size: 1.2rem;
    }

    /* Three Pillars Grid */
    .pillars-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
        .pillars-grid {
            grid-template-columns: 1fr;
        }
    }

    .pillar-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .pillar-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pillar-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .pillar-title i {
        font-size: 1.2rem;
    }

    .pillar-title h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: var(--aiochi-text);
    }

    .pillar-title span {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        font-weight: 400;
    }

    .pillar-body {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* PRESENCE - Device Bubbles */
    .presence-icon { color: var(--aiochi-primary); }

    .bubble-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .bubble-item {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: all 0.3s ease;
    }

    .bubble-item:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
    }

    .bubble-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .bubble-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .bubble-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .bubble-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--aiochi-text);
    }

    .bubble-meta {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .trust-badge {
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .trust-CORE { background: rgba(129, 199, 132, 0.2); color: #81c784; }
    .trust-TRUSTED { background: rgba(79, 195, 247, 0.2); color: #4fc3f7; }
    .trust-KNOWN { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .trust-VISITOR { background: rgba(186, 104, 200, 0.2); color: #ba68c8; }

    .bubble-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .device-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 4px 10px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .device-chip.online {
        color: var(--aiochi-calm);
    }

    .device-chip i {
        font-size: 0.7rem;
    }

    /* PRIVACY - Narrative Feed */
    .privacy-icon { color: var(--aiochi-calm); }

    .feed-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .feed-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .feed-item:hover {
        background: rgba(255,255,255,0.04);
    }

    .feed-item.success { border-left-color: var(--aiochi-calm); }
    .feed-item.warning { border-left-color: var(--aiochi-curious); }
    .feed-item.info { border-left-color: var(--aiochi-primary); }
    .feed-item.danger { border-left-color: var(--aiochi-alert); }

    .feed-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.85rem;
    }

    .feed-icon.success { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .feed-icon.warning { background: rgba(255, 183, 77, 0.15); color: var(--aiochi-curious); }
    .feed-icon.info { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .feed-icon.danger { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }

    .feed-content {
        flex: 1;
        min-width: 0;
    }

    .feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .feed-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--aiochi-text);
    }

    .feed-time {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .feed-narrative {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
        line-height: 1.4;
    }

    /* PERFORMANCE - Health Score */
    .performance-icon { color: var(--aiochi-curious); }

    .health-score-container {
        text-align: center;
        margin-bottom: 24px;
    }

    .health-gauge {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto 16px;
    }

    .health-gauge svg {
        transform: rotate(-90deg);
    }

    .health-gauge-bg {
        fill: none;
        stroke: rgba(255,255,255,0.1);
        stroke-width: 12;
    }

    .health-gauge-fill {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
    }

    .health-gauge-fill.good { stroke: var(--aiochi-calm); }
    .health-gauge-fill.warning { stroke: var(--aiochi-curious); }
    .health-gauge-fill.critical { stroke: var(--aiochi-alert); }

    .health-score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .health-score-number {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .health-score-number.good { color: var(--aiochi-calm); }
    .health-score-number.warning { color: var(--aiochi-curious); }
    .health-score-number.critical { color: var(--aiochi-alert); }

    .health-score-label {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .health-insight {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.85rem;
        color: var(--aiochi-text-muted);
        line-height: 1.5;
        margin-bottom: 20px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .health-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .metric-item {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .metric-label {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Quick Actions */
    .quick-actions-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .quick-actions-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--aiochi-text);
    }

    .quick-actions-title i {
        color: var(--aiochi-primary);
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    @media (max-width: 992px) {
        .quick-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px 12px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.06);
        transform: translateY(-2px);
    }

    .action-btn.active {
        border-color: var(--aiochi-primary);
        background: rgba(79, 195, 247, 0.1);
    }

    .action-btn i {
        font-size: 1.5rem;
    }

    .action-btn.warning i { color: var(--aiochi-curious); }
    .action-btn.info i { color: var(--aiochi-primary); }
    .action-btn.primary i { color: #ba68c8; }
    .action-btn.danger i { color: var(--aiochi-alert); }

    .action-btn span {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        line-height: 1.3;
    }

    .action-btn.active span {
        color: var(--aiochi-text);
    }

    /* Demo Mode Badge */
    .demo-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 183, 77, 0.15);
        color: var(--aiochi-curious);
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Bubble Manager Section */
    .bubble-manager-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .bubble-manager-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-manager-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .bubble-manager-title i {
        color: var(--aiochi-primary);
    }

    .bubble-manager-body {
        padding: 20px;
    }

    .bubble-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .bubble-card {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .bubble-card:hover {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.15);
        transform: translateY(-2px);
    }

    .bubble-card.drop-target {
        border-color: var(--aiochi-primary);
        background: rgba(79, 195, 247, 0.1);
        box-shadow: 0 0 20px rgba(79, 195, 247, 0.2);
    }

    .bubble-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .bubble-card-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .bubble-card-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .bubble-card-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--aiochi-text);
    }

    .bubble-card-type {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
    }

    .bubble-card-actions {
        display: flex;
        gap: 4px;
    }

    .bubble-card-actions button {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .bubble-card-actions button:hover {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text);
    }

    .bubble-card-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 36px;
    }

    .device-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 5px 10px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        cursor: grab;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    /* D2D cluster styling - devices that communicate show same color */
    /* This makes it visually obvious across bubbles which devices talk to each other */
    .device-tag[data-d2d-cluster] {
        border-left-width: 4px;
        border-left-style: solid;
        padding-left: 10px;
    }

    .device-tag:hover {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text);
    }

    /* D2D cluster color - prominent styling for cross-bubble communication */
    .device-tag.d2d-clustered {
        font-weight: 600;
        /* The background color will be set via inline style with cluster color */
        border-radius: 20px;
        box-shadow: 0 0 0 0.4px currentColor;
    }

    .device-tag.d2d-clustered:hover {
        /* Enhance glow on hover to make D2D relationship more visible */
        box-shadow: 0 0 12px currentColor;
        transform: scale(1.02);
    }

    .device-tag.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .device-tag.online::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--aiochi-calm);
        border-radius: 50%;
    }

    .device-tag.offline::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--aiochi-text-muted);
        border-radius: 50%;
    }

    .bubble-card-footer {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-policy-badges {
        display: flex;
        gap: 6px;
    }

    .policy-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.05);
        color: var(--aiochi-text-muted);
    }

    .policy-badge.active {
        background: rgba(129, 199, 132, 0.2);
        color: var(--aiochi-calm);
    }

    .policy-badge.inactive {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
        text-decoration: line-through;
    }

    .bubble-device-count {
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    /* Unassigned Devices Section */
    .unassigned-section {
        margin-top: 20px;
        padding: 16px;
        background: rgba(255, 183, 77, 0.05);
        border-radius: 10px;
        border: 1px dashed rgba(255, 183, 77, 0.3);
    }

    .unassigned-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--aiochi-curious);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .unassigned-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 32px;
    }

    /* Create Bubble Button */
    .create-bubble-card {
        background: rgba(79, 195, 247, 0.05);
        border: 2px dashed rgba(79, 195, 247, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        color: var(--aiochi-primary);
        transition: all 0.3s ease;
    }

    .create-bubble-card:hover {
        background: rgba(79, 195, 247, 0.1);
        border-color: var(--aiochi-primary);
    }

    .create-bubble-card i {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .create-bubble-card span {
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Bubble Modal */
    .bubble-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .bubble-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .bubble-modal {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .bubble-modal-overlay.active .bubble-modal {
        transform: scale(1);
    }

    .bubble-modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bubble-modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--aiochi-text);
    }

    .bubble-modal-close {
        background: none;
        border: none;
        color: var(--aiochi-text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .bubble-modal-body {
        padding: 20px;
    }

    .bubble-form-group {
        margin-bottom: 16px;
    }

    .bubble-form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--aiochi-text);
        margin-bottom: 6px;
    }

    .bubble-form-group input,
    .bubble-form-group select {
        width: 100%;
        padding: 10px 12px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        color: var(--aiochi-text);
        font-size: 0.9rem;
    }

    .bubble-form-group input:focus,
    .bubble-form-group select:focus {
        outline: none;
        border-color: var(--aiochi-primary);
    }

    .bubble-color-picker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: white;
        box-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .bubble-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-bubble {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-bubble-cancel {
        background: rgba(255,255,255,0.1);
        color: var(--aiochi-text-muted);
    }

    .btn-bubble-cancel:hover {
        background: rgba(255,255,255,0.15);
    }

    .btn-bubble-save {
        background: var(--aiochi-primary);
        color: #000;
    }

    .btn-bubble-save:hover {
        background: #6fd0fc;
    }

    .btn-bubble-delete {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
    }

    .btn-bubble-delete:hover {
        background: rgba(229, 115, 115, 0.3);
    }

    /* Loading State */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 26, 46, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 12px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255,255,255,0.1);
        border-top-color: var(--aiochi-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Scrollbar styling */
    .pillar-body::-webkit-scrollbar {
        width: 6px;
    }

    .pillar-body::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.02);
        border-radius: 3px;
    }

    .pillar-body::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
    }

    .pillar-body::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.15);
    }

    /* =========================================================================
       ACTIVE DEFENSES SECTION - 5 Innovations
       ========================================================================= */
    .defenses-card {
        background: var(--aiochi-bg-card);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    .defenses-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .defenses-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--aiochi-text);
    }

    .defenses-title i {
        color: var(--aiochi-alert);
        font-size: 1.2rem;
    }

    .defenses-title small {
        font-weight: 400;
        color: var(--aiochi-text-muted);
        font-size: 0.75rem;
        display: block;
    }

    .defenses-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .defense-tab {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 8px 14px;
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .defense-tab:hover {
        background: rgba(255,255,255,0.08);
        color: var(--aiochi-text);
    }

    .defense-tab.active {
        background: rgba(79, 195, 247, 0.15);
        border-color: var(--aiochi-primary);
        color: var(--aiochi-primary);
    }

    .defense-tab i {
        font-size: 0.85rem;
    }

    .defenses-body {
        padding: 20px;
    }

    .defense-panel {
        display: none;
    }

    .defense-panel.active {
        display: block;
    }

    .defense-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    @media (max-width: 992px) {
        .defense-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-card {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        margin: 0 auto 10px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
    }

    .stat-icon.subtle { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.degraded { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
    .stat-icon.severe { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.clean { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .stat-icon.suspicious { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.masquerade { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.hardened { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .stat-icon.prevented { background: rgba(79, 195, 247, 0.15); color: var(--aiochi-primary); }
    .stat-icon.active-chains { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.dark-ports { background: rgba(156, 39, 176, 0.15); color: #ba68c8; }
    .stat-icon.attackers { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.critical-threats { background: rgba(183, 28, 28, 0.2); color: #ef5350; }
    .stat-icon.blocked-exfil { background: rgba(229, 115, 115, 0.15); color: var(--aiochi-alert); }
    .stat-icon.sensitive { background: rgba(255, 183, 77, 0.15); color: #ffb74d; }
    .stat-icon.high-risk { background: rgba(183, 28, 28, 0.2); color: #ef5350; }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--aiochi-text);
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* List headers */
    .friction-list-header,
    .ghost-list-header,
    .chain-list-header,
    .honeypot-list-header,
    .gravity-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .friction-list-header h5,
    .ghost-list-header h5,
    .chain-list-header h5,
    .honeypot-list-header h5,
    .gravity-list-header h5 {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0;
        color: var(--aiochi-text);
    }

    /* List containers */
    .friction-list,
    .ghost-list,
    .chain-list,
    .honeypot-list,
    .gravity-list {
        max-height: 350px;
        overflow-y: auto;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--aiochi-text-muted);
    }

    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin: 0;
    }

    /* Friction item */
    .friction-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid transparent;
    }

    .friction-item.subtle { border-left-color: #ffb74d; }
    .friction-item.noticeable { border-left-color: #ff9800; }
    .friction-item.degraded { border-left-color: #f57c00; }
    .friction-item.severe { border-left-color: var(--aiochi-alert); }

    .friction-device {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .friction-device-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--aiochi-text-muted);
    }

    .friction-device-info {
        display: flex;
        flex-direction: column;
    }

    .friction-device-name {
        font-weight: 500;
        font-size: 0.85rem;
        color: var(--aiochi-text);
    }

    .friction-device-ip {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .friction-level {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .friction-level-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .friction-level-badge.subtle { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .friction-level-badge.noticeable { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .friction-level-badge.degraded { background: rgba(245, 124, 0, 0.2); color: #f57c00; }
    .friction-level-badge.severe { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }

    .friction-latency {
        font-size: 0.8rem;
        color: var(--aiochi-text-muted);
    }

    .friction-qsecbit {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 8px;
        background: rgba(79, 195, 247, 0.1);
        color: var(--aiochi-primary);
    }

    /* Ghost Probe item */
    .ghost-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid transparent;
    }

    .ghost-item.clean { border-left-color: var(--aiochi-calm); }
    .ghost-item.suspicious { border-left-color: #ffb74d; }
    .ghost-item.masquerading { border-left-color: var(--aiochi-alert); }
    .ghost-item.compromised { border-left-color: #b71c1c; }

    .ghost-verdict {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .ghost-verdict.clean { background: rgba(129, 199, 132, 0.2); color: var(--aiochi-calm); }
    .ghost-verdict.suspicious { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .ghost-verdict.masquerading { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }
    .ghost-verdict.compromised { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .btn-probe-all {
        background: rgba(79, 195, 247, 0.15);
        border: 1px solid rgba(79, 195, 247, 0.3);
        color: var(--aiochi-primary);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .btn-probe-all:hover {
        background: rgba(79, 195, 247, 0.25);
    }

    /* Chain Predictor item */
    .chain-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .chain-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .chain-source {
        font-weight: 500;
        color: var(--aiochi-text);
    }

    .chain-confidence {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        background: rgba(255, 183, 77, 0.2);
        color: #ffb74d;
    }

    .chain-sequence {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
    }

    .chain-technique {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 4px;
        background: rgba(79, 195, 247, 0.15);
        color: var(--aiochi-primary);
        font-family: monospace;
    }

    .chain-technique.observed {
        background: rgba(255, 183, 77, 0.2);
        color: #ffb74d;
    }

    .chain-technique.predicted {
        background: rgba(229, 115, 115, 0.2);
        color: var(--aiochi-alert);
        border: 1px dashed rgba(229, 115, 115, 0.4);
    }

    .chain-arrow {
        color: var(--aiochi-text-muted);
        font-size: 0.8rem;
    }

    .chain-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .chain-action {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 4px;
        background: rgba(129, 199, 132, 0.15);
        color: var(--aiochi-calm);
    }

    /* Honeypot item */
    .honeypot-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid var(--aiochi-alert);
    }

    .honeypot-item.low { border-left-color: var(--aiochi-calm); }
    .honeypot-item.medium { border-left-color: #ffb74d; }
    .honeypot-item.high { border-left-color: #ff9800; }
    .honeypot-item.critical { border-left-color: #b71c1c; }

    .honeypot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .honeypot-ip {
        font-weight: 600;
        font-family: monospace;
        color: var(--aiochi-text);
    }

    .honeypot-threat {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .honeypot-threat.low { background: rgba(129, 199, 132, 0.2); color: var(--aiochi-calm); }
    .honeypot-threat.medium { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .honeypot-threat.high { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .honeypot-threat.critical { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .honeypot-details {
        display: flex;
        gap: 16px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
    }

    .honeypot-ports {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .honeypot-port {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: rgba(229, 115, 115, 0.1);
        border-radius: 4px;
        color: var(--aiochi-alert);
        font-family: monospace;
    }

    /* Data Gravity item */
    .gravity-item {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid #ffb74d;
    }

    .gravity-item.blocked { border-left-color: var(--aiochi-alert); }
    .gravity-item.allowed { border-left-color: var(--aiochi-calm); }

    .gravity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .gravity-file {
        font-weight: 500;
        color: var(--aiochi-text);
        font-size: 0.85rem;
    }

    .gravity-file-type {
        font-size: 0.7rem;
        color: var(--aiochi-text-muted);
    }

    .gravity-action {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .gravity-action.blocked { background: rgba(229, 115, 115, 0.2); color: var(--aiochi-alert); }
    .gravity-action.throttled { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .gravity-action.logged { background: rgba(79, 195, 247, 0.1); color: var(--aiochi-primary); }
    .gravity-action.allowed { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }

    .gravity-details {
        display: flex;
        gap: 16px;
        font-size: 0.75rem;
        color: var(--aiochi-text-muted);
        margin-bottom: 8px;
    }

    .gravity-sensitivity {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .gravity-sensitivity.public { background: rgba(129, 199, 132, 0.15); color: var(--aiochi-calm); }
    .gravity-sensitivity.internal { background: rgba(79, 195, 247, 0.1); color: var(--aiochi-primary); }
    .gravity-sensitivity.confidential { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
    .gravity-sensitivity.restricted { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .gravity-sensitivity.secret { background: rgba(183, 28, 28, 0.3); color: #ef5350; }

    .gravity-risk {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .gravity-risk-bar {
        width: 60px;
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .gravity-risk-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .gravity-risk-fill.low { background: var(--aiochi-calm); }
    .gravity-risk-fill.medium { background: #ffb74d; }
    .gravity-risk-fill.high { background: #ff9800; }
    .gravity-risk-fill.critical { background: var(--aiochi-alert); }

    .gravity-mitre {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .gravity-mitre-tag {
        font-size: 0.65rem;
        padding: 2px 5px;
        background: rgba(79, 195, 247, 0.1);
        border-radius: 3px;
        color: var(--aiochi-primary);
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="aiochi-container">
    <!-- Ambient State Banner -->
    <div class="ambient-banner" id="ambient-banner">
        <div class="ambient-state">
            <div class="ambient-icon calm" id="ambient-icon">
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="ambient-text">
                <h2 id="ambient-title">Everything is Peaceful</h2>
                <p id="ambient-message">Your network is protected and running smoothly.</p>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="whisper-badge" id="whisper-badge">
                <span class="whisper-phase">ðŸŒ™</span>
                <span id="whisper-message">Dreaming...</span>
            </div>
            <span class="demo-badge" id="demo-badge" style="display: none;">
                <i class="fas fa-flask"></i> Demo Mode
            </span>
        </div>
    </div>

    <!-- Three Pillars -->
    <div class="pillars-grid">
        <!-- PRESENCE - Who's Home -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-users presence-icon"></i>
                    <div>
                        <h3>PRESENCE</h3>
                        <span>Who's Home</span>
                    </div>
                </div>
                <span class="badge bg-info" id="presence-count">0 devices</span>
            </div>
            <div class="pillar-body" id="presence-body">
                <div class="bubble-list" id="bubble-list">
                    <!-- Bubbles populated by JS -->
                </div>
            </div>
        </div>

        <!-- PRIVACY - What's Happening -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-shield-alt privacy-icon"></i>
                    <div>
                        <h3>PRIVACY</h3>
                        <span>What's Happening</span>
                    </div>
                </div>
                <span class="badge bg-success" id="privacy-count">All clear</span>
            </div>
            <div class="pillar-body" id="privacy-body">
                <div class="feed-list" id="feed-list">
                    <!-- Feed items populated by JS -->
                </div>
            </div>
        </div>

        <!-- PERFORMANCE - How Fast -->
        <div class="pillar-card">
            <div class="pillar-header">
                <div class="pillar-title">
                    <i class="fas fa-tachometer-alt performance-icon"></i>
                    <div>
                        <h3>PERFORMANCE</h3>
                        <span>How Fast</span>
                    </div>
                </div>
            </div>
            <div class="pillar-body" id="performance-body">
                <div class="health-score-container">
                    <div class="health-gauge">
                        <svg viewBox="0 0 160 160">
                            <circle class="health-gauge-bg" cx="80" cy="80" r="70"></circle>
                            <circle class="health-gauge-fill good" cx="80" cy="80" r="70"
                                    stroke-dasharray="439.8" stroke-dashoffset="439.8" id="health-gauge-fill"></circle>
                        </svg>
                        <div class="health-score-value">
                            <div class="health-score-number good" id="health-score">--</div>
                            <div class="health-score-label">Health</div>
                        </div>
                    </div>
                </div>
                <div class="health-insight" id="health-insight">
                    Loading network insights...
                </div>
                <div class="health-metrics" id="health-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="metric-latency">--</div>
                        <div class="metric-label">Latency (ms)</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-bandwidth">--</div>
                        <div class="metric-label">Bandwidth %</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-uptime">--</div>
                        <div class="metric-label">Uptime %</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="metric-blocked">--</div>
                        <div class="metric-label">Blocked (24h)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-card">
        <h4 class="quick-actions-title">
            <i class="fas fa-bolt"></i>
            Quick Actions
        </h4>
        <div class="quick-actions-grid" id="quick-actions">
            <!-- Actions populated by JS -->
        </div>
    </div>

    <!-- Active Defenses Section - 5 Innovations -->
    <div class="defenses-card">
        <div class="defenses-header">
            <div class="defenses-title">
                <i class="fas fa-shield-virus"></i>
                <div>
                    <span>Active Defenses</span>
                    <small>Advanced threat mitigation systems</small>
                </div>
            </div>
            <div class="defenses-tabs" id="defense-tabs">
                <button class="defense-tab active" data-tab="friction" onclick="switchDefenseTab('friction')">
                    <i class="fas fa-hourglass-half"></i> Friction
                </button>
                <button class="defense-tab" data-tab="ghost" onclick="switchDefenseTab('ghost')">
                    <i class="fas fa-ghost"></i> Ghost Probe
                </button>
                <button class="defense-tab" data-tab="chain" onclick="switchDefenseTab('chain')">
                    <i class="fas fa-link"></i> Chain Predict
                </button>
                <button class="defense-tab" data-tab="honeypot" onclick="switchDefenseTab('honeypot')">
                    <i class="fas fa-spider"></i> Honeypots
                </button>
                <button class="defense-tab" data-tab="gravity" onclick="switchDefenseTab('gravity')">
                    <i class="fas fa-magnet"></i> Data Gravity
                </button>
            </div>
        </div>
        <div class="defenses-body">
            <!-- Friction Control Tab -->
            <div class="defense-panel active" id="panel-friction">
                <div class="defense-stats">
                    <div class="stat-card friction-stat">
                        <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                        <div class="stat-value" id="friction-active">0</div>
                        <div class="stat-label">Active Frictions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon subtle"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="friction-subtle">0</div>
                        <div class="stat-label">Subtle (50ms)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon degraded"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="friction-degraded">0</div>
                        <div class="stat-label">Degraded (500ms)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon severe"><i class="fas fa-ban"></i></div>
                        <div class="stat-value" id="friction-severe">0</div>
                        <div class="stat-label">Severe (1000ms)</div>
                    </div>
                </div>
                <div class="friction-list-header">
                    <h5>Devices with Applied Friction</h5>
                    <span class="badge bg-info" id="friction-count">0 devices</span>
                </div>
                <div class="friction-list" id="friction-list">
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No friction applied. All devices are operating normally.</p>
                    </div>
                </div>
            </div>

            <!-- Ghost Probe Tab -->
            <div class="defense-panel" id="panel-ghost">
                <div class="defense-stats">
                    <div class="stat-card ghost-stat">
                        <div class="stat-icon"><i class="fas fa-ghost"></i></div>
                        <div class="stat-value" id="ghost-probes">0</div>
                        <div class="stat-label">Probes Run (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon clean"><i class="fas fa-check"></i></div>
                        <div class="stat-value" id="ghost-clean">0</div>
                        <div class="stat-label">Clean</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon suspicious"><i class="fas fa-question"></i></div>
                        <div class="stat-value" id="ghost-suspicious">0</div>
                        <div class="stat-label">Suspicious</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon masquerade"><i class="fas fa-mask"></i></div>
                        <div class="stat-value" id="ghost-masquerade">0</div>
                        <div class="stat-label">Masquerading</div>
                    </div>
                </div>
                <div class="ghost-list-header">
                    <h5>Recent Probe Results</h5>
                    <button class="btn-probe-all" onclick="runProbeAll()">
                        <i class="fas fa-radar"></i> Probe All Devices
                    </button>
                </div>
                <div class="ghost-list" id="ghost-list">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No recent probes. Click "Probe All Devices" to start active interrogation.</p>
                    </div>
                </div>
            </div>

            <!-- Chain Predictor Tab -->
            <div class="defense-panel" id="panel-chain">
                <div class="defense-stats">
                    <div class="stat-card chain-stat">
                        <div class="stat-icon"><i class="fas fa-link"></i></div>
                        <div class="stat-value" id="chain-predictions">0</div>
                        <div class="stat-label">Predictions (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon hardened"><i class="fas fa-shield-alt"></i></div>
                        <div class="stat-value" id="chain-hardened">0</div>
                        <div class="stat-label">Pre-Hardened</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon prevented"><i class="fas fa-hand-paper"></i></div>
                        <div class="stat-value" id="chain-prevented">0</div>
                        <div class="stat-label">Attacks Prevented</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active-chains"><i class="fas fa-project-diagram"></i></div>
                        <div class="stat-value" id="chain-active">0</div>
                        <div class="stat-label">Active Chains</div>
                    </div>
                </div>
                <div class="chain-list-header">
                    <h5>Attack Chain Predictions</h5>
                    <span class="badge bg-warning" id="chain-count">0 active</span>
                </div>
                <div class="chain-list" id="chain-list">
                    <div class="empty-state">
                        <i class="fas fa-brain"></i>
                        <p>No attack chains detected. The AI is monitoring for MITRE ATT&CK sequences.</p>
                    </div>
                </div>
            </div>

            <!-- Honeypot Mesh Tab -->
            <div class="defense-panel" id="panel-honeypot">
                <div class="defense-stats">
                    <div class="stat-card honeypot-stat">
                        <div class="stat-icon"><i class="fas fa-spider"></i></div>
                        <div class="stat-value" id="honeypot-touches">0</div>
                        <div class="stat-label">Touches (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon dark-ports"><i class="fas fa-door-closed"></i></div>
                        <div class="stat-value" id="honeypot-ports">0</div>
                        <div class="stat-label">Dark Ports</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon attackers"><i class="fas fa-user-secret"></i></div>
                        <div class="stat-value" id="honeypot-attackers">0</div>
                        <div class="stat-label">Unique Attackers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon critical-threats"><i class="fas fa-skull-crossbones"></i></div>
                        <div class="stat-value" id="honeypot-critical">0</div>
                        <div class="stat-label">Critical Threats</div>
                    </div>
                </div>
                <div class="honeypot-list-header">
                    <h5>Attacker Profiles</h5>
                    <span class="badge bg-danger" id="honeypot-count">0 tracked</span>
                </div>
                <div class="honeypot-list" id="honeypot-list">
                    <div class="empty-state">
                        <i class="fas fa-shield-check"></i>
                        <p>No honeypot touches detected. Dark ports are active and monitoring.</p>
                    </div>
                </div>
            </div>

            <!-- Data Gravity Tab -->
            <div class="defense-panel" id="panel-gravity">
                <div class="defense-stats">
                    <div class="stat-card gravity-stat">
                        <div class="stat-icon"><i class="fas fa-magnet"></i></div>
                        <div class="stat-value" id="gravity-events">0</div>
                        <div class="stat-label">Events (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blocked-exfil"><i class="fas fa-hand-paper"></i></div>
                        <div class="stat-value" id="gravity-blocked">0</div>
                        <div class="stat-label">Blocked Exfil</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon sensitive"><i class="fas fa-file-shield"></i></div>
                        <div class="stat-value" id="gravity-sensitive">0</div>
                        <div class="stat-label">Sensitive Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon high-risk"><i class="fas fa-exclamation-circle"></i></div>
                        <div class="stat-value" id="gravity-highrisk">0</div>
                        <div class="stat-label">High Risk Sources</div>
                    </div>
                </div>
                <div class="gravity-list-header">
                    <h5>Recent Exfiltration Events</h5>
                    <span class="badge bg-warning" id="gravity-count">0 detected</span>
                </div>
                <div class="gravity-list" id="gravity-list">
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <p>No sensitive data movement detected. Zeek file monitoring is active.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bubble Manager Section -->
    <div class="bubble-manager-card">
        <div class="bubble-manager-header">
            <div class="bubble-manager-title">
                <i class="fas fa-layer-group"></i>
                <div>
                    <span>Device Bubbles</span>
                    <small style="font-weight: 400; color: var(--aiochi-text-muted); font-size: 0.75rem; display: block;">
                        Drag devices between bubbles to organize your network
                    </small>
                </div>
            </div>
            <button class="btn-bubble btn-bubble-save" onclick="openCreateBubbleModal()">
                <i class="fas fa-plus"></i> New Bubble
            </button>
        </div>
        <div class="bubble-manager-body">
            <div class="bubble-grid" id="bubble-grid">
                <!-- Bubbles populated by JS -->
            </div>

            <!-- Unassigned Devices -->
            <div class="unassigned-section" id="unassigned-section">
                <div class="unassigned-title">
                    <i class="fas fa-question-circle"></i>
                    Unassigned Devices
                </div>
                <div class="unassigned-devices" id="unassigned-devices"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, null)">
                    <!-- Unassigned devices populated by JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- Bubble Create/Edit Modal -->
    <div class="bubble-modal-overlay" id="bubble-modal-overlay" onclick="closeBubbleModal(event)">
        <div class="bubble-modal" onclick="event.stopPropagation()">
            <div class="bubble-modal-header">
                <h3 id="bubble-modal-title">Create New Bubble</h3>
                <button class="bubble-modal-close" onclick="closeBubbleModal()">&times;</button>
            </div>
            <div class="bubble-modal-body">
                <input type="hidden" id="bubble-edit-id">

                <div class="bubble-form-group">
                    <label for="bubble-name">Bubble Name</label>
                    <input type="text" id="bubble-name" placeholder="e.g., Dad's Devices">
                </div>

                <div class="bubble-form-group">
                    <label for="bubble-type">Bubble Type</label>
                    <select id="bubble-type">
                        <option value="FAMILY">Family - Full network access</option>
                        <option value="GUEST">Guest - Internet only</option>
                        <option value="IOT">IoT - Smart home devices</option>
                        <option value="WORK">Work - Internet only (laptops, phones)</option>
                        <option value="CUSTOM">Custom</option>
                    </select>
                </div>

                <div class="bubble-form-group">
                    <label>Color</label>
                    <div class="bubble-color-picker" id="bubble-color-picker">
                        <div class="color-option" style="background: #1976D2" data-color="#1976D2" onclick="selectColor('#1976D2')"></div>
                        <div class="color-option" style="background: #E91E63" data-color="#E91E63" onclick="selectColor('#E91E63')"></div>
                        <div class="color-option" style="background: #FF5722" data-color="#FF5722" onclick="selectColor('#FF5722')"></div>
                        <div class="color-option" style="background: #4CAF50" data-color="#4CAF50" onclick="selectColor('#4CAF50')"></div>
                        <div class="color-option" style="background: #FF9800" data-color="#FF9800" onclick="selectColor('#FF9800')"></div>
                        <div class="color-option" style="background: #607D8B" data-color="#607D8B" onclick="selectColor('#607D8B')"></div>
                        <div class="color-option" style="background: #9C27B0" data-color="#9C27B0" onclick="selectColor('#9C27B0')"></div>
                        <div class="color-option selected" style="background: #2196F3" data-color="#2196F3" onclick="selectColor('#2196F3')"></div>
                    </div>
                </div>
            </div>
            <div class="bubble-modal-footer">
                <button class="btn-bubble btn-bubble-delete" id="bubble-delete-btn" style="display: none; margin-right: auto;" onclick="deleteBubble()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn-bubble btn-bubble-cancel" onclick="closeBubbleModal()">Cancel</button>
                <button class="btn-bubble btn-bubble-save" onclick="saveBubble()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    // Configuration
    const API_BASE = '/aiochi/api';
    const REFRESH_INTERVAL = 5000;

    // State
    let isLoading = false;
    let demoMode = true;

    // Device type icons
    const deviceIcons = {
        'phone': 'fa-mobile-alt',
        'laptop': 'fa-laptop',
        'tablet': 'fa-tablet-alt',
        'watch': 'fa-clock',
        'speaker': 'fa-volume-up',
        'thermostat': 'fa-thermometer-half',
        'camera': 'fa-video',
        'hub': 'fa-sitemap',
        'gaming': 'fa-gamepad',
        'tv': 'fa-tv',
        'default': 'fa-microchip'
    };

    // Ecosystem colors
    const ecosystemColors = {
        'apple': '#a3a3a3',
        'samsung': '#1428a0',
        'google': '#4285f4',
        'iot': '#ffb74d',
        'mixed': '#ba68c8'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        fetchStatus();
        setInterval(fetchStatus, REFRESH_INTERVAL);
    });

    // Fetch all status data
    async function fetchStatus() {
        if (isLoading) return;
        isLoading = true;

        try {
            const response = await fetch(`${API_BASE}/status`);
            const data = await response.json();

            if (data.success) {
                demoMode = data.demo_mode;
                updateDemoMode(demoMode);
                updateAmbient(data.ambient);
                updatePresence(data.presence);
                updatePrivacy(data.privacy);
                updatePerformance(data.performance);
                updateQuickActions(data.quick_actions);
            }
        } catch (error) {
            console.error('Failed to fetch AIOCHI status:', error);
        } finally {
            isLoading = false;
        }
    }

    // Update demo mode indicator
    function updateDemoMode(isDemo) {
        const badge = document.getElementById('demo-badge');
        badge.style.display = isDemo ? 'inline-flex' : 'none';
    }

    // Update ambient state banner
    function updateAmbient(ambient) {
        const icon = document.getElementById('ambient-icon');
        const title = document.getElementById('ambient-title');
        const message = document.getElementById('ambient-message');
        const whisperPhase = document.querySelector('.whisper-phase');
        const whisperMessage = document.getElementById('whisper-message');

        // Update state class
        icon.className = 'ambient-icon ' + ambient.state.toLowerCase();
        icon.innerHTML = `<i class="fas ${ambient.icon}"></i>`;

        // Update text
        title.textContent = getAmbientTitle(ambient.state);
        message.textContent = ambient.message;

        // Update whisper
        if (ambient.whisper) {
            whisperPhase.textContent = ambient.whisper.phase;
            whisperMessage.textContent = ambient.whisper.message;
        }
    }

    function getAmbientTitle(state) {
        const titles = {
            'CALM': 'Everything is Peaceful',
            'CURIOUS': 'Something Caught My Attention',
            'ALERT': 'Action Required'
        };
        return titles[state] || state;
    }

    // Update presence bubbles
    function updatePresence(presence) {
        const countBadge = document.getElementById('presence-count');
        const bubbleList = document.getElementById('bubble-list');

        countBadge.textContent = `${presence.online_devices}/${presence.total_devices} online`;

        let html = '';
        for (const bubble of presence.bubbles) {
            const bgColor = bubble.color || ecosystemColors[bubble.ecosystem] || '#4fc3f7';
            const devices = bubble.devices.map(d => {
                const iconClass = deviceIcons[d.type] || deviceIcons.default;
                const onlineClass = d.online ? 'online' : '';
                return `<div class="device-chip ${onlineClass}">
                    <i class="fas ${iconClass}"></i>
                    ${d.name}
                </div>`;
            }).join('');

            html += `
            <div class="bubble-item">
                <div class="bubble-header">
                    <div class="bubble-info">
                        <div class="bubble-avatar" style="background: ${bgColor}20; color: ${bgColor}">
                            <i class="fas ${bubble.icon}"></i>
                        </div>
                        <div>
                            <div class="bubble-name">${bubble.label}</div>
                            <div class="bubble-meta">${bubble.devices.length} devices Â· ${bubble.ecosystem}</div>
                        </div>
                    </div>
                    <span class="trust-badge trust-${bubble.trust_level}">${bubble.trust_level}</span>
                </div>
                <div class="bubble-devices">
                    ${devices}
                </div>
            </div>`;
        }

        bubbleList.innerHTML = html;
    }

    // Update privacy feed
    function updatePrivacy(privacy) {
        const countBadge = document.getElementById('privacy-count');
        const feedList = document.getElementById('feed-list');

        if (privacy.unread_count > 0) {
            countBadge.textContent = `${privacy.unread_count} new`;
            countBadge.className = 'badge bg-warning';
        } else {
            countBadge.textContent = 'All clear';
            countBadge.className = 'badge bg-success';
        }

        let html = '';
        for (const event of privacy.events) {
            html += `
            <div class="feed-item ${event.color}">
                <div class="feed-icon ${event.color}">
                    <i class="fas ${event.icon}"></i>
                </div>
                <div class="feed-content">
                    <div class="feed-header">
                        <span class="feed-title">${event.title}</span>
                        <span class="feed-time">${event.time}</span>
                    </div>
                    <p class="feed-narrative">${event.narrative}</p>
                </div>
            </div>`;
        }

        feedList.innerHTML = html;
    }

    // Update performance metrics
    function updatePerformance(performance) {
        const score = performance.health_score;
        const gaugeFill = document.getElementById('health-gauge-fill');
        const scoreEl = document.getElementById('health-score');
        const insightEl = document.getElementById('health-insight');

        // Calculate gauge offset (circumference = 2 * PI * r = 2 * 3.14159 * 70 â‰ˆ 439.8)
        const circumference = 439.8;
        const offset = circumference - (circumference * score / 100);
        gaugeFill.style.strokeDashoffset = offset;

        // Determine color class
        let colorClass = 'good';
        if (score < 50) colorClass = 'critical';
        else if (score < 75) colorClass = 'warning';

        gaugeFill.className.baseVal = `health-gauge-fill ${colorClass}`;
        scoreEl.textContent = score;
        scoreEl.className = `health-score-number ${colorClass}`;

        // Update insight
        insightEl.textContent = performance.insight;

        // Update metrics
        const metrics = performance.metrics;
        document.getElementById('metric-latency').textContent = metrics.latency_ms;
        document.getElementById('metric-bandwidth').textContent = metrics.bandwidth_used_pct + '%';
        document.getElementById('metric-uptime').textContent = metrics.uptime_pct + '%';
        document.getElementById('metric-blocked').textContent = metrics.threats_blocked_24h;
    }

    // Update quick actions
    function updateQuickActions(quickActions) {
        const container = document.getElementById('quick-actions');

        let html = '';
        for (const action of quickActions.actions) {
            const activeClass = action.active ? 'active' : '';
            html += `
            <div class="action-btn ${action.color} ${activeClass}"
                 data-action="${action.id}"
                 data-active="${action.active}"
                 onclick="toggleAction('${action.id}', ${!action.active})"
                 title="${action.description}">
                <i class="fas ${action.icon}"></i>
                <span>${action.label}</span>
            </div>`;
        }

        container.innerHTML = html;
    }

    // Toggle action
    window.toggleAction = async function(actionId, activate) {
        try {
            const response = await fetch(`${API_BASE}/action/${actionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activate })
            });

            const data = await response.json();
            if (data.success) {
                // Update button state
                const btn = document.querySelector(`[data-action="${actionId}"]`);
                if (btn) {
                    if (activate) {
                        btn.classList.add('active');
                        btn.dataset.active = 'true';
                    } else {
                        btn.classList.remove('active');
                        btn.dataset.active = 'false';
                    }
                }
            }
        } catch (error) {
            console.error('Failed to toggle action:', error);
        }
    };

    // =========================================================================
    // BUBBLE MANAGER
    // =========================================================================

    // State
    let bubblesData = { bubbles: [], unassigned_devices: [] };
    let selectedColor = '#2196F3';
    let draggedDevice = null;
    let draggedFromBubble = null;

    // Icon mapping for bubble types
    const typeIcons = {
        'FAMILY': 'fa-users',
        'GUEST': 'fa-user-friends',
        'IOT': 'fa-home',
        'WORK': 'fa-briefcase',
        'CUSTOM': 'fa-layer-group'
    };

    // Fetch bubbles from API
    async function fetchBubbles() {
        try {
            const response = await fetch(`${API_BASE}/bubbles`);
            const data = await response.json();
            if (data.success) {
                bubblesData = data;
                renderBubbles();
            }
        } catch (error) {
            console.error('Failed to fetch bubbles:', error);
        }
    }

    // Render bubbles grid
    function renderBubbles() {
        const grid = document.getElementById('bubble-grid');
        const unassignedEl = document.getElementById('unassigned-devices');

        let html = '';

        // Render each bubble
        for (const bubble of bubblesData.bubbles) {
            const devices = bubble.devices || [];
            const policy = bubble.policy || {};

            html += `
            <div class="bubble-card"
                 data-bubble-id="${bubble.bubble_id}"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event, '${bubble.bubble_id}')">
                <div class="bubble-card-header">
                    <div class="bubble-card-info">
                        <div class="bubble-card-avatar" style="background: ${bubble.color}20; color: ${bubble.color}">
                            <i class="fas ${bubble.icon || typeIcons[bubble.bubble_type] || 'fa-layer-group'}"></i>
                        </div>
                        <div>
                            <div class="bubble-card-name">${bubble.name}</div>
                            <div class="bubble-card-type">${bubble.bubble_type}</div>
                        </div>
                    </div>
                    <div class="bubble-card-actions">
                        <button onclick="openEditBubbleModal('${bubble.bubble_id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
                <div class="bubble-card-devices">
                    ${devices.map(d => {
                        // Apply D2D cluster color - devices that communicate show same color
                        // This makes it visually obvious across bubbles which devices talk to each other
                        const hasCluster = d.d2d_cluster && d.d2d_cluster.cluster_color;
                        const clusterColor = hasCluster ? d.d2d_cluster.cluster_color : '';
                        // Convert hex to rgba for background with opacity
                        const bgColor = hasCluster ? clusterColor + '25' : '';  // 25 = ~15% opacity in hex
                        const clusterStyle = hasCluster
                            ? `color: ${clusterColor} !important; border-left-color: ${clusterColor}; border-color: ${clusterColor}40; background: ${bgColor}; font-weight: 600;`
                            : '';
                        const clusterClass = hasCluster ? 'd2d-clustered' : '';
                        const clusterTitle = hasCluster
                            ? `D2D Cluster #${d.d2d_cluster.cluster_id + 1}: ${d.d2d_cluster.device_count} devices communicate together (affinity: ${(d.d2d_cluster.avg_affinity * 100).toFixed(0)}%)`
                            : '';
                        return `
                        <div class="device-tag ${d.online !== false ? 'online' : 'offline'} ${clusterClass}"
                             draggable="true"
                             data-mac="${d.mac}"
                             data-bubble="${bubble.bubble_id}"
                             data-d2d-cluster="${hasCluster ? d.d2d_cluster.cluster_id : ''}"
                             style="${clusterStyle}"
                             title="${clusterTitle || d.vendor || ''}"
                             ondragstart="handleDragStart(event, '${d.mac}', '${bubble.bubble_id}')"
                             ondragend="handleDragEnd(event)">
                            ${d.label || d.mac}
                        </div>`;
                    }).join('')}
                    ${devices.length === 0 ? '<span style="color: var(--aiochi-text-muted); font-size: 0.75rem;">Drop devices here</span>' : ''}
                </div>
                <div class="bubble-card-footer">
                    <div class="bubble-policy-badges">
                        <span class="policy-badge ${policy.internet !== false ? 'active' : 'inactive'}">Internet</span>
                        <span class="policy-badge ${policy.lan ? 'active' : 'inactive'}">LAN</span>
                        <span class="policy-badge ${policy.d2d ? 'active' : 'inactive'}">D2D</span>
                    </div>
                    <span class="bubble-device-count">${devices.length} devices</span>
                </div>
            </div>`;
        }

        // Add "Create New Bubble" card
        html += `
        <div class="bubble-card create-bubble-card" onclick="openCreateBubbleModal()">
            <i class="fas fa-plus-circle"></i>
            <span>Create New Bubble</span>
        </div>`;

        grid.innerHTML = html;

        // Render unassigned devices
        const unassigned = bubblesData.unassigned_devices || [];
        if (unassigned.length > 0) {
            unassignedEl.innerHTML = unassigned.map(d => {
                // Apply D2D cluster color - devices that communicate show same color
                // This makes it visually obvious which unassigned devices should be grouped together
                const hasCluster = d.d2d_cluster && d.d2d_cluster.cluster_color;
                const clusterColor = hasCluster ? d.d2d_cluster.cluster_color : '';
                // Convert hex to rgba for background with opacity
                const bgColor = hasCluster ? clusterColor + '25' : '';  // 25 = ~15% opacity in hex
                const clusterStyle = hasCluster
                    ? `color: ${clusterColor} !important; border-left-color: ${clusterColor}; border-color: ${clusterColor}40; background: ${bgColor}; font-weight: 600;`
                    : '';
                const clusterClass = hasCluster ? 'd2d-clustered' : '';
                const clusterTitle = hasCluster
                    ? `D2D Cluster #${d.d2d_cluster.cluster_id + 1}: ${d.d2d_cluster.device_count} devices communicate together (affinity: ${(d.d2d_cluster.avg_affinity * 100).toFixed(0)}%)`
                    : '';
                return `
                <div class="device-tag ${clusterClass}"
                     draggable="true"
                     data-mac="${d.mac}"
                     data-bubble=""
                     data-d2d-cluster="${hasCluster ? d.d2d_cluster.cluster_id : ''}"
                     style="${clusterStyle}"
                     title="${clusterTitle || d.vendor || ''}"
                     ondragstart="handleDragStart(event, '${d.mac}', '')"
                     ondragend="handleDragEnd(event)">
                    ${d.label || d.mac}
                </div>`;
            }).join('');
            document.getElementById('unassigned-section').style.display = 'block';
        } else {
            unassignedEl.innerHTML = '<span style="color: var(--aiochi-text-muted); font-size: 0.75rem;">No unassigned devices</span>';
        }
    }

    // Drag and drop handlers
    window.handleDragStart = function(event, mac, bubbleId) {
        draggedDevice = mac;
        draggedFromBubble = bubbleId;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', mac);
    };

    window.handleDragEnd = function(event) {
        event.target.classList.remove('dragging');
        // Remove drop-target class from all cards
        document.querySelectorAll('.bubble-card').forEach(card => {
            card.classList.remove('drop-target');
        });
    };

    window.handleDragOver = function(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        // Add visual feedback
        const card = event.target.closest('.bubble-card');
        if (card && !card.classList.contains('create-bubble-card')) {
            card.classList.add('drop-target');
        }
    };

    window.handleDrop = async function(event, targetBubbleId) {
        event.preventDefault();

        // Remove drop-target class
        document.querySelectorAll('.bubble-card').forEach(card => {
            card.classList.remove('drop-target');
        });

        if (!draggedDevice) return;

        // Don't do anything if dropped on same bubble
        if (draggedFromBubble === targetBubbleId) {
            draggedDevice = null;
            draggedFromBubble = null;
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/bubbles/move-device`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mac: draggedDevice,
                    from_bubble: draggedFromBubble || null,
                    to_bubble: targetBubbleId
                })
            });

            const data = await response.json();
            if (data.success) {
                // Refresh bubbles
                fetchBubbles();
            } else {
                console.error('Move device failed:', data.error);
            }
        } catch (error) {
            console.error('Failed to move device:', error);
        }

        draggedDevice = null;
        draggedFromBubble = null;
    };

    // Modal functions
    window.openCreateBubbleModal = function() {
        document.getElementById('bubble-modal-title').textContent = 'Create New Bubble';
        document.getElementById('bubble-edit-id').value = '';
        document.getElementById('bubble-name').value = '';
        document.getElementById('bubble-type').value = 'FAMILY';
        document.getElementById('bubble-delete-btn').style.display = 'none';
        selectColor('#2196F3');
        document.getElementById('bubble-modal-overlay').classList.add('active');
    };

    window.openEditBubbleModal = function(bubbleId) {
        const bubble = bubblesData.bubbles.find(b => b.bubble_id === bubbleId);
        if (!bubble) return;

        document.getElementById('bubble-modal-title').textContent = 'Edit Bubble';
        document.getElementById('bubble-edit-id').value = bubbleId;
        document.getElementById('bubble-name').value = bubble.name;
        document.getElementById('bubble-type').value = bubble.bubble_type;
        document.getElementById('bubble-delete-btn').style.display = 'block';
        selectColor(bubble.color || '#2196F3');
        document.getElementById('bubble-modal-overlay').classList.add('active');
    };

    window.closeBubbleModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('bubble-modal-overlay').classList.remove('active');
    };

    window.selectColor = function(color) {
        selectedColor = color;
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.color === color);
        });
    };

    window.saveBubble = async function() {
        const bubbleId = document.getElementById('bubble-edit-id').value;
        const name = document.getElementById('bubble-name').value.trim();
        const bubbleType = document.getElementById('bubble-type').value;

        if (!name) {
            alert('Please enter a bubble name');
            return;
        }

        try {
            let url = `${API_BASE}/bubbles`;
            let method = 'POST';

            if (bubbleId) {
                url = `${API_BASE}/bubbles/${bubbleId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    bubble_type: bubbleType,
                    color: selectedColor,
                    icon: typeIcons[bubbleType] || 'fa-layer-group'
                })
            });

            const data = await response.json();
            if (data.success) {
                closeBubbleModal();
                fetchBubbles();
            } else {
                alert(data.error || 'Failed to save bubble');
            }
        } catch (error) {
            console.error('Failed to save bubble:', error);
            alert('Failed to save bubble');
        }
    };

    window.deleteBubble = async function() {
        const bubbleId = document.getElementById('bubble-edit-id').value;
        if (!bubbleId) return;

        if (!confirm('Are you sure you want to delete this bubble? Devices will be moved to unassigned.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/bubbles/${bubbleId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                closeBubbleModal();
                fetchBubbles();
            } else {
                alert(data.error || 'Failed to delete bubble');
            }
        } catch (error) {
            console.error('Failed to delete bubble:', error);
            alert('Failed to delete bubble');
        }
    };

    // Initialize bubbles on load
    document.addEventListener('DOMContentLoaded', function() {
        fetchBubbles();
    });

    // =========================================================================
    // ACTIVE DEFENSES - 5 INNOVATIONS
    // =========================================================================

    // Switch defense tabs
    window.switchDefenseTab = function(tabName) {
        // Update tab buttons
        document.querySelectorAll('.defense-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Update panels
        document.querySelectorAll('.defense-panel').forEach(panel => {
            panel.classList.toggle('active', panel.id === `panel-${tabName}`);
        });

        // Fetch data for the active tab
        fetchDefenseData(tabName);
    };

    // Fetch defense data based on active tab
    async function fetchDefenseData(tabName) {
        try {
            const response = await fetch(`${API_BASE}/defenses/${tabName}`);
            const data = await response.json();

            if (data.success) {
                switch(tabName) {
                    case 'friction': updateFriction(data); break;
                    case 'ghost': updateGhostProbe(data); break;
                    case 'chain': updateChainPredictor(data); break;
                    case 'honeypot': updateHoneypot(data); break;
                    case 'gravity': updateGravity(data); break;
                }
            }
        } catch (error) {
            console.error(`Failed to fetch ${tabName} data:`, error);
        }
    }

    // Update Friction Control panel
    function updateFriction(data) {
        document.getElementById('friction-active').textContent = data.stats.active || 0;
        document.getElementById('friction-subtle').textContent = data.stats.subtle || 0;
        document.getElementById('friction-degraded').textContent = data.stats.degraded || 0;
        document.getElementById('friction-severe').textContent = data.stats.severe || 0;
        document.getElementById('friction-count').textContent = `${data.devices?.length || 0} devices`;

        const listEl = document.getElementById('friction-list');
        if (!data.devices || data.devices.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No friction applied. All devices are operating normally.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.devices.map(d => `
            <div class="friction-item">
                <div class="friction-device">
                    <span class="friction-mac">${d.mac}</span>
                    <span class="friction-label">${d.label || 'Unknown'}</span>
                </div>
                <div class="friction-details">
                    <span class="friction-level ${d.level}">${d.level}</span>
                    <span class="friction-delay">${d.delay_ms}ms</span>
                    <span class="friction-qsecbit">QSecBit: ${(d.qsecbit * 100).toFixed(0)}%</span>
                </div>
                <div class="friction-reason">${d.reason}</div>
            </div>
        `).join('');
    }

    // Update Ghost Probe panel
    function updateGhostProbe(data) {
        document.getElementById('ghost-probes').textContent = data.stats.probes_24h || 0;
        document.getElementById('ghost-clean').textContent = data.stats.clean || 0;
        document.getElementById('ghost-suspicious').textContent = data.stats.suspicious || 0;
        document.getElementById('ghost-masquerade').textContent = data.stats.masquerading || 0;

        const listEl = document.getElementById('ghost-list');
        if (!data.probes || data.probes.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>No recent probes. Click "Probe All Devices" to start active interrogation.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.probes.map(p => `
            <div class="ghost-item">
                <div class="ghost-device">
                    <span class="ghost-mac">${p.mac}</span>
                    <span class="ghost-label">${p.label || p.claimed_vendor || 'Unknown'}</span>
                </div>
                <div class="ghost-verdict-row">
                    <span class="ghost-verdict ${p.verdict}">${p.verdict}</span>
                    <span class="ghost-confidence">${(p.confidence * 100).toFixed(0)}% confidence</span>
                </div>
                <div class="ghost-details">
                    <span>Claimed: ${p.claimed_vendor || 'None'}</span>
                    <span>Actual: ${p.actual_vendor || 'Unknown'}</span>
                    <span class="ghost-action ${p.action}">${p.action}</span>
                </div>
            </div>
        `).join('');
    }

    // Run probe on all devices
    window.runProbeAll = async function() {
        const btn = document.querySelector('.btn-probe-all');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probing...';

        try {
            const response = await fetch(`${API_BASE}/defenses/ghost/probe-all`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                fetchDefenseData('ghost');
            }
        } catch (error) {
            console.error('Failed to run probe:', error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-radar"></i> Probe All Devices';
        }
    };

    // Update Chain Predictor panel
    function updateChainPredictor(data) {
        document.getElementById('chain-predictions').textContent = data.stats.predictions_24h || 0;
        document.getElementById('chain-hardened').textContent = data.stats.hardened || 0;
        document.getElementById('chain-prevented').textContent = data.stats.prevented || 0;
        document.getElementById('chain-active').textContent = data.stats.active_chains || 0;
        document.getElementById('chain-count').textContent = `${data.chains?.length || 0} active`;

        const listEl = document.getElementById('chain-list');
        if (!data.chains || data.chains.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-brain"></i>
                    <p>No attack chains detected. The AI is monitoring for MITRE ATT&CK sequences.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.chains.map(c => `
            <div class="chain-item">
                <div class="chain-header">
                    <span class="chain-id">${c.chain_id.slice(0, 8)}</span>
                    <span class="chain-stage">${c.current_stage}/${c.total_stages}</span>
                    <span class="chain-confidence ${c.confidence > 0.7 ? 'high' : 'medium'}">${(c.confidence * 100).toFixed(0)}%</span>
                </div>
                <div class="chain-techniques">
                    ${c.techniques.map(t => `<span class="mitre-tag">${t}</span>`).join('')}
                </div>
                <div class="chain-prediction">
                    <span class="chain-label">Next likely:</span>
                    ${c.predicted_next.map(p => `<span class="predicted-technique">${p.technique} (${(p.probability * 100).toFixed(0)}%)</span>`).join('')}
                </div>
                <div class="chain-device">
                    <span>Device: ${c.device_mac}</span>
                    <span class="chain-status ${c.status}">${c.status}</span>
                </div>
            </div>
        `).join('');
    }

    // Update Honeypot Mesh panel
    function updateHoneypot(data) {
        document.getElementById('honeypot-touches').textContent = data.stats.touches_24h || 0;
        document.getElementById('honeypot-ports').textContent = data.stats.dark_ports || 0;
        document.getElementById('honeypot-attackers').textContent = data.stats.unique_attackers || 0;
        document.getElementById('honeypot-critical').textContent = data.stats.critical_threats || 0;
        document.getElementById('honeypot-count').textContent = `${data.attackers?.length || 0} tracked`;

        const listEl = document.getElementById('honeypot-list');
        if (!data.attackers || data.attackers.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-check"></i>
                    <p>No honeypot touches detected. Dark ports are active and monitoring.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.attackers.map(a => `
            <div class="honeypot-item ${a.threat_level}">
                <div class="honeypot-header">
                    <span class="attacker-ip">${a.source_ip}</span>
                    <span class="threat-level-badge ${a.threat_level}">${a.threat_level}</span>
                </div>
                <div class="honeypot-ports">
                    ${a.ports_touched.map(p => `<span class="port-tag">${p}</span>`).join('')}
                </div>
                <div class="honeypot-intel">
                    <span>TTPs: ${a.ttp_count || 0}</span>
                    <span>Reputation: ${a.reputation || 'Unknown'}</span>
                    <span>Country: ${a.country || '??'}</span>
                </div>
                <div class="honeypot-action">
                    <span class="action-badge ${a.action}">${a.action}</span>
                    <span class="honeypot-time">${a.last_seen}</span>
                </div>
            </div>
        `).join('');
    }

    // Update Data Gravity panel
    function updateGravity(data) {
        document.getElementById('gravity-events').textContent = data.stats.events_24h || 0;
        document.getElementById('gravity-blocked').textContent = data.stats.blocked || 0;
        document.getElementById('gravity-sensitive').textContent = data.stats.sensitive_files || 0;
        document.getElementById('gravity-highrisk').textContent = data.stats.high_risk_sources || 0;
        document.getElementById('gravity-count').textContent = `${data.events?.length || 0} detected`;

        const listEl = document.getElementById('gravity-list');
        if (!data.events || data.events.length === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-database"></i>
                    <p>No sensitive data movement detected. Zeek file monitoring is active.</p>
                </div>`;
            return;
        }

        listEl.innerHTML = data.events.map(e => `
            <div class="gravity-item ${e.risk_level}">
                <div class="gravity-header">
                    <span class="gravity-filename">${e.filename}</span>
                    <span class="gravity-size">${formatBytes(e.size_bytes)}</span>
                </div>
                <div class="gravity-flow">
                    <span class="gravity-source">${e.source_device}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span class="gravity-dest">${e.dest_ip}</span>
                </div>
                <div class="gravity-risk">
                    <div class="gravity-risk-bar">
                        <div class="gravity-risk-fill ${e.risk_level}" style="width: ${e.risk_score * 100}%"></div>
                    </div>
                    <span class="gravity-risk-score">${(e.risk_score * 100).toFixed(0)}%</span>
                </div>
                <div class="gravity-mitre">
                    ${e.mitre_techniques.map(t => `<span class="gravity-mitre-tag">${t}</span>`).join('')}
                </div>
                <div class="gravity-action">
                    <span class="action-badge ${e.action}">${e.action}</span>
                    <span class="gravity-time">${e.timestamp}</span>
                </div>
            </div>
        `).join('');
    }

    // Helper: format bytes
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Initialize defenses on load
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch initial defense data for the active tab (friction)
        fetchDefenseData('friction');

        // Refresh defense data every 10 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.defense-tab.active');
            if (activeTab) {
                fetchDefenseData(activeTab.dataset.tab);
            }
        }, 10000);
    });

})();
</script>
{% endblock %}
