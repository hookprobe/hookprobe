{% extends "base.html" %}

{% block title %}SDN AI - Intelligent Network Control{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"><i class="fas fa-network-wired mr-2"></i>SDN AI</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">SDN AI</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <!-- Demo Mode Alert -->
        {% if not db_available %}
        <div class="alert alert-warning alert-dismissible">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Demo Mode:</strong> Database not connected. Showing sample data.
        </div>
        {% endif %}

        <!-- WiFi Intelligence Hero Section -->
        <div class="row" id="wifi-intelligence-hero">
            <div class="col-12">
                <div class="card card-widget widget-user-2" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border: none; border-radius: 15px; overflow: hidden;">
                    <div class="card-header border-0" style="background: transparent;">
                        <div class="row align-items-center">
                            <!-- Left: WiFi Status -->
                            <div class="col-lg-3 col-md-6 text-center text-lg-left mb-3 mb-lg-0">
                                <div class="d-flex align-items-center justify-content-center justify-content-lg-start">
                                    <div class="wifi-icon-container mr-3" style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-broadcast-tower fa-3x" id="wifi-icon" style="color: #00d9ff; text-shadow: 0 0 20px rgba(0,217,255,0.5);"></i>
                                    </div>
                                    <div>
                                        <h2 class="mb-0" style="color: #fff; font-weight: 700;">
                                            <span id="wifi-channel">--</span>
                                            <small class="text-muted" id="wifi-band" style="font-size: 0.6em; color: #aaa !important;">--</small>
                                        </h2>
                                        <p class="mb-0" style="color: #888; font-size: 0.85em;">
                                            <i class="fas fa-wifi mr-1"></i>
                                            <span id="wifi-ssid">Loading...</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Center: ML Score Gauge -->
                            <div class="col-lg-3 col-md-6 text-center mb-3 mb-lg-0">
                                <div class="ml-score-container">
                                    <div class="score-ring" style="width: 90px; height: 90px; margin: 0 auto; position: relative;">
                                        <svg viewBox="0 0 36 36" class="circular-chart" style="width: 100%; height: 100%;">
                                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                  fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                            <path class="circle" id="ml-score-ring"
                                                  stroke-dasharray="0, 100"
                                                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                  fill="none" stroke="#00ff88" stroke-width="3" stroke-linecap="round"
                                                  style="transition: stroke-dasharray 1s ease-in-out;"/>
                                        </svg>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                            <span id="ml-score-value" style="color: #00ff88; font-size: 1.4em; font-weight: 700;">--</span>
                                        </div>
                                    </div>
                                    <p class="mb-0 mt-1" style="color: #888; font-size: 0.75em;">
                                        <i class="fas fa-brain mr-1" style="color: #00ff88;"></i>ML CHANNEL SCORE
                                    </p>
                                </div>
                            </div>

                            <!-- Center-Right: Statistics -->
                            <div class="col-lg-3 col-md-6 text-center mb-3 mb-lg-0">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-box p-2" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                                            <i class="fas fa-satellite-dish mb-1" style="color: #ff6b6b; font-size: 1.5em;"></i>
                                            <h4 class="mb-0" style="color: #fff; font-weight: 600;">
                                                <span id="radar-count">0</span>
                                            </h4>
                                            <small style="color: #888; font-size: 0.7em;">RADAR EVENTS</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-box p-2" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                                            <i class="fas fa-exchange-alt mb-1" style="color: #ffd93d; font-size: 1.5em;"></i>
                                            <h4 class="mb-0" style="color: #fff; font-weight: 600;">
                                                <span id="channel-switches">0</span>
                                            </h4>
                                            <small style="color: #888; font-size: 0.7em;">CH SWITCHES</small>
                                        </div>
                                    </div>
                                </div>
                                <p class="mb-0 mt-2" style="color: #666; font-size: 0.7em;">
                                    <i class="far fa-calendar-alt mr-1"></i>Last 30 days
                                </p>
                            </div>

                            <!-- Right: Next Optimization Countdown -->
                            <div class="col-lg-3 col-md-6 text-center text-lg-right">
                                <div class="next-opt-container">
                                    <p class="mb-1" style="color: #888; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px;">
                                        <i class="fas fa-clock mr-1"></i>Next Auto-Optimization
                                    </p>
                                    <h3 class="mb-0" id="countdown-timer" style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600; letter-spacing: 2px;">
                                        --:--:--
                                    </h3>
                                    <p class="mb-0 mt-1" style="color: #666; font-size: 0.7em;">
                                        <span id="last-opt-info">
                                            <i class="fas fa-history mr-1"></i>Last: <span id="last-opt-time">Never</span>
                                            <span id="prev-channel-info" style="display: none;"> (was CH <span id="prev-channel">--</span>)</span>
                                        </span>
                                    </p>
                                    <div class="mt-2">
                                        <span id="dfs-badge" class="badge" style="background: rgba(0,217,255,0.2); color: #00d9ff; font-size: 0.7em; display: none;">
                                            <i class="fas fa-bolt mr-1"></i>DFS INTELLIGENCE ACTIVE
                                        </span>
                                        <span id="basic-badge" class="badge" style="background: rgba(255,255,255,0.1); color: #888; font-size: 0.7em;">
                                            <i class="fas fa-search mr-1"></i>BASIC SCAN MODE
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress bar for countdown -->
                    <div class="progress" style="height: 4px; background: rgba(255,255,255,0.05); border-radius: 0;">
                        <div class="progress-bar" id="countdown-progress" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #00d9ff, #00ff88); transition: width 1s linear;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WAN Health Bar -->
        <div class="row mb-3" id="wan-health-bar">
            <div class="col-12">
                <div class="card mb-0" style="background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); border: none; border-radius: 12px;">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <!-- Primary WAN -->
                            <div class="col-lg-3 col-md-6 mb-2 mb-lg-0">
                                <div class="d-flex align-items-center">
                                    <div class="wan-icon mr-3" style="width: 45px; height: 45px; background: rgba(79,195,247,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-ethernet fa-lg" style="color: #4fc3f7;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Primary WAN</small>
                                            <span id="wan-primary-status" class="badge badge-success badge-sm">ACTIVE</span>
                                        </div>
                                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                            <div class="progress-bar bg-success" id="wan-primary-health" style="width: 95%;"></div>
                                        </div>
                                        <small class="text-white-50" id="wan-primary-interface">eth0</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Backup WAN -->
                            <div class="col-lg-3 col-md-6 mb-2 mb-lg-0">
                                <div class="d-flex align-items-center">
                                    <div class="wan-icon mr-3" style="width: 45px; height: 45px; background: rgba(255,152,0,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-signal fa-lg" style="color: #ffb74d;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Backup WAN</small>
                                            <span id="wan-backup-status" class="badge badge-secondary badge-sm">STANDBY</span>
                                        </div>
                                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                            <div class="progress-bar bg-warning" id="wan-backup-health" style="width: 72%;"></div>
                                        </div>
                                        <small class="text-white-50" id="wan-backup-interface">wwan0</small>
                                    </div>
                                </div>
                            </div>

                            <!-- LSTM Prediction -->
                            <div class="col-lg-3 col-md-6 mb-2 mb-lg-0 text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="mr-3" style="width: 50px; height: 50px; position: relative;">
                                        <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                            <circle cx="18" cy="18" r="15" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                            <circle id="lstm-confidence-ring" cx="18" cy="18" r="15" fill="none" stroke="#00ff88" stroke-width="3"
                                                    stroke-dasharray="87, 100" stroke-linecap="round"/>
                                        </svg>
                                        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff88; font-weight: 700; font-size: 0.8rem;" id="lstm-confidence">87%</span>
                                    </div>
                                    <div class="text-left">
                                        <small class="text-muted d-block">LSTM Prediction</small>
                                        <span class="text-success" id="lstm-status"><i class="fas fa-check-circle mr-1"></i>Stable</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="col-lg-3 col-md-6 text-center text-lg-right">
                                <div class="d-flex justify-content-center justify-content-lg-end align-items-center">
                                    <div class="mr-3 text-right d-none d-md-block">
                                        <small class="text-muted d-block">Uptime</small>
                                        <span class="text-white font-weight-bold" id="wan-uptime">99.9%</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-info" onclick="showWanHealthModal()" title="Full WAN Health Dashboard">
                                        <i class="fas fa-expand-alt mr-1"></i>Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row">
            <!-- Total Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ stats.total_devices }}</h3>
                        <p>Total Devices</p>
                    </div>
                    <div class="icon"><i class="fas fa-laptop"></i></div>
                </div>
            </div>

            <!-- Online Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ stats.online_devices }}</h3>
                        <p>Online</p>
                    </div>
                    <div class="icon"><i class="fas fa-wifi"></i></div>
                </div>
            </div>

            <!-- Offline Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ stats.offline_devices }}</h3>
                        <p>Offline</p>
                    </div>
                    <div class="icon"><i class="fas fa-power-off"></i></div>
                </div>
            </div>

            <!-- Blocked Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ stats.blocked_devices }}</h3>
                        <p>Blocked</p>
                    </div>
                    <div class="icon"><i class="fas fa-ban"></i></div>
                </div>
            </div>
        </div>

        <!-- Filters and Actions Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-filter mr-2"></i>Filters & Actions</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Policy Filter -->
                            <div class="col-md-3">
                                <label>Filter by Policy</label>
                                <select id="filter-policy" class="form-control">
                                    <option value="">All Policies</option>
                                    {% for policy in policies %}
                                    <option value="{{ policy.name }}">{{ policy.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Category Filter -->
                            <div class="col-md-3">
                                <label>Filter by Category</label>
                                <select id="filter-category" class="form-control">
                                    <option value="">All Categories</option>
                                    <option value="iot">IoT Devices</option>
                                    <option value="camera">Cameras</option>
                                    <option value="pos">POS Terminals</option>
                                    <option value="printer">Printers</option>
                                    <option value="workstation">Workstations</option>
                                    <option value="voice_assistant">Voice Assistants</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div class="col-md-2">
                                <label>Status</label>
                                <select id="filter-status" class="form-control">
                                    <option value="">All</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>

                            <!-- Actions -->
                            <div class="col-md-4">
                                <label>&nbsp;</label>
                                <div class="btn-group d-block">
                                    <button type="button" id="btn-discover" class="btn btn-primary">
                                        <i class="fas fa-search mr-1"></i> Discover
                                    </button>
                                    <button type="button" id="btn-refresh" class="btn btn-default">
                                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                                    </button>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                            <i class="fas fa-download mr-1"></i> Export
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="{{ url_for('sdn.export_devices', format='csv') }}">
                                                <i class="fas fa-file-csv mr-2"></i> CSV
                                            </a>
                                            <a class="dropdown-item" href="{{ url_for('sdn.export_devices', format='json') }}">
                                                <i class="fas fa-file-code mr-2"></i> JSON
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions (shown when devices selected) -->
                        <div class="row mt-3" id="bulk-actions" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <strong><span id="selected-count">0</span> devices selected</strong>
                                    <div class="btn-group float-right">
                                        <button type="button" class="btn btn-sm btn-primary" id="bulk-auto-classify">
                                            <i class="fas fa-magic mr-1"></i> Auto-Classify
                                        </button>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-toggle="dropdown">
                                                <i class="fas fa-exchange-alt mr-1"></i> Set Policy
                                            </button>
                                            <div class="dropdown-menu">
                                                {% for policy in policies %}
                                                <a class="dropdown-item bulk-policy" data-policy="{{ policy.name }}">
                                                    <i class="fas {{ policy.icon }} mr-2 text-{{ policy.color }}"></i>
                                                    {{ policy.display_name }}
                                                </a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-danger" id="bulk-block">
                                            <i class="fas fa-ban mr-1"></i> Block All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-list mr-2"></i>Network Devices</h3>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table id="devices-table" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="select-all">
                                            <label class="custom-control-label" for="select-all"></label>
                                        </div>
                                    </th>
                                    <th>Status</th>
                                    <th>Hostname</th>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Vendor</th>
                                    <th>Category</th>
                                    <th>Policy</th>
                                    <th>Access</th>
                                    <th>Last Seen</th>
                                    <th style="width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr data-mac="{{ device.mac_address }}"
                                    data-policy="{{ device.network_policy }}"
                                    data-category="{{ device.oui_category }}"
                                    data-online="{{ 'true' if device.is_online else 'false' }}"
                                    data-blocked="{{ 'true' if device.is_blocked else 'false' }}">
                                    <td>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input device-select"
                                                   id="select-{{ device.mac_address | replace(':', '') }}"
                                                   value="{{ device.mac_address }}">
                                            <label class="custom-control-label"
                                                   for="select-{{ device.mac_address | replace(':', '') }}"></label>
                                        </div>
                                    </td>
                                    <td>
                                        {% if device.is_blocked %}
                                        <span class="badge badge-danger"><i class="fas fa-ban"></i> Blocked</span>
                                        {% elif device.is_online %}
                                        <span class="badge badge-success"><i class="fas fa-circle"></i> Online</span>
                                        {% else %}
                                        <span class="badge badge-secondary"><i class="far fa-circle"></i> Offline</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('sdn.device_detail', mac_address=device.mac_address) }}">
                                            <strong>{{ device.hostname or 'Unknown' }}</strong>
                                        </a>
                                    </td>
                                    <td><code>{{ device.ip_address or 'N/A' }}</code></td>
                                    <td><code>{{ device.mac_address }}</code></td>
                                    <td>{{ device.manufacturer or 'Unknown' }}</td>
                                    <td>
                                        {% set category_icons = {
                                            'iot': 'fa-microchip',
                                            'camera': 'fa-video',
                                            'pos': 'fa-cash-register',
                                            'printer': 'fa-print',
                                            'workstation': 'fa-desktop',
                                            'voice_assistant': 'fa-volume-up',
                                            'mobile': 'fa-mobile-alt',
                                            'network': 'fa-network-wired',
                                            'unknown': 'fa-question'
                                        } %}
                                        <i class="fas {{ category_icons.get(device.oui_category, 'fa-question') }} mr-1"></i>
                                        {{ device.oui_category | capitalize }}
                                    </td>
                                    <td>
                                        {% set policy_colors = {
                                            'full_access': 'success',
                                            'lan_only': 'info',
                                            'internet_only': 'primary',
                                            'isolated': 'danger',
                                            'default': 'secondary'
                                        } %}
                                        <span class="badge badge-{{ policy_colors.get(device.network_policy, 'secondary') }}">
                                            {{ device.network_policy | replace('_', ' ') | title }}
                                        </span>
                                        {% if device.network_policy != device.auto_policy %}
                                        <i class="fas fa-user-edit text-warning ml-1" title="Manual override (OUI: {{ device.auto_policy }})"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.internet_access %}
                                        <span class="badge badge-light" title="Internet Access"><i class="fas fa-globe text-success"></i></span>
                                        {% else %}
                                        <span class="badge badge-light" title="No Internet"><i class="fas fa-globe text-muted"></i></span>
                                        {% endif %}
                                        {% if device.lan_access %}
                                        <span class="badge badge-light" title="LAN Access"><i class="fas fa-network-wired text-success"></i></span>
                                        {% else %}
                                        <span class="badge badge-light" title="No LAN"><i class="fas fa-network-wired text-muted"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ device.last_seen }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('sdn.device_detail', mac_address=device.mac_address) }}"
                                               class="btn btn-default" title="Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-default dropdown-toggle dropdown-toggle-split"
                                                    data-toggle="dropdown">
                                                <span class="sr-only">Actions</span>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item btn-auto-classify" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-magic mr-2"></i> Auto-Classify
                                                </a>
                                                <div class="dropdown-divider"></div>
                                                <h6 class="dropdown-header">Set Policy</h6>
                                                {% for policy in policies %}
                                                <a class="dropdown-item btn-set-policy" href="#"
                                                   data-mac="{{ device.mac_address }}"
                                                   data-policy="{{ policy.name }}">
                                                    <i class="fas {{ policy.icon }} mr-2 text-{{ policy.color }}"></i>
                                                    {{ policy.display_name }}
                                                </a>
                                                {% endfor %}
                                                <div class="dropdown-divider"></div>
                                                {% if device.is_blocked %}
                                                <a class="dropdown-item text-success btn-unblock" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-check mr-2"></i> Unblock
                                                </a>
                                                {% else %}
                                                <a class="dropdown-item btn-disconnect" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-plug mr-2"></i> Disconnect
                                                </a>
                                                <a class="dropdown-item text-danger btn-block" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-ban mr-2"></i> Block
                                                </a>
                                                {% endif %}
                                                <div class="dropdown-divider"></div>
                                                <h6 class="dropdown-header">Move to Segment</h6>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="10">
                                                    <i class="fas fa-shield-alt mr-2 text-info"></i> SECMON
                                                </a>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="20">
                                                    <i class="fas fa-credit-card mr-2 text-warning"></i> POS
                                                </a>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="30">
                                                    <i class="fas fa-laptop mr-2 text-success"></i> CLIENTS
                                                </a>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="40">
                                                    <i class="fas fa-wifi mr-2 text-primary"></i> GUEST
                                                </a>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="50">
                                                    <i class="fas fa-video mr-2 text-purple"></i> CAMERAS
                                                </a>
                                                <a class="dropdown-item btn-move-segment" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="60">
                                                    <i class="fas fa-microchip mr-2 text-orange"></i> IIOT
                                                </a>
                                                <a class="dropdown-item btn-move-segment text-danger" href="#"
                                                   data-mac="{{ device.mac_address }}" data-segment="99">
                                                    <i class="fas fa-exclamation-triangle mr-2"></i> QUARANTINE
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Legend -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-secondary collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Policy Reference</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for policy in policies %}
                            <div class="col-md-4 col-lg-2">
                                <div class="info-box bg-{{ policy.color }}">
                                    <span class="info-box-icon"><i class="fas {{ policy.icon }}"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">{{ policy.display_name }}</span>
                                        <span class="info-box-number">
                                            {{ stats.policy_counts.get(policy.name, 0) }} devices
                                        </span>
                                        <small>{{ policy.description }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Block Device Modal -->
<div class="modal fade" id="modal-block" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title"><i class="fas fa-ban mr-2"></i>Block Device</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form id="form-block" method="POST">
                <div class="modal-body">
                    <p>Block device <strong id="block-mac"></strong>?</p>
                    <p class="text-muted">This device will be completely isolated from the network.</p>
                    <div class="form-group">
                        <label>Reason (optional)</label>
                        <input type="text" name="reason" class="form-control" placeholder="Security concern, unauthorized, etc.">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Block Device</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// WiFi Intelligence - Global state
var wifiIntelligence = {
    countdownSeconds: 0,
    totalSeconds: 86400, // 24 hours
    updateInterval: null,
    countdownInterval: null
};

// Load WiFi intelligence data
function loadWifiIntelligence() {
    $.get('{{ url_for("sdn.api_wifi_intelligence") }}')
        .done(function(response) {
            if (response.success) {
                updateWifiDisplay(response.wifi_intelligence);
            }
        })
        .fail(function() {
            // Use demo data on failure
            updateWifiDisplay({
                current_channel: 36,
                band: '5GHz',
                ssid: 'Fortress-WiFi',
                ml_score: 0.87,
                radar_count_30d: 2,
                channel_switches_30d: 3,
                time_to_next_seconds: 28800,
                last_optimization: '2025-12-17T04:00:00',
                previous_channel: 44,
                dfs_available: true,
                optimization_method: 'dfs_intelligence'
            });
        });
}

function updateWifiDisplay(data) {
    // Update channel and band
    if (data.current_channel) {
        $('#wifi-channel').text('CH ' + data.current_channel);
        $('#wifi-band').text(data.band || '');
    }

    // Update SSID
    if (data.ssid) {
        $('#wifi-ssid').text(data.ssid);
    } else {
        $('#wifi-ssid').text('Fortress Network');
    }

    // Update ML Score
    if (data.ml_score !== null && data.ml_score !== undefined) {
        var score = parseFloat(data.ml_score);
        var scorePercent = Math.round(score * 100);
        $('#ml-score-value').text(scorePercent + '%');
        $('#ml-score-ring').attr('stroke-dasharray', scorePercent + ', 100');

        // Color based on score
        var color = score >= 0.8 ? '#00ff88' : (score >= 0.6 ? '#ffd93d' : '#ff6b6b');
        $('#ml-score-ring').attr('stroke', color);
        $('#ml-score-value').css('color', color);
    } else {
        $('#ml-score-value').text('N/A');
        $('#ml-score-ring').attr('stroke-dasharray', '0, 100');
    }

    // Update statistics
    $('#radar-count').text(data.radar_count_30d || 0);
    $('#channel-switches').text(data.channel_switches_30d || 0);

    // Update last optimization
    if (data.last_optimization) {
        var lastOpt = new Date(data.last_optimization);
        var now = new Date();
        var diffHours = Math.round((now - lastOpt) / (1000 * 60 * 60));
        if (diffHours < 24) {
            $('#last-opt-time').text(diffHours + 'h ago');
        } else {
            $('#last-opt-time').text(Math.round(diffHours / 24) + 'd ago');
        }

        // Show previous channel if available
        if (data.previous_channel && data.previous_channel !== data.current_channel) {
            $('#prev-channel').text(data.previous_channel);
            $('#prev-channel-info').show();
        } else {
            $('#prev-channel-info').hide();
        }
    }

    // Update DFS badge
    if (data.dfs_available && data.band === '5GHz') {
        $('#dfs-badge').show();
        $('#basic-badge').hide();
        // Make icon more vibrant for DFS mode
        $('#wifi-icon').css('color', '#00ff88').css('text-shadow', '0 0 30px rgba(0,255,136,0.7)');
    } else {
        $('#dfs-badge').hide();
        $('#basic-badge').show();
    }

    // Setup countdown
    if (data.time_to_next_seconds) {
        wifiIntelligence.countdownSeconds = data.time_to_next_seconds;
        wifiIntelligence.totalSeconds = 86400; // 24 hours
        startCountdown();
    }
}

function startCountdown() {
    // Clear existing interval
    if (wifiIntelligence.countdownInterval) {
        clearInterval(wifiIntelligence.countdownInterval);
    }

    updateCountdownDisplay();

    wifiIntelligence.countdownInterval = setInterval(function() {
        wifiIntelligence.countdownSeconds--;
        if (wifiIntelligence.countdownSeconds < 0) {
            wifiIntelligence.countdownSeconds = 86400;
        }
        updateCountdownDisplay();
    }, 1000);
}

function updateCountdownDisplay() {
    var seconds = wifiIntelligence.countdownSeconds;
    var hours = Math.floor(seconds / 3600);
    var minutes = Math.floor((seconds % 3600) / 60);
    var secs = seconds % 60;

    var display = String(hours).padStart(2, '0') + ':' +
                  String(minutes).padStart(2, '0') + ':' +
                  String(secs).padStart(2, '0');
    $('#countdown-timer').text(display);

    // Update progress bar (inverse - fills as we get closer)
    var elapsed = wifiIntelligence.totalSeconds - seconds;
    var progress = (elapsed / wifiIntelligence.totalSeconds) * 100;
    $('#countdown-progress').css('width', progress + '%');
}

// Pulse animation for WiFi icon
function pulseWifiIcon() {
    $('#wifi-icon').animate({
        opacity: 0.6
    }, 1000).animate({
        opacity: 1
    }, 1000);
}

$(document).ready(function() {
    // Load WiFi intelligence data
    loadWifiIntelligence();

    // Refresh WiFi data every 60 seconds
    wifiIntelligence.updateInterval = setInterval(loadWifiIntelligence, 60000);

    // Pulse animation every 3 seconds
    setInterval(pulseWifiIcon, 3000);

    // Initialize DataTable
    var table = $('#devices-table').DataTable({
        "paging": true,
        "pageLength": 25,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "order": [[2, 'asc']],
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "columnDefs": [
            { "orderable": false, "targets": [0, 10] }
        ]
    });

    // Filter by policy
    $('#filter-policy').on('change', function() {
        var policy = $(this).val();
        table.column(7).search(policy).draw();
    });

    // Filter by category
    $('#filter-category').on('change', function() {
        var category = $(this).val();
        table.column(6).search(category).draw();
    });

    // Filter by status
    $('#filter-status').on('change', function() {
        var status = $(this).val();
        if (status === 'online') {
            table.column(1).search('Online').draw();
        } else if (status === 'offline') {
            table.column(1).search('Offline').draw();
        } else if (status === 'blocked') {
            table.column(1).search('Blocked').draw();
        } else {
            table.column(1).search('').draw();
        }
    });

    // Select all checkbox
    $('#select-all').on('change', function() {
        $('.device-select').prop('checked', this.checked);
        updateBulkActions();
    });

    // Individual checkbox
    $(document).on('change', '.device-select', function() {
        updateBulkActions();
    });

    function updateBulkActions() {
        var count = $('.device-select:checked').length;
        $('#selected-count').text(count);
        if (count > 0) {
            $('#bulk-actions').slideDown();
        } else {
            $('#bulk-actions').slideUp();
        }
    }

    function getSelectedMacs() {
        return $('.device-select:checked').map(function() {
            return $(this).val();
        }).get();
    }

    // Refresh button
    $('#btn-refresh').on('click', function() {
        location.reload();
    });

    // Discover button
    $('#btn-discover').on('click', function() {
        var btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Scanning...');

        $.post('{{ url_for("sdn.discover_devices") }}')
            .done(function(data) {
                if (data.success) {
                    toastr.success('Found ' + data.total + ' devices (' + data.new + ' new)');
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    toastr.error(data.error || 'Discovery failed');
                }
            })
            .fail(function() {
                toastr.error('Discovery request failed');
            })
            .always(function() {
                btn.prop('disabled', false).html('<i class="fas fa-search mr-1"></i> Discover');
            });
    });

    // Set policy (single device)
    $(document).on('click', '.btn-set-policy', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');
        var policy = $(this).data('policy');

        $.post('{{ url_for("sdn.set_policy", mac_address="MAC") }}'.replace('MAC', mac), {
            policy: policy,
            source: 'dropdown'
        }, function(data) {
            if (data.success) {
                toastr.success(data.message);
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                toastr.error(data.error || 'Failed to set policy');
            }
        }).fail(function() {
            // Fallback to form submit
            var form = $('<form method="POST" action="{{ url_for("sdn.set_policy", mac_address="MAC") }}">'.replace('MAC', mac));
            form.append($('<input type="hidden" name="policy">').val(policy));
            $('body').append(form);
            form.submit();
        });
    });

    // Auto-classify (single device)
    $(document).on('click', '.btn-auto-classify', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        $.post('{{ url_for("sdn.auto_classify", mac_address="MAC") }}'.replace('MAC', mac))
            .done(function(data) {
                if (data.success) {
                    toastr.success('Classified as ' + data.classification.category + ', policy: ' + data.policy_applied);
                    setTimeout(function() { location.reload(); }, 1000);
                } else {
                    toastr.error(data.error || 'Classification failed');
                }
            })
            .fail(function() {
                toastr.error('Request failed');
            });
    });

    // Disconnect device
    $(document).on('click', '.btn-disconnect', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        if (confirm('Disconnect device ' + mac + '?')) {
            $.post('{{ url_for("sdn.disconnect_device", mac_address="MAC") }}'.replace('MAC', mac))
                .done(function(data) {
                    if (data.success) {
                        toastr.success('Device disconnected');
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        toastr.error(data.error || 'Failed to disconnect');
                    }
                })
                .fail(function() {
                    toastr.error('Request failed');
                });
        }
    });

    // Block device - show modal
    $(document).on('click', '.btn-block', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');
        $('#block-mac').text(mac);
        $('#form-block').attr('action', '{{ url_for("sdn.block_device", mac_address="MAC") }}'.replace('MAC', mac));
        $('#modal-block').modal('show');
    });

    // Unblock device
    $(document).on('click', '.btn-unblock', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        if (confirm('Unblock device ' + mac + '?')) {
            $.post('{{ url_for("sdn.unblock_device", mac_address="MAC") }}'.replace('MAC', mac))
                .done(function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        toastr.error(data.error || 'Failed to unblock');
                    }
                })
                .fail(function() {
                    toastr.error('Request failed');
                });
        }
    });

    // Bulk auto-classify
    $('#bulk-auto-classify').on('click', function() {
        var macs = getSelectedMacs();
        if (macs.length === 0) return;

        if (confirm('Auto-classify ' + macs.length + ' devices based on OUI?')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_auto_classify") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs }),
                success: function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        toastr.warning(data.message);
                    }
                },
                error: function() {
                    toastr.error('Bulk classification failed');
                }
            });
        }
    });

    // Bulk set policy
    $(document).on('click', '.bulk-policy', function(e) {
        e.preventDefault();
        var policy = $(this).data('policy');
        var macs = getSelectedMacs();

        if (macs.length === 0) return;

        if (confirm('Set policy "' + policy + '" for ' + macs.length + ' devices?')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_set_policy") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs, policy: policy }),
                success: function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        toastr.warning(data.message);
                    }
                },
                error: function() {
                    toastr.error('Bulk policy update failed');
                }
            });
        }
    });

    // Bulk block
    $('#bulk-block').on('click', function() {
        var macs = getSelectedMacs();
        if (macs.length === 0) return;

        if (confirm('Block ' + macs.length + ' devices? They will be isolated from the network.')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_set_policy") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs, policy: 'isolated' }),
                success: function(data) {
                    toastr.success(data.message);
                    setTimeout(function() { location.reload(); }, 1500);
                },
                error: function() {
                    toastr.error('Bulk block failed');
                }
            });
        }
    });

    // Move to segment
    $(document).on('click', '.btn-move-segment', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');
        var segment = $(this).data('segment');
        var segmentNames = {
            10: 'SECMON', 20: 'POS', 30: 'CLIENTS',
            40: 'GUEST', 50: 'CAMERAS', 60: 'IIOT', 99: 'QUARANTINE'
        };

        $.post('{{ url_for("sdn.assign_segment") }}', {
            mac: mac,
            segment: segment
        }, function(data) {
            if (data.success) {
                toastr.success('Moved to ' + segmentNames[segment]);
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                toastr.error(data.error || 'Failed to move device');
            }
        }).fail(function() {
            toastr.error('Network error');
        });
    });

    // Auto-refresh device statistics every 30 seconds
    var autoRefreshInterval = setInterval(function() {
        $.get('{{ url_for("sdn.api_stats") }}')
            .done(function(data) {
                if (data.success && data.stats) {
                    // Update statistics cards
                    $('.small-box.bg-info .inner h3').text(data.stats.total_devices);
                    $('.small-box.bg-success .inner h3').text(data.stats.online_devices);
                    $('.small-box.bg-warning .inner h3').text(data.stats.offline_devices);
                    $('.small-box.bg-danger .inner h3').text(data.stats.blocked_devices);
                }
            });
    }, 30000);  // 30 second refresh

    // Show last refresh time
    function updateRefreshIndicator() {
        var now = new Date();
        var timeStr = now.toLocaleTimeString();
        if ($('#last-refresh').length === 0) {
            $('.card-header:contains("Network Devices") .card-title').append(
                ' <small id="last-refresh" class="text-muted ml-2">(Updated: ' + timeStr + ')</small>'
            );
        } else {
            $('#last-refresh').text('(Updated: ' + timeStr + ')');
        }
    }

    // Manual refresh updates the indicator
    $('#btn-refresh').on('click', function() {
        updateRefreshIndicator();
        location.reload();
    });

    // === WAN HEALTH FUNCTIONS ===

    // Load WAN Health data
    function loadWanHealth() {
        $.get('/slaai/api/status')
            .done(function(data) {
                if (data.success && data.status) {
                    updateWanHealthBar(data.status);
                }
            })
            .fail(function() {
                // Use fallback values on failure
                console.log('WAN Health API not available');
            });
    }

    // Update WAN Health bar
    function updateWanHealthBar(status) {
        // Primary WAN
        var primaryHealth = Math.round((status.primary_health || 0.95) * 100);
        $('#wan-primary-health').css('width', primaryHealth + '%');
        $('#wan-primary-interface').text(status.primary_interface || 'eth0');

        // Determine if primary is active (multiple checks for reliability)
        var primaryIsActive = (
            status.active_interface === status.primary_interface ||
            status.active_is_primary === true ||
            status.primary_status === 'ACTIVE'
        );

        // Primary status badge
        var primaryBadge = $('#wan-primary-status');
        if (primaryIsActive) {
            primaryBadge.removeClass('badge-secondary badge-danger').addClass('badge-success').text('ACTIVE');
        } else if (primaryHealth < 50 || status.primary_status === 'FAILED') {
            primaryBadge.removeClass('badge-secondary badge-success').addClass('badge-danger').text('FAILED');
        } else {
            primaryBadge.removeClass('badge-success badge-danger').addClass('badge-secondary').text('STANDBY');
        }

        // Backup WAN
        var backupHealth = Math.round((status.backup_health || 0.72) * 100);
        $('#wan-backup-health').css('width', backupHealth + '%');
        $('#wan-backup-interface').text(status.backup_interface || 'wwan0');

        // Determine if backup is active
        var backupIsActive = (
            status.active_interface === status.backup_interface ||
            (status.active_is_primary === false && status.active_interface) ||
            status.backup_status === 'ACTIVE'
        );

        // Backup status badge
        var backupBadge = $('#wan-backup-status');
        if (backupIsActive) {
            backupBadge.removeClass('badge-secondary badge-danger').addClass('badge-warning').text('ACTIVE');
        } else if (backupHealth < 30 || status.backup_status === 'FAILED') {
            backupBadge.removeClass('badge-secondary badge-warning').addClass('badge-danger').text('FAILED');
        } else {
            backupBadge.removeClass('badge-warning badge-danger').addClass('badge-secondary').text('STANDBY');
        }

        // LSTM Prediction
        if (status.prediction) {
            var confidence = Math.round((status.prediction.confidence || 0.87) * 100);
            var failureProb = status.prediction.failure_probability || 0.08;

            $('#lstm-confidence').text(confidence + '%');
            $('#lstm-confidence-ring').attr('stroke-dasharray', confidence + ', 100');

            // Status text
            if (failureProb > 0.5) {
                $('#lstm-status').html('<i class="fas fa-exclamation-triangle mr-1"></i>Risk').removeClass('text-success text-warning').addClass('text-danger');
                $('#lstm-confidence-ring').attr('stroke', '#e57373');
                $('#lstm-confidence').css('color', '#e57373');
            } else if (failureProb > 0.2) {
                $('#lstm-status').html('<i class="fas fa-exclamation-circle mr-1"></i>Warning').removeClass('text-success text-danger').addClass('text-warning');
                $('#lstm-confidence-ring').attr('stroke', '#ffb74d');
                $('#lstm-confidence').css('color', '#ffb74d');
            } else {
                $('#lstm-status').html('<i class="fas fa-check-circle mr-1"></i>Stable').removeClass('text-danger text-warning').addClass('text-success');
                $('#lstm-confidence-ring').attr('stroke', '#00ff88');
                $('#lstm-confidence').css('color', '#00ff88');
            }
        }

        // Uptime
        if (status.uptime_pct !== undefined) {
            $('#wan-uptime').text(status.uptime_pct.toFixed(1) + '%');
        }
    }

    // Load WAN Health on page load and every 15 seconds
    loadWanHealth();
    setInterval(loadWanHealth, 15000);
});

// Show WAN Health Modal
function showWanHealthModal() {
    // Load full SLA status
    $.get('/slaai/api/status')
        .done(function(data) {
            var status = data.status || {};

            // Build modal content
            var content = `
                <div class="row">
                    <!-- Primary WAN Card -->
                    <div class="col-md-6 mb-3">
                        <div class="card bg-dark h-100" style="border: 2px solid ${status.active_interface === status.primary_interface ? 'rgba(76,175,80,0.6)' : 'rgba(255,255,255,0.1)'};">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="fas fa-ethernet mr-2 text-info"></i>Primary WAN</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Interface</span>
                                    <code>${status.primary_interface || 'eth0'}</code>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Health</span>
                                    <span class="${Math.round((status.primary_health || 0) * 100) > 80 ? 'text-success' : 'text-warning'}">${Math.round((status.primary_health || 0) * 100)}%</span>
                                </div>
                                <div class="progress mb-3" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: ${Math.round((status.primary_health || 0) * 100)}%"></div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Status</span>
                                    <span class="badge ${status.active_interface === status.primary_interface ? 'badge-success' : 'badge-secondary'}">${status.active_interface === status.primary_interface ? 'ACTIVE' : 'STANDBY'}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup WAN Card -->
                    <div class="col-md-6 mb-3">
                        <div class="card bg-dark h-100" style="border: 2px solid ${status.active_interface === status.backup_interface ? 'rgba(255,152,0,0.6)' : 'rgba(255,255,255,0.1)'};">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="fas fa-signal mr-2 text-warning"></i>Backup WAN (LTE)</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Interface</span>
                                    <code>${status.backup_interface || 'wwan0'}</code>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Health</span>
                                    <span class="${Math.round((status.backup_health || 0) * 100) > 50 ? 'text-success' : 'text-warning'}">${Math.round((status.backup_health || 0) * 100)}%</span>
                                </div>
                                <div class="progress mb-3" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: ${Math.round((status.backup_health || 0) * 100)}%"></div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Status</span>
                                    <span class="badge ${status.active_interface === status.backup_interface ? 'badge-warning' : 'badge-secondary'}">${status.active_interface === status.backup_interface ? 'ACTIVE' : 'STANDBY'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SLA Metrics Row -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark text-center">
                            <div class="card-body py-3">
                                <h4 class="text-success mb-1">${(status.uptime_pct || 99.9).toFixed(2)}%</h4>
                                <small class="text-muted">Uptime (30d)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark text-center">
                            <div class="card-body py-3">
                                <h4 class="text-info mb-1">${(status.rto_actual_s || 2.3).toFixed(1)}s</h4>
                                <small class="text-muted">RTO Actual</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark text-center">
                            <div class="card-body py-3">
                                <h4 class="text-warning mb-1">${status.failover_count_24h || 0}</h4>
                                <small class="text-muted">Failovers (24h)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Tracking -->
                ${status.cost_status ? `
                <div class="card bg-dark mb-3">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0"><i class="fas fa-dollar-sign mr-2"></i>LTE Cost Tracking</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Daily Usage</small>
                                <div class="progress mt-1" style="height: 6px;">
                                    <div class="progress-bar bg-info" style="width: ${Math.min(100, (status.cost_status.daily_usage_mb / status.cost_status.daily_budget_mb) * 100)}%"></div>
                                </div>
                                <small>${status.cost_status.daily_usage_mb} / ${status.cost_status.daily_budget_mb} MB</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Monthly Usage</small>
                                <div class="progress mt-1" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: ${Math.min(100, (status.cost_status.monthly_usage_mb / status.cost_status.monthly_budget_mb) * 100)}%"></div>
                                </div>
                                <small>${(status.cost_status.monthly_usage_mb / 1024).toFixed(1)} / ${(status.cost_status.monthly_budget_mb / 1024).toFixed(0)} GB</small>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Failover History -->
                ${status.failover_history && status.failover_history.length > 0 ? `
                <div class="card bg-dark">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0"><i class="fas fa-history mr-2"></i>Recent Events</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-dark table-striped mb-0">
                            <thead><tr><th>Time</th><th>Type</th><th>From</th><th>To</th><th>Duration</th></tr></thead>
                            <tbody>
                                ${status.failover_history.slice(0, 5).map(e => `
                                    <tr>
                                        <td><small>${new Date(e.timestamp).toLocaleString()}</small></td>
                                        <td><span class="badge badge-${e.type === 'failover' ? 'danger' : 'success'}">${e.type}</span></td>
                                        <td><code>${e.from_interface}</code></td>
                                        <td><code>${e.to_interface}</code></td>
                                        <td>${e.duration_s}s</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;

            $('#wan-modal-body').html(content);
            $('#wan-health-modal').modal('show');
        })
        .fail(function() {
            $('#wan-modal-body').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle mr-2"></i>Could not load WAN Health data</div>');
            $('#wan-health-modal').modal('show');
        });
}
</script>

<!-- WAN Health Modal -->
<div class="modal fade" id="wan-health-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #0f2027 0%, #203a43 100%); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h5 class="modal-title"><i class="fas fa-heartbeat mr-2 text-info"></i>WAN Health Dashboard</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="wan-modal-body" style="background: #1a1a2e;">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Loading...</p>
                </div>
            </div>
            <div class="modal-footer" style="background: #1a1a2e; border-top: 1px solid rgba(255,255,255,0.1);">
                <a href="{{ url_for('slaai.index') }}" class="btn btn-outline-info">
                    <i class="fas fa-external-link-alt mr-1"></i>Full Dashboard
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
