{% extends "base.html" %}

{% block title %}SDN Management - Network Control{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"><i class="fas fa-network-wired mr-2"></i>SDN Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">SDN Management</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <!-- Demo Mode Alert -->
        {% if not db_available %}
        <div class="alert alert-warning alert-dismissible">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Demo Mode:</strong> Database not connected. Showing sample data.
        </div>
        {% endif %}

        <!-- WiFi Intelligence Hero Section -->
        <div class="row" id="wifi-intelligence-hero">
            <div class="col-12">
                <div class="card card-widget widget-user-2" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border: none; border-radius: 15px; overflow: hidden;">
                    <div class="card-header border-0" style="background: transparent;">
                        <div class="row align-items-center">
                            <!-- Left: WiFi Status -->
                            <div class="col-lg-3 col-md-6 text-center text-lg-left mb-3 mb-lg-0">
                                <div class="d-flex align-items-center justify-content-center justify-content-lg-start">
                                    <div class="wifi-icon-container mr-3" style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-broadcast-tower fa-3x" id="wifi-icon" style="color: #00d9ff; text-shadow: 0 0 20px rgba(0,217,255,0.5);"></i>
                                    </div>
                                    <div>
                                        <h2 class="mb-0" style="color: #fff; font-weight: 700;">
                                            <span id="wifi-channel">--</span>
                                            <small class="text-muted" id="wifi-band" style="font-size: 0.6em; color: #aaa !important;">--</small>
                                        </h2>
                                        <p class="mb-0" style="color: #888; font-size: 0.85em;">
                                            <i class="fas fa-wifi mr-1"></i>
                                            <span id="wifi-ssid">Loading...</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Center: ML Score Gauge -->
                            <div class="col-lg-3 col-md-6 text-center mb-3 mb-lg-0">
                                <div class="ml-score-container">
                                    <div class="score-ring" style="width: 90px; height: 90px; margin: 0 auto; position: relative;">
                                        <svg viewBox="0 0 36 36" class="circular-chart" style="width: 100%; height: 100%;">
                                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                  fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                            <path class="circle" id="ml-score-ring"
                                                  stroke-dasharray="0, 100"
                                                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                  fill="none" stroke="#00ff88" stroke-width="3" stroke-linecap="round"
                                                  style="transition: stroke-dasharray 1s ease-in-out;"/>
                                        </svg>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                            <span id="ml-score-value" style="color: #00ff88; font-size: 1.4em; font-weight: 700;">--</span>
                                        </div>
                                    </div>
                                    <p class="mb-0 mt-1" style="color: #888; font-size: 0.75em;">
                                        <i class="fas fa-brain mr-1" style="color: #00ff88;"></i>ML CHANNEL SCORE
                                    </p>
                                </div>
                            </div>

                            <!-- Center-Right: Statistics -->
                            <div class="col-lg-3 col-md-6 text-center mb-3 mb-lg-0">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-box p-2" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                                            <i class="fas fa-satellite-dish mb-1" style="color: #ff6b6b; font-size: 1.5em;"></i>
                                            <h4 class="mb-0" style="color: #fff; font-weight: 600;">
                                                <span id="radar-count">0</span>
                                            </h4>
                                            <small style="color: #888; font-size: 0.7em;">RADAR EVENTS</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-box p-2" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                                            <i class="fas fa-exchange-alt mb-1" style="color: #ffd93d; font-size: 1.5em;"></i>
                                            <h4 class="mb-0" style="color: #fff; font-weight: 600;">
                                                <span id="channel-switches">0</span>
                                            </h4>
                                            <small style="color: #888; font-size: 0.7em;">CH SWITCHES</small>
                                        </div>
                                    </div>
                                </div>
                                <p class="mb-0 mt-2" style="color: #666; font-size: 0.7em;">
                                    <i class="far fa-calendar-alt mr-1"></i>Last 30 days
                                </p>
                            </div>

                            <!-- Right: Next Optimization Countdown -->
                            <div class="col-lg-3 col-md-6 text-center text-lg-right">
                                <div class="next-opt-container">
                                    <p class="mb-1" style="color: #888; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px;">
                                        <i class="fas fa-clock mr-1"></i>Next Auto-Optimization
                                    </p>
                                    <h3 class="mb-0" id="countdown-timer" style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600; letter-spacing: 2px;">
                                        --:--:--
                                    </h3>
                                    <p class="mb-0 mt-1" style="color: #666; font-size: 0.7em;">
                                        <span id="last-opt-info">
                                            <i class="fas fa-history mr-1"></i>Last: <span id="last-opt-time">Never</span>
                                            <span id="prev-channel-info" style="display: none;"> (was CH <span id="prev-channel">--</span>)</span>
                                        </span>
                                    </p>
                                    <div class="mt-2">
                                        <span id="dfs-badge" class="badge" style="background: rgba(0,217,255,0.2); color: #00d9ff; font-size: 0.7em; display: none;">
                                            <i class="fas fa-bolt mr-1"></i>DFS INTELLIGENCE ACTIVE
                                        </span>
                                        <span id="basic-badge" class="badge" style="background: rgba(255,255,255,0.1); color: #888; font-size: 0.7em;">
                                            <i class="fas fa-search mr-1"></i>BASIC SCAN MODE
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress bar for countdown -->
                    <div class="progress" style="height: 4px; background: rgba(255,255,255,0.05); border-radius: 0;">
                        <div class="progress-bar" id="countdown-progress" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #00d9ff, #00ff88); transition: width 1s linear;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row">
            <!-- Total Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ stats.total_devices }}</h3>
                        <p>Total Devices</p>
                    </div>
                    <div class="icon"><i class="fas fa-laptop"></i></div>
                </div>
            </div>

            <!-- Online Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ stats.online_devices }}</h3>
                        <p>Online</p>
                    </div>
                    <div class="icon"><i class="fas fa-wifi"></i></div>
                </div>
            </div>

            <!-- Offline Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ stats.offline_devices }}</h3>
                        <p>Offline</p>
                    </div>
                    <div class="icon"><i class="fas fa-power-off"></i></div>
                </div>
            </div>

            <!-- Blocked Devices -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ stats.blocked_devices }}</h3>
                        <p>Blocked</p>
                    </div>
                    <div class="icon"><i class="fas fa-ban"></i></div>
                </div>
            </div>
        </div>

        <!-- Filters and Actions Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-filter mr-2"></i>Filters & Actions</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Policy Filter -->
                            <div class="col-md-3">
                                <label>Filter by Policy</label>
                                <select id="filter-policy" class="form-control">
                                    <option value="">All Policies</option>
                                    {% for policy in policies %}
                                    <option value="{{ policy.name }}">{{ policy.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Category Filter -->
                            <div class="col-md-3">
                                <label>Filter by Category</label>
                                <select id="filter-category" class="form-control">
                                    <option value="">All Categories</option>
                                    <option value="iot">IoT Devices</option>
                                    <option value="camera">Cameras</option>
                                    <option value="pos">POS Terminals</option>
                                    <option value="printer">Printers</option>
                                    <option value="workstation">Workstations</option>
                                    <option value="voice_assistant">Voice Assistants</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div class="col-md-2">
                                <label>Status</label>
                                <select id="filter-status" class="form-control">
                                    <option value="">All</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>

                            <!-- Actions -->
                            <div class="col-md-4">
                                <label>&nbsp;</label>
                                <div class="btn-group d-block">
                                    <button type="button" id="btn-discover" class="btn btn-primary">
                                        <i class="fas fa-search mr-1"></i> Discover
                                    </button>
                                    <button type="button" id="btn-refresh" class="btn btn-default">
                                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                                    </button>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                            <i class="fas fa-download mr-1"></i> Export
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="{{ url_for('sdn.export_devices', format='csv') }}">
                                                <i class="fas fa-file-csv mr-2"></i> CSV
                                            </a>
                                            <a class="dropdown-item" href="{{ url_for('sdn.export_devices', format='json') }}">
                                                <i class="fas fa-file-code mr-2"></i> JSON
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions (shown when devices selected) -->
                        <div class="row mt-3" id="bulk-actions" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <strong><span id="selected-count">0</span> devices selected</strong>
                                    <div class="btn-group float-right">
                                        <button type="button" class="btn btn-sm btn-primary" id="bulk-auto-classify">
                                            <i class="fas fa-magic mr-1"></i> Auto-Classify
                                        </button>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-toggle="dropdown">
                                                <i class="fas fa-exchange-alt mr-1"></i> Set Policy
                                            </button>
                                            <div class="dropdown-menu">
                                                {% for policy in policies %}
                                                <a class="dropdown-item bulk-policy" data-policy="{{ policy.name }}">
                                                    <i class="fas {{ policy.icon }} mr-2 text-{{ policy.color }}"></i>
                                                    {{ policy.display_name }}
                                                </a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-danger" id="bulk-block">
                                            <i class="fas fa-ban mr-1"></i> Block All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-list mr-2"></i>Network Devices</h3>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table id="devices-table" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="select-all">
                                            <label class="custom-control-label" for="select-all"></label>
                                        </div>
                                    </th>
                                    <th>Status</th>
                                    <th>Hostname</th>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Vendor</th>
                                    <th>Category</th>
                                    <th>Policy</th>
                                    <th>Access</th>
                                    <th>Last Seen</th>
                                    <th style="width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr data-mac="{{ device.mac_address }}"
                                    data-policy="{{ device.network_policy }}"
                                    data-category="{{ device.oui_category }}"
                                    data-online="{{ 'true' if device.is_online else 'false' }}"
                                    data-blocked="{{ 'true' if device.is_blocked else 'false' }}">
                                    <td>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input device-select"
                                                   id="select-{{ device.mac_address | replace(':', '') }}"
                                                   value="{{ device.mac_address }}">
                                            <label class="custom-control-label"
                                                   for="select-{{ device.mac_address | replace(':', '') }}"></label>
                                        </div>
                                    </td>
                                    <td>
                                        {% if device.is_blocked %}
                                        <span class="badge badge-danger"><i class="fas fa-ban"></i> Blocked</span>
                                        {% elif device.is_online %}
                                        <span class="badge badge-success"><i class="fas fa-circle"></i> Online</span>
                                        {% else %}
                                        <span class="badge badge-secondary"><i class="far fa-circle"></i> Offline</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('sdn.device_detail', mac_address=device.mac_address) }}">
                                            <strong>{{ device.hostname or 'Unknown' }}</strong>
                                        </a>
                                    </td>
                                    <td><code>{{ device.ip_address or 'N/A' }}</code></td>
                                    <td><code>{{ device.mac_address }}</code></td>
                                    <td>{{ device.manufacturer or 'Unknown' }}</td>
                                    <td>
                                        {% set category_icons = {
                                            'iot': 'fa-microchip',
                                            'camera': 'fa-video',
                                            'pos': 'fa-cash-register',
                                            'printer': 'fa-print',
                                            'workstation': 'fa-desktop',
                                            'voice_assistant': 'fa-volume-up',
                                            'mobile': 'fa-mobile-alt',
                                            'network': 'fa-network-wired',
                                            'unknown': 'fa-question'
                                        } %}
                                        <i class="fas {{ category_icons.get(device.oui_category, 'fa-question') }} mr-1"></i>
                                        {{ device.oui_category | capitalize }}
                                    </td>
                                    <td>
                                        {% set policy_colors = {
                                            'full_access': 'success',
                                            'lan_only': 'info',
                                            'internet_only': 'primary',
                                            'isolated': 'danger',
                                            'default': 'secondary'
                                        } %}
                                        <span class="badge badge-{{ policy_colors.get(device.network_policy, 'secondary') }}">
                                            {{ device.network_policy | replace('_', ' ') | title }}
                                        </span>
                                        {% if device.network_policy != device.auto_policy %}
                                        <i class="fas fa-user-edit text-warning ml-1" title="Manual override (OUI: {{ device.auto_policy }})"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.internet_access %}
                                        <span class="badge badge-light" title="Internet Access"><i class="fas fa-globe text-success"></i></span>
                                        {% else %}
                                        <span class="badge badge-light" title="No Internet"><i class="fas fa-globe text-muted"></i></span>
                                        {% endif %}
                                        {% if device.lan_access %}
                                        <span class="badge badge-light" title="LAN Access"><i class="fas fa-network-wired text-success"></i></span>
                                        {% else %}
                                        <span class="badge badge-light" title="No LAN"><i class="fas fa-network-wired text-muted"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ device.last_seen }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('sdn.device_detail', mac_address=device.mac_address) }}"
                                               class="btn btn-default" title="Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-default dropdown-toggle dropdown-toggle-split"
                                                    data-toggle="dropdown">
                                                <span class="sr-only">Actions</span>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item btn-auto-classify" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-magic mr-2"></i> Auto-Classify
                                                </a>
                                                <div class="dropdown-divider"></div>
                                                <h6 class="dropdown-header">Set Policy</h6>
                                                {% for policy in policies %}
                                                <a class="dropdown-item btn-set-policy" href="#"
                                                   data-mac="{{ device.mac_address }}"
                                                   data-policy="{{ policy.name }}">
                                                    <i class="fas {{ policy.icon }} mr-2 text-{{ policy.color }}"></i>
                                                    {{ policy.display_name }}
                                                </a>
                                                {% endfor %}
                                                <div class="dropdown-divider"></div>
                                                {% if device.is_blocked %}
                                                <a class="dropdown-item text-success btn-unblock" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-check mr-2"></i> Unblock
                                                </a>
                                                {% else %}
                                                <a class="dropdown-item btn-disconnect" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-plug mr-2"></i> Disconnect
                                                </a>
                                                <a class="dropdown-item text-danger btn-block" href="#"
                                                   data-mac="{{ device.mac_address }}">
                                                    <i class="fas fa-ban mr-2"></i> Block
                                                </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Legend -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-secondary collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Policy Reference</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for policy in policies %}
                            <div class="col-md-4 col-lg-2">
                                <div class="info-box bg-{{ policy.color }}">
                                    <span class="info-box-icon"><i class="fas {{ policy.icon }}"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">{{ policy.display_name }}</span>
                                        <span class="info-box-number">
                                            {{ stats.policy_counts.get(policy.name, 0) }} devices
                                        </span>
                                        <small>{{ policy.description }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Block Device Modal -->
<div class="modal fade" id="modal-block" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title"><i class="fas fa-ban mr-2"></i>Block Device</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form id="form-block" method="POST">
                <div class="modal-body">
                    <p>Block device <strong id="block-mac"></strong>?</p>
                    <p class="text-muted">This device will be completely isolated from the network.</p>
                    <div class="form-group">
                        <label>Reason (optional)</label>
                        <input type="text" name="reason" class="form-control" placeholder="Security concern, unauthorized, etc.">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Block Device</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// WiFi Intelligence - Global state
var wifiIntelligence = {
    countdownSeconds: 0,
    totalSeconds: 86400, // 24 hours
    updateInterval: null,
    countdownInterval: null
};

// Load WiFi intelligence data
function loadWifiIntelligence() {
    $.get('{{ url_for("sdn.api_wifi_intelligence") }}')
        .done(function(response) {
            if (response.success) {
                updateWifiDisplay(response.wifi_intelligence);
            }
        })
        .fail(function() {
            // Use demo data on failure
            updateWifiDisplay({
                current_channel: 36,
                band: '5GHz',
                ssid: 'Fortress-WiFi',
                ml_score: 0.87,
                radar_count_30d: 2,
                channel_switches_30d: 3,
                time_to_next_seconds: 28800,
                last_optimization: '2025-12-17T04:00:00',
                previous_channel: 44,
                dfs_available: true,
                optimization_method: 'dfs_intelligence'
            });
        });
}

function updateWifiDisplay(data) {
    // Update channel and band
    if (data.current_channel) {
        $('#wifi-channel').text('CH ' + data.current_channel);
        $('#wifi-band').text(data.band || '');
    }

    // Update SSID
    if (data.ssid) {
        $('#wifi-ssid').text(data.ssid);
    } else {
        $('#wifi-ssid').text('Fortress Network');
    }

    // Update ML Score
    if (data.ml_score !== null && data.ml_score !== undefined) {
        var score = parseFloat(data.ml_score);
        var scorePercent = Math.round(score * 100);
        $('#ml-score-value').text(scorePercent + '%');
        $('#ml-score-ring').attr('stroke-dasharray', scorePercent + ', 100');

        // Color based on score
        var color = score >= 0.8 ? '#00ff88' : (score >= 0.6 ? '#ffd93d' : '#ff6b6b');
        $('#ml-score-ring').attr('stroke', color);
        $('#ml-score-value').css('color', color);
    } else {
        $('#ml-score-value').text('N/A');
        $('#ml-score-ring').attr('stroke-dasharray', '0, 100');
    }

    // Update statistics
    $('#radar-count').text(data.radar_count_30d || 0);
    $('#channel-switches').text(data.channel_switches_30d || 0);

    // Update last optimization
    if (data.last_optimization) {
        var lastOpt = new Date(data.last_optimization);
        var now = new Date();
        var diffHours = Math.round((now - lastOpt) / (1000 * 60 * 60));
        if (diffHours < 24) {
            $('#last-opt-time').text(diffHours + 'h ago');
        } else {
            $('#last-opt-time').text(Math.round(diffHours / 24) + 'd ago');
        }

        // Show previous channel if available
        if (data.previous_channel && data.previous_channel !== data.current_channel) {
            $('#prev-channel').text(data.previous_channel);
            $('#prev-channel-info').show();
        } else {
            $('#prev-channel-info').hide();
        }
    }

    // Update DFS badge
    if (data.dfs_available && data.band === '5GHz') {
        $('#dfs-badge').show();
        $('#basic-badge').hide();
        // Make icon more vibrant for DFS mode
        $('#wifi-icon').css('color', '#00ff88').css('text-shadow', '0 0 30px rgba(0,255,136,0.7)');
    } else {
        $('#dfs-badge').hide();
        $('#basic-badge').show();
    }

    // Setup countdown
    if (data.time_to_next_seconds) {
        wifiIntelligence.countdownSeconds = data.time_to_next_seconds;
        wifiIntelligence.totalSeconds = 86400; // 24 hours
        startCountdown();
    }
}

function startCountdown() {
    // Clear existing interval
    if (wifiIntelligence.countdownInterval) {
        clearInterval(wifiIntelligence.countdownInterval);
    }

    updateCountdownDisplay();

    wifiIntelligence.countdownInterval = setInterval(function() {
        wifiIntelligence.countdownSeconds--;
        if (wifiIntelligence.countdownSeconds < 0) {
            wifiIntelligence.countdownSeconds = 86400;
        }
        updateCountdownDisplay();
    }, 1000);
}

function updateCountdownDisplay() {
    var seconds = wifiIntelligence.countdownSeconds;
    var hours = Math.floor(seconds / 3600);
    var minutes = Math.floor((seconds % 3600) / 60);
    var secs = seconds % 60;

    var display = String(hours).padStart(2, '0') + ':' +
                  String(minutes).padStart(2, '0') + ':' +
                  String(secs).padStart(2, '0');
    $('#countdown-timer').text(display);

    // Update progress bar (inverse - fills as we get closer)
    var elapsed = wifiIntelligence.totalSeconds - seconds;
    var progress = (elapsed / wifiIntelligence.totalSeconds) * 100;
    $('#countdown-progress').css('width', progress + '%');
}

// Pulse animation for WiFi icon
function pulseWifiIcon() {
    $('#wifi-icon').animate({
        opacity: 0.6
    }, 1000).animate({
        opacity: 1
    }, 1000);
}

$(document).ready(function() {
    // Load WiFi intelligence data
    loadWifiIntelligence();

    // Refresh WiFi data every 60 seconds
    wifiIntelligence.updateInterval = setInterval(loadWifiIntelligence, 60000);

    // Pulse animation every 3 seconds
    setInterval(pulseWifiIcon, 3000);

    // Initialize DataTable
    var table = $('#devices-table').DataTable({
        "paging": true,
        "pageLength": 25,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "order": [[2, 'asc']],
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "columnDefs": [
            { "orderable": false, "targets": [0, 10] }
        ]
    });

    // Filter by policy
    $('#filter-policy').on('change', function() {
        var policy = $(this).val();
        table.column(7).search(policy).draw();
    });

    // Filter by category
    $('#filter-category').on('change', function() {
        var category = $(this).val();
        table.column(6).search(category).draw();
    });

    // Filter by status
    $('#filter-status').on('change', function() {
        var status = $(this).val();
        if (status === 'online') {
            table.column(1).search('Online').draw();
        } else if (status === 'offline') {
            table.column(1).search('Offline').draw();
        } else if (status === 'blocked') {
            table.column(1).search('Blocked').draw();
        } else {
            table.column(1).search('').draw();
        }
    });

    // Select all checkbox
    $('#select-all').on('change', function() {
        $('.device-select').prop('checked', this.checked);
        updateBulkActions();
    });

    // Individual checkbox
    $(document).on('change', '.device-select', function() {
        updateBulkActions();
    });

    function updateBulkActions() {
        var count = $('.device-select:checked').length;
        $('#selected-count').text(count);
        if (count > 0) {
            $('#bulk-actions').slideDown();
        } else {
            $('#bulk-actions').slideUp();
        }
    }

    function getSelectedMacs() {
        return $('.device-select:checked').map(function() {
            return $(this).val();
        }).get();
    }

    // Refresh button
    $('#btn-refresh').on('click', function() {
        location.reload();
    });

    // Discover button
    $('#btn-discover').on('click', function() {
        var btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Scanning...');

        $.post('{{ url_for("sdn.discover_devices") }}')
            .done(function(data) {
                if (data.success) {
                    toastr.success('Found ' + data.total + ' devices (' + data.new + ' new)');
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    toastr.error(data.error || 'Discovery failed');
                }
            })
            .fail(function() {
                toastr.error('Discovery request failed');
            })
            .always(function() {
                btn.prop('disabled', false).html('<i class="fas fa-search mr-1"></i> Discover');
            });
    });

    // Set policy (single device)
    $(document).on('click', '.btn-set-policy', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');
        var policy = $(this).data('policy');

        $.post('{{ url_for("sdn.set_policy", mac_address="MAC") }}'.replace('MAC', mac), {
            policy: policy,
            source: 'dropdown'
        }, function(data) {
            if (data.success) {
                toastr.success(data.message);
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                toastr.error(data.error || 'Failed to set policy');
            }
        }).fail(function() {
            // Fallback to form submit
            var form = $('<form method="POST" action="{{ url_for("sdn.set_policy", mac_address="MAC") }}">'.replace('MAC', mac));
            form.append($('<input type="hidden" name="policy">').val(policy));
            $('body').append(form);
            form.submit();
        });
    });

    // Auto-classify (single device)
    $(document).on('click', '.btn-auto-classify', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        $.post('{{ url_for("sdn.auto_classify", mac_address="MAC") }}'.replace('MAC', mac))
            .done(function(data) {
                if (data.success) {
                    toastr.success('Classified as ' + data.classification.category + ', policy: ' + data.policy_applied);
                    setTimeout(function() { location.reload(); }, 1000);
                } else {
                    toastr.error(data.error || 'Classification failed');
                }
            })
            .fail(function() {
                toastr.error('Request failed');
            });
    });

    // Disconnect device
    $(document).on('click', '.btn-disconnect', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        if (confirm('Disconnect device ' + mac + '?')) {
            $.post('{{ url_for("sdn.disconnect_device", mac_address="MAC") }}'.replace('MAC', mac))
                .done(function(data) {
                    if (data.success) {
                        toastr.success('Device disconnected');
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        toastr.error(data.error || 'Failed to disconnect');
                    }
                })
                .fail(function() {
                    toastr.error('Request failed');
                });
        }
    });

    // Block device - show modal
    $(document).on('click', '.btn-block', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');
        $('#block-mac').text(mac);
        $('#form-block').attr('action', '{{ url_for("sdn.block_device", mac_address="MAC") }}'.replace('MAC', mac));
        $('#modal-block').modal('show');
    });

    // Unblock device
    $(document).on('click', '.btn-unblock', function(e) {
        e.preventDefault();
        var mac = $(this).data('mac');

        if (confirm('Unblock device ' + mac + '?')) {
            $.post('{{ url_for("sdn.unblock_device", mac_address="MAC") }}'.replace('MAC', mac))
                .done(function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        toastr.error(data.error || 'Failed to unblock');
                    }
                })
                .fail(function() {
                    toastr.error('Request failed');
                });
        }
    });

    // Bulk auto-classify
    $('#bulk-auto-classify').on('click', function() {
        var macs = getSelectedMacs();
        if (macs.length === 0) return;

        if (confirm('Auto-classify ' + macs.length + ' devices based on OUI?')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_auto_classify") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs }),
                success: function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        toastr.warning(data.message);
                    }
                },
                error: function() {
                    toastr.error('Bulk classification failed');
                }
            });
        }
    });

    // Bulk set policy
    $(document).on('click', '.bulk-policy', function(e) {
        e.preventDefault();
        var policy = $(this).data('policy');
        var macs = getSelectedMacs();

        if (macs.length === 0) return;

        if (confirm('Set policy "' + policy + '" for ' + macs.length + ' devices?')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_set_policy") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs, policy: policy }),
                success: function(data) {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        toastr.warning(data.message);
                    }
                },
                error: function() {
                    toastr.error('Bulk policy update failed');
                }
            });
        }
    });

    // Bulk block
    $('#bulk-block').on('click', function() {
        var macs = getSelectedMacs();
        if (macs.length === 0) return;

        if (confirm('Block ' + macs.length + ' devices? They will be isolated from the network.')) {
            $.ajax({
                url: '{{ url_for("sdn.bulk_set_policy") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mac_addresses: macs, policy: 'isolated' }),
                success: function(data) {
                    toastr.success(data.message);
                    setTimeout(function() { location.reload(); }, 1500);
                },
                error: function() {
                    toastr.error('Bulk block failed');
                }
            });
        }
    });
});
</script>
{% endblock %}
