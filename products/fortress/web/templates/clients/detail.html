{% extends "base.html" %}
{% block title %}{{ device.hostname or device.mac_address }} - HookProbe Fortress{% endblock %}
{% block page_title %}Device Details{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('clients.index') }}">Clients</a></li>
<li class="breadcrumb-item active">{{ device.hostname or device.mac_address }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Device Info Card -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-{{ 'laptop' if device.device_type == 'laptop' else 'mobile-alt' if device.device_type == 'phone' else 'cash-register' if device.device_type == 'pos' else 'video' if device.device_type == 'camera' else 'microchip' }} mr-2"></i>
                    Device Information
                </h3>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 40%">Hostname</th>
                        <td>{{ device.hostname or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <th>MAC Address</th>
                        <td><code>{{ device.mac_address }}</code></td>
                    </tr>
                    <tr>
                        <th>IP Address</th>
                        <td>{{ device.ip_address }}</td>
                    </tr>
                    <tr>
                        <th>Device Type</th>
                        <td>{{ device.device_type|capitalize }}</td>
                    </tr>
                    <tr>
                        <th>Manufacturer</th>
                        <td>{{ device.manufacturer or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>
                            {% if device.is_blocked %}
                            <span class="badge badge-danger"><i class="fas fa-ban"></i> Blocked</span>
                            {% else %}
                            <span class="badge badge-success"><i class="fas fa-check"></i> Active</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>First Seen</th>
                        <td>{{ device.first_seen }}</td>
                    </tr>
                    <tr>
                        <th>Last Seen</th>
                        <td>{{ device.last_seen }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- VLAN Assignment Card -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-project-diagram mr-2"></i>Network Assignment</h3>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h5>Current VLAN</h5>
                    {% set vlan_names = {'10': 'Management', '20': 'POS', '30': 'Staff', '40': 'Guest', '99': 'IoT'} %}
                    <span class="badge badge-lg badge-{% if device.vlan_id == 10 %}primary{% elif device.vlan_id == 20 %}success{% elif device.vlan_id == 30 %}info{% elif device.vlan_id == 40 %}secondary{% else %}warning{% endif %}" style="font-size: 1.2em; padding: 10px 20px;">
                        VLAN {{ device.vlan_id }} - {{ vlan_names.get(device.vlan_id|string, 'Custom') }}
                    </span>
                </div>

                <hr>

                <h5>Reassign to VLAN</h5>
                <form action="{{ url_for('clients.assign_vlan', mac_address=device.mac_address) }}" method="post">
                    <div class="form-group">
                        <select name="vlan_id" class="form-control">
                            {% for vlan in vlans %}
                            <option value="{{ vlan.vlan_id }}" {% if vlan.vlan_id == device.vlan_id %}selected{% endif %}>
                                VLAN {{ vlan.vlan_id }} - {{ vlan.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if not db_available %}disabled{% endif %}>
                        <i class="fas fa-exchange-alt"></i> Assign VLAN
                    </button>
                </form>
            </div>
        </div>

        <!-- Actions Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-cogs mr-2"></i>Actions</h3>
            </div>
            <div class="card-body">
                {% if device.is_blocked %}
                <form action="{{ url_for('clients.unblock', mac_address=device.mac_address) }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-success btn-lg" {% if not db_available %}disabled{% endif %}>
                        <i class="fas fa-unlock"></i> Unblock Device
                    </button>
                </form>
                {% else %}
                <button type="button" class="btn btn-danger btn-lg" data-toggle="modal" data-target="#blockModal" {% if not db_available %}disabled{% endif %}>
                    <i class="fas fa-ban"></i> Block Device
                </button>
                {% endif %}

                <a href="{{ url_for('clients.index') }}" class="btn btn-secondary btn-lg ml-2">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- VLAN Description Cards -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>VLAN Descriptions</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-box bg-primary">
                            <span class="info-box-icon"><i class="fas fa-shield-alt"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Management (10)</span>
                                <span class="info-box-number">Admin devices, full access</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box bg-success">
                            <span class="info-box-icon"><i class="fas fa-cash-register"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">POS (20)</span>
                                <span class="info-box-number">Payment terminals, isolated</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box bg-info">
                            <span class="info-box-icon"><i class="fas fa-users"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Staff (30)</span>
                                <span class="info-box-number">Employee devices</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-box bg-secondary">
                            <span class="info-box-icon"><i class="fas fa-wifi"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Guest (40)</span>
                                <span class="info-box-number">Customer WiFi, limited</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box bg-warning">
                            <span class="info-box-icon"><i class="fas fa-microchip"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">IoT (99)</span>
                                <span class="info-box-number">Cameras, sensors, isolated</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Block Device Modal -->
<div class="modal fade" id="blockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title"><i class="fas fa-ban"></i> Block Device</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form action="{{ url_for('clients.block', mac_address=device.mac_address) }}" method="post">
                <div class="modal-body">
                    <p>Are you sure you want to block <strong>{{ device.hostname or device.mac_address }}</strong>?</p>
                    <p class="text-muted">This will prevent the device from accessing the network.</p>
                    <div class="form-group">
                        <label for="block-reason">Reason</label>
                        <select name="reason" id="block-reason" class="form-control">
                            <option value="manual_block">Manual Block</option>
                            <option value="security_threat">Security Threat</option>
                            <option value="policy_violation">Policy Violation</option>
                            <option value="unauthorized">Unauthorized Device</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Block Device</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if not db_available %}
<div class="alert alert-warning mt-3">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Demo Mode:</strong> Database is not connected. Changes will not be saved.
</div>
{% endif %}
{% endblock %}
