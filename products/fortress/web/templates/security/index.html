{% extends "base.html" %}
{% block title %}AI Security - HookProbe Fortress{% endblock %}
{% block page_title %}AI Security{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">AI Security</li>{% endblock %}

{% block extra_css %}
<style>
    /* Equal height cards */
    .ai-security-row {
        display: flex;
        flex-wrap: wrap;
    }
    .ai-security-row > [class*='col-'] {
        display: flex;
        flex-direction: column;
    }
    .ai-security-card {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .ai-security-card .card-body {
        flex: 1;
    }

    /* QSecBit gauge */
    .qsecbit-gauge {
        width: 160px;
        height: 160px;
        margin: 0 auto;
        position: relative;
    }
    .qsecbit-score {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        font-weight: bold;
    }
    .rag-GREEN { color: #28a745; }
    .rag-AMBER { color: #ffc107; }
    .rag-RED { color: #dc3545; }

    /* DNS Protection status */
    .dns-status-icon {
        font-size: 4rem;
    }
    .dns-status-icon.active { color: #28a745; }
    .dns-status-icon.paused { color: #ffc107; }
    .dns-status-icon.disabled { color: #dc3545; }

    /* Threat severity borders */
    .threat-severity-HIGH { border-left: 3px solid #dc3545; }
    .threat-severity-MEDIUM { border-left: 3px solid #ffc107; }
    .threat-severity-LOW { border-left: 3px solid #17a2b8; }

    /* Component list */
    .component-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .component-item:last-child {
        border-bottom: none;
    }

    /* Stats display */
    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #adb5bd;
        text-transform: uppercase;
    }

    /* Unified Protection Level Slider */
    .protection-slider-container {
        position: relative;
        padding: 8px 0;
    }
    .protection-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 12px;
        border-radius: 6px;
        background: linear-gradient(to right,
            #6c757d 0%,
            #17a2b8 20%,
            #28a745 40%,
            #ffc107 60%,
            #fd7e14 80%,
            #dc3545 100%
        );
        outline: none;
        cursor: pointer;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
    }
    /* Webkit (Chrome, Safari, Edge) */
    .protection-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #212529;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.2);
        cursor: grab;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .protection-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 12px rgba(0,0,0,0.5), 0 0 0 3px rgba(255,255,255,0.3);
    }
    .protection-slider::-webkit-slider-thumb:active {
        cursor: grabbing;
        transform: scale(1.15);
        box-shadow: 0 4px 16px rgba(0,0,0,0.6), 0 0 0 4px rgba(255,255,255,0.4);
    }
    /* Firefox */
    .protection-slider::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #212529;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.2);
        cursor: grab;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .protection-slider::-moz-range-thumb:hover {
        transform: scale(1.1);
    }
    .protection-slider::-moz-range-thumb:active {
        cursor: grabbing;
        transform: scale(1.15);
    }
    .protection-slider::-moz-range-track {
        height: 12px;
        border-radius: 6px;
        background: transparent;
    }
    /* Level labels */
    .protection-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 0.7rem;
        font-weight: 600;
        color: #6c757d;
    }
    .protection-labels span {
        flex: 1;
        text-align: center;
        transition: color 0.2s ease, transform 0.2s ease;
    }
    .protection-labels span.active {
        color: #fff;
        transform: scale(1.1);
    }

    /* Modal improvements */
    .modal-dark .modal-content {
        background-color: #343a40;
        color: #fff;
    }
    .modal-dark .modal-header {
        border-bottom-color: #495057;
    }
    .modal-dark .modal-footer {
        border-top-color: #495057;
    }
    .modal-dark .close {
        color: #fff;
    }
    .modal-dark .nav-tabs .nav-link {
        color: #adb5bd;
    }
    .modal-dark .nav-tabs .nav-link.active {
        background-color: #495057;
        color: #fff;
        border-color: #495057;
    }
    .modal-dark .table {
        color: #fff;
    }
    .modal-dark .form-control {
        background-color: #495057;
        border-color: #6c757d;
        color: #fff;
    }

    /* Pause buttons */
    .pause-btn {
        border-color: #6c757d;
        color: #6c757d;
    }
    .pause-btn:hover {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #212529;
    }

    /* Scrollable threat list */
    .threats-scroll {
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Main Two-Card Layout -->
<div class="row ai-security-row">
    <!-- LEFT CARD: DNS Protection -->
    <div class="col-lg-6 mb-4">
        <div class="card ai-security-card card-outline card-success">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-shield-alt mr-2"></i>DNS Protection</h3>
                <div class="card-tools">
                    <button class="btn btn-sm btn-outline-light" onclick="showDnsSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Protection Status -->
                <div class="text-center mb-4">
                    <div id="dns-status-icon" class="dns-status-icon active mb-2">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h4 id="dns-status-text" class="text-success mb-0">Active</h4>
                    <p class="text-muted mb-2" id="pause-timer" style="display: none;">
                        Resuming in: <span id="pause-countdown">--:--</span>
                    </p>
                    <div class="btn-group mt-2" role="group">
                        <button class="btn btn-sm btn-outline-secondary pause-btn" onclick="pauseProtection(5)">5m</button>
                        <button class="btn btn-sm btn-outline-secondary pause-btn" onclick="pauseProtection(15)">15m</button>
                        <button class="btn btn-sm btn-outline-secondary pause-btn" onclick="pauseProtection(30)">30m</button>
                        <button class="btn btn-sm btn-danger" id="killswitch-btn" onclick="toggleProtection()">OFF</button>
                    </div>
                </div>

                <!-- Statistics Row -->
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="stat-value text-success" id="stat-allowed">0</div>
                        <div class="stat-label">Allowed</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-value text-danger" id="stat-blocked">0</div>
                        <div class="stat-label">Blocked</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-value text-info" id="stat-rate">0%</div>
                        <div class="stat-label">Block Rate</div>
                    </div>
                </div>

                <!-- Protection Level - Unified Slider -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted small text-uppercase font-weight-bold">Protection Level</span>
                        <span id="level-name" class="badge badge-success px-3 py-2" style="font-size: 0.85rem;">Strong</span>
                    </div>
                    <div class="protection-slider-container">
                        <input type="range" class="protection-slider" min="0" max="5" value="3" id="protection-level"
                               oninput="updateLevelDisplay(this.value)" onchange="setProtectionLevel(this.value)">
                    </div>
                    <div class="protection-labels" id="protection-labels">
                        <span data-level="0">OFF</span>
                        <span data-level="1">BASE</span>
                        <span data-level="2">ENHANCED</span>
                        <span data-level="3" class="active">STRONG</span>
                        <span data-level="4">MAX</span>
                        <span data-level="5">FULL</span>
                    </div>
                </div>

                <!-- ML Status with Training Button -->
                <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                    <div>
                        <i class="fas fa-brain text-primary mr-2"></i>
                        <span>ML/LSTM Threat Detection</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span id="ml-status" class="badge badge-secondary mr-2">Checking...</span>
                        <button id="train-btn" class="btn btn-sm btn-outline-info" onclick="trainML()" title="Train ML Model" style="display: none;">
                            <i class="fas fa-graduation-cap"></i>
                        </button>
                    </div>
                </div>
                <div id="ml-training-progress" class="mt-2 p-2 bg-info text-white rounded" style="display: none;">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    <span id="ml-training-text">Training in progress...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT CARD: QSecBit Security -->
    <div class="col-lg-6 mb-4">
        <div class="card ai-security-card card-outline card-warning">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line mr-2"></i>QSecBit Score</h3>
                <div class="card-tools">
                    <span class="badge badge-lg badge-{% if qsecbit.rag_status == 'GREEN' %}success{% elif qsecbit.rag_status == 'AMBER' %}warning{% else %}danger{% endif %}">
                        {{ qsecbit.rag_status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Score Gauge -->
                <div class="row mb-4">
                    <div class="col-5 text-center">
                        <div class="qsecbit-gauge">
                            <canvas id="qsecbitGauge" width="160" height="160"></canvas>
                            <div class="qsecbit-score rag-{{ qsecbit.rag_status }}" id="qsecbit-score">
                                {{ (qsecbit.score * 100)|int }}
                            </div>
                        </div>
                        <small class="text-muted">Risk Score</small>
                    </div>
                    <div class="col-7">
                        <!-- Threat Summary -->
                        <h6 class="mb-3"><i class="fas fa-exclamation-triangle mr-1"></i> Threats (24h)</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total</span>
                            <span class="font-weight-bold">{{ threat_summary.total }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><span class="badge badge-danger">HIGH</span></span>
                            <span>{{ threat_summary.high }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><span class="badge badge-warning">MEDIUM</span></span>
                            <span>{{ threat_summary.medium }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><span class="badge badge-info">LOW</span></span>
                            <span>{{ threat_summary.low }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-success"><i class="fas fa-ban mr-1"></i>Blocked</span>
                            <span class="text-success font-weight-bold">{{ threat_summary.blocked }}</span>
                        </div>
                    </div>
                </div>

                <!-- Security Components -->
                <div class="mb-3">
                    <h6 class="mb-2"><i class="fas fa-cogs mr-1"></i> Security Components</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-shield-alt text-success mr-1"></i> QSecBit</span>
                                <span class="badge badge-success">Active</span>
                            </div>
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-brain text-info mr-1"></i> dnsXai</span>
                                <span class="badge badge-success">Active</span>
                            </div>
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-microchip text-warning mr-1"></i> XDP</span>
                                <span class="badge badge-success">Enabled</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-sitemap text-primary mr-1"></i> VLAN</span>
                                <span class="badge badge-success">Active</span>
                            </div>
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-lock text-danger mr-1"></i> MACsec</span>
                                <span class="badge badge-success">Active</span>
                            </div>
                            <div class="component-item d-flex justify-content-between">
                                <span><i class="fas fa-wifi text-info mr-1"></i> DFS</span>
                                <span class="badge badge-success">Active</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Threats -->
                <div>
                    <h6 class="mb-2"><i class="fas fa-shield-virus mr-1"></i> Recent Threats</h6>
                    <div class="threats-scroll">
                        {% for threat in threats %}
                        <div class="d-flex justify-content-between align-items-center p-2 mb-1 bg-dark rounded threat-severity-{{ threat.severity }}">
                            <div>
                                <small class="font-weight-bold">{{ threat.threat_type|replace('_', ' ')|title }}</small>
                                <br><small class="text-muted"><code>{{ threat.source_ip }}</code></small>
                            </div>
                            <div class="text-right">
                                <span class="badge badge-{% if threat.severity == 'HIGH' %}danger{% elif threat.severity == 'MEDIUM' %}warning{% else %}info{% endif %}">
                                    {{ threat.severity }}
                                </span>
                                {% if threat.blocked %}
                                <span class="badge badge-success ml-1"><i class="fas fa-ban"></i></span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <p class="mb-0">No threats in last 24h</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not data_available %}
<div class="alert alert-info">
    <i class="fas fa-info-circle mr-2"></i>
    <strong>No Data:</strong> QSecBit agent is starting up. Security metrics will appear once data is collected.
</div>
{% endif %}

<!-- DNS Settings Modal -->
<div class="modal fade modal-dark" id="dnsSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title"><i class="fas fa-cog mr-2"></i>DNS Protection Settings</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabs -->
                <ul class="nav nav-tabs nav-fill" id="settingsTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#tab-privacy">
                            <i class="fas fa-user-shield"></i> Privacy
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab-whitelist">
                            <i class="fas fa-check-circle"></i> Whitelist
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab-sources">
                            <i class="fas fa-list"></i> Sources
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab-blocked">
                            <i class="fas fa-ban"></i> Blocked
                        </a>
                    </li>
                </ul>

                <div class="tab-content p-3">
                    <!-- Privacy Tab -->
                    <div class="tab-pane fade show active" id="tab-privacy">
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm w-100">
                                <button class="btn btn-success" onclick="applyPrivacyPreset('maximum')">Maximum Privacy</button>
                                <button class="btn btn-warning" onclick="applyPrivacyPreset('balanced')">Balanced</button>
                                <button class="btn btn-danger" onclick="applyPrivacyPreset('full')">Full Analytics</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-query-logging"
                                           onchange="setPrivacy('enable_query_logging', this.checked)">
                                    <label class="custom-control-label" for="privacy-query-logging">DNS Query Logging</label>
                                    <small class="form-text text-warning">HIGH privacy impact</small>
                                </div>
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-domain-tracking"
                                           onchange="setPrivacy('enable_domain_tracking', this.checked)">
                                    <label class="custom-control-label" for="privacy-domain-tracking">Domain Tracking</label>
                                    <small class="form-text text-warning">HIGH privacy impact</small>
                                </div>
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-ad-stats" checked
                                           onchange="setPrivacy('enable_ad_blocking_stats', this.checked)">
                                    <label class="custom-control-label" for="privacy-ad-stats">Ad Blocking Statistics</label>
                                    <small class="form-text text-muted">LOW privacy impact</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-threat-detection" checked
                                           onchange="setPrivacy('enable_threat_detection', this.checked)">
                                    <label class="custom-control-label" for="privacy-threat-detection">Threat Detection</label>
                                    <small class="form-text text-success">RECOMMENDED</small>
                                </div>
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-ml-training"
                                           onchange="setPrivacy('enable_ml_training_data', this.checked)">
                                    <label class="custom-control-label" for="privacy-ml-training">ML Training Data</label>
                                    <small class="form-text text-info">MEDIUM privacy impact</small>
                                </div>
                                <div class="custom-control custom-switch mb-3">
                                    <input type="checkbox" class="custom-control-input" id="privacy-anonymize-ips" checked
                                           onchange="setPrivacy('anonymize_client_ips', this.checked)">
                                    <label class="custom-control-label" for="privacy-anonymize-ips">Anonymize IPs</label>
                                    <small class="form-text text-success">ALWAYS recommended</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Data Retention (days)</label>
                            <input type="number" class="form-control" id="privacy-retention" value="7" min="1" max="90"
                                   style="width: 100px;" onchange="setPrivacy('retention_days', parseInt(this.value))">
                        </div>
                    </div>

                    <!-- Whitelist Tab -->
                    <div class="tab-pane fade" id="tab-whitelist">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="whitelist-input" placeholder="domain.com"
                                   onkeypress="if(event.key==='Enter') addWhitelist()">
                            <div class="input-group-append">
                                <button class="btn btn-success" onclick="addWhitelist()">Add</button>
                            </div>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-dark">
                                <thead><tr><th>Domain</th><th class="text-right">Action</th></tr></thead>
                                <tbody id="whitelist-body">
                                    <tr><td colspan="2" class="text-muted text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Sources Tab -->
                    <div class="tab-pane fade" id="tab-sources">
                        <button class="btn btn-sm btn-primary mb-3" data-toggle="modal" data-target="#add-source-modal">
                            <i class="fas fa-plus"></i> Add Source
                        </button>
                        <div id="sources-list">
                            <p class="text-muted">Loading sources...</p>
                        </div>
                    </div>

                    <!-- Blocked Tab -->
                    <div class="tab-pane fade" id="tab-blocked">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="blocked-search" placeholder="Search domains..."
                                   onkeyup="filterBlockedList()">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" onclick="loadBlockedModal()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-dark table-striped">
                                <thead><tr><th>Domain</th><th>Reason</th><th class="text-center">Actions</th></tr></thead>
                                <tbody id="blocked-modal-body">
                                    <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted"><span id="blocked-modal-count">0</span> blocked domains (deduplicated)</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Source Modal -->
<div class="modal fade modal-dark" id="add-source-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Blocklist Source</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Source Name</label>
                    <input type="text" class="form-control" id="source-name" placeholder="e.g., StevenBlack Hosts">
                </div>
                <div class="form-group">
                    <label>Source URL</label>
                    <input type="text" class="form-control" id="source-url" placeholder="https://raw.githubusercontent.com/...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSource()">Add Source</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const LEVEL_NAMES = ['OFF', 'Base', 'Enhanced', 'Strong', 'Maximum', 'Full'];
const LEVEL_COLORS = ['secondary', 'info', 'primary', 'success', 'warning', 'danger'];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDnsStats();
    loadMLStatus();
    drawQsecbitGauge();
    setInterval(checkPauseStatus, 10000);
    setInterval(loadDnsStats, 30000);
    setInterval(refreshQsecbit, 30000);
});

// === DNS STATS ===
async function loadDnsStats() {
    try {
        const resp = await fetch('/dnsxai/api/stats');
        const data = await resp.json();

        document.getElementById('stat-blocked').textContent = data.blocked.toLocaleString();
        document.getElementById('stat-allowed').textContent = data.allowed.toLocaleString();
        document.getElementById('stat-rate').textContent = data.block_rate.toFixed(1) + '%';

        document.getElementById('protection-level').value = data.level;
        updateLevelDisplay(data.level);
        updateDnsStatus(data.status);
    } catch(e) {
        console.error('Failed to load DNS stats:', e);
    }
}

function updateDnsStatus(status) {
    const icon = document.getElementById('dns-status-icon');
    const text = document.getElementById('dns-status-text');
    const btn = document.getElementById('killswitch-btn');
    const timer = document.getElementById('pause-timer');

    icon.className = 'dns-status-icon ' + status;

    if (status === 'active') {
        icon.innerHTML = '<i class="fas fa-shield-alt"></i>';
        text.textContent = 'Active';
        text.className = 'h4 text-success mb-0';
        btn.textContent = 'OFF';
        btn.className = 'btn btn-sm btn-danger';
        timer.style.display = 'none';
    } else if (status === 'paused') {
        icon.innerHTML = '<i class="fas fa-pause-circle"></i>';
        text.textContent = 'Paused';
        text.className = 'h4 text-warning mb-0';
        btn.textContent = 'ON';
        btn.className = 'btn btn-sm btn-success';
        timer.style.display = 'block';
    } else {
        icon.innerHTML = '<i class="fas fa-times-circle"></i>';
        text.textContent = 'Disabled';
        text.className = 'h4 text-danger mb-0';
        btn.textContent = 'ON';
        btn.className = 'btn btn-sm btn-success';
        timer.style.display = 'none';
    }
}

async function toggleProtection() {
    const btn = document.getElementById('killswitch-btn');
    const action = btn.textContent === 'OFF' ? 'disable' : 'enable';

    try {
        const resp = await fetch('/dnsxai/api/pause', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action})
        });
        const data = await resp.json();
        if (data.success) {
            updateDnsStatus(data.status);
            toastr.success('Protection ' + data.status);
        }
    } catch(e) {
        toastr.error('Failed to toggle protection');
    }
}

async function pauseProtection(minutes) {
    try {
        const resp = await fetch('/dnsxai/api/pause', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'pause', minutes})
        });
        const data = await resp.json();
        if (data.success) {
            updateDnsStatus('paused');
            toastr.success('Paused for ' + minutes + ' minutes');
        }
    } catch(e) {
        toastr.error('Failed to pause protection');
    }
}

async function checkPauseStatus() {
    try {
        const resp = await fetch('/dnsxai/api/pause');
        const data = await resp.json();
        updateDnsStatus(data.status);

        if (data.status === 'paused' && data.remaining_seconds > 0) {
            const mins = Math.floor(data.remaining_seconds / 60);
            const secs = data.remaining_seconds % 60;
            document.getElementById('pause-countdown').textContent =
                mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }
    } catch(e) {}
}

// === PROTECTION LEVEL ===
function updateLevelDisplay(level) {
    const name = document.getElementById('level-name');
    const labels = document.querySelectorAll('#protection-labels span');

    // Update badge
    name.textContent = LEVEL_NAMES[level];
    name.className = 'badge badge-' + LEVEL_COLORS[level] + ' px-3 py-2';
    name.style.fontSize = '0.85rem';

    // Highlight active label
    labels.forEach((label, idx) => {
        if (idx == level) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    });
}

async function setProtectionLevel(level) {
    try {
        const resp = await fetch('/dnsxai/api/level', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({level: parseInt(level)})
        });
        const data = await resp.json();
        if (data.success) {
            toastr.success('Level set to ' + LEVEL_NAMES[level]);
        }
    } catch(e) {
        toastr.error('Failed to set level');
    }
}

// === ML STATUS ===
async function loadMLStatus() {
    try {
        const resp = await fetch('/dnsxai/api/ml/status');
        const data = await resp.json();

        const status = document.getElementById('ml-status');
        const trainBtn = document.getElementById('train-btn');
        const progress = document.getElementById('ml-training-progress');

        if (data.training_in_progress) {
            status.textContent = 'Training...';
            status.className = 'badge badge-info mr-2';
            trainBtn.style.display = 'none';
            progress.style.display = 'block';
        } else if (data.model_trained) {
            status.textContent = 'Active';
            status.className = 'badge badge-success mr-2';
            trainBtn.style.display = 'inline-block';
            trainBtn.title = 'Retrain ML Model';
            progress.style.display = 'none';
        } else if (data.ready_for_training) {
            status.textContent = 'Ready';
            status.className = 'badge badge-primary mr-2';
            trainBtn.style.display = 'inline-block';
            trainBtn.title = `Train ML Model (${data.training_samples || 0} samples)`;
            progress.style.display = 'none';
        } else {
            status.textContent = 'Learning';
            status.className = 'badge badge-secondary mr-2';
            // Show train button if we have some samples
            if (data.training_samples && data.training_samples > 50) {
                trainBtn.style.display = 'inline-block';
                trainBtn.title = `Train ML Model (${data.training_samples} samples)`;
            } else {
                trainBtn.style.display = 'none';
            }
            progress.style.display = 'none';
        }
    } catch(e) {
        document.getElementById('ml-status').textContent = 'Offline';
        document.getElementById('ml-status').className = 'badge badge-danger mr-2';
        document.getElementById('train-btn').style.display = 'none';
        document.getElementById('ml-training-progress').style.display = 'none';
    }
}

async function trainML() {
    const trainBtn = document.getElementById('train-btn');
    const progress = document.getElementById('ml-training-progress');
    const progressText = document.getElementById('ml-training-text');

    // Confirm training
    if (!confirm('Start ML training? This may take a few minutes.')) {
        return;
    }

    // Show progress
    trainBtn.disabled = true;
    progress.style.display = 'block';
    progressText.textContent = 'Starting training...';

    try {
        const resp = await fetch('/dnsxai/api/ml/train', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await resp.json();

        if (data.success) {
            progressText.textContent = 'Training complete!';
            progress.className = 'mt-2 p-2 bg-success text-white rounded';
            toastr.success('ML model trained successfully');

            setTimeout(() => {
                progress.style.display = 'none';
                progress.className = 'mt-2 p-2 bg-info text-white rounded';
                loadMLStatus();
            }, 2000);
        } else {
            progressText.textContent = data.error || 'Training failed';
            progress.className = 'mt-2 p-2 bg-danger text-white rounded';
            toastr.error(data.error || 'Training failed');

            setTimeout(() => {
                progress.style.display = 'none';
                progress.className = 'mt-2 p-2 bg-info text-white rounded';
            }, 3000);
        }
    } catch(e) {
        progressText.textContent = 'Connection error';
        progress.className = 'mt-2 p-2 bg-danger text-white rounded';
        toastr.error('Failed to connect to ML service');

        setTimeout(() => {
            progress.style.display = 'none';
            progress.className = 'mt-2 p-2 bg-info text-white rounded';
        }, 3000);
    }

    trainBtn.disabled = false;
}

// === QSECBIT GAUGE ===
function drawQsecbitGauge() {
    const canvas = document.getElementById('qsecbitGauge');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const score = {{ qsecbit.score }};
    const status = '{{ qsecbit.rag_status }}';

    const color = status === 'GREEN' ? '#28a745' : status === 'AMBER' ? '#ffc107' : '#dc3545';

    // Background arc
    ctx.beginPath();
    ctx.arc(80, 80, 60, 0.75 * Math.PI, 2.25 * Math.PI);
    ctx.strokeStyle = '#2c2c2c';
    ctx.lineWidth = 15;
    ctx.stroke();

    // Score arc
    const endAngle = 0.75 * Math.PI + (score * 1.5 * Math.PI);
    ctx.beginPath();
    ctx.arc(80, 80, 60, 0.75 * Math.PI, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 15;
    ctx.lineCap = 'round';
    ctx.stroke();
}

async function refreshQsecbit() {
    try {
        const resp = await fetch('/security/api/qsecbit');
        const data = await resp.json();
        if (data.score !== undefined) {
            document.getElementById('qsecbit-score').textContent = Math.round(data.score * 100);
        }
    } catch(e) {}
}

// === DNS SETTINGS MODAL ===
function showDnsSettings() {
    $('#dnsSettingsModal').modal('show');
    loadPrivacy();
    loadWhitelist();
    loadSources();
    loadBlockedModal();
}

// === PRIVACY ===
async function loadPrivacy() {
    try {
        const resp = await fetch('/dnsxai/api/privacy');
        const data = await resp.json();
        const s = data.settings || {};

        document.getElementById('privacy-query-logging').checked = s.enable_query_logging;
        document.getElementById('privacy-domain-tracking').checked = s.enable_domain_tracking;
        document.getElementById('privacy-ad-stats').checked = s.enable_ad_blocking_stats;
        document.getElementById('privacy-threat-detection').checked = s.enable_threat_detection;
        document.getElementById('privacy-ml-training').checked = s.enable_ml_training_data;
        document.getElementById('privacy-anonymize-ips').checked = s.anonymize_client_ips;
        document.getElementById('privacy-retention').value = s.retention_days || 7;
    } catch(e) {}
}

async function setPrivacy(setting, value) {
    try {
        const resp = await fetch('/dnsxai/api/privacy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({setting, value})
        });
        if ((await resp.json()).success) toastr.success('Setting updated');
    } catch(e) {
        toastr.error('Failed to update');
    }
}

async function applyPrivacyPreset(preset) {
    if (preset === 'full' && !confirm('Enable full analytics?')) return;
    try {
        const resp = await fetch('/dnsxai/api/privacy/preset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({preset})
        });
        if ((await resp.json()).success) {
            loadPrivacy();
            toastr.success('Preset applied: ' + preset);
        }
    } catch(e) {
        toastr.error('Failed');
    }
}

// === WHITELIST ===
async function loadWhitelist() {
    try {
        const resp = await fetch('/dnsxai/api/whitelist');
        const data = await resp.json();
        const list = data.whitelist || [];

        const tbody = document.getElementById('whitelist-body');
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No whitelisted domains</td></tr>';
        } else {
            tbody.innerHTML = list.map(d => `
                <tr>
                    <td class="text-monospace">${d}</td>
                    <td class="text-right">
                        <button class="btn btn-xs btn-danger" onclick="removeWhitelist('${d.replace(/'/g, "\\'")}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    } catch(e) {}
}

async function addWhitelist() {
    const input = document.getElementById('whitelist-input');
    const domain = input.value.trim().toLowerCase();
    if (!domain) return;

    try {
        const resp = await fetch('/dnsxai/api/whitelist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain})
        });
        if ((await resp.json()).success) {
            input.value = '';
            loadWhitelist();
            toastr.success(domain + ' whitelisted');
        }
    } catch(e) {
        toastr.error('Failed');
    }
}

async function removeWhitelist(domain) {
    try {
        const resp = await fetch('/dnsxai/api/whitelist', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain})
        });
        if ((await resp.json()).success) {
            loadWhitelist();
            toastr.success('Removed');
        }
    } catch(e) {}
}

// === SOURCES ===
async function loadSources() {
    try {
        const resp = await fetch('/dnsxai/api/sources');
        const data = await resp.json();
        const sources = data.sources || [];

        const container = document.getElementById('sources-list');
        if (sources.length === 0) {
            container.innerHTML = '<p class="text-muted">No sources configured</p>';
        } else {
            container.innerHTML = sources.map(s => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-dark rounded">
                    <div>
                        <strong>${s.name}</strong>
                        ${s.builtin ? '<span class="badge badge-secondary ml-1">Built-in</span>' : ''}
                        <br><small class="text-muted">${s.url}</small>
                    </div>
                    ${!s.builtin ? `<button class="btn btn-sm btn-danger" onclick="removeSource('${s.id}')"><i class="fas fa-trash"></i></button>` : ''}
                </div>
            `).join('');
        }
    } catch(e) {}
}

async function addSource() {
    const name = document.getElementById('source-name').value.trim();
    const url = document.getElementById('source-url').value.trim();
    if (!url) { toastr.error('URL required'); return; }

    try {
        const resp = await fetch('/dnsxai/api/sources', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name || 'Custom', url})
        });
        if ((await resp.json()).success) {
            $('#add-source-modal').modal('hide');
            document.getElementById('source-name').value = '';
            document.getElementById('source-url').value = '';
            loadSources();
            toastr.success('Source added');
        }
    } catch(e) {
        toastr.error('Failed');
    }
}

async function removeSource(id) {
    if (!confirm('Remove source?')) return;
    try {
        const resp = await fetch('/dnsxai/api/sources', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        if ((await resp.json()).success) {
            loadSources();
            toastr.success('Removed');
        }
    } catch(e) {}
}

// === BLOCKED ===
let blockedCache = [];

async function loadBlockedModal() {
    try {
        const resp = await fetch('/dnsxai/api/blocked?limit=200');
        const data = await resp.json();
        blockedCache = data.blocked || [];
        renderBlocked(blockedCache);
    } catch(e) {}
}

function renderBlocked(domains) {
    const tbody = document.getElementById('blocked-modal-body');
    document.getElementById('blocked-modal-count').textContent = domains.length;

    if (domains.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No blocked domains</td></tr>';
        return;
    }

    tbody.innerHTML = domains.map(d => {
        const esc = d.domain.replace(/'/g, "\\'");
        const badge = d.ml_classified ? '<span class="badge badge-primary">ML</span>' : '<span class="badge badge-secondary">List</span>';
        return `
            <tr>
                <td class="text-monospace" style="font-size:0.8em;word-break:break-all;">${d.domain}</td>
                <td>${badge}</td>
                <td class="text-center text-nowrap">
                    <button class="btn btn-xs btn-success" onclick="whitelistBlocked('${esc}')" title="Whitelist"><i class="fas fa-check"></i></button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterBlockedList() {
    const search = document.getElementById('blocked-search').value.toLowerCase();
    if (!search) {
        renderBlocked(blockedCache);
    } else {
        renderBlocked(blockedCache.filter(d => d.domain.includes(search)));
    }
}

async function whitelistBlocked(domain) {
    try {
        const resp = await fetch('/dnsxai/api/whitelist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain})
        });
        if ((await resp.json()).success) {
            blockedCache = blockedCache.filter(d => d.domain !== domain);
            renderBlocked(blockedCache);
            loadWhitelist();
            toastr.success('Whitelisted');
        }
    } catch(e) {}
}
</script>
{% endblock %}
