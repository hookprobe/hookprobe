{% extends "base.html" %}

{% block title %}Dashboard - HookProbe Fortress{% endblock %}

{% block page_header %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Home</li>
{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   NETWORK TOPOLOGY - D3.js Force-Directed Graph
   ========================================================================== */
.topology-container {
    background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0d1117 100%);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.08);
    overflow: hidden;
    position: relative;
    min-height: 500px;
}

.topology-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
}

.topology-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
}

.topology-legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.topology-legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    color: #888;
}

.topology-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

#topology-svg {
    width: 100%;
    height: 500px;
    cursor: grab;
}

#topology-svg:active {
    cursor: grabbing;
}

/* Ecosystem bubble styles */
.ecosystem-bubble {
    pointer-events: none;
}

.bubble-label {
    text-shadow: 0 0 3px rgba(0,0,0,0.8);
}

/* Node styles */
.node {
    cursor: pointer;
    transition: transform 0.2s;
}

.node:hover {
    filter: brightness(1.2);
}

.node-label {
    font-size: 10px;
    fill: #ccc;
    text-anchor: middle;
    pointer-events: none;
    font-weight: 500;
}

.node-icon {
    fill: #fff;
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    font-size: 16px;
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
}

.node-device .node-icon {
    font-size: 14px;
}

/* Link styles */
.link {
    stroke: rgba(255,255,255,0.15);
    stroke-width: 1.5px;
    fill: none;
}

.link-wan_link { stroke: rgba(40, 167, 69, 0.5); stroke-width: 3px; }
.link-policy_link { stroke: rgba(230, 149, 0, 0.4); stroke-width: 2px; }
.link-device_link { stroke-dasharray: 4,2; stroke-width: 1px; }

/* Tooltip */
.topology-tooltip {
    position: absolute;
    background: rgba(0,0,0,0.95);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.8rem;
    color: #fff;
    pointer-events: none;
    z-index: 1000;
    min-width: 180px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    display: none;
}

.topology-tooltip.visible { display: block; }

.topology-tooltip h5 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: #fff;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 0.4rem;
}

.topology-tooltip .tt-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.topology-tooltip .tt-label { color: #888; }
.topology-tooltip .tt-value { color: #fff; font-weight: 500; }

/* Controls */
.topology-controls {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
}

.topology-controls .btn {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 8px;
    transition: all 0.2s;
}

.topology-controls .btn:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.4);
}

/* Drag hint */
.drag-hint {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    font-size: 0.75rem;
    color: #666;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* ==========================================================================
   AI SECURITY SECTION
   ========================================================================== */
.ai-security-section {
    margin-top: 1.5rem;
}

.ai-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    overflow: hidden;
    height: 100%;
}

.ai-card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ai-card-header h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-card-header .status-badge {
    font-size: 0.65rem;
    padding: 0.2em 0.5em;
    border-radius: 4px;
}

.ai-card-body {
    padding: 1.25rem;
}

/* dnsXai Card */
.dnsxai-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.dnsxai-stat {
    text-align: center;
    padding: 0.75rem;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
}

.dnsxai-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4fc3f7;
}

.dnsxai-stat-label {
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* QSecBit Card */
.qsecbit-gauge {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto 1rem;
}

.qsecbit-gauge svg {
    transform: rotate(-90deg);
}

.qsecbit-gauge-bg {
    fill: none;
    stroke: rgba(255,255,255,0.1);
    stroke-width: 10;
}

.qsecbit-gauge-fill {
    fill: none;
    stroke-width: 10;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
}

.qsecbit-gauge-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.qsecbit-score {
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
}

.qsecbit-label {
    font-size: 0.65rem;
    color: #888;
    text-transform: uppercase;
}

.qsecbit-status-badge {
    display: inline-block;
    padding: 0.3em 0.8em;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.qsecbit-status-badge.green {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.4);
}

.qsecbit-status-badge.amber {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.4);
}

.qsecbit-status-badge.red {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.4);
}

.qsecbit-layers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.4rem;
}

.qsecbit-layer {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.5rem;
    background: rgba(0,0,0,0.3);
    border-radius: 5px;
    font-size: 0.7rem;
}

.qsecbit-layer-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

.qsecbit-layer-name {
    color: #888;
    flex: 1;
}

.qsecbit-layer-status {
    color: #fff;
    font-weight: 600;
}

/* ==========================================================================
   BOTTOM SECTION - QUICK ACTIONS & REMOTE ACCESS
   ========================================================================== */
.bottom-section {
    margin-top: 1.5rem;
}

.quick-actions-card, .remote-access-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 1.25rem;
    height: 100%;
}

.quick-actions-card h5, .remote-access-card h5 {
    margin: 0 0 1rem 0;
    font-size: 0.85rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.quick-action-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: flex-start;
}

.quick-action-btn {
    flex: 1 1 calc(14.28% - 0.75rem);
    min-width: 90px;
    max-width: 130px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem 0.5rem;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: #ccc;
    text-decoration: none;
    transition: all 0.2s;
    font-size: 0.75rem;
}

.quick-action-btn:hover {
    background: rgba(230, 149, 0, 0.15);
    border-color: rgba(230, 149, 0, 0.4);
    color: #e69500;
    transform: translateY(-2px);
    text-decoration: none;
}

.quick-action-btn i {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
}

.remote-access-card h5 {
    font-size: 0.85rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Device Edit Modal */
.device-modal-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.device-modal-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    background: rgba(230, 149, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #e69500;
}

.policy-selector {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
}

.policy-option {
    padding: 0.6rem 0.4rem;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.policy-option:hover {
    transform: translateY(-2px);
}

.policy-option.selected {
    border-color: currentColor;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.policy-option i {
    font-size: 1.1rem;
    margin-bottom: 0.3rem;
    display: block;
}

.policy-option span {
    font-size: 0.65rem;
    font-weight: 600;
}

/* Responsive */
@media (max-width: 1200px) {
    .quick-action-btn {
        flex: 1 1 calc(14.28% - 0.65rem);
        min-width: 85px;
        padding: 0.85rem 0.4rem;
    }
}

@media (max-width: 992px) {
    .quick-action-btn {
        flex: 1 1 calc(25% - 0.75rem);
        min-width: 80px;
    }
}

@media (max-width: 768px) {
    .topology-container {
        min-height: 400px;
    }
    #topology-svg {
        height: 400px;
    }
    .dnsxai-stats {
        grid-template-columns: repeat(3, 1fr);
    }
    .policy-selector {
        grid-template-columns: repeat(3, 1fr);
    }
    .topology-legend {
        display: none;
    }
    .quick-action-btn {
        flex: 1 1 calc(33.33% - 0.65rem);
        min-width: 70px;
        padding: 0.75rem 0.3rem;
        font-size: 0.7rem;
    }
    .quick-action-btn i {
        font-size: 1.1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Network Topology -->
<div class="row">
    <div class="col-12">
        <div class="topology-container">
            <div class="topology-header">
                <div>
                    <h3><i class="fas fa-project-diagram mr-2"></i>Network Topology</h3>
                </div>
                <div class="topology-legend">
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #28a745;"></span>
                        <span>WAN</span>
                    </div>
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #e69500;"></span>
                        <span>Bridge</span>
                    </div>
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #dc3545;"></span>
                        <span>Quarantine</span>
                    </div>
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #17a2b8;"></span>
                        <span>Internet Only</span>
                    </div>
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #28a745;"></span>
                        <span>Normal</span>
                    </div>
                    <div class="topology-legend-item">
                        <span class="topology-legend-dot" style="background: #007bff;"></span>
                        <span>Full Access</span>
                    </div>
                    <div class="topology-legend-item" title="Same-user device grouping detected by AI">
                        <span class="topology-legend-dot" style="background: rgba(66, 133, 244, 0.3); border: 2px dashed #4285F4;"></span>
                        <span>Ecosystem Bubble</span>
                    </div>
                </div>
            </div>
            <svg id="topology-svg"></svg>
            <div class="topology-tooltip" id="topology-tooltip"></div>
            <div class="drag-hint">
                <i class="fas fa-hand-pointer"></i>
                <span>Drag devices to change policy</span>
            </div>
            <div class="topology-controls">
                <button class="btn" id="btn-zoom-in" title="Zoom In"><i class="fas fa-plus"></i></button>
                <button class="btn" id="btn-zoom-out" title="Zoom Out"><i class="fas fa-minus"></i></button>
                <button class="btn" id="btn-reset" title="Reset View"><i class="fas fa-expand"></i></button>
                <button class="btn" id="btn-refresh" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- AI Security Section -->
<div class="row ai-security-section">
    <!-- dnsXai Card -->
    <div class="col-lg-6 mb-3">
        <div class="ai-card">
            <div class="ai-card-header">
                <h4><i class="fas fa-shield-virus text-info"></i> dnsXai Protection</h4>
                {% if dnsxai_summary.enabled %}
                <span class="status-badge bg-success">Active</span>
                {% else %}
                <span class="status-badge bg-secondary">Inactive</span>
                {% endif %}
            </div>
            <div class="ai-card-body">
                <div class="dnsxai-stats">
                    <div class="dnsxai-stat">
                        <div class="dnsxai-stat-value">{{ dnsxai_summary.blocked_today | default(0) }}</div>
                        <div class="dnsxai-stat-label">Blocked Today</div>
                    </div>
                    <div class="dnsxai-stat">
                        <div class="dnsxai-stat-value">{{ dnsxai_summary.block_rate | default(0) }}%</div>
                        <div class="dnsxai-stat-label">Block Rate</div>
                    </div>
                    <div class="dnsxai-stat">
                        <div class="dnsxai-stat-value">{{ dnsxai_summary.queries_today | default(0) }}</div>
                        <div class="dnsxai-stat-label">Queries</div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.8rem;">
                    <span class="text-muted">Top: <strong class="text-white">{{ dnsxai_summary.top_blocked_category | default('Ads & Trackers') }}</strong></span>
                    <span class="text-muted">Level: <strong class="text-warning">{{ dnsxai_summary.protection_level | default('Standard') }}</strong></span>
                </div>

                <div class="d-flex" style="gap: 0.5rem;">
                    <a href="{{ url_for('security.index') }}" class="btn btn-outline-info btn-sm flex-fill">
                        <i class="fas fa-cog mr-1"></i> Configure
                    </a>
                    <button class="btn btn-outline-warning btn-sm flex-fill" id="btn-train-dnsxai">
                        <i class="fas fa-brain mr-1"></i> Train Model
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QSecBit Card -->
    <div class="col-lg-6 mb-3">
        <div class="ai-card">
            <div class="ai-card-header">
                <h4><i class="fas fa-shield-alt text-warning"></i> QSecBit Score</h4>
                <span class="status-badge bg-{{ 'success' if qsecbit_status == 'GREEN' else ('warning' if qsecbit_status == 'AMBER' else 'danger') }}">
                    {{ qsecbit_status | default('GREEN') }}
                </span>
            </div>
            <div class="ai-card-body">
                <div class="row align-items-center">
                    <div class="col-5">
                        <div class="qsecbit-gauge">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle class="qsecbit-gauge-bg" cx="60" cy="60" r="50"/>
                                <circle class="qsecbit-gauge-fill" cx="60" cy="60" r="50"
                                    stroke="{{ '#28a745' if qsecbit_status == 'GREEN' else ('#ffc107' if qsecbit_status == 'AMBER' else '#dc3545') }}"
                                    stroke-dasharray="314.16"
                                    stroke-dashoffset="{{ 314.16 - (qsecbit_score * 314.16) }}"/>
                            </svg>
                            <div class="qsecbit-gauge-value">
                                <div class="qsecbit-score">{{ (qsecbit_score * 100)|int }}</div>
                                <div class="qsecbit-label">Score</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="text-center mb-3">
                            <span class="qsecbit-status-badge {{ qsecbit_status | lower }}">
                                {% if qsecbit_status == 'GREEN' %}
                                <i class="fas fa-check-circle mr-1"></i> Secure
                                {% elif qsecbit_status == 'AMBER' %}
                                <i class="fas fa-exclamation-triangle mr-1"></i> Warning
                                {% else %}
                                <i class="fas fa-times-circle mr-1"></i> Critical
                                {% endif %}
                            </span>
                        </div>
                        <div class="qsecbit-layers">
                            <div class="qsecbit-layer">
                                <span class="qsecbit-layer-dot" style="background: #28a745;"></span>
                                <span class="qsecbit-layer-name">L2</span>
                                <span class="qsecbit-layer-status">OK</span>
                            </div>
                            <div class="qsecbit-layer">
                                <span class="qsecbit-layer-dot" style="background: #28a745;"></span>
                                <span class="qsecbit-layer-name">L3</span>
                                <span class="qsecbit-layer-status">OK</span>
                            </div>
                            <div class="qsecbit-layer">
                                <span class="qsecbit-layer-dot" style="background: #28a745;"></span>
                                <span class="qsecbit-layer-name">L4</span>
                                <span class="qsecbit-layer-status">OK</span>
                            </div>
                            <div class="qsecbit-layer">
                                <span class="qsecbit-layer-dot" style="background: #28a745;"></span>
                                <span class="qsecbit-layer-name">L7</span>
                                <span class="qsecbit-layer-status">OK</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <a href="{{ url_for('security.index') }}" class="btn btn-outline-warning btn-sm btn-block">
                        <i class="fas fa-chart-line mr-1"></i> View Security Details
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row bottom-section">
    <div class="col-12 mb-3">
        <div class="quick-actions-card">
            <h5><i class="fas fa-bolt mr-2"></i>Quick Actions</h5>
            <div class="quick-action-grid">
                <a href="{{ url_for('sdn.index') }}" class="quick-action-btn">
                    <i class="fas fa-network-wired"></i>
                    <span>SDN AI</span>
                </a>
                <a href="{{ url_for('security.index') }}" class="quick-action-btn">
                    <i class="fas fa-shield-alt"></i>
                    <span>AI Security</span>
                </a>
                <a href="#" class="quick-action-btn" title="AI Eyes - Cognitive Network Layer">
                    <i class="fas fa-eye"></i>
                    <span>AIOCHI</span>
                </a>
                <a href="#" class="quick-action-btn" title="Neural Command Center">
                    <i class="fas fa-globe"></i>
                    <span>Cortex</span>
                </a>
                <a href="{{ url_for('tunnel.index') }}" class="quick-action-btn">
                    <i class="fas fa-cloud"></i>
                    <span>Cloudflare</span>
                </a>
                <a href="{{ url_for('auth.profile') }}" class="quick-action-btn">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
                <a href="{{ url_for('settings.index') }}" class="quick-action-btn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Remote Access Status -->
<div class="row">
    <div class="col-12 mb-3">
        <div class="remote-access-card">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 mr-3"><i class="fas fa-cloud mr-2"></i>Remote Access</h5>
                    {% if tunnel_status.state == 'connected' %}
                    <span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>Connected</span>
                    {% else %}
                    <span class="badge badge-secondary"><i class="fas fa-times-circle mr-1"></i>Not Configured</span>
                    {% endif %}
                </div>
                <a href="{{ url_for('tunnel.index') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-external-link-alt mr-1"></i> Manage Tunnel
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Device Edit Modal -->
<div class="modal fade" id="device-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header device-modal-header border-0">
                <div class="d-flex align-items-center">
                    <div class="device-modal-icon mr-3">
                        <i class="fas fa-laptop" id="modal-device-icon"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="modal-device-name">Device Name</h5>
                        <small class="text-muted" id="modal-device-ip">192.168.1.100</small>
                    </div>
                </div>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">MAC Address</span>
                        <span class="text-white" style="font-family: monospace;" id="modal-device-mac">00:00:00:00:00:00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Manufacturer</span>
                        <span class="text-white" id="modal-device-manufacturer">Unknown</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Status</span>
                        <span id="modal-device-status"><span class="badge badge-success">Online</span></span>
                    </div>
                </div>

                <hr class="border-secondary">

                <label class="text-muted mb-2">Select Policy</label>
                <div class="policy-selector">
                    <div class="policy-option" data-policy="quarantine" style="background: rgba(220,53,69,0.2); color: #dc3545;">
                        <i class="fas fa-ban"></i>
                        <span>Quarantine</span>
                    </div>
                    <div class="policy-option" data-policy="internet_only" style="background: rgba(23,162,184,0.2); color: #17a2b8;">
                        <i class="fas fa-globe"></i>
                        <span>Internet</span>
                    </div>
                    <div class="policy-option" data-policy="lan_only" style="background: rgba(255,193,7,0.2); color: #ffc107;">
                        <i class="fas fa-home"></i>
                        <span>LAN Only</span>
                    </div>
                    <div class="policy-option" data-policy="smart_home" style="background: rgba(40,167,69,0.2); color: #28a745;">
                        <i class="fas fa-check-circle"></i>
                        <span>Smart Home</span>
                    </div>
                    <div class="policy-option" data-policy="full_access" style="background: rgba(0,123,255,0.2); color: #007bff;">
                        <i class="fas fa-shield-alt"></i>
                        <span>Full</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="btn-save-policy">
                    <i class="fas fa-save mr-1"></i> Save Policy
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Network Topology Visualization
(function() {
    const svg = d3.select('#topology-svg');
    const container = document.querySelector('.topology-container');
    const tooltip = document.getElementById('topology-tooltip');

    let width = container.clientWidth;
    let height = 500;
    let simulation, nodes, links, nodeElements, linkElements;
    let selectedDevice = null;
    let currentZoom = d3.zoomIdentity;

    // Icon mapping (FontAwesome unicode)
    const iconMap = {
        'globe': '\uf0ac',
        'signal': '\uf012',
        'network-wired': '\uf6ff',
        'ban': '\uf05e',
        'home': '\uf015',
        'check-circle': '\uf058',
        'shield-alt': '\uf3ed',
        'layer-group': '\uf5fd',
        'laptop': '\uf109',
        'mobile-alt': '\uf3cd',
        'tablet-alt': '\uf3fa',
        'tv': '\uf26c',
        'print': '\uf02f',
        'video': '\uf03d',
        'desktop': '\uf108',
        'server': '\uf233',
        'gamepad': '\uf11b'
    };

    const policyColors = {
        'quarantine': '#dc3545',
        'internet_only': '#17a2b8',
        'lan_only': '#ffc107',
        'smart_home': '#28a745',
        'full_access': '#007bff'
    };

    // Initialize SVG
    svg.attr('width', width).attr('height', height);
    const g = svg.append('g');

    // Zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.3, 3])
        .on('zoom', (event) => {
            currentZoom = event.transform;
            g.attr('transform', event.transform);
        });
    svg.call(zoom);

    // Arrow marker for links
    svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 20)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .append('path')
        .attr('d', 'M 0,-5 L 10,0 L 0,5')
        .attr('fill', 'rgba(255,255,255,0.3)');

    function loadTopology() {
        fetch('/api/dashboard/topology')
            .then(res => res.json())
            .then(data => renderTopology(data))
            .catch(err => console.error('Failed to load topology:', err));
    }

    let bubbleElements = null;  // Ecosystem bubble elements
    let ecosystemBubbles = [];   // Bubble data

    function renderTopology(data) {
        nodes = data.nodes;
        links = data.links;
        ecosystemBubbles = data.ecosystem_bubbles || [];

        g.selectAll('*').remove();

        // Render ecosystem bubbles FIRST (behind everything else) - 30% opacity
        if (ecosystemBubbles.length > 0) {
            bubbleElements = g.append('g')
                .attr('class', 'ecosystem-bubbles')
                .selectAll('g')
                .data(ecosystemBubbles)
                .enter()
                .append('g')
                .attr('class', 'ecosystem-bubble');

            bubbleElements.append('ellipse')
                .attr('rx', 80)
                .attr('ry', 50)
                .attr('fill', d => d.color)
                .attr('opacity', 0.3)
                .attr('stroke', d => d.color)
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,3');

            bubbleElements.append('text')
                .attr('class', 'bubble-label')
                .attr('dy', -55)
                .attr('text-anchor', 'middle')
                .attr('fill', d => d.color)
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .text(d => d.ecosystem.charAt(0).toUpperCase() + d.ecosystem.slice(1) + ' Bubble');
        }

        // Create links
        linkElements = g.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(links)
            .enter()
            .append('line')
            .attr('class', d => `link link-${d.type}`);

        // Create node groups
        nodeElements = g.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(nodes)
            .enter()
            .append('g')
            .attr('class', d => `node node-${d.type}`)
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        // Draw node shapes
        nodeElements.each(function(d) {
            const node = d3.select(this);

            if (d.type === 'wan') {
                node.append('rect')
                    .attr('width', 70)
                    .attr('height', 35)
                    .attr('x', -35)
                    .attr('y', -17.5)
                    .attr('rx', 8)
                    .attr('fill', d.status === 'online' ? '#28a745' : '#6c757d')
                    .attr('stroke', 'rgba(255,255,255,0.3)')
                    .attr('stroke-width', 2);
            } else if (d.type === 'bridge') {
                node.append('polygon')
                    .attr('points', '0,-30 26,-15 26,15 0,30 -26,15 -26,-15')
                    .attr('fill', '#e69500')
                    .attr('stroke', 'rgba(255,255,255,0.4)')
                    .attr('stroke-width', 2);
            } else if (d.type === 'policy') {
                node.append('circle')
                    .attr('r', 35)
                    .attr('fill', d.color)
                    .attr('opacity', 0.85)
                    .attr('stroke', 'rgba(255,255,255,0.3)')
                    .attr('stroke-width', 2);

                // Device count badge
                if (d.device_count > 0) {
                    node.append('circle')
                        .attr('cx', 25)
                        .attr('cy', -25)
                        .attr('r', 12)
                        .attr('fill', '#fff');
                    node.append('text')
                        .attr('x', 25)
                        .attr('y', -21)
                        .attr('text-anchor', 'middle')
                        .attr('fill', d.color)
                        .attr('font-size', '11px')
                        .attr('font-weight', 'bold')
                        .text(d.device_count);
                }
            } else if (d.type === 'device') {
                node.append('circle')
                    .attr('r', 14)
                    .attr('fill', policyColors[d.policy] || '#6c757d')
                    .attr('opacity', d.status === 'online' ? 1 : 0.5)
                    .attr('stroke', 'rgba(255,255,255,0.4)')
                    .attr('stroke-width', 1.5);
            }

            // Icon
            node.append('text')
                .attr('class', 'node-icon')
                .attr('dy', 5)
                .text(iconMap[d.icon] || iconMap['laptop']);

            // Label
            const labelOffset = d.type === 'policy' ? 50 : (d.type === 'device' ? 26 : 30);
            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', labelOffset)
                .text(d.label ? d.label.substring(0, 14) : '');
        });

        // Mouse events
        nodeElements
            .on('mouseover', showTooltip)
            .on('mouseout', hideTooltip)
            .on('click', (event, d) => {
                if (d.type === 'device') {
                    openDeviceModal(d);
                }
            });

        // Force simulation
        simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
                if (d.type === 'wan_link') return 120;
                if (d.type === 'policy_link') return 140;
                return 90;
            }))
            .force('charge', d3.forceManyBody().strength(d => {
                if (d.type === 'bridge') return -500;
                if (d.type === 'policy') return -350;
                if (d.type === 'wan') return -200;
                return -120;
            }))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => {
                if (d.type === 'policy') return 55;
                if (d.type === 'device') return 24;
                if (d.type === 'bridge') return 50;
                return 45;
            }))
            .force('y', d3.forceY().y(d => {
                if (d.type === 'wan') return 80;
                if (d.type === 'bridge') return 180;
                if (d.type === 'policy') return 320;
                return 450;
            }).strength(0.15))
            .on('tick', ticked);
    }

    function ticked() {
        linkElements
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);

        // Update ecosystem bubble positions (centered on member devices)
        if (bubbleElements) {
            bubbleElements.each(function(bubble) {
                // Find member device nodes
                const memberMacs = bubble.devices.map(m => m.toUpperCase());
                const memberNodes = nodes.filter(n =>
                    n.type === 'device' && memberMacs.includes(n.mac?.toUpperCase())
                );

                if (memberNodes.length > 0) {
                    // Calculate centroid of member devices
                    const cx = d3.mean(memberNodes, d => d.x);
                    const cy = d3.mean(memberNodes, d => d.y);

                    // Calculate bounding box to size the ellipse
                    const xs = memberNodes.map(d => d.x);
                    const ys = memberNodes.map(d => d.y);
                    const rx = Math.max(60, (d3.max(xs) - d3.min(xs)) / 2 + 40);
                    const ry = Math.max(40, (d3.max(ys) - d3.min(ys)) / 2 + 30);

                    d3.select(this)
                        .attr('transform', `translate(${cx},${cy})`);

                    d3.select(this).select('ellipse')
                        .attr('rx', rx)
                        .attr('ry', ry);
                }
            });
        }
    }

    function dragStarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
        if (d.type === 'device') {
            d3.select(this).select('circle')
                .attr('stroke', '#fff')
                .attr('stroke-width', 3);
        }
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragEnded(event, d) {
        if (!event.active) simulation.alphaTarget(0);

        d3.select(this).select('circle')
            .attr('stroke', 'rgba(255,255,255,0.4)')
            .attr('stroke-width', 1.5);

        // Check if dropped on a policy node
        if (d.type === 'device') {
            const dropTarget = findPolicyAtPosition(event.x, event.y);
            if (dropTarget && dropTarget.name !== d.policy) {
                updateDevicePolicy(d.mac, dropTarget.name);
            }
        }

        d.fx = null;
        d.fy = null;
    }

    function findPolicyAtPosition(x, y) {
        for (const node of nodes) {
            if (node.type === 'policy') {
                const dist = Math.sqrt((node.x - x) ** 2 + (node.y - y) ** 2);
                if (dist < 55) return node;
            }
        }
        return null;
    }

    function showTooltip(event, d) {
        let html = `<h5>${d.label || d.id}</h5>`;

        if (d.type === 'device') {
            html += `
                <div class="tt-row"><span class="tt-label">IP:</span><span class="tt-value">${d.ip || 'N/A'}</span></div>
                <div class="tt-row"><span class="tt-label">MAC:</span><span class="tt-value">${d.mac || 'N/A'}</span></div>
                <div class="tt-row"><span class="tt-label">Policy:</span><span class="tt-value">${d.policy}</span></div>
                <div class="tt-row"><span class="tt-label">Status:</span><span class="tt-value">${d.status}</span></div>
            `;
        } else if (d.type === 'policy') {
            html += `<div class="tt-row"><span class="tt-label">Devices:</span><span class="tt-value">${d.device_count}</span></div>`;
        } else if (d.type === 'wan') {
            html += `<div class="tt-row"><span class="tt-label">Status:</span><span class="tt-value">${d.status}</span></div>`;
            html += `<div class="tt-row"><span class="tt-label">Type:</span><span class="tt-value">${d.subtype || 'Ethernet'}</span></div>`;
        }

        tooltip.innerHTML = html;

        const rect = container.getBoundingClientRect();
        tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
        tooltip.style.top = (event.clientY - rect.top + 15) + 'px';
        tooltip.classList.add('visible');
    }

    function hideTooltip() {
        tooltip.classList.remove('visible');
    }

    function openDeviceModal(device) {
        selectedDevice = device;
        document.getElementById('modal-device-name').textContent = device.label || 'Unknown Device';
        document.getElementById('modal-device-ip').textContent = device.ip || 'N/A';
        document.getElementById('modal-device-mac').textContent = device.mac || 'N/A';
        document.getElementById('modal-device-manufacturer').textContent = device.manufacturer || 'Unknown';
        document.getElementById('modal-device-icon').className = `fas fa-${device.icon || 'laptop'}`;

        const statusBadge = device.status === 'online'
            ? '<span class="badge badge-success">Online</span>'
            : '<span class="badge badge-secondary">Offline</span>';
        document.getElementById('modal-device-status').innerHTML = statusBadge;

        document.querySelectorAll('.policy-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.policy === device.policy);
        });

        $('#device-modal').modal('show');
    }

    function updateDevicePolicy(mac, newPolicy) {
        fetch(`/api/dashboard/device/${encodeURIComponent(mac)}/policy`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({policy: newPolicy})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                toastr.success(`Policy updated to ${newPolicy.replace('_', ' ')}`);
                loadTopology();
            } else {
                toastr.error(data.error || 'Failed to update policy');
            }
        })
        .catch(err => {
            console.error('Policy update error:', err);
            toastr.error('Failed to update policy');
        });
    }

    // Policy selector in modal
    document.querySelectorAll('.policy-option').forEach(el => {
        el.addEventListener('click', function() {
            document.querySelectorAll('.policy-option').forEach(p => p.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    document.getElementById('btn-save-policy').addEventListener('click', function() {
        const selected = document.querySelector('.policy-option.selected');
        if (selected && selectedDevice) {
            updateDevicePolicy(selectedDevice.mac, selected.dataset.policy);
            $('#device-modal').modal('hide');
        }
    });

    // Control buttons
    document.getElementById('btn-zoom-in').addEventListener('click', () => {
        svg.transition().call(zoom.scaleBy, 1.3);
    });

    document.getElementById('btn-zoom-out').addEventListener('click', () => {
        svg.transition().call(zoom.scaleBy, 0.7);
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
        svg.transition().call(zoom.transform, d3.zoomIdentity);
    });

    document.getElementById('btn-refresh').addEventListener('click', () => {
        loadTopology();
        toastr.info('Refreshing topology...');
    });

    // Train dnsXai button
    document.getElementById('btn-train-dnsxai').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Training...';
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-brain mr-1"></i> Train Model';
            toastr.success('Model training initiated');
        }, 2000);
    });

    // Handle resize
    window.addEventListener('resize', () => {
        width = container.clientWidth;
        svg.attr('width', width);
        if (simulation) {
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        }
    });

    // Initial load
    loadTopology();

    // Auto-refresh every 30 seconds
    setInterval(loadTopology, 30000);
})();
</script>
{% endblock %}
