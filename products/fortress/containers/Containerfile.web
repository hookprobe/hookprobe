# HookProbe Fortress - Flask Web Application Container
# Self-contained with all dependencies - no system-wide pip
#
# Build context: repo root (../../)
# Build: podman-compose build web
# Run:   podman run -d -p 8443:8443 -v /etc/hookprobe:/etc/hookprobe:ro fts-web
#
# Version: 5.5.0
# License: AGPL-3.0

FROM python:3.11-slim-bookworm AS builder

# Install build dependencies (includes g++ for scikit-learn compilation)
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libpq-dev \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy requirements and install dependencies
# All dependencies including psycopg2-binary and redis are in requirements.txt
COPY products/fortress/web/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r /tmp/requirements.txt

# ============================================================
# Production Stage
# ============================================================
FROM python:3.11-slim-bookworm

LABEL maintainer="HookProbe Security <qsecbit@hookprobe.com>"
LABEL version="5.5.0"
LABEL description="HookProbe Fortress Admin Portal - Self-contained Flask application"

# Install runtime dependencies only
# iputils-ping: for latency measurement via ping
# iproute2: for network interface and route detection
# ethtool: for link speed detection
# iproute2 includes tc for traffic shaping (friction engine)
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    iputils-ping \
    iproute2 \
    ethtool \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd -g 1000 fortress \
    && useradd -g fortress -u 1000 -d /app -s /sbin/nologin fortress

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Application directory
WORKDIR /app

# Copy application code (context is repo root)
COPY products/fortress/web/ /app/web/
COPY products/fortress/lib/ /app/lib/

# Copy core AEGIS module (promoted from lib/aegis to core/aegis)
RUN mkdir -p /app/core
COPY core/__init__.py /app/core/__init__.py
COPY core/aegis/ /app/core/aegis/
ENV PYTHONPATH="/app:${PYTHONPATH:-}"

# Copy shared AIOCHI backend modules for Active Defenses
# Structure: /app/shared/aiochi/backend/*.py
# These provide: DynamicFrictionEngine, NSEGhostProbe, AttackChainPredictor,
#                HoneypotMesh, DataGravityMonitor
RUN mkdir -p /app/shared/aiochi/backend /app/shared/aiochi/playbooks
COPY shared/aiochi/backend/ /app/shared/aiochi/backend/
COPY shared/aiochi/playbooks/ /app/shared/aiochi/playbooks/
COPY shared/aiochi/__init__.py /app/shared/aiochi/__init__.py
RUN touch /app/shared/__init__.py

# Copy gunicorn configuration
COPY products/fortress/web/gunicorn.conf.py /app/gunicorn.conf.py

# Create necessary directories
RUN mkdir -p /app/data /app/logs /app/certs && \
    chown -R fortress:fortress /app

# Generate self-signed certificate for development
RUN openssl req -x509 -newkey rsa:4096 -keyout /app/certs/key.pem \
    -out /app/certs/cert.pem -days 365 -nodes \
    -subj "/C=US/ST=State/L=City/O=HookProbe/OU=Fortress/CN=localhost" && \
    chmod 600 /app/certs/key.pem && \
    chown fortress:fortress /app/certs/*

# Copy entrypoint script
COPY products/fortress/containers/entrypoint-web.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment configuration
ENV FLASK_APP=web.app:app
ENV FLASK_ENV=production
ENV FORTRESS_DATA_DIR=/app/data
ENV FORTRESS_CONFIG_DIR=/etc/hookprobe
ENV GUNICORN_WORKERS=2
ENV GUNICORN_THREADS=4
ENV GUNICORN_BIND=0.0.0.0:8443

# Health check
# start-period allows 90s for entrypoint to wait for DB (up to 60s) and app startup
# Note: Uses shell form to support dynamic WEB_PORT via GUNICORN_BIND env var
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD ["sh", "-c", "PORT=${GUNICORN_BIND##*:}; curl -f -k https://localhost:${PORT:-8443}/health || exit 1"]

# Expose HTTPS port
EXPOSE 8443

# Run as non-root user
USER fortress

# Volumes for persistent data
VOLUME ["/app/data", "/etc/hookprobe"]

ENTRYPOINT ["/entrypoint.sh"]
CMD ["gunicorn", "--config", "/app/gunicorn.conf.py", "web.app:app"]
